<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- === Ø¶Ø¹ Ù‡Ù†Ø§ === -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MENU PRINCIPAL</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª SheetJS/XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Ù…ÙƒØªØ¨Ø© Html5Qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- ========== Ø¶Ø¹ ÙƒÙˆØ¯ Webtonotive Ù‡Ù†Ø§ ========== -->
    <script>
    // ÙƒÙˆØ¯ Ø®Ø§Øµ Ù„Ù€ Webtonotive Ù„Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
    (function() {
        console.log('ğŸ”„ Initialisation pour Webtonotive...');
        
        // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù†Ø¹ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Webtonotive
        if (window.location.protocol === 'file:' || 
            window.navigator.standalone || 
            window.matchMedia('(display-mode: standalone)').matches) {
            
            console.log('ğŸ“± Mode application dÃ©tectÃ© (Webtonotive)');
            
            // ØªØ¹Ø·ÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù€ Webtonotive
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                
                // ØªØ¬Ø§Ù‡Ù„ Ø·Ù„Ø¨Ø§Øª ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Webtonotive
                if (typeof url === 'string' && (
                    url.includes('connectivity-check') ||
                    url.includes('connection-test') ||
                    url.includes('online-check')
                )) {
                    console.log('ğŸ“¶ IgnorÃ© la vÃ©rification de connexion Webtonotive');
                    return Promise.resolve(new Response(
                        JSON.stringify({ status: 'online' }),
                        { status: 200, headers: { 'Content-Type': 'application/json' } }
                    ));
                }
                
                return originalFetch.apply(this, args);
            };
        }
        
        // 2. ØªÙ‡ÙŠØ¦Ø© localStorage ÙÙˆØ±Ø§Ù‹
        if (typeof localStorage !== 'undefined') {
            // Ø®Ø¯Ø¹Ø© Ù„Ø¬Ø¹Ù„ Webtonotive ÙŠØ¹ØªÙ‚Ø¯ Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²
            localStorage.setItem('webtonotive_ready', 'true');
            localStorage.setItem('app_initialized', new Date().toISOString());
        }
    })();
    </script>
    
    <style>
    /* Ø®Ø¯Ø¹Ø© Ø¨ØµØ±ÙŠØ© Ù„Ù€ Webtonotive */
    #webtonotiveSplash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f0f4f8, #ffffff);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s;
    }
    
    #webtonotiveSplash h1 {
        color: #1E3A8A;
        font-size: 24px;
        text-align: center;
    }
    </style>
    <!-- ========== Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Webtonotive ========== -->

<style>
/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø§Ù…Ø© */
* {
    font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif !important;
    font-weight: 600 !important;
}

body {
    background: linear-gradient(135deg, #f0f4f8, #ffffff);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† */
h1 {
    text-align: center;
    margin-top: 40px !important; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© */
    font-size: 28px;
    text-transform: uppercase;
    color: #1E3A8A !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ù…Ù„ÙƒÙŠ */
}

/* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† GESTION RESERVE ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
.main-title {
    text-align: center;
    margin-top: 40px !important; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© */
    margin-bottom: 30px !important; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© */
    font-size: 32px;
    font-weight: 900;
    text-transform: uppercase;
    color: #1E3A8A !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ù…Ù„ÙƒÙŠ */
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

/* ØªØºÙŠÙŠØ± Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© */
.footer-line {
    font-size: 18px;
    font-weight: 700;
    color: #1E3A8A !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ù…Ù„ÙƒÙŠ */
    margin: 5px 0;
    text-transform: uppercase;
}

.footer-developer {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
    margin-top: 10px;
    text-transform: uppercase;
}

/* ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± PARTAGER Ø¥Ù„Ù‰ Ø£Ø²Ø±Ù‚ */
.partager-btn {
    padding: 10px 20px;
    background: #3498db !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ */
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    margin-top: 10px;
    text-transform: uppercase;
}

.partager-btn:hover {
    background: #2980b9 !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¯Ø§ÙƒÙ† */
}

/* ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ù‡Ø¨ÙˆØ· Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„ */
.bottomBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #3498db !important; /* Ù†ÙØ³ Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØµØ¹ÙˆØ¯ */
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
}

.bottomBtn:hover {
    background: #2980b9 !important; /* Ù†ÙØ³ Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØµØ¹ÙˆØ¯ */
    transform: scale(1.1);
}

/* Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø® Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ø§ Ø¹Ø¯Ø§ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ */
* {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ø³Ø® Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø· */
.codeRow, .produit-code, input[type="tel"] {
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
}

/* Ø²Ø± Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® */
.date-picker-btn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    width: 40px;
    height: 40px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 5px;
    transition: all 0.3s;
}

.date-picker-btn:hover {
    background: #2980b9;
    transform: scale(1.1);
}

/* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ Ø²Ø± Ø§Ù„ØªÙ‚ÙˆÙŠÙ… */
.retirer-input-row, .casse-input-row {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    align-items: center;
}

.retirer-input-row input, .casse-input-row input {
    flex: 1;
}

/* Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® */
.date-picker-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 3000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.date-picker-content {
    background: white;
    padding: 25px;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.3s ease-out;
    position: relative;
    overflow: hidden;
}

.date-picker-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

.date-picker-title {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
}

.date-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 15px 0;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 10px;
}

.date-option {
    background: #f8f9fa;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-weight: 500;
    color: #2c3e50;
    text-transform: uppercase;
}

.date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

/* Ø¥Ø¨Ù‚Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø±Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ */
.container {
    width: 90%;
    max-width: 500px;
    margin: 20px auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 15px;
    position: relative;
    overflow: visible;
}

.btn {
    padding: 18px 12px;
    text-align: center;
    border-radius: 10px;
    font-size: 18px;
    color: white;
    text-decoration: none;
    transition: 0.25s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    border: none;
    text-transform: uppercase;
    height: 85px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.3;
    word-break: break-word;
    overflow: hidden;
}

.btn:hover { transform: scale(1.03); }

.info     { background: #3498db; }
.changement { background: #FFA500; }
.adresse  { background: #9b59b6; }
.rupture  { background: #e74c3c; }
.dlc      { background: #f39c12; }
.commande { background: #1abc9c; }
.ajouter  { background: #27ae60; }
.retirer  { background: #34495e; }
.casse    { background: #d35400; }
.panier   { background: #2ecc71; }
.partager { background: #9b59b6; }

#infoPage, #adressePage, #rupturePage, #dlcPage, #commandePage, #ajouterPage, #cassePage, #retirerPage, #changementPrixPage, #panierPage { 
    display: none; 
    padding: 20px; 
    animation: fadeIn 0.3s ease-in-out; 
    max-width: 600px;
    margin: 0 auto;
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

.adresseCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #f39c12;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.adresseCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #f39c12, #e67e22);
}

.adresseCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.adresseCard .infoRow, .adresseCard .codeRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 16px;
    letter-spacing: 0.5px;
    border: 1px solid #e0e0e0;
    text-transform: uppercase;
}

.adresseCard .nameRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 14px;
    font-style: normal;
    border: 1px solid #e0e0e0;
    text-transform: uppercase;
}

.adresseCard .qteRow {
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 13px;
    text-transform: uppercase;
}

.adresseCard .qteRow .qte-value {
    color: #27ae60;
    font-size: 14px;
}

.adresseCard .qteRow .date-value {
    color: #e74c3c;
    font-size: 14px;
}

.adresseCard .qteRow .label {
    color: #7f8c8d;
    font-size: 13px;
}

.reserveCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.reserveCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9);
}

.reserveCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.reserveCard .dataRow {
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.reserveCard .dataRow .label {
    color: #7f8c8d;
}

.reserveCard .dataRow .value {
    color: #2c3e50;
}

.totalSummaryCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.totalSummaryCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9);
}

.totalSummaryCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.totalSummaryCard .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #27ae60;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    border: 1px solid #bdc3c7;
    font-size: 15px;
    text-transform: uppercase;
}

.totalRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 12px;
    color: #27ae60;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    border: 1px solid #bdc3c7;
    font-size: 15px;
    text-transform: uppercase;
}

.totalRow .total-value {
    color: #27ae60;
    font-size: 16px;
    margin-left: 5px;
}

.search-card {
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    color: white;
    transition: transform 0.3s, box-shadow 0.3s;
    background: white;
    border-left: 3px solid #3498db !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.search-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.search-card:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
}

.input-row { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
    gap: 8px;
}

#codeInput, #adresseInput, #commandeCodeInput, #commandeQteInput, #ajouterCodeInput, #ajouterAdresseInput, #ajouterQte1Input, #ajouterDlc1Input, #ajouterQte2Input, #ajouterDlc2Input, #ajouterQte3Input, #ajouterDlc3Input, #casseCodeInput, #casseQteInput, #casseDateInput, #retirerCodeInput, #retirerAdresseInput, #retirerQteInput, #retirerDateInput, #changementCodeInput, #panierCodeInput, #panierQteInput {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #bbb;
    padding: 8px;
    font-size: 16px;
    background: #f0f4f8;
    text-align: center;
    color: #1e2a38;
    box-sizing: border-box;
    text-transform: uppercase;
}

button.scan, button.searchBtn, .scan-small {
    padding: 8px 12px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    width: 100%;
    margin-top: 8px;
    height: 50px;
    text-transform: uppercase;
}

.scan-small {
    width: 100px;
    height: 50px;
    margin-top: 0;
}

button.scan:hover, button.searchBtn:hover, .scan-small:hover {
    background: #2980b9;
}

.backBtn { 
    display: block;
    margin: 0 auto 20px auto;
    cursor: pointer; 
    color: #fff; 
    font-size: 16px; 
    text-decoration: none;
    text-transform: uppercase;
    padding: 12px 24px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s;
    border: none;
    width: auto;
    text-align: center;
}

.backBtn:hover { 
    background: linear-gradient(135deg, #2980b9, #1c6ea4);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
}

.backBtn::before {
    content: 'â† ';
    margin-right: 8px;
}

#adresseContainer, #resultatsContainer, #infoDataContainer, #ruptureContainer, #dlcContainer, #commandeContainer, #commandeProduitsContainer, #ajouterContainer, #ajouterProduitsContainer, #casseContainer, #casseProduitsContainer, #retirerContainer, #retirerProduitsContainer, #changementInfoContainer, #changementResultsContainer, #panierContainer, #panierProduitsContainer { margin-top: 6px; margin-bottom: 30px; }

.search-type {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.search-type-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    text-transform: uppercase;
}

.search-type-btn.active {
    background: #3498db;
    color: white;
}

.search-type-btn:hover {
    background: #2980b9;
    color: white;
}

.departement-select {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.departement-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    width: 48%;
    text-transform: uppercase;
}

.departement-btn.active {
    background: #3498db;
    color: white;
}

.departement-btn:hover {
    background: #2980b9;
    color: white;
}

.month-select {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.month-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    width: 100%;
    text-transform: uppercase;
}

.month-btn.active {
    background: #3498db;
    color: white;
}

.month-btn:hover {
    background: #2980b9;
    color: white;
}

.topBtn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
}

.topBtn:hover {
    background: #2980b9;
    transform: scale(1.1);
}

.commande-card, .ajouter-card, .casse-card, .retirer-card, .panier-card {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.commande-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.ajouter-card, .casse-card, .retirer-card, .panier-card {
    border-left: 3px solid #3498db !important;
}

.ajouter-card::before, .casse-card::before, .retirer-card::before, .panier-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.commande-input-row, .ajouter-input-row, .casse-input-row, .retirer-input-row, .panier-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.commande-input-row input, .ajouter-input-row input, .casse-input-row input, .retirer-input-row input, .panier-input-row input {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 16px;
    text-align: center;
    text-transform: uppercase;
}

.ajouter-qte-input, .ajouter-dlc-input, .casse-date-input, .retirer-date-input {
    max-width: 150px;
}

.commande-btn, .ajouter-btn, .casse-btn, .retirer-btn, .panier-btn {
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    margin-top: 10px;
    text-transform: uppercase;
}

.commande-btn:hover {
    background: #2980b9;
}

.ajouter-btn {
    background: #27ae60;
}

.ajouter-btn:hover {
    background: #219653;
}

.casse-btn {
    background: #d35400;
}

.casse-btn:hover {
    background: #a04000;
}

.retirer-btn {
    background: #34495e;
}

.retirer-btn:hover {
    background: #2c3e50;
}

.panier-btn {
    background: #2ecc71;
}

.panier-btn:hover {
    background: #27ae60;
}

.commande-btn.secondary, .ajouter-btn.secondary, .casse-btn.secondary, .retirer-btn.secondary, .panier-btn.secondary {
    background: #e74c3c;
    border: 2px solid #c0392b;
}

.commande-btn.secondary:hover, .ajouter-btn.secondary:hover, .casse-btn.secondary:hover, .retirer-btn.secondary:hover, .panier-btn.secondary:hover {
    background: #c0392b;
}

.commande-summary, .ajouter-summary, .casse-summary, .retirer-summary, .panier-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    text-align: center;
    color: #2c3e50;
    border: 2px solid #3498db;
    text-transform: uppercase;
}

.ajouter-summary {
    border: 2px solid #27ae60;
}

.casse-summary {
    border: 2px solid #d35400;
}

.retirer-summary {
    border: 2px solid #34495e;
}

.panier-summary {
    border: 2px solid #2ecc71;
}

.commande-summary span, .ajouter-summary span, .casse-summary span, .retirer-summary span, .panier-summary span {
    color: #27ae60;
    font-size: 20px;
}

.produit-card {
    background: white;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db;
    position: relative;
    text-transform: uppercase;
}

.produit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ecf0f1;
}

.produit-code {
    background: #3498db;
    color: white;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 14px;
}

.produit-actions {
    display: flex;
    gap: 8px;
}

.produit-edit {
    background: #f39c12;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.produit-edit:hover {
    background: #d68910;
    transform: scale(1.1);
}

.produit-delete {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.produit-delete:hover {
    background: #c0392b;
    transform: scale(1.1);
}

.produit-name {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    color: #2c3e50;
    text-align: center;
}

.produit-qte {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
}

.qte-label {
    color: #7f8c8d;
}

.qte-value {
    color: #27ae60;
    font-size: 18px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: white;
    padding: 40px 30px;
    border-radius: 16px;
    max-width: 450px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.3s ease-out;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal h2 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 24px;
    text-transform: uppercase;
}

.modal p {
    color: #5a6c7d;
    font-size: 16px;
    line-height: 1.5;
    margin: 0;
    padding: 0 10px;
}

.modal-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    justify-content: center;
}

.modal-btn {
    flex: 1;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    max-width: 160px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-transform: uppercase;
}

.modal-btn.confirm {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.modal-btn.confirm:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.modal-btn.cancel {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.modal-btn.cancel:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.date-select-modal .modal-content {
    max-width: 400px;
}

.date-options {
    max-height: 300px;
    overflow-y: auto;
    margin: 20px 0;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 10px;
}

.date-option {
    background: #f8f9fa;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    text-transform: uppercase;
}

.date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

.date-option.selected {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
}

.alert-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    border-left: 3px solid #e74c3c;
    z-index: 3000;
    animation: alertSlideIn 0.3s ease-out;
    max-width: 350px;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
    text-transform: uppercase;
}

.alert-message.success {
    border-left-color: #27ae60;
}

.alert-message.info {
    border-left-color: #3498db;
}

.alert-message.warning {
    border-left-color: #f39c12;
}

.alert-icon {
    font-size: 20px;
}

@keyframes alertSlideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.ajouter-input-row.small-row {
    flex-wrap: nowrap;
    justify-content: space-between;
}

.ajouter-small-input {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 6px 8px;
    font-size: 14px;
    text-align: center;
    min-width: 0;
    box-sizing: border-box;
    text-transform: uppercase;
}

.ajouter-small-input.qte {
    max-width: 80px;
    margin-right: 5px;
}

.ajouter-small-input.date {
    flex: 2;
    min-width: 120px;
    margin-left: 5px;
}

.action-buttons {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    justify-content: center;
}

.action-btn {
    flex: 1;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
    text-align: center;
    color: white;
    min-width: 80px;
}

.action-btn.retirer {
    background: #34495e;
}

.action-btn.retirer:hover {
    background: #2c3e50;
    transform: translateY(-2px);
}

.action-btn.commander {
    background: #1abc9c;
}

.action-btn.commander:hover {
    background: #16a085;
    transform: translateY(-2px);
}

.action-btn.ajouter {
    background: #27ae60;
}

.action-btn.ajouter:hover {
    background: #219653;
    transform: translateY(-2px);
}

.quick-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.quick-modal-content {
    background: white;
    padding: 30px 25px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.3s ease-out;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.quick-modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

.quick-modal-title {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 22px;
    text-transform: uppercase;
}

.quick-modal-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 3px solid #3498db;
}

.quick-modal-info .code {
    color: #3498db;
    font-size: 16px;
    margin-bottom: 5px;
}

.quick-modal-info .name {
    color: #2c3e50;
    font-size: 14px;
    margin-bottom: 5px;
}

.quick-modal-info .adresse {
    color: #e74c3c;
    font-size: 16px;
}

.quick-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.quick-input-row input {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 16px;
    text-align: center;
    text-transform: uppercase;
}

.quick-input-row input:focus {
    outline: none;
    border-color: #3498db;
}

.quick-modal-buttons {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    justify-content: center;
}

.quick-modal-btn {
    flex: 1;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    max-width: 160px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-transform: uppercase;
}

.quick-modal-btn.confirm {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.quick-modal-btn.confirm:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.quick-modal-btn.cancel {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.quick-modal-btn.cancel:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.quick-modal-btn.retirer {
    background: linear-gradient(135deg, #34495e, #2c3e50);
    color: white;
}

.quick-modal-btn.retirer:hover {
    background: linear-gradient(135deg, #2c3e50, #1c2836);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(52, 73, 94, 0.3);
}

.quick-modal-btn.commander {
    background: linear-gradient(135deg, #1abc9c, #16a085);
    color: white;
}

.quick-modal-btn.commander:hover {
    background: linear-gradient(135deg, #16a085, #138d75);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(26, 188, 156, 0.3);
}

.quick-modal-btn.ajouter {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.quick-modal-btn.ajouter:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.infoChangementCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #FFA500;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.infoChangementCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #FFA500, #FF8C00);
}

.infoChangementCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.infoChangementCard .infoRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.infoChangementCard .lot-permanent {
    color: #27ae60 !important;
}

.infoChangementCard .lot-promo {
    color: #e74c3c !important;
}

.resultatChangementCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    font-weight: bold;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.resultatChangementCard.permanent {
    border-left: 3px solid #27ae60;
}

.resultatChangementCard.permanent::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #27ae60, #219653);
}

.resultatChangementCard.promo {
    border-left: 3px solid #e74c3c;
}

.resultatChangementCard.promo::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #e74c3c, #c0392b);
}

.resultatChangementCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.resultatChangementCard .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.resultatChangementCard .dataRow .label {
    color: #7f8c8d;
}

.resultatChangementCard .dataRow .value {
    color: #2c3e50;
}

.totalChangementCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #FFA500;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.totalChangementCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #FFA500, #FF8C00);
}

.totalChangementCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.totalChangementCard .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.totalChangementCard .dataRow .total-value {
    color: #FFA500;
    font-size: 16px;
}

.quick-modal-content.retirer-modal {
    border-left: none !important;
}

.quick-modal-content.retirer-modal::before {
    display: none !important;
}

.quick-retirer-info {
    background: white !important;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #ddd !important;
    text-align: left;
}

.quick-retirer-info .code {
    color: #2c3e50 !important;
    font-size: 16px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-retirer-info .name {
    color: #2c3e50 !important;
    font-size: 14px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-retirer-info .adresse {
    color: #FFA500 !important;
    font-size: 16px;
    text-align: center;
}

.quick-ajouter-info {
    background: white !important;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #ddd !important;
    text-align: left;
}

.quick-ajouter-info .adresse {
    color: #FFA500 !important;
    font-size: 16px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-ajouter-info .code {
    color: #2c3e50 !important;
    font-size: 16px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-ajouter-info .name {
    color: #2c3e50 !important;
    font-size: 14px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-ajouter-label {
    color: #7f8c8d;
    font-size: 12px;
    margin-bottom: 5px;
    text-align: left;
}

.quick-ajouter-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.quick-ajouter-input-row input {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 14px;
    text-align: center;
    text-transform: uppercase;
}

.quick-ajouter-input-row.small-row {
    flex-wrap: nowrap;
}

.quick-ajouter-small-input {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 6px 8px;
    font-size: 14px;
    text-align: center;
    min-width: 0;
    box-sizing: border-box;
    text-transform: uppercase;
}

.quick-ajouter-small-input.qte {
    max-width: 80px;
}

.quick-ajouter-small-input.date {
    flex: 2;
    min-width: 120px;
}

.panier-produit-card {
    background: white;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #2ecc71;
    position: relative;
    text-transform: uppercase;
}

.panier-produit-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #2ecc71, #27ae60);
}

.panier-produit-card .produit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ecf0f1;
}

.panier-produit-card .produit-code {
    background: #2ecc71;
    color: white;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 14px;
}

.panier-produit-card .produit-name {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    color: #2c3e50;
    text-align: center;
}

.panier-produit-card .produit-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
}

.panier-produit-card .detail-item {
    text-align: center;
    flex: 1;
}

.panier-produit-card .detail-label {
    color: #7f8c8d;
    font-size: 12px;
    margin-bottom: 5px;
}

.panier-produit-card .detail-value {
    color: #2c3e50;
    font-size: 16px;
}

.panier-produit-card .detail-value.prix {
    color: #27ae60;
}

.panier-produit-card .detail-value.total {
    color: #e74c3c;
    font-size: 18px;
}

.panier-total-card {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #2ecc71;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.panier-total-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #2ecc71, #27ae60);
}

.panier-total-card h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.panier-total-card .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.panier-total-card .dataRow .label {
    color: #7f8c8d;
}

.panier-total-card .dataRow .value {
    color: #2c3e50;
}

.panier-total-card .dataRow .total-value {
    color: #2ecc71;
    font-size: 16px;
}

/* ØªØ¹Ø¯ÙŠÙ„ 2: Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ */
#scannerOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#scannerFrame {
    width: 90%;
    height: 70%;
    max-width: 600px;
    max-height: 600px;
    border: 4px solid #3498db;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
    position: relative;
}

#scannerFrame::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(0deg, rgba(0,0,0,0) 50%, rgba(255,255,255,0.1) 50%);
    background-size: 100% 4px;
    pointer-events: none;
    animation: scanLine 2s linear infinite;
}

@keyframes scanLine {
    0% { background-position: 0 -100%; }
    100% { background-position: 0 100%; }
}

#scannerLoading {
    display: none;
    color: white;
    font-size: 20px;
    margin-top: 20px;
    text-align: center;
}

#scannerLoading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#closeScanner {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 30px;
    cursor: pointer;
    z-index: 10000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#closeScanner:hover {
    background: #c0392b;
    transform: scale(1.1);
}

/* Ø²Ø± PARTAGER */
.partager-card {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #9b59b6 !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.partager-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #9b59b6, #8e44ad) !important;
}

/* ØªØ¹Ø¯ÙŠÙ„ 5: Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙÙŠ ÙƒØ±ÙˆØª Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
.checkbox-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

.adresse-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid #e74c3c;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #e74c3c;
    transition: all 0.2s;
}

.adresse-checkbox.checked {
    background: #e74c3c;
    color: white;
}

.adresse-checkbox:hover {
    transform: scale(1.1);
    box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± SCANNER ÙÙŠ ØµÙØ­Ø© CONTINUE D'ADRESSE */
#adressePage .search-card button.searchBtn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    height: 50px;
    text-transform: uppercase;
    width: 100%;
    margin-top: 8px;
}

#adressePage .search-card button.searchBtn:hover {
    background: #2980b9;
}

/* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.footer-info {
    text-align: center;
    margin-top: 40px;
    padding-bottom: 40px;
}

.footer-spacing {
    height: 60px;
}

@media (max-width: 480px) {
    .container {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .btn {
        padding: 16px 10px;
        font-size: 16px;
        height: 75px;
    }
    
    .input-row {
        flex-direction: column;
    }
    
    #codeInput, #adresseInput, .scan-small {
        width: 100%;
    }
    
    .commande-input-row, .ajouter-input-row, .casse-input-row, .retirer-input-row, .panier-input-row {
        flex-direction: column;
    }
    
    .ajouter-qte-input, .ajouter-dlc-input, .casse-date-input, .retirer-date-input {
        max-width: 100%;
    }
    
    .modal-content {
        padding: 30px 20px;
    }
    
    .modal-buttons {
        flex-direction: column;
    }
    
    .modal-btn {
        max-width: 100%;
    }
    
    .alert-message {
        left: 20px;
        right: 20px;
        max-width: none;
    }
    
    .produit-actions {
        gap: 5px;
    }
    
    .ajouter-input-row.small-row {
        flex-wrap: wrap;
    }
    
    .ajouter-small-input.qte,
    .ajouter-small-input.date {
        max-width: 100%;
        width: 100%;
        margin: 5px 0;
    }
    
    .backBtn {
        padding: 10px 20px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
    }
    
    .quick-modal-content {
        padding: 20px 15px;
    }
    
    .quick-input-row {
        flex-direction: column;
    }
    
    .quick-modal-buttons {
        flex-direction: column;
    }
    
    .quick-modal-btn {
        max-width: 100%;
    }
    
    #scannerFrame {
        width: 95%;
        height: 60%;
        max-width: 400px;
        max-height: 400px;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø£Ù‚Ù„ Ù…Ù† 400px */
@media (max-width: 400px) {
    .container {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 95%;
        padding: 10px;
    }
    
    .btn {
        padding: 14px 8px;
        font-size: 15px;
        height: 70px;
        line-height: 1.2;
    }
    
    h1 {
        font-size: 22px;
        margin-top: 15px;
    }
    
    .search-card, .commande-card, .ajouter-card, .casse-card, .retirer-card, .panier-card, .partager-card {
        padding: 12px;
    }
    
    .adresseCard, .reserveCard, .totalSummaryCard, .infoChangementCard, .resultatChangementCard, .totalChangementCard, .panier-produit-card, .panier-total-card {
        padding: 10px;
    }
    
    .adresseCard h3, .reserveCard h3, .totalSummaryCard h3, .infoChangementCard h3, .resultatChangementCard h3, .totalChangementCard h3, .panier-total-card h3 {
        font-size: 16px;
    }
    
    .backBtn {
        padding: 8px 16px;
        font-size: 13px;
        margin-bottom: 10px;
    }
    
    #codeInput, #adresseInput, #commandeCodeInput, #commandeQteInput, #ajouterCodeInput, #ajouterAdresseInput, #ajouterQte1Input, #ajouterDlc1Input, #ajouterQte2Input, #ajouterDlc2Input, #ajouterQte3Input, #ajouterDlc3Input, #casseCodeInput, #casseQteInput, #casseDateInput, #retirerCodeInput, #retirerAdresseInput, #retirerQteInput, #retirerDateInput, #changementCodeInput, #panierCodeInput, #panierQteInput {
        height: 45px;
        font-size: 14px;
    }
    
    button.scan, button.searchBtn, .scan-small {
        height: 45px;
        font-size: 13px;
    }
    
    .modal-content {
        padding: 20px 15px;
    }
    
    .modal h2 {
        font-size: 20px;
    }
    
    .modal-btn {
        padding: 12px 16px;
        font-size: 14px;
    }
    
    #scannerFrame {
        max-width: 320px;
        max-height: 320px;
    }
}
/* Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
#addressOptionsModal .modal-content {
    max-width: 450px;
}

#addressOptionsModal .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
}

#addressOptionsModal .date-option:hover {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
    transform: translateX(5px);
}
/* Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù€ RETIRER */
#dateOptionsModalRetirer .modal-content {
    max-width: 450px;
}

#dateOptionsModalRetirer .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
}

#dateOptionsModalRetirer .date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

/* Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ù€ AJOUTER */
#addressOptionsModalAjouter .modal-content {
    max-width: 450px;
}

#addressOptionsModalAjouter .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    text-transform: uppercase;
}

#addressOptionsModalAjouter .date-option:hover {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
    transform: translateX(5px);
}
/* Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù€ AJOUTER */
#dateOptionsModalAjouter .modal-content {
    max-width: 450px;
}

#dateOptionsModalAjouter .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    text-transform: uppercase;
}

#dateOptionsModalAjouter .date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

#dateOptionsModalAjouter .date-option[style*="background: #3498db"] {
    border-color: #3498db;
}

#dateOptionsModalAjouter .date-option[style*="background: #3498db"]:hover {
    background: #2980b9 !important;
    transform: translateX(5px);
}
/* Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© AJOUTER */
#dateOptionsModalQuickAjouter .modal-content {
    max-width: 450px;
}

#dateOptionsModalQuickAjouter .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    text-transform: uppercase;
}

#dateOptionsModalQuickAjouter .date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

#dateOptionsModalQuickAjouter .date-option[style*="background: #3498db"] {
    border-color: #3498db;
}

#dateOptionsModalQuickAjouter .date-option[style*="background: #3498db"]:hover {
    background: #2980b9 !important;
    transform: translateX(5px);
}
</style>
</head>

<body>
<div id="webtonotiveSplash">
        <h1>GESTION RÃ‰SERVE<br>Chargement...</h1>
    </div>
<!-- Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ -->
<div id="scannerOverlay">
    <button id="closeScanner" onclick="stopScanner()">Ã—</button>
    <div id="scannerFrame"></div>
    <div id="scannerLoading">CHARGEMENT DU SCANNER...</div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
<div id="datePickerModal" class="date-picker-modal">
    <div class="date-picker-content">
        <h2 class="date-picker-title">SÃ‰LECTIONNER UNE DATE</h2>
        <div id="dateList" class="date-list"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDatePicker()">ANNULER</button>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h2>CONFIRMATION</h2>
        <p id="confirmMessage"></p>
        <div class="modal-buttons">
            <button class="modal-btn confirm" onclick="confirmAction()">CONFIRMER</button>
            <button class="modal-btn cancel" onclick="cancelAction()">ANNULER</button>
        </div>
    </div>
</div>

<div id="dateSelectModal" class="modal date-select-modal">
    <div class="modal-content">
        <h2>SÃ‰LECTIONNER UNE DATE</h2>
        <p id="dateSelectMessage">CHOISISSEZ UNE DATE POUR CE PRODUIT:</p>
        <div id="dateOptionsContainer" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateSelectModal()">ANNULER</button>
        </div>
    </div>
</div>

<div id="quickRetirerModal" class="quick-modal">
    <div class="quick-modal-content retirer-modal">
        <h2 class="quick-modal-title">RETIRER PRODUIT</h2>
        <div id="quickRetirerInfo" class="quick-retirer-info"></div>
        
        <!-- ØªØºÙŠÙŠØ±: Ø­Ø°Ù Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù€ AJOUTER -->
        <div class="quick-input-row small-row" style="margin-bottom: 10px;">
    <input type="tel" id="quickRetirerQte1Input" class="quick-ajouter-small-input qte" placeholder="QTE1" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="quickRetirerDlc1Input" class="quick-ajouter-small-input date" placeholder="DLC1 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickRetirer(1)">
</div>

<div class="quick-input-row small-row" style="margin-bottom: 10px;">
    <input type="tel" id="quickRetirerQte2Input" class="quick-ajouter-small-input qte" placeholder="QTE2" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="quickRetirerDlc2Input" class="quick-ajouter-small-input date" placeholder="DLC2 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickRetirer(2)">
</div>

<div class="quick-input-row small-row" style="margin-bottom: 15px;">
    <input type="tel" id="quickRetirerQte3Input" class="quick-ajouter-small-input qte" placeholder="QTE3" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="quickRetirerDlc3Input" class="quick-ajouter-small-input date" placeholder="DLC3 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickRetirer(3)">
</div>
        
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn retirer" onclick="quickRetirerProduit()">RETIRER</button>
            <button class="quick-modal-btn cancel" onclick="closeQuickRetirerModal()">ANNULER</button>
        </div>
    </div>
</div>

<div id="quickCommanderModal" class="quick-modal">
    <div class="quick-modal-content">
        <h2 class="quick-modal-title">COMMANDER PRODUIT</h2>
        <div id="quickCommanderInfo" class="quick-modal-info"></div>
        <div class="quick-input-row">
            <input type="tel" id="quickCommanderQteInput" placeholder="QUANTITÃ‰" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn commander" onclick="quickCommanderProduit()">COMMANDER</button>
            <button class="quick-modal-btn cancel" onclick="closeQuickCommanderModal()">ANNULER</button>
        </div>
    </div>
</div>

<div id="quickAjouterModal" class="quick-modal">
    <div class="quick-modal-content">
        <h2 class="quick-modal-title">AJOUTER PRODUIT</h2>
        <div id="quickAjouterInfo" class="quick-ajouter-info"></div>
        
        <!-- ØªØ¹Ø¯ÙŠÙ„: Ø¬Ø¹Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„ÙˆØ³Ø· ÙˆÙ…Ø´Ø§Ø¨Ù‡ Ù„Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© -->
        <div class="quick-input-row" style="margin-bottom: 10px;">
            <input type="tel" id="quickAjouterAdresseInput" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off" style="text-align: center;">
        </div>
        
        <!-- Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <!-- Ø¹Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù„Ù€ AJOUTER -->
<div class="quick-input-row small-row" style="margin-bottom: 10px;">
    <input type="tel" id="quickAjouterQte1Input" class="quick-ajouter-small-input qte" placeholder="QTE 1" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="quickAjouterDlc1Input" class="quick-ajouter-small-input date" placeholder="DLC 1 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickAjouter(1)">
</div>

<div class="quick-input-row small-row" style="margin-bottom: 10px;">
    <input type="tel" id="quickAjouterQte2Input" class="quick-ajouter-small-input qte" placeholder="QTE 2" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="quickAjouterDlc2Input" class="quick-ajouter-small-input date" placeholder="DLC 2 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickAjouter(2)">
</div>

<div class="quick-input-row small-row" style="margin-bottom: 15px;">
    <input type="tel" id="quickAjouterQte3Input" class="quick-ajouter-small-input qte" placeholder="QTE 3" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="quickAjouterDlc3Input" class="quick-ajouter-small-input date" placeholder="DLC 3 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickAjouter(3)">
</div>
        
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn ajouter" onclick="quickAjouterProduit()">AJOUTER</button>
            <button class="quick-modal-btn cancel" onclick="closeQuickAjouterModal()">ANNULER</button>
        </div>
    </div>
</div>

</div> <!-- Ø¥ØºÙ„Ø§Ù‚ div Ù„Ù„Ù€ quickAjouterModal -->
<!-- ============== Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ù€ AJOUTER ============== -->
<div id="addressOptionsModalAjouter" class="modal">
    <div class="modal-content">
        <h2>SÃ‰LECTIONNER UNE ADRESSE</h2>
        <p id="addressSelectMessageAjouter">CHOISISSEZ UNE ADRESSE POUR CE PRODUIT:</p>
        <div id="addressOptionsContainerAjouter" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeAddressOptionsModalAjouter()">ANNULER</button>
        </div>
    </div>
</div>
<!-- Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ù€ AJOUTER Ù…Ø¨Ø§Ø´Ø±Ø© -->
<!-- ============== Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù€ AJOUTER ============== -->
<div id="dateOptionsModalAjouter" class="modal">
    <div class="modal-content">
        <h2>SÃ‰LECTIONNER UNE DATE</h2>
        <p id="dateSelectMessageAjouter">CHOISISSEZ UNE DATE POUR CE PRODUIT:</p>
        <div id="dateOptionsContainerAjouter" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateOptionsModalAjouter()">ANNULER</button>
        </div>
    </div>
</div>
<!-- ============== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ============== -->
<!-- ============== Ø£Ø¶Ù Ù‡Ù†Ø§ ============== -->
<!-- Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù†Ø§ÙØ°Ø© RETIRER Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
<div id="dateOptionsModalQuickRetirer" class="modal">
    <div class="modal-content">
        <h2>SÃ‰LECTIONNER UNE DATE</h2>
        <p id="dateSelectMessageQuickRetirer">CHOISISSEZ UNE DATE:</p>
        <div id="dateOptionsContainerQuickRetirer" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateOptionsModalQuickRetirer()">ANNULER</button>
        </div>
    </div>
</div>
<!-- ============== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ============== -->
<!-- ============== Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© AJOUTER ============== -->
<div id="dateOptionsModalQuickAjouter" class="modal">
    <div class="modal-content">
        <h2>SÃ‰LECTIONNER UNE DATE</h2>
        <p id="dateSelectMessageQuickAjouter">CHOISISSEZ UNE DATE:</p>
        <div id="dateOptionsContainerQuickAjouter" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateOptionsModalQuickAjouter()">ANNULER</button>
        </div>
    </div>
</div>
<!-- ============== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ============== -->
<button class="topBtn" onclick="scrollToTop()">â†‘</button>
<button class="bottomBtn" onclick="scrollToBottom()">â†“</button>

<div id="mainPage">
    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <h1 class="main-title">GESTION RESERVE</h1>
    
    <div class="container">
        <button class="btn info" onclick="document.getElementById('mainPage').style.display='none'; document.getElementById('infoPage').style.display='block'">INFO PRODUIT</button>
        <button class="btn changement" onclick="openChangementPrix()">CHANGEMENT DE PRIX</button>
        <button class="btn adresse" onclick="openAdresse()">CONTENUE D'ADRESSE</button>
        <button class="btn rupture" onclick="openRupture()">REPTURE RAYON</button>
        <button class="btn dlc" onclick="openDLC()">DLC RESERVE</button>
        <button class="btn commande" onclick="openCommande()">COMMANDE</button>
        <button class="btn ajouter" onclick="openAjouter()">AJOUTER</button>
        <button class="btn retirer" onclick="openRetirer()">RETIRER</button>
        <button class="btn casse" onclick="openCasse()">CASSE FRAIS</button>
        <button class="btn panier" onclick="openPanier()">PANIER</button>
    </div>
    
    <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="footer-info">
        <div class="footer-line">MARJANE BERKANE</div>
        <div class="footer-line">DÃ‰PARTEMENT PGC</div>
        <div class="footer-spacing"></div>
        <div class="footer-developer">DÃ‰VELOPPÃ‰ PAR ALA EDDINE ABDELLAOUI</div>
    </div>
</div>

<div id="infoPage">
    <button class="backBtn" onclick="goBack()">RETOUR</button>
    <h1 style="color: #3498db;">INFO PRODUIT</h1>

    <div class="search-card">
        <div class="input-row">
            <input type="tel" id="codeInput" placeholder="ENTRER CODE ARTICLE" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan scan-small" onclick="startScanner('codeInput')">SCANNER</button>
        </div>
    </div>

    <div id="infoDataContainer"></div>
    <div id="adresseContainer"></div>
</div>

<div id="changementPrixPage">
    <button class="backBtn" onclick="goBackFromChangementPrix()">RETOUR</button>
    <h1 style="color: #FFA500;">CHANGEMENT DE PRIX</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="prixEpicerieBtn" onclick="setPrixDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="prixBiscuiterieBtn" onclick="setPrixDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
        
        <div class="input-row">
            <input type="tel" id="changementCodeInput" placeholder="GENCODE" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan scan-small" onclick="startScanner('changementCodeInput')">SCANNER</button>
        </div>
        <button class="searchBtn" onclick="rechercherChangementPrix()">RECHERCHER</button>
    </div>

    <div id="changementInfoContainer"></div>
    <div id="changementResultsContainer"></div>
</div>

<div id="adressePage">
    <button class="backBtn" onclick="goBackFromAdresse()">RETOUR</button>
    <h1 style="color: #9b59b6;">CONTENUE D'ADRESSE</h1>

    <div class="search-card">
        <div class="search-type">
            <button class="search-type-btn active" id="searchByAdresseBtn" onclick="setSearchType('adresse')">ADRESSE</button>
            <button class="search-type-btn" id="searchByCodeBtn" onclick="setSearchType('code')">CODE</button>
        </div>
        
        <div class="input-row">
            <input type="tel" id="adresseInput" placeholder="EX: 6/1 (POUR Z6P1)" pattern="[0-9/]*" inputmode="decimal" autocomplete="off" lang="fr" inputmode="numeric">
        </div>
        <button class="searchBtn" onclick="startScannerForAdresse()">SCANNER</button>
        <div id="productNameDisplayAdresse" class="product-name-display" style="display: none;"></div>
    </div>

    <div id="resultatsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerAdresse()">PARTAGER</button>
    </div>
</div>

<div id="rupturePage">
    <button class="backBtn" onclick="goBackFromRupture()">RETOUR</button>
    <h1 style="color: #e74c3c;">REPTURE RAYON</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="epicerieBtn" onclick="setDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="biscuiterieBtn" onclick="setDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
    </div>

    <div id="ruptureContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerRupture()">PARTAGER</button>
    </div>
</div>

<div id="dlcPage">
    <button class="backBtn" onclick="goBackFromDLC()">RETOUR</button>
    <h1 style="color: #f39c12;">DLC RESERVE</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="dlcEpicerieBtn" onclick="setDLCDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="dlcBiscuiterieBtn" onclick="setDLCDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
        
        <div class="month-select">
            <select id="monthSelect" class="month-btn" onchange="displayDLCByMonth()">
                <option value="">SÃ‰LECTIONNER UN MOIS</option>
            </select>
        </div>
    </div>

    <div id="dlcContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerDLC()">PARTAGER</button>
    </div>
</div>

<div id="commandePage">
    <button class="backBtn" onclick="goBackFromCommande()">RETOUR</button>
    <h1 style="color: #1abc9c;">COMMANDE</h1>

    <div class="commande-card">
        <div class="commande-input-row">
            <input type="tel" id="commandeCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('commandeCodeInput')">SCANNER</button>
        </div>
        
        <div id="commandeProductInfo"></div>
        
        <div class="commande-input-row">
            <input type="tel" id="commandeQteInput" placeholder="QUANTITÃ‰" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        
        <button class="commande-btn" onclick="ajouterProduit()" style="background: #27ae60;">COMMANDER</button>
        
        <div class="commande-summary">
            NOMBRE DES PRODUITS: <span id="produitCount">0</span>
        </div>
        
        <button class="commande-btn secondary" onclick="clearAllProduits()">EFFACER TOUT</button>
    </div>

    <div id="commandeProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerCommande()">PARTAGER</button>
    </div>
</div>

<div id="ajouterPage">
    <button class="backBtn" onclick="goBackFromAjouter()">RETOUR</button>
    <h1 style="color: #27ae60;">AJOUTER</h1>

    <div class="ajouter-card">
        <div class="ajouter-input-row">
            <input type="tel" id="ajouterCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('ajouterCodeInput')">SCANNER</button>
        </div>
    </div>

    <div id="ajouterSearchResultsContainer"></div>

    <div class="ajouter-card">
        <div id="ajouterProductInfo"></div>
        
        <div class="ajouter-input-row">
    <input type="tel" id="ajouterAdresseInput" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off" onfocus="showAddressOptionsForAjouter()">
</div>
        
        <!-- Ø¹Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø«Ù„Ø§Ø«Ø© ÙÙŠ ØµÙØ­Ø© AJOUTER -->
<div class="ajouter-input-row small-row">
    <input type="tel" id="ajouterQte1Input" class="ajouter-small-input qte" placeholder="QTE 1" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="ajouterDlc1Input" class="ajouter-small-input date" placeholder="DLC 1 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForAjouter(1)">
</div>

<div class="ajouter-input-row small-row">
    <input type="tel" id="ajouterQte2Input" class="ajouter-small-input qte" placeholder="QTE 2" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="ajouterDlc2Input" class="ajouter-small-input date" placeholder="DLC 2 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForAjouter(2)">
</div>

<div class="ajouter-input-row small-row">
    <input type="tel" id="ajouterQte3Input" class="ajouter-small-input qte" placeholder="QTE 3" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="ajouterDlc3Input" class="ajouter-small-input date" placeholder="DLC 3 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForAjouter(3)">
</div>
        
        <button class="ajouter-btn" onclick="ajouterProduitAjouter()">AJOUTER</button>
        
        <div class="ajouter-summary">
            NOMBRE DES PRODUITS: <span id="ajouterProduitCount">0</span>
        </div>
        
        <button class="ajouter-btn secondary" onclick="clearAllAjouter()">EFFACER TOUT</button>
    </div>

    <div id="ajouterProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerAjouter()">PARTAGER</button>
    </div>
</div>

<div id="cassePage">
    <button class="backBtn" onclick="goBackFromCasse()">RETOUR</button>
    <h1 style="color: #d35400;">CASSE FRAIS</h1>

    <div class="casse-card">
        <div class="casse-input-row">
            <input type="tel" id="casseCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('casseCodeInput')">SCANNER</button>
        </div>
        
        <div id="casseProductInfo"></div>
        
        <div class="casse-input-row">
            <input type="tel" id="casseQteInput" placeholder="QUANTITÃ‰" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
            <input type="tel" id="casseDateInput" class="casse-date-input" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
            
        </div>
        
        <button class="casse-btn" onclick="ajouterProduitCasse()" style="background: #27ae60;">CASSER</button>
        
        <div class="casse-summary">
            NOMBRE DES PRODUITS: <span id="casseProduitCount">0</span>
        </div>
        
        <button class="casse-btn secondary" onclick="clearAllProduitsCasse()">EFFACER TOUT</button>
    </div>

    <div id="casseProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerCasse()">PARTAGER</button>
    </div>
</div>

<div id="retirerPage">
    <button class="backBtn" onclick="goBackFromRetirer()">RETOUR</button>
    <h1 style="color: #34495e;">RETIRER</h1>

    <div class="retirer-card">
        <div class="retirer-input-row">
            <input type="tel" id="retirerCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('retirerCodeInput')">SCANNER</button>
        </div>
    </div>

    <div id="retirerSearchResultsContainer"></div>

    <div class="retirer-card">
        <div id="retirerProductInfo"></div>
        
       <div class="retirer-input-row">
    <input type="tel" id="retirerAdresseInput" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off" onfocus="showAddressOptions()">
</div>

        
        <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - Ù†Ø¶ÙŠÙÙ‡Ø§ Ù‡Ù†Ø§ -->
<div class="retirer-input-row small-row">
    <input type="tel" id="retirerQte1Input" class="retirer-small-input qte" placeholder="QTE 1">
    <input type="tel" id="retirerDlc1Input" class="retirer-small-input date" placeholder="DLC 1 (JJ/MM/AAAA)" onfocus="showDateOptionsForRetirer(1)">
</div>

<div class="retirer-input-row small-row">
    <input type="tel" id="retirerQte2Input" class="retirer-small-input qte" placeholder="QTE 2">
    <input type="tel" id="retirerDlc2Input" class="retirer-small-input date" placeholder="DLC 2 (JJ/MM/AAAA)" onfocus="showDateOptionsForRetirer(2)">
</div>

<div class="retirer-input-row small-row">
    <input type="tel" id="retirerQte3Input" class="retirer-small-input qte" placeholder="QTE 3">
    <input type="tel" id="retirerDlc3Input" class="retirer-small-input date" placeholder="DLC 3 (JJ/MM/AAAA)" onfocus="showDateOptionsForRetirer(3)">
</div>
        
        <button class="retirer-btn" onclick="ajouterProduitRetirer()" style="background: #27ae60;">RETIRER</button>
        
        <div class="retirer-summary">
            NOMBRE DES PRODUITS: <span id="retirerProduitCount">0</span>
        </div>
        
        <button class="retirer-btn secondary" onclick="clearAllProduitsRetirer()">EFFACER TOUT</button>
    </div>

    <div id="retirerProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerRetirer()">PARTAGER</button>
    </div>
</div>

<div id="panierPage">
    <button class="backBtn" onclick="goBackFromPanier()">RETOUR</button>
    <h1 style="color: #2ecc71;">PANIER</h1>

    <div class="panier-card">
        <div class="panier-input-row">
            <input type="tel" id="panierCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('panierCodeInput')">SCANNER</button>
        </div>
        
        <div id="panierProductInfo"></div>
        
        <div class="panier-input-row">
            <input type="tel" id="panierQteInput" placeholder="QUANTITÃ‰" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        
        <button class="panier-btn" onclick="ajouterProduitPanier()">AJOUTER AU PANIER</button>
        
        <div class="panier-summary">
            NOMBRE DES PRODUITS: <span id="panierProduitCount">0</span>
        </div>
        
        <button class="panier-btn secondary" onclick="clearAllPanier()">EFFACER TOUT</button>
    </div>

    <div id="panierContainer">
        <div id="panierTotalCard" style="display: none;"></div>
        <div id="panierProduitsContainer"></div>
    </div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerPanier()">PARTAGER</button>
    </div>
</div>

<script>
// Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const DATA_SOURCES = {
    produits: {
        url: "https://docs.google.com/spreadsheets/d/11YoNOkm_CWh4OouBTiE6aniRQxRmJOg0vOEW_SXxzqQ/export?format=tsv",
        storageKey: "produits_data",
        lastUpdateKey: "produits_last_update",
        cache: []
    },
    adresses: {
        url: "https://docs.google.com/spreadsheets/d/1gL4eDcnsECNmlhZ_F6jJlrDM3YW0UHdaClqPjxVQxQY/export?format=tsv",
        storageKey: "adresses_data",
        lastUpdateKey: "adresses_last_update",
        cache: []
    },
    ventes: {
        url: "https://docs.google.com/spreadsheets/d/18281vphP4T25wl_W82TheVyQtyERFtwWg8sHrnNCzKU/export?format=tsv",
        storageKey: "ventes_data",
        lastUpdateKey: "ventes_last_update",
        cache: []
    },
    prixEpicerie: {
        url: "https://docs.google.com/spreadsheets/d/1c8emdsPMVpK78W_504ucw-hcTjXajIfz8CXdtBcTTVg/export?format=csv",
        storageKey: "prix_epicerie_data",
        lastUpdateKey: "prix_epicerie_last_update",
        cache: []
    },
    prixBiscuiterie: {
        url: "https://docs.google.com/spreadsheets/d/1Cj9Y_ZYiQCfxxh4RhVLr6JWgBM4eX1YqE0GbF4NPTX8/export?format=csv",
        storageKey: "prix_biscuiterie_data",
        lastUpdateKey: "prix_biscuiterie_last_update",
        cache: []
    }
};

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let produitsCache = [];
let csvCache = [];
let csvNewCache = [];
let searchType = 'adresse';
let totalGlobalReserve = 0;
let showTotalReserve = false;
let currentDepartement = 'epicerie';
let currentDLCDepartement = 'epicerie';
let allMonths = [];

// Ù…ØªØºÙŠØ±Ø§Øª ØµÙØ­Ø© COMMANDE
let commandeProduits = [];
let pendingAction = null;
let editingProduitIndex = -1;

// Ù…ØªØºÙŠØ±Ø§Øª ØµÙØ­Ø© AJOUTER
let ajouterProduits = [];
let editingAjouterProduitIndex = -1;

// Ù…ØªØºÙŠØ±Ø§Øª ØµÙØ­Ø© CASSE FRAIS
let casseProduits = [];
let editingCasseProduitIndex = -1;

// Ù…ØªØºÙŠØ±Ø§Øª ØµÙØ­Ø© RETIRER
let retirerProduits = [];
let editingRetirerProduitIndex = -1;

// Ù…ØªØºÙŠØ±Ø§Øª ØµÙØ­Ø© CHANGEMENT DE PRIX
let currentPrixDepartement = 'epicerie';
let prixDataCache = {
    epicerie: [],
    biscuiterie: []
};
let changementInfo = {};

// Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
let currentQuickProduct = null;

// Ù…ØªØºÙŠØ±Ø§Øª ØµÙØ­Ø© PANIER
let panierProduits = [];
let editingPanierProduitIndex = -1;

// Ù…ØªØºÙŠØ± Ù„Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
let html5QrCode = null;

// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø¹Ù†ÙˆØ§Ù†
let selectedAddresses = new Set();

// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
let currentDateField = null;
let currentProductCodeForDate = null;

// ÙˆØ¸Ø§Ø¦Ù ÙØªØ­ Ø§Ù„ØµÙØ­Ø§Øª
function openInfo(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("infoPage").style.display = "block";
    document.getElementById("codeInput").focus();
}

function openChangementPrix(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("changementPrixPage").style.display = "block";
    
    loadPrixData();
    displayAllPrixData();
}

function openAdresse(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("adressePage").style.display = "block";
    
    document.getElementById("adresseInput").focus();
    setSearchType('adresse');
    // ØªÙØ±ÙŠØº Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    selectedAddresses.clear();
}

function openRupture(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("rupturePage").style.display = "block";
    
    displayRuptureProductsByDepartement();
}

function openDLC(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("dlcPage").style.display = "block";
    
    extractAvailableMonths();
}

function openCommande(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("commandePage").style.display = "block";
    
    updateCommandeDisplay();
}

function openAjouter(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("ajouterPage").style.display = "block";
    
    updateAjouterDisplay();
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
}

function openCasse(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("cassePage").style.display = "block";
    
    updateCasseDisplay();
}

function openRetirer(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("retirerPage").style.display = "block";
    
    updateRetirerDisplay();
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
}

function openPanier(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("panierPage").style.display = "block";
    
    updatePanierDisplay();
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¬ÙˆØ¹
function goBack(){ 
    document.getElementById("infoPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block"; 
    resetFields();
}

function goBackFromAdresse(){ 
    document.getElementById("adressePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("adresseInput").value = "";
    document.getElementById("resultatsContainer").innerHTML = "";
    document.getElementById("productNameDisplayAdresse").style.display = "none";
    // ØªÙØ±ÙŠØº Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
    selectedAddresses.clear();
}

function goBackFromRupture(){ 
    document.getElementById("rupturePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("ruptureContainer").innerHTML = "";
}

function goBackFromDLC(){ 
    document.getElementById("dlcPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("dlcContainer").innerHTML = "";
}

function goBackFromCommande(){ 
    document.getElementById("commandePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById('commandeCodeInput').value = '';
    document.getElementById('commandeQteInput').value = '';
    document.getElementById('commandeProductInfo').innerHTML = '';
}

function goBackFromAjouter(){ 
    document.getElementById("ajouterPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById('ajouterCodeInput').value = '';
    document.getElementById('ajouterAdresseInput').value = '';
    document.getElementById('ajouterQte1Input').value = '';
    document.getElementById('ajouterDlc1Input').value = '';
    document.getElementById('ajouterQte2Input').value = '';
    document.getElementById('ajouterDlc2Input').value = '';
    document.getElementById('ajouterQte3Input').value = '';
    document.getElementById('ajouterDlc3Input').value = '';
    document.getElementById('ajouterProductInfo').innerHTML = '';
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
}

function goBackFromCasse(){ 
    document.getElementById("cassePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById('casseCodeInput').value = '';
    document.getElementById('casseQteInput').value = '';
    document.getElementById('casseDateInput').value = '';
    document.getElementById('casseProductInfo').innerHTML = '';
}

function goBackFromRetirer(){ 
    document.getElementById("retirerPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    
    // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙ‚Ø· (Ù„Ø§ ØªÙ…Ø³Ø­ Ø§Ù„ÙƒØ±ÙˆØª)
    document.getElementById('retirerCodeInput').value = '';
    document.getElementById('retirerAdresseInput').value = '';
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
    document.getElementById('retirerQte1Input').value = '';
    document.getElementById('retirerDlc1Input').value = '';
    document.getElementById('retirerQte2Input').value = '';
    document.getElementById('retirerDlc2Input').value = '';
    document.getElementById('retirerQte3Input').value = '';
    document.getElementById('retirerDlc3Input').value = '';
    
    // Ù…Ø³Ø­ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙÙ‚Ø· (Ù„Ø§ ØªÙ…Ø³Ø­ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    // Ù„Ø§ ØªÙ…Ø³Ø­ retirerProduitsContainer Ù„Ø£Ù†Ù‡Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    
    // Ù„Ø§ ØªÙ…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ØªØªØ±Ùƒ Ø§Ù„ÙƒØ±ÙˆØª ÙƒÙ…Ø§ Ù‡ÙŠ)
    // retirerProduits = []; // ØªÙ… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    // saveRetirerProduits(); // ØªÙ… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    // updateRetirerDisplay(); // ØªÙ… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    
    // Ù„Ø§ ØªØ¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯ (ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ)
    // document.getElementById('retirerProduitCount').textContent = '0'; // ØªÙ… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
}

function goBackFromChangementPrix(){ 
    document.getElementById("changementPrixPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("changementCodeInput").value = "";
    document.getElementById("changementInfoContainer").innerHTML = "";
    document.getElementById("changementResultsContainer").innerHTML = "";
}

function goBackFromPanier(){ 
    document.getElementById("panierPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById('panierCodeInput').value = '';
    document.getElementById('panierQteInput').value = '';
    document.getElementById('panierProductInfo').innerHTML = '';
}

function resetFields(){
    document.getElementById("codeInput").value = "";
    document.getElementById("infoDataContainer").innerHTML = "";
    document.getElementById("adresseContainer").innerHTML = "";
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
// ============================================

// 1. Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
async function startScanner(targetInputId) {
    const scannerOverlay = document.getElementById("scannerOverlay");
    const scannerLoading = document.getElementById("scannerLoading");

    scannerOverlay.style.display = "flex";
    scannerLoading.style.display = "block";

    try {
        if (html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
        }

        html5QrCode = new Html5Qrcode("scannerFrame");
        const config = { fps: 15, qrbox: { width: 300, height: 200 } };

        await html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText) => onScanSuccess(decodedText, targetInputId),
            onScanFailure
        );
        scannerLoading.style.display = "none";
    } catch (err) {
        scannerOverlay.style.display = "none";
        showAlert("ERREUR CAMÃ‰RA", "Impossible de dÃ©marrer le scanner...", 'warning');
    }
}

// 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø§Ø¬Ø­
function onScanSuccess(decodedText, targetInputId) {
    let scannedCode = decodedText.trim();
    if (scannedCode.length > 13) scannedCode = scannedCode.substring(0, 13);

    const targetInput = document.getElementById(targetInputId);
    if (targetInput) {
        targetInput.value = scannedCode;
        
        // ØªØ´ØºÙŠÙ„ Ø­Ø¯Ø« input ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        const event = new Event('input', { bubbles: true });
        targetInput.dispatchEvent(event);
        
        // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø­Ù‚Ù„
        const originalColor = targetInput.style.backgroundColor;
        targetInput.style.backgroundColor = "#c6f6d5";
        targetInput.style.borderColor = "#9ae6b4";
        setTimeout(() => {
            targetInput.style.backgroundColor = originalColor;
            targetInput.style.borderColor = "";
        }, 1000);
    }
    
    showAlert("Code scannÃ© avec succÃ¨s!", 'success');
    stopScanner();
}

// 3. Ù…Ø¹Ø§Ù„Ø¬Ø© ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­
function onScanFailure(error) {
    console.warn(`Ã‰chec du scan: ${error}`);
}

// 4. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
function stopScanner() {
    const scannerOverlay = document.getElementById("scannerOverlay");
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            scannerOverlay.style.display = 'none';
        });
    } else {
        scannerOverlay.style.display = 'none';
    }
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ù„ØµÙØ­Ø© CONTINUE D'ADRESSE
function startScannerForAdresse() {
    startScanner('adresseInput');
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function initApp() {
    console.log('ğŸš€ DÃ‰MARRAGE APPLICATION GESTION RÃ‰SERVE');
    
    // ========== Ø§Ù„Ø¬Ø²Ø¡ 1: Ù„Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ==========
    // 1. Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Webtonotive Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (typeof hideSplashScreen === 'function') {
        hideSplashScreen();
    }
    
    // 2. Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙˆØ±Ø§Ù‹
    document.getElementById('mainPage').style.display = 'block';
    
    // 3. ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ù„Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„)
    loadAllDataFromStorage();
    
    // 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    if (typeof setupConnectionMonitor === 'function') {
        setupConnectionMonitor();
    }
    
    // 5. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†ØªØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (navigator.onLine) {
        console.log('ğŸŒ Connexion dÃ©tectÃ©e - Mise Ã  jour des donnÃ©es...');
        updateAllData().then(success => {
            if (success) {
                console.log('âœ… DonnÃ©es mises Ã  jour avec succÃ¨s');
            }
        }).catch(error => {
            console.warn('âš ï¸ Mise Ã  jour Ã©chouÃ©e:', error.message);
        });
    } else {
        console.log('ğŸ“¶ Mode hors ligne - Utilisation des donnÃ©es locales');
        showAlert('ğŸ“¶ MODE HORS LIGNE - DONNÃ‰ES LOCALES', 'info');
    }
    
    // ========== Ø§Ù„Ø¬Ø²Ø¡ 2: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ==========
    // 6. Ø¬Ù…ÙŠØ¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù…Ù† initApp Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
    window.addEventListener('scroll', toggleScrollButtons);
    loadCommandeProduits();
    loadAjouterProduits();
    loadCasseProduits();
    loadRetirerProduits();
    loadPanierProduits();
    setupDateInput();
    setupQuantityInputs();
    setupDatePickerButtons();
    
    // 7. ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const prixEpicerieData = localStorage.getItem(DATA_SOURCES.prixEpicerie.storageKey);
    if (prixEpicerieData) {
        prixDataCache.epicerie = JSON.parse(prixEpicerieData);
        DATA_SOURCES.prixEpicerie.cache = prixDataCache.epicerie;
    }
    
    const prixBiscuiterieData = localStorage.getItem(DATA_SOURCES.prixBiscuiterie.storageKey);
    if (prixBiscuiterieData) {
        prixDataCache.biscuiterie = JSON.parse(prixBiscuiterieData);
        DATA_SOURCES.prixBiscuiterie.cache = prixDataCache.biscuiterie;
    }
    
    console.log('âœ… APPLICATION PRÃŠTE Ã€ L\'EMPLOI');
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
function checkAndFixPrixData() {
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙØ§Ø±ØºØ©ØŒ Ø£Ù†Ø´Ø¦ Ù‡ÙŠÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ
    if (!prixDataCache.epicerie || prixDataCache.epicerie.length === 0) {
        prixDataCache.epicerie = [["Gencode", "Libelle", "Prix"]];
        console.log('ğŸ“ Structure Epicerie crÃ©Ã©e');
    }
    
    if (!prixDataCache.biscuiterie || prixDataCache.biscuiterie.length === 0) {
        prixDataCache.biscuiterie = [["Gencode", "Libelle", "Prix"]];
        console.log('ğŸ“ Structure Biscuiterie crÃ©Ã©e');
    }
}

// ======== Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ========
function setupConnectionMonitor() {
    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ØµØºÙŠØ± Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    const statusElement = document.createElement('div');
    statusElement.id = 'connectionStatus';
    statusElement.style.cssText = `
        position: fixed;
        top: 70px; /* Ø£Ø³ÙÙ„ Ø²Ø± Ø§Ù„ØµØ¹ÙˆØ¯ */
        right: 20px;
        padding: 8px 15px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        z-index: 9999;
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: all 0.3s;
        display: none;
        text-transform: uppercase;
    `;
    document.body.appendChild(statusElement);
    
    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    function updateConnectionUI() {
        const isOnline = navigator.onLine;
        
        if (isOnline) {
            statusElement.textContent = 'ğŸŒ EN LIGNE';
            statusElement.style.background = '#27ae60';
            statusElement.style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                if (navigator.onLine) { // ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…ØªØµÙ„Ø§Ù‹
                    statusElement.style.display = 'none';
                }
            }, 3000);
        } else {
            statusElement.textContent = 'ğŸ“¶ HORS LIGNE';
            statusElement.style.background = '#e74c3c';
            statusElement.style.display = 'block';
        }
    }
    
    // 3. Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('online', () => {
        console.log('ğŸŒ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
        updateConnectionUI();
        
        // Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
        showAlert('ğŸŒ CONNEXION RÃ‰TABLIE - MISE Ã€ JOUR DES DONNÃ‰ES', 'success');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
        setTimeout(() => {
            if (navigator.onLine) {
                console.log('ğŸ”„ Mise Ã  jour automatique des donnÃ©es...');
                updateAllData().then(() => {
                    showAlert('âœ… DONNÃ‰ES MISE Ã€ JOUR AVEC SUCCÃˆS', 'success');
                }).catch(err => {
                    console.warn('âš ï¸ Ã‰chec de la mise Ã  jour:', err);
                });
            }
        }, 1500);
    });
    
    // 4. Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('offline', () => {
        console.log('ğŸ“¶ Perte de connexion Internet');
        updateConnectionUI();
        
        // Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© (Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚Ùƒ)
        showAlert('ğŸ“¶ HORS LIGNE - LES MODIFICATIONS SERONT SAUVEGARDÃ‰ES LOCALEMENT', 'warning');
        
        // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© "Ù…ØªØµÙ„" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¸Ø§Ù‡Ø±Ø©
        const onlineAlerts = document.querySelectorAll('.alert-message');
        onlineAlerts.forEach(alert => {
            if (alert.textContent.includes('EN LIGNE')) {
                alert.style.display = 'none';
            }
        });
    });
    
    // 5. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    updateConnectionUI();
}

// ======== ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© showAlert Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± ========
// ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† showAlert ØªØ¯Ø¹Ù… Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± Ù„Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
// Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø£Ø¶ÙÙ‡ ÙÙŠ Ø¯Ø§Ù„Ø© showAlert Ø§Ù„Ø£ØµÙ„ÙŠØ©

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ…Ø±ÙŠØ±
function toggleScrollButtons() {
    const topBtn = document.querySelector('.topBtn');
    const bottomBtn = document.querySelector('.bottomBtn');
    
    if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        topBtn.style.display = 'flex';
    } else {
        topBtn.style.display = 'none';
    }
    
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const scrollPosition = window.scrollY || window.pageYOffset || document.body.scrollTop + (document.documentElement && document.documentElement.scrollTop || 0);
    
    if (documentHeight - (windowHeight + scrollPosition) > 100) {
        bottomBtn.style.display = 'flex';
    } else {
        bottomBtn.style.display = 'none';
    }
}

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

function scrollToBottom() {
    window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'smooth'
    });
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
function setupDateInput() {
    const dateInputs = [
        document.getElementById('casseDateInput'),
        document.getElementById('retirerDateInput'),
        document.getElementById('ajouterDlc1Input'),
        document.getElementById('ajouterDlc2Input'),
        document.getElementById('ajouterDlc3Input'),
        document.getElementById('quickRetirerDlc1Input'),
        document.getElementById('quickRetirerDlc2Input'),
        document.getElementById('quickRetirerDlc3Input'),
        document.getElementById('quickAjouterDlc1Input'),
        document.getElementById('quickAjouterDlc2Input'),
        document.getElementById('quickAjouterDlc3Input'),
        // Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
        document.getElementById('retirerDlc1Input'),
        document.getElementById('retirerDlc2Input'),
        document.getElementById('retirerDlc3Input')
    ];
    
    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
        }
    });
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
function setupDatePickerButtons() {
    // ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ ÙÙŠ HTML
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ¹Ø¨ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©
function setupQuantityInputs() {
    const quantityInputs = [
        'commandeQteInput', 'ajouterQte1Input', 'ajouterQte2Input', 'ajouterQte3Input',
        'casseQteInput', 'retirerQteInput', 'panierQteInput', 'quickCommanderQteInput',
        'quickRetirerQte1Input', 'quickRetirerQte2Input', 'quickRetirerQte3Input',
        'quickAjouterQte1Input', 'quickAjouterQte2Input', 'quickAjouterQte3Input'
    ];
    
    quantityInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                delayedEvaluateExpression(this);
            });
        }
    });
}

// ÙˆØ¸ÙŠÙØ© Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ¹Ø¨ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ù…Ø¹ ØªØ£Ø®ÙŠØ±
function delayedEvaluateExpression(inputElement) {
    const value = inputElement.value.trim();
    
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (inputElement.timeoutId) {
        clearTimeout(inputElement.timeoutId);
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ù…Ù‡Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (800 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
    inputElement.timeoutId = setTimeout(() => {
        evaluateExpression(inputElement);
    }, 800);
}

// ÙˆØ¸ÙŠÙØ© Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ¹Ø¨ÙŠØ±Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©
function evaluateExpression(inputElement) {
    const value = inputElement.value.trim();
    
    if (value.includes('*') || value.includes('+') || value.includes('-') || value.includes('/')) {
        try {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ã— Ø¨Ù€ * Ù„Ù„ØªÙ‚ÙŠÙŠÙ…
            const expression = value.replace(/Ã—/g, '*').replace(/x/gi, '*');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ¹Ø¨ÙŠØ± ÙŠØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙˆØ¹ÙˆØ§Ù…Ù„ Ø±ÙŠØ§Ø¶ÙŠØ©
            if (/^[0-9\s\+\-\*\/\(\)\.]+$/.test(expression)) {
                const result = eval(expression);
                if (!isNaN(result) && isFinite(result)) {
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
                    inputElement.value = Math.round(result);
                    
                    // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø­Ù‚Ù„
                    const originalColor = inputElement.style.backgroundColor;
                    inputElement.style.backgroundColor = "#d6f0ff";
                    inputElement.style.borderColor = "#3498db";
                    setTimeout(() => {
                        inputElement.style.backgroundColor = originalColor;
                        inputElement.style.borderColor = "";
                    }, 1500);
                }
            }
        } catch (e) {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø± ÙÙŠ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø§ ÙŠØ±ÙŠØ¯
        }
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
function isValidDateYYYY(dateString) {
    const pattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    if (!pattern.test(dateString)) return false;
    
    const parts = dateString.split('/');
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);
    
    const date = new Date(year, month - 1, day);
    return date.getFullYear() === year && 
           date.getMonth() === month - 1 && 
           date.getDate() === day;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function loadAllDataFromStorage() {
    const produitsData = localStorage.getItem(DATA_SOURCES.produits.storageKey);
    if (produitsData) {
        produitsCache = JSON.parse(produitsData);
        DATA_SOURCES.produits.cache = produitsCache;
    }
    
    const adressesData = localStorage.getItem(DATA_SOURCES.adresses.storageKey);
    if (adressesData) {
        csvCache = JSON.parse(adressesData);
        DATA_SOURCES.adresses.cache = csvCache;
    }
    
    const ventesData = localStorage.getItem(DATA_SOURCES.ventes.storageKey);
    if (ventesData) {
        csvNewCache = JSON.parse(ventesData);
        DATA_SOURCES.ventes.cache = csvNewCache;
    }
    
    const prixEpicerieData = localStorage.getItem(DATA_SOURCES.prixEpicerie.storageKey);
    if (prixEpicerieData) {
        prixDataCache.epicerie = JSON.parse(prixEpicerieData);
        DATA_SOURCES.prixEpicerie.cache = prixDataCache.epicerie;
    }
    
    const prixBiscuiterieData = localStorage.getItem(DATA_SOURCES.prixBiscuiterie.storageKey);
    if (prixBiscuiterieData) {
        prixDataCache.biscuiterie = JSON.parse(prixBiscuiterieData);
        DATA_SOURCES.prixBiscuiterie.cache = prixDataCache.biscuiterie;
    }
}

function saveDataToStorage(source, data) {
    localStorage.setItem(source.storageKey, JSON.stringify(data));
    localStorage.setItem(source.lastUpdateKey, new Date().toISOString());
}

async function updateDataSource(source) {
   async function updateDataSource(source) {
    // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    if (!navigator.onLine) {
        console.log(`ğŸ“¶ Pas de connexion pour ${source.storageKey}`);
        return false; // Ù„Ø§ ØªØ­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
    }
    
    // ... Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ...
}
    try {
        console.log('MISE Ã€ JOUR DES DONNÃ‰ES:', source.storageKey);
        const response = await fetch(source.url);
        
        if (!response.ok) {
            throw new Error(`ERREUR HTTP: ${response.status}`);
        }
        
        const text = await response.text();
        const data = text.split("\n").map(l => l.split("\t"));
        
        saveDataToStorage(source, data);
        source.cache = data;
        
        console.log(`DONNÃ‰ES MISE Ã€ JOUR: ${source.storageKey}`, data.length, 'LIGNES');
        return true;
    } catch (error) {
        console.error(`ERREUR LORS DE LA MISE Ã€ JOUR DE ${source.storageKey}:`, error);
        return false;
    }
}

async function updatePrixDataSource(departement) {
  async function updatePrixDataSource(departement) {
    // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù‚Ù‚
    if (!navigator.onLine) {
        console.log(`ğŸ“¶ Pas de connexion pour prix ${departement}`);
        return false;
    }
    
    // ... Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ...
}
    const source = departement === 'epicerie' ? DATA_SOURCES.prixEpicerie : DATA_SOURCES.prixBiscuiterie;
    
    try {
        console.log('MISE Ã€ JOUR DES DONNÃ‰ES DE PRIX:', source.storageKey);
        const response = await fetch(source.url);
        
        if (!response.ok) {
            throw new Error(`ERREUR HTTP: ${response.status}`);
        }
        
        const text = await response.text();
        const data = parseCSV(text);
        
        saveDataToStorage(source, data);
        source.cache = data;
        prixDataCache[departement] = data;
        
        console.log(`DONNÃ‰ES DE PRIX MISE Ã€ JOUR: ${source.storageKey}`, data.length, 'LIGNES');
        return true;
    } catch (error) {
        console.error(`ERREUR LORS DE LA MISE Ã€ JOUR DE ${source.storageKey}:`, error);
        createSamplePrixData(departement);
        return false;
    }
}

function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const result = [];
    
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].trim()) {
            const cells = lines[i].split(',').map(cell => {
                return cell.replace(/^"|"$/g, '').trim();
            });
            result.push(cells);
        }
    }
    
    return result;
}

function createSamplePrixData(departement) {
    const sampleData = [
        ["Date debut", "Date fin", "Numero Lot Permanent", "Numero Lot Promo", "Gencode", "Libelle", "Prix de vente a la date de debut", "Prix de vente a la date de fin", "Code tarif", "Qte en stock"],
        ["01/01/2024", "31/01/2024", "LP001", "PR001", "123456", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "10.00", "12.00", "PERMANENT", "67"],
        ["01/01/2024", "31/01/2024", "LP002", "PR002", "789012", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "15.00", "18.00", "PROMO", "42"],
        ["01/02/2024", "29/02/2024", "LP003", "PR003", "345678", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "20.00", "25.00", "PERMANENT", "89"],
        ["01/02/2024", "29/02/2024", "LP004", "PR004", "901234", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "30.00", "35.00", "PROMO", "56"]
    ];
    
    if (departement === 'biscuiterie') {
        sampleData[1][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
        sampleData[2][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
        sampleData[3][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
        sampleData[4][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
    }
    
    prixDataCache[departement] = sampleData;
    
    const storageKey = departement === 'epicerie' ? DATA_SOURCES.prixEpicerie.storageKey : DATA_SOURCES.prixBiscuiterie.storageKey;
    localStorage.setItem(storageKey, JSON.stringify(sampleData));
}
async function updateAllData() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
    if (!navigator.onLine) {
        console.log('ğŸ“¶ Pas de connexion - Annulation de la mise Ã  jour');
        return false;
    }
    
    try {
        console.log('ğŸ”„ Mise Ã  jour des donnÃ©es...');
        const results = await Promise.allSettled([
            updateDataSource(DATA_SOURCES.produits),
            updateDataSource(DATA_SOURCES.adresses),
            updateDataSource(DATA_SOURCES.ventes),
            updatePrixDataSource('epicerie'),
            updatePrixDataSource('biscuiterie')
        ]);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        produitsCache = DATA_SOURCES.produits.cache;
        csvCache = DATA_SOURCES.adresses.cache;
        csvNewCache = DATA_SOURCES.ventes.cache;
        prixDataCache.epicerie = DATA_SOURCES.prixEpicerie.cache;
        prixDataCache.biscuiterie = DATA_SOURCES.prixBiscuiterie.cache;
        
        console.log('âœ… DonnÃ©es mises Ã  jour');
        showAlert('âœ… DONNÃ‰ES MISE Ã€ JOUR', 'success');
        return true;
        
    } catch (error) {
        console.error('âŒ Erreur:', error);
        showAlert('âŒ ERREUR DE MISE Ã€ JOUR', 'warning');
        return false;
    }
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
function validateLoadedData() {
    console.log('ğŸ” Validation des donnÃ©es chargÃ©es...');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const checks = [
        { name: 'PRODUITS', data: produitsCache, minLength: 2 },
        { name: 'ADRESSES', data: csvCache, minLength: 2 },
        { name: 'VENTES', data: csvNewCache, minLength: 2 },
        { name: 'PRIX EPICERIE', data: prixDataCache.epicerie, minLength: 1 },
        { name: 'PRIX BISCUITERIE', data: prixDataCache.biscuiterie, minLength: 1 }
    ];
    
    checks.forEach(check => {
        if (!check.data || check.data.length < check.minLength) {
            console.warn(`âš ï¸ ${check.name}: DonnÃ©es insuffisantes (${check.data ? check.data.length : 0} lignes)`);
        } else {
            console.log(`âœ… ${check.name}: ${check.data.length} lignes`);
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
function refreshUIAfterUpdate() {
    // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    const currentPage = document.querySelector('[id$="Page"][style*="display: block"]');
    
    if (currentPage && currentPage.id === 'infoPage') {
        const currentCode = document.getElementById('codeInput').value;
        if (currentCode) {
            chercherProduit(currentCode);
            remplirCartesAdresse(currentCode);
        }
    }
    
    if (currentPage && currentPage.id === 'adressePage') {
        const searchTerm = document.getElementById('adresseInput').value;
        if (searchTerm) {
            rechercher();
        }
    }
}

// Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert-message ${type}`;
    alert.innerHTML = `
        <span class="alert-icon">${type === 'success' ? 'âœ“' : type === 'warning' ? 'âš ' : 'â„¹'}</span>
        <span>${message}</span>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.style.animation = 'alertSlideIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 300);
    }, 3000);
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù PARTAGER
// ============================================

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø¥ØµÙ„Ø§Ø­ Ù„Ù€ webtonotive
async function shareXLSXDirect(data, filename, title) {
    try {
        if (data.length === 0) {
            showAlert("AUCUN PRODUIT Ã€ PARTAGER!", 'warning');
            return;
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        showAlert("Please wait, downloading file to share", 'info');
        
        // 1. ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Produits");
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        
        // 2. ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø´ÙƒÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
        const downloadUrl = URL.createObjectURL(blob);
        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = filename;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        setTimeout(async () => {
            try {
                // 3. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                console.log('Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: ÙƒÙ…Ø§ ÙÙŠ ØªÙˆØ«ÙŠÙ‚ webtonotive Ø¨Ø§Ù„Ø¶Ø¨Ø·
                try {
                    await navigator.share({
                        type: "file",
                        url: downloadUrl, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                        extension: "xlsx",
                        text: `ğŸ“‹ ${title} - ${data.length} produits`
                    });
                    
                    showAlert("Fichier partagÃ© avec succÃ¨s!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err1) {
                    console.log('Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1 ÙØ´Ù„Øª:', err1);
                }
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: Ù…Ø¹ Ù…Ø³Ø§Ø± Ù…Ù„Ù Ù…Ø­Ù„ÙŠ
                try {
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø³Ø§Ø± Ù…Ù„Ù Ù…Ø­Ù„ÙŠ (Ù‚Ø¯ ÙŠØ¹Ù…Ù„ Ù…Ø¹ webtonotive)
                    const fakeLocalPath = `file:///storage/emulated/0/Download/${filename}`;
                    
                    await navigator.share({
                        type: "file",
                        url: fakeLocalPath,
                        extension: "xlsx",
                        text: `${title} - ${data.length} produits`
                    });
                    
                    showAlert("Fichier partagÃ© avec succÃ¨s!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err2) {
                    console.log('Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2 ÙØ´Ù„Øª:', err2);
                }
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3: ÙƒÙ…Ø´Ø§Ø±ÙƒØ© Ù†ØµÙŠØ© ÙÙ‚Ø·
                try {
                    await navigator.share({
                        type: "url",
                        url: `Le fichier "${filename}" a Ã©tÃ© tÃ©lÃ©chargÃ© dans votre dossier TÃ©lÃ©chargements.`,
                        text: `${title} - ${data.length} produits`
                    });
                    
                    showAlert("Information partagÃ©e!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err3) {
                    console.log('Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3 ÙØ´Ù„Øª:', err3);
                }
                
                // Ø¥Ø°Ø§ ÙØ´Ù„Øª ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                URL.revokeObjectURL(downloadUrl);
                showAlert("Le fichier a Ã©tÃ© tÃ©lÃ©chargÃ©. Utilisez le menu de partage de votre appareil.", 'info');
                
            } catch (finalErr) {
                console.error('Erreur finale:', finalErr);
                showAlert("Le fichier a Ã©tÃ© tÃ©lÃ©chargÃ© avec succÃ¨s.", 'success');
            }
        }, 1500); // Ø§Ù†ØªØ¸Ø§Ø± 1.5 Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªÙ†Ø²ÙŠÙ„
        
    } catch (err) {
        console.error('Erreur de partage:', err);
        showAlert("Erreur lors du tÃ©lÃ©chargement du fichier", 'warning');
    }
}

// ÙˆØ¸Ø§Ø¦Ù PARTAGER Ù„ÙƒÙ„ ØµÙØ­Ø©
function partagerAdresse() {
    const searchTerm = document.getElementById("adresseInput").value.trim();
    let data = [];
    
    if (searchType === 'adresse' && searchTerm) {
        let rechercheFinale = searchTerm;
        if (searchTerm.includes('/')) {
            const parties = searchTerm.split('/');
            if (parties.length === 2) {
                const num1 = parties[0].trim();
                const num2 = parties[1].trim();
                rechercheFinale = `Z${num1}P${num2}`;
            }
        }
        
        for(let i = 1; i < csvCache.length; i++) {
            const adresse = csvCache[i][1] || "";
            if (adresse === rechercheFinale) {
                const codeProduit = csvCache[i][0] || "";
                const nomProduit = getProductNameByCode(codeProduit);
                let totalQte = 0;
                
                for(let j = 2; j < 8; j += 2) {
                    let q = (csvCache[i][j] || "").trim();
                    const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                    totalQte += qNum;
                }
                
                if (totalQte > 0) {
                    data.push({
                        "ADRESSE": adresse,
                        "CODE": codeProduit,
                        "NOM": nomProduit || "PRODUIT INCONNU",
                        "QUANTITÃ‰": totalQte
                    });
                }
            }
        }
    } else if (searchType === 'code' && searchTerm) {
        for(let i = 1; i < csvCache.length; i++) {
            const codeProduit = csvCache[i][0] || "";
            if (codeProduit === searchTerm) {
                const adresse = csvCache[i][1] || "";
                const nomProduit = getProductNameByCode(codeProduit);
                let totalQte = 0;
                
                for(let j = 2; j < 8; j += 2) {
                    let q = (csvCache[i][j] || "").trim();
                    const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                    totalQte += qNum;
                }
                
                if (totalQte > 0) {
                    data.push({
                        "ADRESSE": adresse,
                        "CODE": codeProduit,
                        "NOM": nomProduit || "PRODUIT INCONNU",
                        "QUANTITÃ‰": totalQte
                    });
                }
            }
        }
    }
    
    shareXLSXDirect(data, "Contenu_Adresse.xlsx", "CONTENUE D'ADRESSE");
}

function partagerRupture() {
    let data = [];
    
    for(let i = 1; i < csvCache.length; i++) {
        const code = csvCache[i][0];
        const adresse = csvCache[i][1];
        
        if (code) {
            let adresseValide = false;
            if (currentDepartement === 'epicerie') {
                adresseValide = isEpicerieAdresse(adresse);
            } else {
                adresseValide = isBiscuiterieAdresse(adresse);
            }
            
            if (adresseValide) {
                const qteGold = getQteGoldByCode(code);
                const qteReserve = getQteReserveByCode(code);
                
                const qteGoldNum = parseFloat(qteGold.replace(/[^0-9.-]+/g,"")) || 0;
                const qteReserveNum = parseFloat(qteReserve.replace(/[^0-9.-]+/g,"")) || 0;
                
                if (qteGoldNum === qteReserveNum && qteGoldNum > 0) {
                    const nomProduit = getProductNameByCode(code);
                    let totalQte = 0;
                    
                    for(let j = 2; j < 8; j += 2) {
                        let q = (csvCache[i][j] || "").trim();
                        const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                        totalQte += qNum;
                    }
                    
                    if (totalQte > 0) {
                        data.push({
                            "ADRESSE": adresse,
                            "CODE": code,
                            "NOM": nomProduit || "PRODUIT INCONNU",
                            "QTE Gold": qteGoldNum,
                            "QTE Reserve": qteReserveNum,
                            "QuantitÃ©": totalQte
                        });
                    }
                }
            }
        }
    }
    
    shareXLSXDirect(data, "Rupture_Rayon.xlsx", "REPTURE RAYON");
}

function partagerDLC() {
    const monthSelect = document.getElementById('monthSelect');
    const selectedMonth = monthSelect.value;
    
    if (!selectedMonth) {
        showAlert("SÃ‰LECTIONNEZ D'ABORD UN MOIS", 'warning');
        return;
    }
    
    let data = [];
    
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        const codeProduit = csvCache[i][0] || "";
        
        let adresseValide = false;
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
        }
        
        if (adresseValide && codeProduit) {
            let produitTrouveDansAdresse = false;
            let datesDetails = [];
            
            for(let j = 2; j < 8; j += 2) {
                let q = (csvCache[i][j] || "").trim();
                let d = (csvCache[i][j+1] || "").trim();
                const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                const monthFromDate = getMonthFromDate(d);
                
                if (qNum > 0 && monthFromDate === selectedMonth) {
                    produitTrouveDansAdresse = true;
                    datesDetails.push({
                        qte: qNum,
                        date: d
                    });
                }
            }
            
            if (produitTrouveDansAdresse) {
                const nomProduit = getProductNameByCode(codeProduit);
                let totalQte = datesDetails.reduce((sum, detail) => sum + detail.qte, 0);
                
                data.push({
                    "ADRESSE": adresse,
                    "CODE": codeProduit,
                    "NOM": nomProduit || "PRODUIT INCONNU",
                    "QuantitÃ©": totalQte,
                    "Mois": selectedMonth
                });
            }
        }
    }
    
    shareXLSXDirect(data, "DLC_Reserve.xlsx", "DLC RESERVE");
}

function partagerCommande() {
    const data = commandeProduits.map(p => ({
        "ADRESSE": "",
        "CODE": p.code,
        "NOM": p.nom,
        "QuantitÃ©": p.qte
    }));
    
    shareXLSXDirect(data, "Commande.xlsx", "COMMANDE");
}

function partagerAjouter() {
    const data = ajouterProduits.map(p => ({
        "ADRESSE": p.adresse,
        "CODE": p.code,
        "NOM": p.nom,
        "QTE 1": p.qte1,
        "DLC 1": p.dlc1,
        "QTE 2": p.qte2,
        "DLC 2": p.dlc2,
        "QTE 3": p.qte3,
        "DLC 3": p.dlc3
    }));
    
    shareXLSXDirect(data, "Ajouter.xlsx", "AJOUTER");
}

function partagerCasse() {
    const data = casseProduits.map(p => ({
        "ADRESSE": "",
        "CODE": p.code,
        "NOM": p.nom,
        "QuantitÃ©": p.qte,
        "Date": p.date
    }));
    
    shareXLSXDirect(data, "Casse_Frais.xlsx", "CASSE FRAIS");
}

function partagerRetirer() {
    const data = retirerProduits.map(p => ({
        "ADRESSE": p.adresse,
        "CODE": p.code,
        "NOM": p.nom,
        "QTE 1": p.qte1,
        "DLC 1": p.dlc1,
        "QTE 2": p.qte2,
        "DLC 2": p.dlc2,
        "QTE 3": p.qte3,
        "DLC 3": p.dlc3
    }));
    
    shareXLSXDirect(data, "Retirer.xlsx", "RETIRER");
}

function partagerPanier() {
    const data = panierProduits.map(p => {
        const prixVente = parseFloat(p.prix.replace(',', '.')) || 0;
        const totalProduit = prixVente * p.qte;
        return {
            "ADRESSE": "",
            "CODE": p.code,
            "NOM": p.nom,
            "QuantitÃ©": p.qte,
            "Prix": p.prix,
            "Total": totalProduit.toFixed(2)
        };
    });
    
    shareXLSXDirect(data, "Panier.xlsx", "PANIER");
}

// ØªØ­Ø¯ÙŠØ¯ Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
function setPrixDepartement(dep) {
    currentPrixDepartement = dep;
    
    document.getElementById('prixEpicerieBtn').classList.remove('active');
    document.getElementById('prixBiscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('prixEpicerieBtn').classList.add('active');
    } else {
        document.getElementById('prixBiscuiterieBtn').classList.add('active');
    }
    
    displayAllPrixData();
}

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØºÙŠÙŠØ±
function extractChangementInfo(data) {
    if (data.length < 2) return {};
    
    const firstDataRow = data[1];
    
    return {
        dateDebut: firstDataRow[0] || "",
        dateFin: firstDataRow[1] || "",
        lotPermanent: firstDataRow[2] || "",
        lotPromo: firstDataRow[3] || ""
    };
}

// Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
function displayAllPrixData() {
    const container = document.getElementById('changementResultsContainer');
    const infoContainer = document.getElementById('changementInfoContainer');
    
    container.innerHTML = '';
    infoContainer.innerHTML = '';
    
    const currentData = prixDataCache[currentPrixDepartement];
    
    if (!currentData || currentData.length === 0) {
        const noDataCard = document.createElement('div');
        noDataCard.className = 'resultatChangementCard';
        noDataCard.innerHTML = `<h3>AUCUNE DONNÃ‰E DISPONIBLE POUR ${currentPrixDepartement.toUpperCase()}</h3>`;
        container.appendChild(noDataCard);
        return;
    }
    
    changementInfo = extractChangementInfo(currentData);
    
    if (changementInfo.dateDebut || changementInfo.dateFin || changementInfo.lotPermanent || changementInfo.lotPromo) {
        const infoCard = document.createElement('div');
        infoCard.className = 'infoChangementCard';
        
        const title = document.createElement('h3');
        title.textContent = 'INFORMATIONS DE CHANGEMENT';
        infoCard.appendChild(title);
        
        if (changementInfo.dateDebut) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE DEBUT:</span> <span class="value">${changementInfo.dateDebut}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.dateFin) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE FIN:</span> <span class="value">${changementInfo.dateFin}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPermanent) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PERMANENT:</span> <span class="value lot-permanent">${changementInfo.lotPermanent}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPromo) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PROMO:</span> <span class="value lot-promo">${changementInfo.lotPromo}</span>`;
            infoCard.appendChild(row);
        }
        
        infoContainer.appendChild(infoCard);
    }
    
    let produitsTrouves = 0;
    
    for (let i = 1; i < currentData.length; i++) {
        const row = currentData[i];
        
        if (row.length >= 10) {
            const gencode = row[4] || "";
            const libelle = row[5] || "";
            const prixDebut = row[6] || "";
            const prixFin = row[7] || "";
            const codeTarif = row[8] || "";
            const qteStock = row[9] || "";
            
            if (gencode) {
                produitsTrouves++;
                createPrixResultCard(container, gencode, libelle, prixDebut, prixFin, codeTarif, qteStock);
            }
        }
    }
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement('div');
        totalCard.className = 'totalChangementCard';
        
        const totalTitle = document.createElement('h3');
        totalTitle.textContent = `TOTAL ${currentPrixDepartement.toUpperCase()}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement('div');
        totalRow.className = 'dataRow';
        totalRow.innerHTML = `<span class="label">NOMBRE DE PRODUITS:</span> <span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement('div');
        noResultCard.className = 'resultatChangementCard';
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT TROUVÃ‰</h3>`;
        container.appendChild(noResultCard);
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø±Ø¯ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
function createPrixResultCard(container, gencode, libelle, prixDebut, prixFin, codeTarif, qteStock) {
    const card = document.createElement('div');
    
    if (codeTarif.toUpperCase() === 'PERMANENT') {
        card.className = 'resultatChangementCard permanent';
    } else if (codeTarif.toUpperCase() === 'PROMO') {
        card.className = 'resultatChangementCard promo';
    } else {
        card.className = 'resultatChangementCard';
    }
    
    const title = document.createElement('h3');
    title.textContent = gencode;
    card.appendChild(title);
    
    if (libelle) {
        const libelleRow = document.createElement('div');
        libelleRow.className = 'dataRow';
        libelleRow.innerHTML = `<span class="value">${libelle}</span>`;
        card.appendChild(libelleRow);
    }
    
    if (prixDebut) {
        const prixDebutRow = document.createElement('div');
        prixDebutRow.className = 'dataRow';
        prixDebutRow.innerHTML = `<span class="label">PRIX DEBUT:</span> <span class="value">${prixDebut}</span>`;
        card.appendChild(prixDebutRow);
    }
    
    if (prixFin) {
        const prixFinRow = document.createElement('div');
        prixFinRow.className = 'dataRow';
        prixFinRow.innerHTML = `<span class="label">PRIX FIN:</span> <span class="value">${prixFin}</span>`;
        card.appendChild(prixFinRow);
    }
    
    if (codeTarif) {
        const codeTarifRow = document.createElement('div');
        codeTarifRow.className = 'dataRow';
        
        let colorClass = '';
        if (codeTarif.toUpperCase() === 'PERMANENT') {
            colorClass = 'lot-permanent';
        } else if (codeTarif.toUpperCase() === 'PROMO') {
            colorClass = 'lot-promo';
        }
        
        codeTarifRow.innerHTML = `<span class="label">CODE TARIF:</span> <span class="value ${colorClass}">${codeTarif}</span>`;
        card.appendChild(codeTarifRow);
    }
    
    if (qteStock) {
        const qteStockClean = qteStock.replace('.00', '').replace('.0', '');
        const qteStockRow = document.createElement('div');
        qteStockRow.className = 'dataRow';
        qteStockRow.innerHTML = `<span class="label">QTE EN STOCK:</span> <span class="value">${qteStockClean}</span>`;
        card.appendChild(qteStockRow);
    }
    
    container.appendChild(card);
}

// Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
function rechercherChangementPrix() {
    const searchTerm = document.getElementById('changementCodeInput').value.trim();
    const container = document.getElementById('changementResultsContainer');
    const infoContainer = document.getElementById('changementInfoContainer');
    
    container.innerHTML = '';
    infoContainer.innerHTML = '';
    
    const currentData = prixDataCache[currentPrixDepartement];
    
    if (!currentData || currentData.length === 0) {
        const noDataCard = document.createElement('div');
        noDataCard.className = 'resultatChangementCard';
        noDataCard.innerHTML = `<h3>AUCUNE DONNÃ‰E DISPONIBLE</h3>`;
        container.appendChild(noDataCard);
        return;
    }
    
    changementInfo = extractChangementInfo(currentData);
    
    if (changementInfo.dateDebut || changementInfo.dateFin || changementInfo.lotPermanent || changementInfo.lotPromo) {
        const infoCard = document.createElement('div');
        infoCard.className = 'infoChangementCard';
        
        const title = document.createElement('h3');
        title.textContent = 'INFORMATIONS DE CHANGEMENT';
        infoCard.appendChild(title);
        
        if (changementInfo.dateDebut) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE DEBUT:</span> <span class="value">${changementInfo.dateDebut}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.dateFin) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE FIN:</span> <span class="value">${changementInfo.dateFin}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPermanent) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PERMANENT:</span> <span class="value lot-permanent">${changementInfo.lotPermanent}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPromo) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PROMO:</span> <span class="value lot-promo">${changementInfo.lotPromo}</span>`;
            infoCard.appendChild(row);
        }
        
        infoContainer.appendChild(infoCard);
    }
    
    let produitsTrouves = 0;
    
    for (let i = 1; i < currentData.length; i++) {
        const row = currentData[i];
        
        if (row.length >= 10) {
            const gencode = row[4] || "";
            
            if (!searchTerm || gencode.includes(searchTerm)) {
                const libelle = row[5] || "";
                const prixDebut = row[6] || "";
                const prixFin = row[7] || "";
                const codeTarif = row[8] || "";
                const qteStock = row[9] || "";
                
                if (gencode) {
                    produitsTrouves++;
                    createPrixResultCard(container, gencode, libelle, prixDebut, prixFin, codeTarif, qteStock);
                }
            }
        }
    }
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement('div');
        totalCard.className = 'totalChangementCard';
        
        const totalTitle = document.createElement('h3');
        totalTitle.textContent = `RÃ‰SULTATS DE RECHERCHE - ${currentPrixDepartement.toUpperCase()}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement('div');
        totalRow.className = 'dataRow';
        totalRow.innerHTML = `<span class="label">PRODUITS TROUVÃ‰S:</span> <span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement('div');
        noResultCard.className = 'resultatChangementCard';
        noResultCard.innerHTML = `<h3>AUCUN RÃ‰SULTAT POUR "${searchTerm}"</h3>`;
        container.appendChild(noResultCard);
    }
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
document.getElementById('changementCodeInput').addEventListener('input', function() {
    const searchTerm = this.value.trim();
    
    clearTimeout(window.changementSearchTimeout);
    window.changementSearchTimeout = setTimeout(() => {
        if (searchTerm.length > 0) {
            rechercherChangementPrix();
        } else {
            displayAllPrixData();
        }
    }, 300);
});

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('changementCodeInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        rechercherChangementPrix();
    }
});

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…Ø©
function setSearchType(type) {
    searchType = type;
    showTotalReserve = (type === 'code');
    
    document.getElementById('searchByAdresseBtn').classList.remove('active');
    document.getElementById('searchByCodeBtn').classList.remove('active');
    
    if (type === 'adresse') {
        document.getElementById('searchByAdresseBtn').classList.add('active');
        document.getElementById('adresseInput').placeholder = "EX: 6/1 (POUR Z6P1)";
    } else {
        document.getElementById('searchByCodeBtn').classList.add('active');
        document.getElementById('adresseInput').placeholder = "ENTRER LE CODE PRODUIT";
    }
    
    document.getElementById('adresseInput').value = "";
    document.getElementById("resultatsContainer").innerHTML = "";
    document.getElementById("productNameDisplayAdresse").style.display = "none";
    // ØªÙØ±ÙŠØº Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø­Ø«
    selectedAddresses.clear();
}

function setDepartement(dep) {
    currentDepartement = dep;
    
    document.getElementById('epicerieBtn').classList.remove('active');
    document.getElementById('biscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('epicerieBtn').classList.add('active');
    } else {
        document.getElementById('biscuiterieBtn').classList.add('active');
    }
    
    displayRuptureProductsByDepartement();
}

function setDLCDepartement(dep) {
    currentDLCDepartement = dep;
    
    document.getElementById('dlcEpicerieBtn').classList.remove('active');
    document.getElementById('dlcBiscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('dlcEpicerieBtn').classList.add('active');
    } else {
        document.getElementById('dlcBiscuiterieBtn').classList.add('active');
    }
    
    extractAvailableMonths();
    displayDLCByMonth();
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
function getProductNameByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][1] || "";
        }
    }
    return "";
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ QTE STOCK (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† QTE GOLD)
function getQteGoldByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][6] || "0";
        }
    }
    return "0";
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ QTE RESERVE
function getQteReserveByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < csvCache.length; i++) {
        if(csvCache[i][0] && csvCache[i][0].trim() === codeRecherche) {
            return csvCache[i][9] || "0";
        }
    }
    return "0";
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ PRIX DE VENTE
function getPrixVenteByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][3] || "0";
        }
    }
    return "0";
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ VENTE J-1
function getVenteJ1ByCode(codeProduit) {
    const codeTrim = codeProduit.trim();
    for(let i = 1; i < csvNewCache.length; i++) {
        if(!csvNewCache[i]) continue;
        const row = csvNewCache[i].map(c=>c.trim());
        if(row[0] == codeTrim){
            return row[1] || "0";
        }
    }
    return "0";
}

document.getElementById("codeInput").addEventListener("input", function(){
    const c = this.value.trim();
    if(c!==""){ 
        chercherProduit(c); 
        remplirQTEReserve(c); 
        remplirCartesAdresse(c); 
    }
    else { 
        resetFields(); 
    }
});

// Ø¥ØµØ¯Ø§Ø± Ù…Ø¹Ø¯Ù„: ÙŠØ¹Ø±Ø¶ VENTE J-1 Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­
// Ø¥ØµØ¯Ø§Ø± Ù…ØµØ­Ø­: ÙŠØ¸Ù‡Ø± VENTE J-1 Ùˆ COMMANDE ÙƒØ­Ù‚Ù„ÙŠÙ† Ù…Ù†ÙØµÙ„ÙŠÙ†
// Ø¥ØµØ¯Ø§Ø± Ù…ØµØ­Ø­: ÙŠØ¸Ù‡Ø± VENTE J-1 Ùˆ COMMANDE ÙƒØ­Ù‚Ù„ÙŠÙ† Ù…Ù†ÙØµÙ„ÙŠÙ† Ø¨Ù‚ÙŠÙ… Ù…Ù†ÙØµÙ„Ø©
function chercherProduit(code){
    for(let i=1;i<produitsCache.length;i++){
        if(produitsCache[i][0] && produitsCache[i][0].trim() == code){
            const nomProduit = produitsCache[i][1] || "";
            
            const container = document.getElementById("infoDataContainer");
            container.innerHTML = "";
            
            const card = document.createElement("div");
            card.className = "reserveCard";
            
            const title = document.createElement("h3"); 
            title.textContent = nomProduit; 
            card.appendChild(title);
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            const venteJ1Value = getVenteJ1ByCode(code);
            const commandeValue = getCommandeByCode(code); // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            
            const infos = [
                {label: "RAYON", value: produitsCache[i][2] || ""},
                {label: "PRIX DE VENTE", value: formatPrix(produitsCache[i][3] || "")},
                {label: "VENTE J-1", value: venteJ1Value},
                {label: "COMMANDE", value: commandeValue}, // Ù‡Ù†Ø§ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ø·Ù„Ø¨
                {label: "FOURNISSEUR", value: produitsCache[i][4] || ""},
                {label: "CNEUF", value: produitsCache[i][5] || ""},
                {label: "QTE STOCK", value: produitsCache[i][6] || ""}
            ];
            
            infos.forEach(info => {
                if(info.value !== undefined && info.value !== null) {
                    const row = document.createElement("div");
                    row.className = "dataRow";
                    row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
                    card.appendChild(row);
                }
            });
            
            container.appendChild(card);
            return;
        }
    }
    document.getElementById("infoDataContainer").innerHTML = "";
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© COMMANDE (Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù€ VENTE J-1)
function getCommandeByCode(codeProduit) {
    const codeTrim = codeProduit.trim();
    for(let i = 1; i < csvNewCache.length; i++) {
        if(!csvNewCache[i]) continue;
        const row = csvNewCache[i].map(c=>c.trim());
        if(row[0] == codeTrim){
            // Ø¥Ø°Ø§ ÙƒØ§Ù† VENTE J-1 ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 1ØŒ ÙØ§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 2
            return row[2] || "0"; // ØºÙŠØ± 1 Ø¥Ù„Ù‰ 2 Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ
        }
    }
    return "0";
}

function formatPrix(prixValue) {
    if (!prixValue) return "";
    
    prixValue = prixValue.replace(/"/g, '');
    prixValue = prixValue.replace('.', ',');
    
    if (prixValue !== "") {
        prixValue = prixValue + " DH";
    }
    
    return prixValue;
}

function remplirQTEReserve(codeProduit){
    for(let i=1;i<csvCache.length;i++){
        if(csvCache[i][0] && csvCache[i][0].trim() == codeProduit.trim()){
            const container = document.getElementById("infoDataContainer");
            const card = container.querySelector('.reserveCard');
            
            if(card) {
                const row = document.createElement("div");
                row.className = "dataRow";
                row.innerHTML = `<span class="label">QTE RESERVE:</span> <span class="value">${csvCache[i][9] || ""}</span>`;
                card.appendChild(row);
            }
            return;
        }
    }
}

function remplirCartesAdresse(codeProduit){
    const container = document.getElementById("adresseContainer");
    container.innerHTML = "";
    
    let totalQte = 0;
    let adressesTrouvees = 0;
    
    for(let i=1;i<csvCache.length;i++){
        if(csvCache[i][0] && csvCache[i][0].trim() == codeProduit.trim()){
            const adresse = csvCache[i][1] || "";
            const card = document.createElement("div");
            card.className = "adresseCard";
            const title = document.createElement("h3"); 
            title.textContent = adresse; 
            card.appendChild(title);
            
            let compteur = 1;
            let qteAdresse = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    qteAdresse += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(qteAdresse > 0){
                totalQte += qteAdresse;
                adressesTrouvees++;
                
                const totalAdresseRow = document.createElement("div");
                totalAdresseRow.className = "totalRow";
                totalAdresseRow.innerHTML = `<span class="total-value">TOTAL ${qteAdresse} UNITÃ‰S</span>`;
                card.appendChild(totalAdresseRow);
                
                container.appendChild(card);
            }
        }
    }
    
    if(totalQte > 0){
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSE";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${adressesTrouvees} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    }
}

function rechercher() {
    const searchTerm = document.getElementById("adresseInput").value.trim();
    
    if (searchType === 'code' && searchTerm) {
        const nomProduit = getProductNameByCode(searchTerm);
        const displayElement = document.getElementById("productNameDisplayAdresse");
        if (nomProduit) {
            displayElement.textContent = nomProduit;
            displayElement.style.display = "block";
        } else {
            displayElement.style.display = "none";
        }
    } else {
        document.getElementById("productNameDisplayAdresse").style.display = "none";
    }
    
    if (searchType === 'adresse') {
        rechercherParAdresse(searchTerm);
    } else {
        rechercherParCodeProduit(searchTerm);
    }
}

function rechercherParCodeProduit(searchTerm) {
    const container = document.getElementById("resultatsContainer");
    container.innerHTML = "";
    totalGlobalReserve = 0;
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    // Ø¥ØµÙ„Ø§Ø­: Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    const infoCard = document.createElement('div');
    infoCard.className = 'reserveCard';
    
    const title = document.createElement('h3');
    title.textContent = nomProduit || "PRODUIT INCONNU";
    infoCard.appendChild(title);
    
    const infos = [];
    
    if (venteJ1 && venteJ1 !== "0") {
        infos.push({label: "VENTE J-1", value: venteJ1});
    } else {
        infos.push({label: "VENTE J-1", value: "0"});
    }
    
    if (qteGold && qteGold !== "0") {
        infos.push({label: "QTE STOCK", value: qteGold}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
    } else {
        infos.push({label: "QTE STOCK", value: "0"}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
    }
    
    if (qteReserve && qteReserve !== "0") {
        infos.push({label: "QTE RESERVE", value: qteReserve});
    } else {
        infos.push({label: "QTE RESERVE", value: "0"});
    }
    
    infos.forEach(info => {
        const row = document.createElement('div');
        row.className = 'dataRow';
        row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
        infoCard.appendChild(row);
    });
    
    container.appendChild(infoCard);
    
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                totalGlobalReserve += totalQte;
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÃ‰S</span>`;
                card.appendChild(totalRow);
            }
            
            const actionButtons = document.createElement("div");
            actionButtons.className = "action-buttons";
            
            const retirerBtn = document.createElement("button");
            retirerBtn.className = "action-btn retirer";
            retirerBtn.textContent = "RETIRER";
            retirerBtn.onclick = function() {
                openQuickRetirerModal(codeProduit, adresse, nomProduit);
            };
            
            const commanderBtn = document.createElement("button");
            commanderBtn.className = "action-btn commander";
            commanderBtn.textContent = "COMMANDER";
            commanderBtn.onclick = function() {
                openQuickCommanderModal(codeProduit, nomProduit);
            };
            
            const ajouterBtn = document.createElement("button");
            ajouterBtn.className = "action-btn ajouter";
            ajouterBtn.textContent = "AJOUTER";
            ajouterBtn.onclick = function() {
                openQuickAjouterModal(codeProduit, nomProduit, adresse);
            };
            
            actionButtons.appendChild(retirerBtn);
            actionButtons.appendChild(commanderBtn);
            actionButtons.appendChild(ajouterBtn);
            
            card.appendChild(actionButtons);
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

function rechercherParAdresse(searchTerm) {
    const container = document.getElementById("resultatsContainer");
    container.innerHTML = "";
    totalGlobalReserve = 0;
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let rechercheFinale = searchTerm;
    
    if (searchTerm.includes('/')) {
        const parties = searchTerm.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            rechercheFinale = `Z${num1}P${num2}`;
        }
    }
    
    for(let i=1;i<csvCache.length;i++){
        const adresse = csvCache[i][1] || "";
        
        if(adresse === rechercheFinale){
            resultatsTrouves++;
            const codeProduit = csvCache[i][0] || "";
            const nomProduit = getProductNameByCode(codeProduit);
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                totalGlobalReserve += totalQte;
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÃ‰S</span>`;
                card.appendChild(totalRow);
            }
            
            const actionButtons = document.createElement("div");
            actionButtons.className = "action-buttons";
            
            const retirerBtn = document.createElement("button");
            retirerBtn.className = "action-btn retirer";
            retirerBtn.textContent = "RETIRER";
            retirerBtn.onclick = function() {
                openQuickRetirerModal(codeProduit, adresse, nomProduit);
            };
            
            const commanderBtn = document.createElement("button");
            commanderBtn.className = "action-btn commander";
            commanderBtn.textContent = "COMMANDER";
            commanderBtn.onclick = function() {
                openQuickCommanderModal(codeProduit, nomProduit);
            };
            
            const ajouterBtn = document.createElement("button");
            ajouterBtn.className = "action-btn ajouter";
            ajouterBtn.textContent = "AJOUTER";
            ajouterBtn.onclick = function() {
                openQuickAjouterModal(codeProduit, nomProduit, adresse);
            };
            
            actionButtons.appendChild(retirerBtn);
            actionButtons.appendChild(commanderBtn);
            actionButtons.appendChild(ajouterBtn);
            
            card.appendChild(actionButtons);
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves > 0){
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL PRODUITS";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${resultatsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else if(resultatsTrouves === 0){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN RÃ‰SULTAT POUR "${searchTerm}"</h3>`;
        container.appendChild(noResultCard);
    }
}

// Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
document.getElementById("adresseInput").addEventListener("input", function(e){
    const value = this.value;
    const allowedChars = /^[0-9/]*$/;
    
    if (!allowedChars.test(value)) {
        this.value = value.replace(/[^0-9/]/g, '');
    }
    
    if (searchType === 'code' && value.trim()) {
        const nomProduit = getProductNameByCode(value.trim());
        const displayElement = document.getElementById("productNameDisplayAdresse");
        if (nomProduit) {
            displayElement.textContent = nomProduit;
            displayElement.style.display = "block";
        } else {
            displayElement.style.display = "none";
        }
    }
    
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(() => {
        const searchTerm = this.value.trim();
        if(searchTerm.length > 0) {
            rechercher();
        } else {
            document.getElementById("resultatsContainer").innerHTML = "";
            document.getElementById("productNameDisplayAdresse").style.display = "none";
        }
    }, 300);
});

document.getElementById("adresseInput").addEventListener("keypress", function(event){
    if(event.key === "Enter"){
        event.preventDefault();
        rechercher();
    }
    
    const allowedKeys = /[0-9/]/;
    if (!allowedKeys.test(event.key) && 
        event.key !== 'Backspace' && 
        event.key !== 'Delete' && 
        event.key !== 'Tab' && 
        event.key !== 'ArrowLeft' && 
        event.key !== 'ArrowRight') {
        event.preventDefault();
    }
});

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
function parseDate(dateStr) {
    if (!dateStr || dateStr === "00/01/1900" || dateStr === "0000-00-00") {
        return null;
    }
    
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1;
        let year = parseInt(parts[2]);
        
        if (year < 100) {
            year += 2000;
        }
        
        return new Date(year, month, day);
    }
    
    return null;
}

function getMonthFromDate(dateStr) {
    if (!dateStr || dateStr === "00/01/1900" || dateStr === "0000-00-00") {
        return null;
    }
    
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const month = parts[1];
        let year = parts[2];
        
        if (year.length === 2) {
            year = '20' + year;
        }
        
        return `${month}/${year}`;
    }
    
    return null;
}

// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªÙˆÙØ±Ø©
function extractAvailableMonths() {
    const monthSet = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        
        let adresseValide = false;
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
        }
        
        if (adresseValide) {
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        const month = parts[1];
                        let year = parts[2];
                        
                        if (year.length === 2) {
                            year = '20' + year;
                        }
                        
                        const monthYear = `${month}/${year}`;
                        monthSet.add(monthYear);
                    }
                }
            }
        }
    }
    
    allMonths = Array.from(monthSet).sort((a, b) => {
        const [monthA, yearA] = a.split('/');
        const [monthB, yearB] = b.split('/');
        if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
        return parseInt(monthA) - parseInt(monthB);
    });
    
    const monthSelect = document.getElementById('monthSelect');
    monthSelect.innerHTML = '<option value="">SÃ‰LECTIONNER UN MOIS</option>';
    
    allMonths.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
    });
}

// Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª DLC Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
function displayDLCByMonth() {
    const monthSelect = document.getElementById('monthSelect');
    const selectedMonth = monthSelect.value;
    
    const container = document.getElementById("dlcContainer");
    container.innerHTML = "";
    
    if (!selectedMonth) {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>SÃ‰LECTIONNEZ UN MOIS</h3>`;
        container.appendChild(noResultCard);
        return;
    }
    
    let produitsTrouves = 0;
    let totalGlobalReserve = 0;
    let produitsMap = new Map();
    
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        const codeProduit = csvCache[i][0] || "";
        
        let adresseValide = false;
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
        }
        
        if (adresseValide && codeProduit) {
            let produitTrouveDansAdresse = false;
            let datesDetails = [];
            
            for(let j = 2; j < 8; j += 2) {
                let q = (csvCache[i][j] || "").trim();
                let d = (csvCache[i][j+1] || "").trim();
                const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                const monthFromDate = getMonthFromDate(d);
                
                if (qNum > 0 && monthFromDate === selectedMonth) {
                    produitTrouveDansAdresse = true;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            adresse: adresse,
                            qte: q,
                            date: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            if (produitTrouveDansAdresse) {
                if (!produitsMap.has(codeProduit)) {
                    produitsMap.set(codeProduit, {
                        nom: getProductNameByCode(codeProduit),
                        totalQte: 0,
                        details: []
                    });
                }
                
                const produit = produitsMap.get(codeProduit);
                datesDetails.forEach(detail => {
                    const qNum = parseFloat(detail.qte.replace(/[^0-9.-]+/g,"")) || 0;
                    produit.totalQte += qNum;
                });
                produit.details.push(...datesDetails);
            }
        }
    }
    
    const produitsArray = Array.from(produitsMap.entries());
    
    produitsArray.forEach(([code, produit]) => {
        produit.details.sort((a, b) => a.dateObj - b.dateObj);
        produit.nearestDate = produit.details.length > 0 ? produit.details[0].dateObj : new Date(9999, 11, 31);
    });
    
    produitsArray.sort((a, b) => a[1].nearestDate - b[1].nearestDate);
    
    produitsArray.forEach(([codeProduit, produit]) => {
        if (produit.totalQte > 0) {
            produitsTrouves++;
            totalGlobalReserve += produit.totalQte;
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const adresse = produit.details.length > 0 ? produit.details[0].adresse : "";
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (produit.nom) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = produit.nom;
                card.appendChild(nameRow);
            }
            
            produit.details.forEach(detail => {
                const detailRow = document.createElement("div");
                detailRow.className = "qteRow";
                detailRow.innerHTML = `<span class="label">QTE :</span> <span class="qte-value">${detail.qte}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.date}</span>`;
                card.appendChild(detailRow);
            });
            
            const totalRow = document.createElement("div");
            totalRow.className = "totalRow";
            totalRow.innerHTML = `<span class="total-value">TOTAL ${produit.totalQte} UNITÃ‰</span>`;
            card.appendChild(totalRow);
            
            container.appendChild(card);
        }
    });
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = `TOTAL ${currentDLCDepartement.toUpperCase()} - MOIS ${selectedMonth}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT TROUVÃ‰ POUR LE MOIS ${selectedMonth} DANS ${currentDLCDepartement.toUpperCase()}</h3>`;
        container.appendChild(noResultCard);
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
function isEpicerieAdresse(adresse) {
    if (!adresse) return false;
    
    for (let i = 6; i <= 15; i++) {
        for (let j = 1; j <= 9; j++) {
            if (adresse === `Z${i}P${j}`) {
                return true;
            }
        }
    }
    
    if (adresse === 'Z107P1') {
        return true;
    }
    
    return false;
}

function isBiscuiterieAdresse(adresse) {
    if (!adresse) return false;
    
    for (let i = 16; i <= 106; i++) {
        for (let j = 1; j <= 12; j++) {
            if (adresse === `Z${i}P${j}`) {
                return true;
            }
        }
    }
    
    if (adresse === 'Z107P2') {
        return true;
    }
    
    return false;
}

// Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø±ÙˆØªÙˆØ±
function displayRuptureProductsByDepartement() {
    const container = document.getElementById("ruptureContainer");
    container.innerHTML = "";
    
    let produitsTrouves = 0;
    let totalGlobalReserve = 0;
    
    const codesUniques = [];
    const codesAdresses = {};
    
    for(let i = 1; i < csvCache.length; i++) {
        const code = csvCache[i][0];
        const adresse = csvCache[i][1];
        
        if (code) {
            let adresseValide = false;
            if (currentDepartement === 'epicerie') {
                adresseValide = isEpicerieAdresse(adresse);
            } else {
                adresseValide = isBiscuiterieAdresse(adresse);
            }
            
            if (adresseValide) {
                if (!codesUniques.includes(code)) {
                    codesUniques.push(code);
                    codesAdresses[code] = [];
                }
                
                if (adresse && !codesAdresses[code].includes(adresse)) {
                    codesAdresses[code].push(adresse);
                }
            }
        }
    }
    
    codesUniques.forEach(code => {
        const qteGold = getQteGoldByCode(code);
        const qteReserve = getQteReserveByCode(code);
        
        const qteGoldNum = parseFloat(qteGold.replace(/[^0-9.-]+/g,"")) || 0;
        const qteReserveNum = parseFloat(qteReserve.replace(/[^0-9.-]+/g,"")) || 0;
        
        if (qteGoldNum === qteReserveNum && qteGoldNum > 0) {
            produitsTrouves++;
            
            let totalQte = 0;
            let allDetails = [];
            
            for(let i = 1; i < csvCache.length; i++) {
                if(csvCache[i][0] && csvCache[i][0].trim() === code.trim()) {
                    const adresse = csvCache[i][1] || "";
                    
                    let adresseValide = false;
                    if (currentDepartement === 'epicerie') {
                        adresseValide = isEpicerieAdresse(adresse);
                    } else {
                        adresseValide = isBiscuiterieAdresse(adresse);
                    }
                    
                    if (adresseValide) {
                        for(let j = 2; j < 8; j += 2) {
                            let q = (csvCache[i][j] || "").trim();
                            let d = (csvCache[i][j+1] || "").trim();
                            const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                            const dateInvalid = (d === "" || d === "00/01/1900" || d === "0000-00-00");
                            
                            if(qNum > 0 && !dateInvalid) {
                                totalQte += qNum;
                                const dateObj = parseDate(d);
                                if (dateObj) {
                                    allDetails.push({
                                        adresse: adresse,
                                        qte: qNum,
                                        date: d,
                                        dateObj: dateObj
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            if (totalQte > 0) {
                totalGlobalReserve += totalQte;
                
                const card = document.createElement("div");
                card.className = "adresseCard";
                
                const adresse = allDetails.length > 0 ? allDetails[0].adresse : "";
                const title = document.createElement("h3"); 
                title.textContent = `${adresse}`; 
                card.appendChild(title);
                
                if (code) {
                    const codeRow = document.createElement("div");
                    codeRow.className = "codeRow";
                    codeRow.textContent = `${code}`;
                    card.appendChild(codeRow);
                }
                
                const nomProduit = getProductNameByCode(code);
                if (nomProduit) {
                    const nameRow = document.createElement("div");
                    nameRow.className = "nameRow";
                    nameRow.textContent = nomProduit;
                    card.appendChild(nameRow);
                }
                
                allDetails.sort((a, b) => a.dateObj - b.dateObj);
                
                let compteur = 1;
                allDetails.forEach(detail => {
                    const qteRow = document.createElement("div");
                    qteRow.className = "qteRow";
                    qteRow.innerHTML = `<span class="label">QTE ${compteur} :</span> <span class="qte-value">${detail.qte}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.date}</span>`;
                    card.appendChild(qteRow);
                    compteur++;
                });
                
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÃ‰</span>`;
                card.appendChild(totalRow);
                
                const actionButtons = document.createElement("div");
                actionButtons.className = "action-buttons";
                
                const retirerBtn = document.createElement("button");
                retirerBtn.className = "action-btn retirer";
                retirerBtn.textContent = "RETIRER";
                retirerBtn.onclick = function() {
                    openQuickRetirerModal(code, adresse, nomProduit);
                };
                
                const commanderBtn = document.createElement("button");
                commanderBtn.className = "action-btn commander";
                commanderBtn.textContent = "COMMANDER";
                commanderBtn.onclick = function() {
                    openQuickCommanderModal(code, nomProduit);
                };
                
                const ajouterBtn = document.createElement("button");
                ajouterBtn.className = "action-btn ajouter";
                ajouterBtn.textContent = "AJOUTER";
                ajouterBtn.onclick = function() {
                    openQuickAjouterModal(code, nomProduit, adresse);
                };
                
                actionButtons.appendChild(retirerBtn);
                actionButtons.appendChild(commanderBtn);
                actionButtons.appendChild(ajouterBtn);
                
                card.appendChild(actionButtons);
                
                container.appendChild(card);
            }
        }
    });
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = `TOTAL ${currentDepartement.toUpperCase()}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC QTE RESERVE = QTE STOCK DANS ${currentDepartement.toUpperCase()}</h3>`;
        container.appendChild(noResultCard);
    }
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù ØµÙØ­Ø© COMMANDE
// ============================================

function loadCommandeProduits() {
    const savedProduits = localStorage.getItem('commande_produits');
    if (savedProduits) {
        commandeProduits = JSON.parse(savedProduits);
        updateCommandeDisplay();
    }
}

function saveCommandeProduits() {
    localStorage.setItem('commande_produits', JSON.stringify(commandeProduits));
}

function updateCommandeDisplay() {
    document.getElementById('produitCount').textContent = commandeProduits.length;
    
    const container = document.getElementById('commandeProduitsContainer');
    container.innerHTML = '';
    
    commandeProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editProduit(${index})">âœï¸</button>
                    <button class="produit-delete" onclick="deleteProduit(${index})">âœ•</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <span class="qte-label">QUANTITÃ‰:</span>
                <span class="qte-value">${produit.qte}</span>
            </div>
        `;
        
        container.appendChild(card);
    });
}

document.getElementById('commandeCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForCommande(code);
    } else {
        document.getElementById('commandeProductInfo').innerHTML = '';
    }
});

function showProductInfoForCommande(code) {
    const container = document.getElementById('commandeProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÃ‰</h3>`;
        container.appendChild(message);
    }
}

function ajouterProduit() {
    const codeInput = document.getElementById('commandeCodeInput');
    const qteInput = document.getElementById('commandeQteInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÃ‰ DU PRODUIT', 'warning');
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    
    const produitNom = nomProduit || "PRODUIT NON RÃ‰FÃ‰RENCÃ‰";
    
    const existingIndex = commandeProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        commandeProduits[existingIndex].qte = parseInt(qte);
        showAlert('PRODUIT MIS Ã€ JOUR AVEC SUCCÃˆS', 'success');
    } else {
        commandeProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte)
        });
        showAlert('PRODUIT AJOUTÃ‰ AVEC SUCCÃˆS', 'success');
    }
    
    saveCommandeProduits();
    updateCommandeDisplay();
    
    codeInput.value = '';
    qteInput.value = '';
    document.getElementById('commandeProductInfo').innerHTML = '';
    
    codeInput.focus();
}

function editProduit(index) {
    editingProduitIndex = index;
    const produit = commandeProduits[index];
    
    const container = document.getElementById('commandeProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="produit-header">
            <div class="produit-code">${produit.code}</div>
            <div style="color: #3498db; font-weight: bold;">MODIFICATION</div>
        </div>
        <div class="produit-name">${produit.nom}</div>
        <div class="produit-qte" style="flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center;">
                <input type="number" class="edit-qte-input" id="editQteInput" value="${produit.qte}" min="1" oninput="delayedEvaluateExpression(this)">
                <button class="save-edit-btn" onclick="saveEditProduit()">ENREGISTRER</button>
                <button class="cancel-edit-btn" onclick="cancelEditProduit()">ANNULER</button>
            </div>
        </div>
    `;
    
    document.getElementById('editQteInput').focus();
    document.getElementById('editQteInput').select();
}

function saveEditProduit() {
    const newQte = document.getElementById('editQteInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÃ‰ VALIDE', 'warning');
        return;
    }
    
    commandeProduits[editingProduitIndex].qte = parseInt(newQte);
    saveCommandeProduits();
    updateCommandeDisplay();
    editingProduitIndex = -1;
    showAlert('QUANTITÃ‰ MODIFIÃ‰E AVEC SUCCÃˆS', 'success');
}

function cancelEditProduit() {
    editingProduitIndex = -1;
    updateCommandeDisplay();
}

function deleteProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        commandeProduits.splice(index, 1);
        saveCommandeProduits();
        updateCommandeDisplay();
        showAlert('PRODUIT SUPPRIMÃ‰ AVEC SUCCÃˆS', 'success');
    });
}

function showConfirmModal(message, callback) {
    document.getElementById('confirmMessage').textContent = message;
    pendingAction = callback;
    document.getElementById('confirmModal').style.display = 'flex';
}

function confirmAction() {
    if (typeof pendingAction === 'function') {
        pendingAction();
    }
    
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
}

function cancelAction() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
}

function clearAllProduits() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        commandeProduits = [];
        saveCommandeProduits();
        updateCommandeDisplay();
        showAlert('TOUS LES PRODUITS ONT Ã‰TÃ‰ EFFACÃ‰S', 'success');
    });
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù ØµÙØ­Ø© AJOUTER
// ============================================

function loadAjouterProduits() {
    const savedProduits = localStorage.getItem('ajouter_produits');
    if (savedProduits) {
        ajouterProduits = JSON.parse(savedProduits);
        updateAjouterDisplay();
    }
}

function saveAjouterProduits() {
    localStorage.setItem('ajouter_produits', JSON.stringify(ajouterProduits));
}

function updateAjouterDisplay() {
    document.getElementById('ajouterProduitCount').textContent = ajouterProduits.length;
    
    const container = document.getElementById('ajouterProduitsContainer');
    container.innerHTML = '';
    
    ajouterProduits.forEach((produit, index) => {
        const card = document.createElement("div");
        card.className = "adresseCard";
        
        const headerRow = document.createElement("div");
        headerRow.className = "produit-header";
        headerRow.style.marginBottom = "10px";
        
        const title = document.createElement("h3"); 
        title.textContent = `${produit.adresse}`; 
        title.style.marginBottom = "0";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "produit-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "produit-edit";
        editBtn.textContent = "âœï¸";
        editBtn.onclick = function() {
            editAjouterProduit(index);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "produit-delete";
        deleteBtn.textContent = "âœ•";
        deleteBtn.onclick = function() {
            deleteAjouterProduit(index);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        headerRow.appendChild(title);
        headerRow.appendChild(actionsDiv);
        card.appendChild(headerRow);
        
        if (produit.code) {
            const codeRow = document.createElement("div");
            codeRow.className = "codeRow";
            codeRow.textContent = `${produit.code}`;
            card.appendChild(codeRow);
        }
        
        if (produit.nom) {
            const nameRow = document.createElement("div");
            nameRow.className = "nameRow";
            nameRow.textContent = produit.nom;
            card.appendChild(nameRow);
        }
        
        let compteur = 1;
        
        if (produit.qte1 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte1}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc1}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte2 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte2}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc2}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte3 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte3}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc3}</span>`;
            card.appendChild(row);
        }
        
        container.appendChild(card);
    });
}

document.getElementById('ajouterCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForAjouter(code);
        afficherResultatsRechercheAjouter(code);
    } else {
        document.getElementById('ajouterProductInfo').innerHTML = '';
        document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    }
});

function showProductInfoForAjouter(code) {
    const container = document.getElementById('ajouterProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    // Ø¥ØµÙ„Ø§Ø­: Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÃ‰</h3>`;
        container.appendChild(message);
    }
}

function afficherResultatsRechercheAjouter(searchTerm) {
    const container = document.getElementById('ajouterSearchResultsContainer');
    container.innerHTML = "";
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    // Ø¥ØµÙ„Ø§Ø­: Ø¹Ø¯Ù… Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡Ø§ ØªØ¸Ù‡Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ showProductInfoForAjouter
    
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÃ‰S</span>`;
                card.appendChild(totalRow);
            }
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

function ajouterProduitAjouter() {
    const codeInput = document.getElementById('ajouterCodeInput');
    const adresseInput = document.getElementById('ajouterAdresseInput');
    const qte1Input = document.getElementById('ajouterQte1Input');
    const dlc1Input = document.getElementById('ajouterDlc1Input');
    const qte2Input = document.getElementById('ajouterQte2Input');
    const dlc2Input = document.getElementById('ajouterDlc2Input');
    const qte3Input = document.getElementById('ajouterQte3Input');
    const dlc3Input = document.getElementById('ajouterDlc3Input');
    
    const code = codeInput.value.trim();
    const adresse = adresseInput.value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const nomProduit = getProductNameByCode(code);
    
    const produitNom = nomProduit || "PRODUIT NON RÃ‰FÃ‰RENCÃ‰";
    
    const qte1 = qte1Input.value.trim();
    const dlc1 = dlc1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÃ‰', 'warning');
        return;
    }
    
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    const existingIndex = ajouterProduits.findIndex(p => p.adresse === adresseFinale && p.code === code);
    
    if (existingIndex >= 0) {
        showAlert('CE PRODUIT AVEC LE MÃŠME CODE ET ADRESSE EXISTE DÃ‰JÃ€!', 'warning');
        return;
    }
    
    ajouterProduits.push({
        code: code,
        adresse: adresseFinale,
        nom: produitNom,
        qte1: qte1 ? parseInt(qte1) : 0,
        dlc1: dlc1,
        qte2: qte2 ? parseInt(qte2) : 0,
        dlc2: dlc2,
        qte3: qte3 ? parseInt(qte3) : 0,
        dlc3: dlc3
    });
    showAlert('PRODUIT AJOUTÃ‰ AVEC SUCCÃˆS', 'success');
    
    saveAjouterProduits();
    updateAjouterDisplay();
    
    codeInput.value = '';
    adresseInput.value = '';
    qte1Input.value = '';
    dlc1Input.value = '';
    qte2Input.value = '';
    dlc2Input.value = '';
    qte3Input.value = '';
    dlc3Input.value = '';
    document.getElementById('ajouterProductInfo').innerHTML = '';
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    
    codeInput.focus();
}

function editAjouterProduit(index) {
    editingAjouterProduitIndex = index;
    const produit = ajouterProduits[index];
    
    const container = document.getElementById('ajouterProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="adresseCard">
            <h3 style="color: #3498db;">MODIFICATION</h3>
            
            <div class="codeRow" style="background: #3498db; color: white;">${produit.code}</div>
            
            <div class="nameRow">${produit.nom}</div>
            
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 8px;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">ADRESSE:</div>
                <input type="tel" id="editAjouterAdresseInput" value="${produit.adresse}" pattern="[0-9/]*" style="width: 100%; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 1:</div>
                    <input type="number" id="editAjouterQte1Input" value="${produit.qte1 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" oninput="delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 1:</div>
                    <input type="tel" id="editAjouterDlc1Input" value="${produit.dlc1 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 2:</div>
                    <input type="number" id="editAjouterQte2Input" value="${produit.qte2 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" oninput="delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 2:</div>
                    <input type="tel" id="editAjouterDlc2Input" value="${produit.dlc2 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 3:</div>
                    <input type="number" id="editAjouterQte3Input" value="${produit.qte3 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" oninput="delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 3:</div>
                    <input type="tel" id="editAjouterDlc3Input" value="${produit.dlc3 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="ajouter-btn" onclick="saveEditAjouterProduit()" style="flex: 1; padding: 10px; background: #27ae60;">ENREGISTRER</button>
                <button class="ajouter-btn" onclick="cancelEditAjouterProduit()" style="flex: 1; padding: 10px; background: #e74c3c;">ANNULER</button>
            </div>
        </div>
    `;
    
    const dateInputs = [
        document.getElementById('editAjouterDlc1Input'),
        document.getElementById('editAjouterDlc2Input'),
        document.getElementById('editAjouterDlc3Input')
    ];
    
    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
        }
    });
    
    document.getElementById('editAjouterAdresseInput').focus();
}

function saveEditAjouterProduit() {
    const newAdresse = document.getElementById('editAjouterAdresseInput').value;
    const newQte1 = document.getElementById('editAjouterQte1Input').value;
    const newDlc1 = document.getElementById('editAjouterDlc1Input').value;
    const newQte2 = document.getElementById('editAjouterQte2Input').value;
    const newDlc2 = document.getElementById('editAjouterDlc2Input').value;
    const newQte3 = document.getElementById('editAjouterQte3Input').value;
    const newDlc3 = document.getElementById('editAjouterDlc3Input').value;
    
    if (!newAdresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    let adresseFinale = newAdresse;
    if (newAdresse.includes('/')) {
        const parties = newAdresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    if (newDlc1 && !isValidDateYYYY(newDlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc2 && !isValidDateYYYY(newDlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc3 && !isValidDateYYYY(newDlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (!newQte1 && !newQte2 && !newQte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÃ‰', 'warning');
        return;
    }
    
    const produitOriginal = ajouterProduits[editingAjouterProduitIndex];
    if (adresseFinale !== produitOriginal.adresse) {
        const existingIndex = ajouterProduits.findIndex((p, i) => i !== editingAjouterProduitIndex && p.adresse === adresseFinale && p.code === produitOriginal.code);
        
        if (existingIndex >= 0) {
            showAlert('UN PRODUIT AVEC LE MÃŠME CODE ET ADRESSE EXISTE DÃ‰JÃ€!', 'warning');
            return;
        }
    }
    
    ajouterProduits[editingAjouterProduitIndex].adresse = adresseFinale;
    ajouterProduits[editingAjouterProduitIndex].qte1 = newQte1 ? parseInt(newQte1) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc1 = newDlc1;
    ajouterProduits[editingAjouterProduitIndex].qte2 = newQte2 ? parseInt(newQte2) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc2 = newDlc2;
    ajouterProduits[editingAjouterProduitIndex].qte3 = newQte3 ? parseInt(newQte3) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc3 = newDlc3;
    
    saveAjouterProduits();
    updateAjouterDisplay();
    editingAjouterProduitIndex = -1;
    showAlert('PRODUIT MODIFIÃ‰ AVEC SUCCÃˆS', 'success');
}

function cancelEditAjouterProduit() {
    editingAjouterProduitIndex = -1;
    updateAjouterDisplay();
}

function deleteAjouterProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        ajouterProduits.splice(index, 1);
        saveAjouterProduits();
        updateAjouterDisplay();
        showAlert('PRODUIT SUPPRIMÃ‰ AVEC SUCCÃˆS', 'success');
    });
}

function clearAllAjouter() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        ajouterProduits = [];
        saveAjouterProduits();
        updateAjouterDisplay();
        showAlert('TOUS LES PRODUITS ONT Ã‰TÃ‰ EFFACÃ‰S', 'success');
    });
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù ØµÙØ­Ø© CASSE FRAIS
// ============================================

function loadCasseProduits() {
    const savedProduits = localStorage.getItem('casse_produits');
    if (savedProduits) {
        casseProduits = JSON.parse(savedProduits);
        updateCasseDisplay();
    }
}

function saveCasseProduits() {
    localStorage.setItem('casse_produits', JSON.stringify(casseProduits));
}

function updateCasseDisplay() {
    document.getElementById('casseProduitCount').textContent = casseProduits.length;
    
    const container = document.getElementById('casseProduitsContainer');
    container.innerHTML = '';
    
    casseProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editCasseProduit(${index})">âœï¸</button>
                    <button class="produit-delete" onclick="deleteCasseProduit(${index})">âœ•</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <div style="display: flex; justify-content: space-between; width: 100%;">
                    <div>
                        <span class="qte-label">QTE:</span>
                        <span class="qte-value">${produit.qte}</span>
                    </div>
                    <div>
                        <span class="qte-label">DATE:</span>
                        <span class="qte-value">${produit.date}</span>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

document.getElementById('casseCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForCasse(code);
    } else {
        document.getElementById('casseProductInfo').innerHTML = '';
    }
});

function showProductInfoForCasse(code) {
    const container = document.getElementById('casseProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÃ‰</h3>`;
        container.appendChild(message);
    }
}

function ajouterProduitCasse() {
    const codeInput = document.getElementById('casseCodeInput');
    const qteInput = document.getElementById('casseQteInput');
    const dateInput = document.getElementById('casseDateInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    const date = dateInput.value.trim();
    
    if (!date) {
        showAlert('VEUILLEZ ENTRER LA DATE (JJ/MM/AAAA)', 'warning');
        dateInput.focus();
        return;
    }
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÃ‰ DU PRODUIT', 'warning');
        return;
    }
    
    if (!isValidDateYYYY(date)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dateInput.focus();
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    
    const produitNom = nomProduit || "PRODUIT NON RÃ‰FÃ‰RENCÃ‰";
    
    const existingIndex = casseProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        casseProduits[existingIndex].qte = parseInt(qte);
        casseProduits[existingIndex].date = date;
        showAlert('PRODUIT MIS Ã€ JOUR AVEC SUCCÃˆS', 'success');
    } else {
        casseProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte),
            date: date
        });
        showAlert('PRODUIT AJOUTÃ‰ AVEC SUCCÃˆS', 'success');
    }
    
    saveCasseProduits();
    updateCasseDisplay();
    
    codeInput.value = '';
    qteInput.value = '';
    dateInput.value = '';
    document.getElementById('casseProductInfo').innerHTML = '';
    
    codeInput.focus();
}

function editCasseProduit(index) {
    editingCasseProduitIndex = index;
    const produit = casseProduits[index];
    
    const container = document.getElementById('casseProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="produit-header">
            <div class="produit-code">${produit.code}</div>
            <div style="color: #3498db; font-weight: bold;">MODIFICATION</div>
        </div>
        <div class="produit-name">${produit.nom}</div>
        <div class="produit-qte" style="flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; font-size: 12px; color: #7f8c8d;">QTE:</div>
                    <input type="number" class="edit-qte-input" id="editCasseQteInput" value="${produit.qte}" min="1" style="width: 100%;" oninput="delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; font-size: 12px; color: #7f8c8d;">DATE:</div>
                    <input type="tel" class="edit-qte-input" id="editCasseDateInput" value="${produit.date}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; text-align: center;">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="save-edit-btn" onclick="saveEditCasseProduit()" style="flex: 1;">ENREGISTRER</button>
                <button class="cancel-edit-btn" onclick="cancelEditCasseProduit()" style="flex: 1;">ANNULER</button>
            </div>
        </div>
    `;
    
    const dateInput = document.getElementById('editCasseDateInput');
    dateInput.addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        if (value.length >= 5) {
            value = value.substring(0, 5) + '/' + value.substring(5, 9);
        }
        
        this.value = value;
    });
    
    document.getElementById('editCasseQteInput').focus();
    document.getElementById('editCasseQteInput').select();
}

function saveEditCasseProduit() {
    const newQte = document.getElementById('editCasseQteInput').value;
    const newDate = document.getElementById('editCasseDateInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÃ‰ VALIDE', 'warning');
        return;
    }
    
    if (!newDate || !isValidDateYYYY(newDate)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    casseProduits[editingCasseProduitIndex].qte = parseInt(newQte);
    casseProduits[editingCasseProduitIndex].date = newDate;
    saveCasseProduits();
    updateCasseDisplay();
    editingCasseProduitIndex = -1;
    showAlert('PRODUIT MODIFIÃ‰ AVEC SUCCÃˆS', 'success');
}

function cancelEditCasseProduit() {
    editingCasseProduitIndex = -1;
    updateCasseDisplay();
}

function deleteCasseProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        casseProduits.splice(index, 1);
        saveCasseProduits();
        updateCasseDisplay();
        showAlert('PRODUIT SUPPRIMÃ‰ AVEC SUCCÃˆS', 'success');
    });
}

function clearAllProduitsCasse() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        casseProduits = [];
        saveCasseProduits();
        updateCasseDisplay();
        showAlert('TOUS LES PRODUITS ONT Ã‰TÃ‰ EFFACÃ‰S', 'success');
    });
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù ØµÙØ­Ø© RETIRER
// ============================================

function loadRetirerProduits() {
    const savedProduits = localStorage.getItem('retirer_produits');
    if (savedProduits) {
        retirerProduits = JSON.parse(savedProduits);
        updateRetirerDisplay();
    }
}

function saveRetirerProduits() {
    localStorage.setItem('retirer_produits', JSON.stringify(retirerProduits));
}

function updateRetirerDisplay() {
    document.getElementById('retirerProduitCount').textContent = retirerProduits.length;
    
    const container = document.getElementById('retirerProduitsContainer');
    container.innerHTML = '';
    
    retirerProduits.forEach((produit, index) => {
        const card = document.createElement("div");
        card.className = "adresseCard";
        
        const headerRow = document.createElement("div");
        headerRow.className = "produit-header";
        headerRow.style.marginBottom = "10px";
        
        const title = document.createElement("h3"); 
        title.textContent = `${produit.adresse}`; 
        title.style.marginBottom = "0";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "produit-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "produit-edit";
        editBtn.textContent = "âœï¸";
        editBtn.onclick = function() {
            editRetirerProduit(index);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "produit-delete";
        deleteBtn.textContent = "âœ•";
        deleteBtn.onclick = function() {
            deleteRetirerProduit(index);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        headerRow.appendChild(title);
        headerRow.appendChild(actionsDiv);
        card.appendChild(headerRow);
        
        if (produit.code) {
            const codeRow = document.createElement("div");
            codeRow.className = "codeRow";
            codeRow.textContent = `${produit.code}`;
            card.appendChild(codeRow);
        }
        
        if (produit.nom) {
            const nameRow = document.createElement("div");
            nameRow.className = "nameRow";
            nameRow.textContent = produit.nom;
            card.appendChild(nameRow);
        }
        
        let compteur = 1;
        
        if (produit.qte1 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte1}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc1}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte2 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte2}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc2}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte3 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte3}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc3}</span>`;
            card.appendChild(row);
        }
        
        container.appendChild(card);
    });
}

document.getElementById('retirerCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForRetirer(code);
        afficherResultatsRechercheRetirer(code);
    } else {
        document.getElementById('retirerProductInfo').innerHTML = '';
        document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    }
});

function showProductInfoForRetirer(code) {
    const container = document.getElementById('retirerProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    // Ø¥ØµÙ„Ø§Ø­: Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÃ‰</h3>`;
        container.appendChild(message);
    }
}

function afficherResultatsRechercheRetirer(searchTerm) {
    const container = document.getElementById('retirerSearchResultsContainer');
    container.innerHTML = "";
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    // Ø¥ØµÙ„Ø§Ø­: Ø¹Ø¯Ù… Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡Ø§ ØªØ¸Ù‡Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ showProductInfoForRetirer
    
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
    
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
    
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
    
            if(totalQte > 0){
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÃ‰S</span>`;
                card.appendChild(totalRow);
            }
    
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

// ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø²Ø§Ù„Ø© Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© AJOUTER Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†Ù‡Ø§
function showDateOptionsForRetirer() {
    const code = document.getElementById('retirerCodeInput').value.trim();
    const adresse = document.getElementById('retirerAdresseInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('retirerCodeInput').focus();
        return;
    }
    
    if (!adresse) {
        showAlert('VEUILLEZ D\'ABORD ENTRER L\'ADRESSE', 'warning');
        document.getElementById('retirerAdresseInput').focus();
        return;
    }
    
    openQuickAjouterModalForRetirer(code, adresse);
}

// ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© AJOUTER Ù„ØµÙØ­Ø© RETIRER
function openQuickAjouterModalForRetirer(code, adresse) {
    const nomProduit = getProductNameByCode(code);
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†ÙØ³ ÙˆØ¸ÙŠÙØ© AJOUTER ÙˆÙ„ÙƒÙ† Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© RETIRER
    currentQuickProduct = {
        code: code,
        nom: nomProduit,
        adresse: adresse,
        type: 'ajouter-retirer'
    };
    
    const infoDiv = document.getElementById('quickAjouterInfo');
    const displayAdresse = adresse || "Z6P1";
    infoDiv.innerHTML = `
        <div class="adresse" style="color: #FFA500 !important;">ADRESSE: ${displayAdresse}</div>
        <div class="code" style="color: #2c3e50 !important;">CODE: ${code}</div>
        <div class="name" style="color: #2c3e50 !important;">NOM: ${nomProduit}</div>
    `;
    
    if (adresse && adresse.startsWith('Z') && adresse.includes('P')) {
        const match = adresse.match(/Z(\d+)P(\d+)/);
        if (match) {
            document.getElementById('quickAjouterAdresseInput').value = `${match[1]}/${match[2]}`;
        } else {
            document.getElementById('quickAjouterAdresseInput').value = adresse;
        }
    } else {
        document.getElementById('quickAjouterAdresseInput').value = adresse;
    }
    
    document.getElementById('quickAjouterQte1Input').value = '';
    document.getElementById('quickAjouterDlc1Input').value = '';
    document.getElementById('quickAjouterQte2Input').value = '';
    document.getElementById('quickAjouterDlc2Input').value = '';
    document.getElementById('quickAjouterQte3Input').value = '';
    document.getElementById('quickAjouterDlc3Input').value = '';
    
    // ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.querySelector('#quickAjouterModal .quick-modal-title').textContent = "AJOUTER POUR RETIRER";
    
    // ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
    const ajouterBtn = document.querySelector('#quickAjouterModal .quick-modal-btn.ajouter');
    if (ajouterBtn) {
        ajouterBtn.textContent = "AJOUTER POUR RETIRER";
    }
    
    document.getElementById('quickAjouterModal').style.display = 'flex';
}

function closeDateSelectModal() {
    document.getElementById('dateSelectModal').style.display = 'none';
    document.getElementById('dateOptionsContainer').innerHTML = '';
}

function getAvailableDatesForProduct(code) {
    const dates = [];
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    if (!dates.includes(dateStr)) {
                        dates.push(dateStr);
                    }
                }
            }
        }
    }
    
    dates.sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
    
    return dates;
}

function ajouterProduitRetirer() {
    const codeInput = document.getElementById('retirerCodeInput');
    const adresseInput = document.getElementById('retirerAdresseInput');
    const qte1Input = document.getElementById('retirerQte1Input');
    const dlc1Input = document.getElementById('retirerDlc1Input');
    const qte2Input = document.getElementById('retirerQte2Input');
    const dlc2Input = document.getElementById('retirerDlc2Input');
    const qte3Input = document.getElementById('retirerQte3Input');
    const dlc3Input = document.getElementById('retirerDlc3Input');
    
    const code = codeInput.value.trim();
    const adresse = adresseInput.value.trim();
    
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        adresseInput.focus();
        return;
    }
    
    if (!code) {
        showAlert('VEUILLEZ ENTRER LE CODE DU PRODUIT', 'warning');
        codeInput.focus();
        return;
    }
    
    const qte1 = qte1Input.value.trim();
    const dlc1 = dlc1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÃ‰', 'warning');
        return;
    }
    
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    if (!nomProduit) {
        showAlert('PRODUIT NON TROUVÃ‰ DANS LA BASE DE DONNÃ‰ES', 'warning');
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const existingIndex = retirerProduits.findIndex(p => p.code === code && p.adresse === adresseFinale);
    
    if (existingIndex >= 0) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
        retirerProduits[existingIndex] = {
            code: code,
            adresse: adresseFinale,
            nom: nomProduit,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        };
        showAlert('PRODUIT MIS Ã€ JOUR AVEC SUCCÃˆS', 'success');
    } else {
        // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
        retirerProduits.push({
            code: code,
            adresse: adresseFinale,
            nom: nomProduit,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        });
        showAlert('PRODUIT AJOUTÃ‰ AVEC SUCCÃˆS', 'success');
    }
    
    saveRetirerProduits();
    updateRetirerDisplay();
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    codeInput.value = '';
    adresseInput.value = '';
    qte1Input.value = '';
    dlc1Input.value = '';
    qte2Input.value = '';
    dlc2Input.value = '';
    qte3Input.value = '';
    dlc3Input.value = '';
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    
    codeInput.focus();
}

function editRetirerProduit(index) {
    editingRetirerProduitIndex = index;
    const produit = retirerProduits[index];
    
    const container = document.getElementById('retirerProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="adresseCard">
            <h3 style="color: #3498db;">MODIFICATION</h3>
            
            <div class="codeRow" style="background: #3498db; color: white;">${produit.code}</div>
            
            <div class="nameRow">${produit.nom}</div>
            
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 8px;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">ADRESSE:</div>
                <input type="tel" id="editRetirerAdresseInput" value="${produit.adresse}" pattern="[0-9/]*" style="width: 100%; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 1:</div>
                    <input type="number" id="editRetirerQte1Input" value="${produit.qte1 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" oninput="delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 1:</div>
                    <input type="tel" id="editRetirerDlc1Input" value="${produit.dlc1 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 2:</div>
                    <input type="number" id="editRetirerQte2Input" value="${produit.qte2 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" oninput="delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 2:</div>
                    <input type="tel" id="editRetirerDlc2Input" value="${produit.dlc2 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 3:</div>
                    <input type="number" id="editRetirerQte3Input" value="${produit.qte3 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" oninput="delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 3:</div>
                    <input type="tel" id="editRetirerDlc3Input" value="${produit.dlc3 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="retirer-btn" onclick="saveEditRetirerProduit()" style="flex: 1; padding: 10px; background: #34495e;">ENREGISTRER</button>
                <button class="retirer-btn" onclick="cancelEditRetirerProduit()" style="flex: 1; padding: 10px; background: #e74c3c;">ANNULER</button>
            </div>
        </div>
    `;
    
    // Ø£Ø¶Ù Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªÙˆØ§Ø±ÙŠØ®
    const dateInputs = [
        document.getElementById('editRetirerDlc1Input'),
        document.getElementById('editRetirerDlc2Input'),
        document.getElementById('editRetirerDlc3Input')
    ];
    
    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
        }
    });
    
    document.getElementById('editRetirerAdresseInput').focus();
    document.getElementById('editRetirerAdresseInput').select();
}
function saveEditRetirerProduit() {
    const newAdresse = document.getElementById('editRetirerAdresseInput').value;
    const newQte1 = document.getElementById('editRetirerQte1Input').value;
    const newDlc1 = document.getElementById('editRetirerDlc1Input').value;
    const newQte2 = document.getElementById('editRetirerQte2Input').value;
    const newDlc2 = document.getElementById('editRetirerDlc2Input').value;
    const newQte3 = document.getElementById('editRetirerQte3Input').value;
    const newDlc3 = document.getElementById('editRetirerDlc3Input').value;
    
    if (!newAdresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    let adresseFinale = newAdresse;
    if (newAdresse.includes('/')) {
        const parties = newAdresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    if (newDlc1 && !isValidDateYYYY(newDlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc2 && !isValidDateYYYY(newDlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc3 && !isValidDateYYYY(newDlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (!newQte1 && !newQte2 && !newQte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÃ‰', 'warning');
        return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    retirerProduits[editingRetirerProduitIndex].adresse = adresseFinale;
    retirerProduits[editingRetirerProduitIndex].qte1 = newQte1 ? parseInt(newQte1) : 0;
    retirerProduits[editingRetirerProduitIndex].dlc1 = newDlc1;
    retirerProduits[editingRetirerProduitIndex].qte2 = newQte2 ? parseInt(newQte2) : 0;
    retirerProduits[editingRetirerProduitIndex].dlc2 = newDlc2;
    retirerProduits[editingRetirerProduitIndex].qte3 = newQte3 ? parseInt(newQte3) : 0;
    retirerProduits[editingRetirerProduitIndex].dlc3 = newDlc3;
    
    saveRetirerProduits();
    updateRetirerDisplay();
    editingRetirerProduitIndex = -1;
    showAlert('PRODUIT MODIFIÃ‰ AVEC SUCCÃˆS', 'success');
}


function cancelEditRetirerProduit() {
    editingRetirerProduitIndex = -1;
    updateRetirerDisplay();
}

function deleteRetirerProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        retirerProduits.splice(index, 1);
        saveRetirerProduits();
        updateRetirerDisplay();
        showAlert('PRODUIT SUPPRIMÃ‰ AVEC SUCCÃˆS', 'success');
    });
}

function clearAllProduitsRetirer() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        retirerProduits = [];
        saveRetirerProduits();
        updateRetirerDisplay();
        showAlert('TOUS LES PRODUITS ONT Ã‰TÃ‰ EFFACÃ‰S', 'success');
    });
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù ØµÙØ­Ø© PANIER
// ============================================

function loadPanierProduits() {
    const savedProduits = localStorage.getItem('panier_produits');
    if (savedProduits) {
        panierProduits = JSON.parse(savedProduits);
        updatePanierDisplay();
    }
}

function savePanierProduits() {
    localStorage.setItem('panier_produits', JSON.stringify(panierProduits));
}

function updatePanierDisplay() {
    document.getElementById('panierProduitCount').textContent = panierProduits.length;
    
    const container = document.getElementById('panierProduitsContainer');
    const totalContainer = document.getElementById('panierTotalCard');
    
    container.innerHTML = '';
    totalContainer.innerHTML = '';
    
    if (panierProduits.length === 0) {
        totalContainer.style.display = 'none';
        return;
    }
    
    totalContainer.style.display = 'block';
    
    let totalProduits = 0;
    let totalPrix = 0;
    
    panierProduits.forEach((produit, index) => {
        totalProduits++;
        
        const prixVente = parseFloat(produit.prix.replace(',', '.')) || 0;
        const totalProduit = prixVente * produit.qte;
        totalPrix += totalProduit;
        
        const card = document.createElement('div');
        card.className = 'panier-produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editPanierProduit(${index})">âœï¸</button>
                    <button class="produit-delete" onclick="deletePanierProduit(${index})">âœ•</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-details">
                <div class="detail-item">
                    <div class="detail-label">QTE</div>
                    <div class="detail-value">${produit.qte}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">PRIX</div>
                    <div class="detail-value prix">${produit.prix} DH</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">TOTAL</div>
                    <div class="detail-value total">${totalProduit.toFixed(2)} DH</div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    totalContainer.innerHTML = `
        <div class="panier-total-card">
            <h3>RÃ‰SUMÃ‰ DU PANIER</h3>
            <div class="dataRow">
                <span class="label">NOMBRE DE PRODUITS:</span>
                <span class="value">${totalProduits}</span>
            </div>
            <div class="dataRow">
                <span class="label">PRIX TOTAL:</span>
                <span class="total-value">${totalPrix.toFixed(2)} DH</span>
            </div>
        </div>
    `;
    
    totalContainer.prepend(totalContainer.firstChild);
}

document.getElementById('panierCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForPanier(code);
    } else {
        document.getElementById('panierProductInfo').innerHTML = '';
    }
});

function showProductInfoForPanier(code) {
    const container = document.getElementById('panierProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const prixVente = getPrixVenteByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || prixVente || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        if (prixVente && prixVente !== "0") {
            const prixRow = document.createElement('div');
            prixRow.className = 'dataRow';
            prixRow.innerHTML = `<span class="label">PRIX DE VENTE:</span> <span class="value">${formatPrix(prixVente)}</span>`;
            card.appendChild(prixRow);
        }
        
        if (qteGold && qteGold !== "0") {
            const qteGoldRow = document.createElement('div');
            qteGoldRow.className = 'dataRow';
            qteGoldRow.innerHTML = `<span class="label">QTE STOCK:</span> <span class="value">${qteGold}</span>`; // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
            card.appendChild(qteGoldRow);
        } else {
            const qteGoldRow = document.createElement('div');
            qteGoldRow.className = 'dataRow';
            qteGoldRow.innerHTML = `<span class="label">QTE STOCK:</span> <span class="value">0</span>`; // ØªØºÙŠÙŠØ± QTE GOLD Ø¥Ù„Ù‰ QTE STOCK
            card.appendChild(qteGoldRow);
        }
        
        if (qteReserve && qteReserve !== "0") {
            const qteReserveRow = document.createElement('div');
            qteReserveRow.className = 'dataRow';
            qteReserveRow.innerHTML = `<span class="label">QTE RESERVE:</span> <span class="value">${qteReserve}</span>`;
            card.appendChild(qteReserveRow);
        } else {
            const qteReserveRow = document.createElement('div');
            qteReserveRow.className = 'dataRow';
            qteReserveRow.innerHTML = `<span class="label">QTE RESERVE:</span> <span class="value">0</span>`;
            card.appendChild(qteReserveRow);
        }
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÃ‰</h3>`;
        container.appendChild(message);
    }
}

function ajouterProduitPanier() {
    const codeInput = document.getElementById('panierCodeInput');
    const qteInput = document.getElementById('panierQteInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÃ‰ DU PRODUIT', 'warning');
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    const prixVente = getPrixVenteByCode(code);
    
    if (!nomProduit) {
        showAlert('PRODUIT NON TROUVÃ‰ DANS LA BASE DE DONNÃ‰ES', 'warning');
        return;
    }
    
    const produitNom = nomProduit;
    const produitPrix = prixVente || "0";
    
    const existingIndex = panierProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        panierProduits[existingIndex].qte = parseInt(qte);
        showAlert('PRODUIT MIS Ã€ JOUR AVEC SUCCÃˆS', 'success');
    } else {
        panierProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte),
            prix: produitPrix
        });
        showAlert('PRODUIT AJOUTÃ‰ AU PANIER AVEC SUCCÃˆS', 'success');
    }
    
    savePanierProduits();
    updatePanierDisplay();
    
    codeInput.value = '';
    qteInput.value = '';
    document.getElementById('panierProductInfo').innerHTML = '';
    
    codeInput.focus();
}

function editPanierProduit(index) {
    editingPanierProduitIndex = index;
    const produit = panierProduits[index];
    
    const container = document.getElementById('panierProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="panier-produit-card">
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div style="color: #3498db; font-weight: bold;">MODIFICATION</div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-details" style="flex-direction: column; gap: 10px;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                    <div style="flex: 1;">
                        <div style="margin-bottom: 5px; font-size: 12px; color: #7f8c8d;">QUANTITÃ‰:</div>
                        <input type="number" class="edit-qte-input" id="editPanierQteInput" value="${produit.qte}" min="1" style="width: 100%;" oninput="delayedEvaluateExpression(this)">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="save-edit-btn" onclick="saveEditPanierProduit()" style="flex: 1;">ENREGISTRER</button>
                    <button class="cancel-edit-btn" onclick="cancelEditPanierProduit()" style="flex: 1;">ANNULER</button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('editPanierQteInput').focus();
    document.getElementById('editPanierQteInput').select();
}

function saveEditPanierProduit() {
    const newQte = document.getElementById('editPanierQteInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÃ‰ VALIDE', 'warning');
        return;
    }
    
    panierProduits[editingPanierProduitIndex].qte = parseInt(newQte);
    savePanierProduits();
    updatePanierDisplay();
    editingPanierProduitIndex = -1;
    showAlert('QUANTITÃ‰ MODIFIÃ‰E AVEC SUCCÃˆS', 'success');
}

function cancelEditPanierProduit() {
    editingPanierProduitIndex = -1;
    updatePanierDisplay();
}

function deletePanierProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT DU PANIER?', () => {
        panierProduits.splice(index, 1);
        savePanierProduits();
        updatePanierDisplay();
        showAlert('PRODUIT SUPPRIMÃ‰ DU PANIER AVEC SUCCÃˆS', 'success');
    });
}

function clearAllPanier() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUT LE PANIER?', function() {
        panierProduits = [];
        savePanierProduits();
        updatePanierDisplay();
        showAlert('PANIER VIDÃ‰ AVEC SUCCÃˆS', 'success');
    });
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
// ============================================

function openQuickRetirerModal(code, adresse, nomProduit) {
    currentQuickProduct = {
        code: code,
        adresse: adresse,
        nom: nomProduit,
        type: 'retirer'
    };
    
    const infoDiv = document.getElementById('quickRetirerInfo');
    infoDiv.innerHTML = `
        <div class="code" style="color: #2c3e50 !important;">CODE: ${code}</div>
        <div class="name" style="color: #2c3e50 !important;">NOM: ${nomProduit}</div>
        <div class="adresse" style="color: #FFA500 !important;">ADRESSE: ${adresse}</div>
    `;
    
    document.getElementById('quickRetirerQte1Input').value = '';
    document.getElementById('quickRetirerDlc1Input').value = '';
    document.getElementById('quickRetirerQte2Input').value = '';
    document.getElementById('quickRetirerDlc2Input').value = '';
    document.getElementById('quickRetirerQte3Input').value = '';
    document.getElementById('quickRetirerDlc3Input').value = '';
    
    document.getElementById('quickRetirerModal').style.display = 'flex';
}

function closeQuickRetirerModal() {
    document.getElementById('quickRetirerModal').style.display = 'none';
    currentQuickProduct = null;
}

function quickRetirerProduit() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'retirer') {
        return;
    }
    
    const qte1Input = document.getElementById('quickRetirerQte1Input');
    const dlc1Input = document.getElementById('quickRetirerDlc1Input');
    const qte2Input = document.getElementById('quickRetirerQte2Input');
    const dlc2Input = document.getElementById('quickRetirerDlc2Input');
    const qte3Input = document.getElementById('quickRetirerQte3Input');
    const dlc3Input = document.getElementById('quickRetirerDlc3Input');
    
    const dlc1 = dlc1Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÃ‰', 'warning');
        return;
    }
    
    const existingIndex = retirerProduits.findIndex(p => p.code === currentQuickProduct.code && p.adresse === currentQuickProduct.adresse);
    
    if (existingIndex >= 0) {
        retirerProduits[existingIndex] = {
            code: currentQuickProduct.code,
            adresse: currentQuickProduct.adresse,
            nom: currentQuickProduct.nom,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        };
        showAlert('PRODUIT MIS Ã€ JOUR AVEC SUCCÃˆS', 'success');
    } else {
        retirerProduits.push({
            code: currentQuickProduct.code,
            adresse: currentQuickProduct.adresse,
            nom: currentQuickProduct.nom,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        });
        showAlert('PRODUIT AJOUTÃ‰ AVEC SUCCÃˆS', 'success');
    }
    
    saveRetirerProduits();
    updateRetirerDisplay();
    closeQuickRetirerModal();
}

function openQuickCommanderModal(code, nomProduit) {
    currentQuickProduct = {
        code: code,
        nom: nomProduit,
        type: 'commander'
    };
    
    const infoDiv = document.getElementById('quickCommanderInfo');
    infoDiv.innerHTML = `
        <div class="code">CODE: ${code}</div>
        <div class="name">NOM: ${nomProduit}</div>
    `;
    
    document.getElementById('quickCommanderQteInput').value = '';
    document.getElementById('quickCommanderModal').style.display = 'flex';
}

function closeQuickCommanderModal() {
    document.getElementById('quickCommanderModal').style.display = 'none';
    currentQuickProduct = null;
}

function quickCommanderProduit() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'commander') {
        return;
    }
    
    const qteInput = document.getElementById('quickCommanderQteInput');
    const qte = qteInput.value.trim();
    
    if (!qte) {
        showAlert('VEUILLEZ ENTRER LA QUANTITÃ‰ DU PRODUIT', 'warning');
        return;
    }
    
    const existingIndex = commandeProduits.findIndex(p => p.code === currentQuickProduct.code);
    
    if (existingIndex >= 0) {
        commandeProduits[existingIndex].qte = parseInt(qte);
        showAlert('PRODUIT MIS Ã€ JOUR AVEC SUCCÃˆS', 'success');
    } else {
        commandeProduits.push({
            code: currentQuickProduct.code,
            nom: currentQuickProduct.nom,
            qte: parseInt(qte)
        });
        showAlert('PRODUIT AJOUTÃ‰ AVEC SUCCÃˆS', 'success');
    }
    
    saveCommandeProduits();
    updateCommandeDisplay();
    closeQuickCommanderModal();
}

function openQuickAjouterModal(code, nomProduit, adresse) {
    currentQuickProduct = {
        code: code,
        nom: nomProduit,
        adresse: adresse,
        type: 'ajouter'
    };
    
    const infoDiv = document.getElementById('quickAjouterInfo');
    const displayAdresse = adresse || "Z6P1";
    infoDiv.innerHTML = `
        <div class="adresse" style="color: #FFA500 !important;">ADRESSE: ${displayAdresse}</div>
        <div class="code" style="color: #2c3e50 !important;">CODE: ${code}</div>
        <div class="name" style="color: #2c3e50 !important;">NOM: ${nomProduit}</div>
    `;
    
    if (adresse && adresse.startsWith('Z') && adresse.includes('P')) {
        const match = adresse.match(/Z(\d+)P(\d+)/);
        if (match) {
            document.getElementById('quickAjouterAdresseInput').value = `${match[1]}/${match[2]}`;
        } else {
            document.getElementById('quickAjouterAdresseInput').value = adresse;
        }
    } else {
        document.getElementById('quickAjouterAdresseInput').value = adresse;
    }
    
    // ØªÙØ±ÙŠØº Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)
    document.getElementById('quickAjouterQte1Input').value = '';
    document.getElementById('quickAjouterDlc1Input').value = '';
    document.getElementById('quickAjouterQte2Input').value = '';
    document.getElementById('quickAjouterDlc2Input').value = '';
    document.getElementById('quickAjouterQte3Input').value = '';
    document.getElementById('quickAjouterDlc3Input').value = '';
    
    // ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…Ø¤Ø´Ø± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    document.getElementById('quickAjouterAdresseInput').focus();
    
    document.getElementById('quickAjouterModal').style.display = 'flex';
}

function closeQuickAjouterModal() {
    document.getElementById('quickAjouterModal').style.display = 'none';
    currentQuickProduct = null;
}

function quickAjouterProduit() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'ajouter') {
        return;
    }
    
    const adresseInput = document.getElementById('quickAjouterAdresseInput');
    const qte1Input = document.getElementById('quickAjouterQte1Input');
    const dlc1Input = document.getElementById('quickAjouterDlc1Input');
    const qte2Input = document.getElementById('quickAjouterQte2Input');
    const dlc2Input = document.getElementById('quickAjouterDlc2Input');
    const qte3Input = document.getElementById('quickAjouterQte3Input');
    const dlc3Input = document.getElementById('quickAjouterDlc3Input');
    
    const adresse = adresseInput.value.trim();
    const dlc1 = dlc1Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÃ‰', 'warning');
        return;
    }
    
    const existingIndex = ajouterProduits.findIndex(p => p.adresse === adresseFinale && p.code === currentQuickProduct.code);
    
    if (existingIndex >= 0) {
        showAlert('CE PRODUIT AVEC LE MÃŠME CODE ET ADRESSE EXISTE DÃ‰JÃ€!', 'warning');
        return;
    }
    
    ajouterProduits.push({
        code: currentQuickProduct.code,
        adresse: adresseFinale,
        nom: currentQuickProduct.nom,
        qte1: qte1 ? parseInt(qte1) : 0,
        dlc1: dlc1,
        qte2: qte2 ? parseInt(qte2) : 0,
        dlc2: dlc2,
        qte3: qte3 ? parseInt(qte3) : 0,
        dlc3: dlc3
    });
    showAlert('PRODUIT AJOUTÃ‰ AVEC SUCCÃˆS', 'success');
    
    saveAjouterProduits();
    updateAjouterDisplay();
    closeQuickAjouterModal();
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ø²Ø± Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
// ============================================

function showDatePicker(dateFieldId, productCode) {
    currentDateField = dateFieldId;
    currentProductCodeForDate = productCode;
    
    if (!productCode) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    const dates = getAvailableDatesForProduct(productCode);
    
    const dateList = document.getElementById('dateList');
    dateList.innerHTML = '';
    
    if (dates.length === 0) {
        dateList.innerHTML = '<div class="date-option">AUCUNE DATE DISPONIBLE POUR CE PRODUIT</div>';
    } else {
        dates.forEach(date => {
            const dateOption = document.createElement('div');
            dateOption.className = 'date-option';
            dateOption.textContent = date;
            dateOption.onclick = function() {
                selectDate(date);
            };
            dateList.appendChild(dateOption);
        });
    }
    
    document.getElementById('datePickerModal').style.display = 'flex';
}

function closeDatePicker() {
    document.getElementById('datePickerModal').style.display = 'none';
    currentDateField = null;
    currentProductCodeForDate = null;
}

function selectDate(date) {
    if (currentDateField) {
        const dateInput = document.getElementById(currentDateField);
        if (dateInput) {
            dateInput.value = date;
            dateInput.focus();
        }
    }
    closeDatePicker();
}

// ============================================
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ============================================

// ============================================
// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
// ============================================

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
function showAddressOptions() {
    // Ø¥Ø°Ø§ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ø§ ØªÙØªØ­Ù‡Ø§ Ø«Ø§Ù†ÙŠØ©
    if (document.getElementById('addressOptionsModal')) {
        return;
    }
    
    const code = document.getElementById('retirerCodeInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('retirerCodeInput').focus();
        return;
    }
    
    const addresses = getAddressesForProduct(code);
    
    if (addresses.length === 0) {
        showAlert('AUCUNE ADRESSE TROUVÃ‰E POUR CE PRODUIT', 'warning');
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'addressOptionsModal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>SÃ‰LECTIONNER UNE ADRESSE</h2>
            <p>CHOISISSEZ UNE ADRESSE POUR LE CODE: ${code}</p>
            <div id="addressOptionsList" class="date-options" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAddressOptions()">ANNULER</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const addressList = document.getElementById('addressOptionsList');
    
    addresses.forEach(address => {
        const option = document.createElement('div');
        option.className = 'date-option';
        option.textContent = address;
        option.onclick = function() {
            selectAddress(address);
        };
        addressList.appendChild(option);
    });
    
    modal.style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ù„Ù…Ù†ØªØ¬
function getAddressesForProduct(code) {
    const addresses = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            const adresse = csvCache[i][1] || "";
            if (adresse) {
                addresses.add(adresse);
            }
        }
    }
    
    return Array.from(addresses).sort();
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
function selectAddress(address) {
    document.getElementById('retirerAdresseInput').value = address;
    
    // ØªØ­ÙˆÙŠÙ„ Z6P1 Ø¥Ù„Ù‰ 6/1
    if (address.startsWith('Z') && address.includes('P')) {
        const match = address.match(/Z(\d+)P(\d+)/);
        if (match) {
            document.getElementById('retirerAdresseInput').value = `${match[1]}/${match[2]}`;
        }
    }
    
    closeAddressOptions();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
function closeAddressOptions() {
    const modal = document.getElementById('addressOptionsModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.removeChild(modal);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ø­Ù‚ÙˆÙ„ DLC
function showDateOptionsForRetirer(dlcNumber) {
    // Ø¥Ø°Ø§ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ø§ ØªÙØªØ­Ù‡Ø§ Ø«Ø§Ù†ÙŠØ©
    if (document.getElementById('dateOptionsModalRetirer')) {
        return;
    }
    
    const code = document.getElementById('retirerCodeInput').value.trim();
    const adresse = document.getElementById('retirerAdresseInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('retirerCodeInput').focus();
        return;
    }
    
    if (!adresse) {
        showAlert('VEUILLEZ D\'ABORD ENTRER L\'ADRESSE', 'warning');
        document.getElementById('retirerAdresseInput').focus();
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const dates = getDatesForProductAtAddress(code, adresseFinale);
    
    if (dates.length === 0) {
        showAlert('AUCUNE DATE DISPONIBLE POUR CE PRODUIT Ã€ CETTE ADRESSE', 'warning');
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'dateOptionsModalRetirer';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>SÃ‰LECTIONNER UNE DATE</h2>
            <p>CHOISISSEZ UNE DATE POUR DLC ${dlcNumber} (${code} - ${adresseFinale})</p>
            <div id="dateOptionsListRetirer" class="date-options" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeDateOptionsForRetirer()">ANNULER</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const dateList = document.getElementById('dateOptionsListRetirer');
    
    dates.forEach(date => {
        const option = document.createElement('div');
        option.className = 'date-option';
        option.textContent = date;
        option.onclick = function() {
            selectDateForRetirer(date, dlcNumber);
        };
        dateList.appendChild(option);
    });
    
    modal.style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­Ø¯Ø¯
function getDatesForProductAtAddress(code, adresse) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            // Ø¬Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© 3, 5, 7 (Ø§Ù„Ø¯Ù„Ø§Ù„ Ù‡ÙŠ 1, 3, 5 ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©)
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
function selectDateForRetirer(date, dlcNumber) {
    const dlcField = document.getElementById(`retirerDlc${dlcNumber}Input`);
    if (dlcField) {
        dlcField.value = date;
    }
    
    closeDateOptionsForRetirer();
}
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø­Ù‚Ù„ DLC Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ù†Ø§ÙØ°Ø© Quick Retirer
let currentQuickRetirerDlcField = null;
let currentQuickRetirerDlcNumber = null;

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù†Ø§ÙØ°Ø© Quick Retirer
function showDateOptionsForQuickRetirer(dlcNumber) {
    currentQuickRetirerDlcNumber = dlcNumber;
    
    if (!currentQuickProduct || !currentQuickProduct.code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    const dates = getDatesForProductAtAddress(currentQuickProduct.code, currentQuickProduct.adresse);
    
    if (dates.length === 0) {
        showAlert('AUCUNE DATE DISPONIBLE POUR CE PRODUIT Ã€ CETTE ADRESSE', 'warning');
        return;
    }
    
    const dateList = document.getElementById('dateOptionsContainerQuickRetirer');
    dateList.innerHTML = '';
    
    dates.forEach(date => {
        const option = document.createElement('div');
        option.className = 'date-option';
        option.textContent = date;
        option.onclick = function() {
            selectDateForQuickRetirer(date);
        };
        dateList.appendChild(option);
    });
    
    document.getElementById('dateOptionsModalQuickRetirer').style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù†Ø§ÙØ°Ø© Quick Retirer
function selectDateForQuickRetirer(date) {
    if (currentQuickRetirerDlcNumber) {
        const dlcField = document.getElementById(`quickRetirerDlc${currentQuickRetirerDlcNumber}Input`);
        if (dlcField) {
            dlcField.value = date;
            dlcField.focus();
        }
    }
    
    closeDateOptionsModalQuickRetirer();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù†Ø§ÙØ°Ø© Quick Retirer
function closeDateOptionsModalQuickRetirer() {
    document.getElementById('dateOptionsModalQuickRetirer').style.display = 'none';
    currentQuickRetirerDlcField = null;
    currentQuickRetirerDlcNumber = null;
    document.getElementById('dateOptionsContainerQuickRetirer').innerHTML = '';
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­Ø¯Ø¯
function getDatesForProductAtAddress(code, adresse) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            // Ø¬Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© 3, 5, 7 (Ø§Ù„Ø¯Ù„Ø§Ù„ Ù‡ÙŠ 1, 3, 5 ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©)
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}
// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
function closeDateOptionsForRetirer() {
    const modal = document.getElementById('dateOptionsModalRetirer');
    if (modal) {
        modal.style.display = 'none';
        document.body.removeChild(modal);
    }
}

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„ØµÙØ­Ø© AJOUTER
// ============================================

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
function showAddressOptionsForAjouter() {
    const code = document.getElementById('ajouterCodeInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('ajouterCodeInput').focus();
        return;
    }
    
    const addresses = getAddressesForProduct(code);
    
    if (addresses.length === 0) {
        showAlert('AUCUNE ADRESSE TROUVÃ‰E POUR CE PRODUIT', 'warning');
        return;
    }
    
    const container = document.getElementById('addressOptionsContainerAjouter');
    container.innerHTML = '';
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "NOUVELLE ADRESSE"
    const newAddressOption = document.createElement('div');
    newAddressOption.className = 'date-option';
    newAddressOption.style.background = '#3498db';
    newAddressOption.style.color = 'white';
    newAddressOption.style.borderColor = '#3498db';
    newAddressOption.innerHTML = '<strong>NOUVELLE ADRESSE</strong>';
    newAddressOption.onclick = function() {
        selectAddressForAjouter('');
    };
    container.appendChild(newAddressOption);
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    addresses.forEach(address => {
        const option = document.createElement('div');
        option.className = 'date-option';
        
        // ØªØ­ÙˆÙŠÙ„ Z6P1 Ø¥Ù„Ù‰ 6/1 Ù„Ù„Ø¹Ø±Ø¶
        let displayAddress = address;
        if (address.startsWith('Z') && address.includes('P')) {
            const match = address.match(/Z(\d+)P(\d+)/);
            if (match) {
                displayAddress = `${match[1]}/${match[2]}`;
            }
        }
        
        option.textContent = displayAddress;
        option.setAttribute('data-address', address);
        option.onclick = function() {
            selectAddressForAjouter(address);
        };
        container.appendChild(option);
    });
    
    document.getElementById('addressSelectMessageAjouter').textContent = `CHOISISSEZ UNE ADRESSE POUR LE CODE: ${code}`;
    document.getElementById('addressOptionsModalAjouter').style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
function selectAddressForAjouter(address) {
    if (address === '') {
        // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "NOUVELLE ADRESSE"ØŒ Ø§ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙƒØªØ§Ø¨Ø©
        document.getElementById('ajouterAdresseInput').value = '';
        document.getElementById('ajouterAdresseInput').focus();
    } else {
        // ØªØ­ÙˆÙŠÙ„ Z6P1 Ø¥Ù„Ù‰ 6/1 Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„
        if (address.startsWith('Z') && address.includes('P')) {
            const match = address.match(/Z(\d+)P(\d+)/);
            if (match) {
                document.getElementById('ajouterAdresseInput').value = `${match[1]}/${match[2]}`;
            } else {
                document.getElementById('ajouterAdresseInput').value = address;
            }
        } else {
            document.getElementById('ajouterAdresseInput').value = address;
        }
        
        // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø­Ù‚Ù„
        const input = document.getElementById('ajouterAdresseInput');
        input.style.backgroundColor = "#d6f0ff";
        input.style.borderColor = "#3498db";
        setTimeout(() => {
            input.style.backgroundColor = "";
            input.style.borderColor = "";
        }, 1500);
    }
    
    closeAddressOptionsModalAjouter();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
function closeAddressOptionsModalAjouter() {
    document.getElementById('addressOptionsModalAjouter').style.display = 'none';
    document.getElementById('addressOptionsContainerAjouter').innerHTML = '';
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„Ù„Ù…Ù†ØªØ¬
function getAddressesForProduct(code) {
    const addresses = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            const adresse = csvCache[i][1] || "";
            if (adresse && adresse.trim() !== '') {
                addresses.add(adresse);
            }
        }
    }
    
    // ÙØ±Ø² Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    return Array.from(addresses).sort((a, b) => {
        // ØªØ­ÙˆÙŠÙ„ Z6P1 Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
        const aMatch = a.match(/Z(\d+)P(\d+)/);
        const bMatch = b.match(/Z(\d+)P(\d+)/);
        
        if (aMatch && bMatch) {
            const aZone = parseInt(aMatch[1]);
            const bZone = parseInt(bMatch[1]);
            const aPos = parseInt(aMatch[2]);
            const bPos = parseInt(bMatch[2]);
            
            if (aZone !== bZone) {
                return aZone - bZone;
            }
            return aPos - bPos;
        }
        
        return a.localeCompare(b);
    });
}
// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„ØµÙØ­Ø© AJOUTER
// ============================================

let currentAjouterDlcNumber = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø±Ù‚Ù… Ø­Ù‚Ù„ DLC Ø§Ù„Ø­Ø§Ù„ÙŠ

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
function showDateOptionsForAjouter(dlcNumber) {
    currentAjouterDlcNumber = dlcNumber;
    
    const code = document.getElementById('ajouterCodeInput').value.trim();
    const adresse = document.getElementById('ajouterAdresseInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('ajouterCodeInput').focus();
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    let dates = [];
    
    if (adresseFinale) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù†ÙˆØ§Ù†ØŒ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ø°Ù„Ùƒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯
        dates = getDatesForProductAtAddress(code, adresseFinale);
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†ØªØ¬
    if (dates.length === 0) {
        dates = getAllDatesForProduct(code);
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "NOUVELLE DATE" Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØªÙˆØ§Ø±ÙŠØ®
    if (dates.length === 0) {
        dates = ["NOUVELLE DATE"];
    }
    
    displayDateOptionsForAjouter(dates, dlcNumber, code, adresseFinale);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†ØªØ¬
function getAllDatesForProduct(code) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            // Ø¬Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© 3, 5, 7
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
function displayDateOptionsForAjouter(dates, dlcNumber, code, adresse) {
    const container = document.getElementById('dateOptionsContainerAjouter');
    container.innerHTML = '';
    
    let titleText = `CHOISISSEZ UNE DATE POUR DLC ${dlcNumber}`;
    if (code) {
        titleText += ` (${code})`;
    }
    if (adresse) {
        titleText += ` - ${adresse}`;
    }
    
    document.getElementById('dateSelectMessageAjouter').textContent = titleText;
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "NOUVELLE DATE" ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    const newDateOption = document.createElement('div');
    newDateOption.className = 'date-option';
    newDateOption.style.background = '#3498db';
    newDateOption.style.color = 'white';
    newDateOption.style.borderColor = '#3498db';
    newDateOption.innerHTML = '<strong>NOUVELLE DATE</strong>';
    newDateOption.onclick = function() {
        selectDateForAjouter('');
    };
    container.appendChild(newDateOption);
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    dates.forEach(date => {
        if (date !== "NOUVELLE DATE") {
            const option = document.createElement('div');
            option.className = 'date-option';
            option.textContent = date;
            option.onclick = function() {
                selectDateForAjouter(date);
            };
            container.appendChild(option);
        }
    });
    
    document.getElementById('dateOptionsModalAjouter').style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
function selectDateForAjouter(date) {
    if (currentAjouterDlcNumber) {
        const dlcField = document.getElementById(`ajouterDlc${currentAjouterDlcNumber}Input`);
        if (dlcField) {
            if (date === '') {
                // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "NOUVELLE DATE"ØŒ Ø§ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙƒØªØ§Ø¨Ø©
                dlcField.value = '';
                dlcField.focus();
            } else {
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯
                dlcField.value = date;
                
                // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø­Ù‚Ù„
                dlcField.style.backgroundColor = "#d6f0ff";
                dlcField.style.borderColor = "#3498db";
                setTimeout(() => {
                    dlcField.style.backgroundColor = "";
                    dlcField.style.borderColor = "";
                }, 1500);
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                const qteField = document.getElementById(`ajouterQte${currentAjouterDlcNumber}Input`);
                if (qteField && !qteField.value.trim()) {
                    setTimeout(() => {
                        qteField.focus();
                    }, 100);
                }
            }
        }
    }
    
    closeDateOptionsModalAjouter();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
function closeDateOptionsModalAjouter() {
    document.getElementById('dateOptionsModalAjouter').style.display = 'none';
    currentAjouterDlcNumber = null;
    document.getElementById('dateOptionsContainerAjouter').innerHTML = '';
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­Ø¯Ø¯
function getDatesForProductAtAddress(code, adresse) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            // Ø¬Ù…Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© 3, 5, 7
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}
// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© AJOUTER
// ============================================

let currentQuickAjouterDlcNumber = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø±Ù‚Ù… Ø­Ù‚Ù„ DLC Ø§Ù„Ø­Ø§Ù„ÙŠ

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function showDateOptionsForQuickAjouter(dlcNumber) {
    currentQuickAjouterDlcNumber = dlcNumber;
    
    if (!currentQuickProduct || !currentQuickProduct.code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    const adresseInput = document.getElementById('quickAjouterAdresseInput');
    const adresse = adresseInput ? adresseInput.value.trim() : '';
    
    let adresseFinale = adresse;
    if (adresse && adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    let dates = [];
    
    if (adresseFinale) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù†ÙˆØ§Ù†ØŒ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù† Ø°Ù„Ùƒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯
        dates = getDatesForProductAtAddress(currentQuickProduct.code, adresseFinale);
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†ØªØ¬
    if (dates.length === 0) {
        dates = getAllDatesForProduct(currentQuickProduct.code);
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "NOUVELLE DATE" Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØªÙˆØ§Ø±ÙŠØ®
    if (dates.length === 0) {
        dates = ["NOUVELLE DATE"];
    }
    
    displayDateOptionsForQuickAjouter(dates, dlcNumber);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function displayDateOptionsForQuickAjouter(dates, dlcNumber) {
    const container = document.getElementById('dateOptionsContainerQuickAjouter');
    container.innerHTML = '';
    
    let titleText = `CHOISISSEZ UNE DATE POUR DLC ${dlcNumber}`;
    if (currentQuickProduct && currentQuickProduct.code) {
        titleText += ` (${currentQuickProduct.code})`;
    }
    if (currentQuickProduct && currentQuickProduct.adresse) {
        titleText += ` - ${currentQuickProduct.adresse}`;
    }
    
    document.getElementById('dateSelectMessageQuickAjouter').textContent = titleText;
    
    // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "NOUVELLE DATE" ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    const newDateOption = document.createElement('div');
    newDateOption.className = 'date-option';
    newDateOption.style.background = '#3498db';
    newDateOption.style.color = 'white';
    newDateOption.style.borderColor = '#3498db';
    newDateOption.innerHTML = '<strong>NOUVELLE DATE</strong>';
    newDateOption.onclick = function() {
        selectDateForQuickAjouter('');
    };
    container.appendChild(newDateOption);
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    dates.forEach(date => {
        if (date !== "NOUVELLE DATE") {
            const option = document.createElement('div');
            option.className = 'date-option';
            option.textContent = date;
            option.onclick = function() {
                selectDateForQuickAjouter(date);
            };
            container.appendChild(option);
        }
    });
    
    document.getElementById('dateOptionsModalQuickAjouter').style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function selectDateForQuickAjouter(date) {
    if (currentQuickAjouterDlcNumber) {
        const dlcField = document.getElementById(`quickAjouterDlc${currentQuickAjouterDlcNumber}Input`);
        if (dlcField) {
            if (date === '') {
                // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "NOUVELLE DATE"ØŒ Ø§ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙƒØªØ§Ø¨Ø©
                dlcField.value = '';
                dlcField.focus();
            } else {
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯
                dlcField.value = date;
                
                // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø­Ù‚Ù„
                dlcField.style.backgroundColor = "#d6f0ff";
                dlcField.style.borderColor = "#3498db";
                setTimeout(() => {
                    dlcField.style.backgroundColor = "";
                    dlcField.style.borderColor = "";
                }, 1500);
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                const qteField = document.getElementById(`quickAjouterQte${currentQuickAjouterDlcNumber}Input`);
                if (qteField && !qteField.value.trim()) {
                    setTimeout(() => {
                        qteField.focus();
                    }, 100);
                }
            }
        }
    }
    
    closeDateOptionsModalQuickAjouter();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function closeDateOptionsModalQuickAjouter() {
    document.getElementById('dateOptionsModalQuickAjouter').style.display = 'none';
    currentQuickAjouterDlcNumber = null;
    document.getElementById('dateOptionsContainerQuickAjouter').innerHTML = '';
}

// ... ÙƒÙ„ ÙƒÙˆØ¯ JavaScript Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ...

// ========== Ø£Ø¶Ù Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ==========

// 1. Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function hideSplashScreen() {
    const splash = document.getElementById('webtonotiveSplash');
    if (splash) {
        splash.style.opacity = '0';
        setTimeout(() => {
            splash.style.display = 'none';
            // ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            document.getElementById('mainPage').style.display = 'block';
        }, 500);
    }
}

// 2. Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
function setupConnectionMonitor() {
    const statusElement = document.createElement('div');
    statusElement.id = 'connectionStatus';
    statusElement.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        z-index: 9999;
        color: white;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        display: none;
    `;
    document.body.appendChild(statusElement);
    
    function updateStatus() {
        if (navigator.onLine) {
            statusElement.textContent = 'ğŸŒ EN LIGNE';
            statusElement.style.background = '#27ae60';
            statusElement.style.display = 'block';
            setTimeout(() => statusElement.style.display = 'none', 3000);
        } else {
            statusElement.textContent = 'ğŸ“¶ HORS LIGNE';
            statusElement.style.background = '#e74c3c';
            statusElement.style.display = 'block';
        }
    }
    
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    updateStatus();
}

// 3. ØªØ¹Ø¯ÙŠÙ„ initApp() Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
function initApp() {
    console.log('ğŸš€ DÃ‰MARRAGE APPLICATION');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹
    hideSplashScreen();
    
    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    document.getElementById('mainPage').style.display = 'block';
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    loadAllDataFromStorage();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    setupConnectionMonitor();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ù†ØªØ±Ù†Øª
    if (navigator.onLine) {
        updateAllData().catch(err => {
            console.log('âš ï¸ Mise Ã  jour Ã©chouÃ©e:', err.message);
        });
    } else {
        showAlert('ğŸ“¶ MODE HORS LIGNE - DONNÃ‰ES LOCALES', 'info');
    }
    
    // Ø¨Ù‚ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ
    window.addEventListener('scroll', toggleScrollButtons);
    loadCommandeProduits();
    loadAjouterProduits();
    loadCasseProduits();
    loadRetirerProduits();
    loadPanierProduits();
    setupDateInput();
    setupQuantityInputs();
    setupDatePickerButtons();
    
    console.log('âœ… APPLICATION PRÃŠTE');
}

// 4. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = function() {
    // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
    setTimeout(initApp, 100);
};

// ========== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ==========

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
// ============================================
window.onload = function() {
    initApp();
};

// Ù…Ù†Ø¹ Ù†Ø³Ø® Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
document.addEventListener('copy', function(e) {
    const selection = window.getSelection();
    const selectedText = selection.toString();
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø·
    const isCode = /^\d+$/.test(selectedText.trim());
    const isInputField = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';
    
    if (!isCode && !isInputField && selectedText.length > 0) {
        e.preventDefault();
        showAlert('LA COPIE EST INTERDITE SAUF POUR LES CODES PRODUITS', 'warning');
    }
});

// Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø·Ø¹
document.addEventListener('cut', function(e) {
    e.preventDefault();
    showAlert('LE COUPER EST INTERDIT', 'warning');
});

// Ù…Ù†Ø¹ Ø§Ù„Ù„ØµÙ‚
document.addEventListener('paste', function(e) {
    const target = e.target;
    const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
    
    if (!isInputField) {
        e.preventDefault();
        showAlert('LE COPIER-COLLER EST INTERDIT', 'warning');
    }
});
</script>
</body>
