<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MENU PRINCIPAL</title>
<!-- مكتبة QuaggaJS الأساسية -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<!-- إضافة مكتبة SheetJS/XLSX لإنشاء ملفات Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- إضافة مكتبة Html5Qrcode للماسح الضوئي -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
/* إعدادات الخط العامة */
* {
    font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif !important;
    font-weight: 600 !important;
}

body {
    background: linear-gradient(135deg, #f0f4f8, #ffffff);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* تعديل العنوان الرئيسي - زيادة المسافة وتغيير اللون */
h1 {
    text-align: center;
    margin-top: 40px !important; /* زيادة المسافة */
    font-size: 28px;
    text-transform: uppercase;
    color: #1E3A8A !important; /* اللون الأزرق الملكي */
}

/* زيادة المسافة بين GESTION RESERVE والأزرار */
.main-title {
    text-align: center;
    margin-top: 40px !important; /* زيادة المسافة */
    margin-bottom: 30px !important; /* زيادة المسافة */
    font-size: 32px;
    font-weight: 900;
    text-transform: uppercase;
    color: #1E3A8A !important; /* اللون الأزرق الملكي */
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

/* تغيير ألوان النصوص في أسفل الصفحة */
.footer-line {
    font-size: 18px;
    font-weight: 700;
    color: #1E3A8A !important; /* اللون الأزرق الملكي */
    margin: 5px 0;
    text-transform: uppercase;
}

.footer-developer {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
    margin-top: 10px;
    text-transform: uppercase;
}

/* تغيير لون زر PARTAGER إلى أزرق */
.partager-btn {
    padding: 10px 20px;
    background: #3498db !important; /* اللون الأزرق */
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    margin-top: 10px;
    text-transform: uppercase;
}

.partager-btn:hover {
    background: #2980b9 !important; /* اللون الأزرق الداكن */
}

/* تغيير لون زر الهبوط إلى الأسفل */
.bottomBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #3498db !important; /* نفس لون زر الصعود */
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
}

.bottomBtn:hover {
    background: #2980b9 !important; /* نفس لون زر الصعود */
    transform: scale(1.1);
}

/* منع النسخ لجميع العناصر ما عدا كود المنتج */
* {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* السماح بالنسخ لكود المنتج فقط */
.codeRow, .produit-code, input[type="tel"] {
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
}

/* زر التقويم الجديد لحقول التواريخ */
.date-picker-btn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    width: 40px;
    height: 40px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 5px;
    transition: all 0.3s;
}

.date-picker-btn:hover {
    background: #2980b9;
    transform: scale(1.1);
}

/* تحسين عرض حقول التاريخ مع زر التقويم */
.retirer-input-row, .casse-input-row {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    align-items: center;
}

.retirer-input-row input, .casse-input-row input {
    flex: 1;
}

/* نافذة اختيار التواريخ */
.date-picker-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 3000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.date-picker-content {
    background: white;
    padding: 25px;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.3s ease-out;
    position: relative;
    overflow: hidden;
}

.date-picker-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

.date-picker-title {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
}

.date-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 15px 0;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 10px;
}

.date-option {
    background: #f8f9fa;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-weight: 500;
    color: #2c3e50;
    text-transform: uppercase;
}

.date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

/* إبقاء جميع الأنماط الأخرى كما هي */
.container {
    width: 90%;
    max-width: 500px;
    margin: 20px auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 15px;
    position: relative;
    overflow: visible;
}

.btn {
    padding: 18px 12px;
    text-align: center;
    border-radius: 10px;
    font-size: 18px;
    color: white;
    text-decoration: none;
    transition: 0.25s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    border: none;
    text-transform: uppercase;
    height: 85px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.3;
    word-break: break-word;
    overflow: hidden;
}

.btn:hover { transform: scale(1.03); }

.info     { background: #3498db; }
.changement { background: #FFA500; }
.adresse  { background: #9b59b6; }
.rupture  { background: #e74c3c; }
.dlc      { background: #f39c12; }
.commande { background: #1abc9c; }
.ajouter  { background: #27ae60; }
.retirer  { background: #34495e; }
.casse    { background: #d35400; }
.panier   { background: #2ecc71; }
.partager { background: #9b59b6; }

#infoPage, #adressePage, #rupturePage, #dlcPage, #commandePage, #ajouterPage, #cassePage, #retirerPage, #changementPrixPage, #panierPage { 
    display: none; 
    padding: 20px; 
    animation: fadeIn 0.3s ease-in-out; 
    max-width: 600px;
    margin: 0 auto;
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

.adresseCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #f39c12;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.adresseCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #f39c12, #e67e22);
}

.adresseCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.adresseCard .infoRow, .adresseCard .codeRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 16px;
    letter-spacing: 0.5px;
    border: 1px solid #e0e0e0;
    text-transform: uppercase;
}

.adresseCard .nameRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 14px;
    font-style: normal;
    border: 1px solid #e0e0e0;
    text-transform: uppercase;
}

.adresseCard .qteRow {
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 13px;
    text-transform: uppercase;
}

.adresseCard .qteRow .qte-value {
    color: #27ae60;
    font-size: 14px;
}

.adresseCard .qteRow .date-value {
    color: #e74c3c;
    font-size: 14px;
}

.adresseCard .qteRow .label {
    color: #7f8c8d;
    font-size: 13px;
}

.reserveCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.reserveCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9);
}

.reserveCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.reserveCard .dataRow {
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.reserveCard .dataRow .label {
    color: #7f8c8d;
}

.reserveCard .dataRow .value {
    color: #2c3e50;
}

.totalSummaryCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.totalSummaryCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9);
}

.totalSummaryCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.totalSummaryCard .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #27ae60;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    border: 1px solid #bdc3c7;
    font-size: 15px;
    text-transform: uppercase;
}

.totalRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 12px;
    color: #27ae60;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    border: 1px solid #bdc3c7;
    font-size: 15px;
    text-transform: uppercase;
}

.totalRow .total-value {
    color: #27ae60;
    font-size: 16px;
    margin-left: 5px;
}

.search-card {
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    color: white;
    transition: transform 0.3s, box-shadow 0.3s;
    background: white;
    border-left: 3px solid #3498db !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.search-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.search-card:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
}

.input-row { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
    gap: 8px;
}

#codeInput, #adresseInput, #commandeCodeInput, #commandeQteInput, #ajouterCodeInput, #ajouterAdresseInput, #ajouterQte1Input, #ajouterDlc1Input, #ajouterQte2Input, #ajouterDlc2Input, #ajouterQte3Input, #ajouterDlc3Input, #casseCodeInput, #casseQteInput, #casseDateInput, #retirerCodeInput, #retirerAdresseInput, #retirerQteInput, #retirerDateInput, #changementCodeInput, #panierCodeInput, #panierQteInput {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #bbb;
    padding: 8px;
    font-size: 16px;
    background: #f0f4f8;
    text-align: center;
    color: #1e2a38;
    box-sizing: border-box;
    text-transform: uppercase;
}

button.scan, button.searchBtn, .scan-small {
    padding: 8px 12px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    width: 100%;
    margin-top: 8px;
    height: 50px;
    text-transform: uppercase;
}

.scan-small {
    width: 100px;
    height: 50px;
    margin-top: 0;
}

button.scan:hover, button.searchBtn:hover, .scan-small:hover {
    background: #2980b9;
}

.backBtn { 
    display: block;
    margin: 0 auto 20px auto;
    cursor: pointer; 
    color: #fff; 
    font-size: 16px; 
    text-decoration: none;
    text-transform: uppercase;
    padding: 12px 24px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s;
    border: none;
    width: auto;
    text-align: center;
}

.backBtn:hover { 
    background: linear-gradient(135deg, #2980b9, #1c6ea4);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
}

.backBtn::before {
    content: '← ';
    margin-right: 8px;
}

#adresseContainer, #resultatsContainer, #infoDataContainer, #ruptureContainer, #dlcContainer, #commandeContainer, #commandeProduitsContainer, #ajouterContainer, #ajouterProduitsContainer, #casseContainer, #casseProduitsContainer, #retirerContainer, #retirerProduitsContainer, #changementInfoContainer, #changementResultsContainer, #panierContainer, #panierProduitsContainer { margin-top: 6px; margin-bottom: 30px; }

.search-type {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.search-type-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    text-transform: uppercase;
}

.search-type-btn.active {
    background: #3498db;
    color: white;
}

.search-type-btn:hover {
    background: #2980b9;
    color: white;
}

.departement-select {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.departement-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    width: 48%;
    text-transform: uppercase;
}

.departement-btn.active {
    background: #3498db;
    color: white;
}

.departement-btn:hover {
    background: #2980b9;
    color: white;
}

.month-select {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.month-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    width: 100%;
    text-transform: uppercase;
}

.month-btn.active {
    background: #3498db;
    color: white;
}

.month-btn:hover {
    background: #2980b9;
    color: white;
}

.topBtn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
}

.topBtn:hover {
    background: #2980b9;
    transform: scale(1.1);
}

.commande-card, .ajouter-card, .casse-card, .retirer-card, .panier-card {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.commande-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.ajouter-card, .casse-card, .retirer-card, .panier-card {
    border-left: 3px solid #3498db !important;
}

.ajouter-card::before, .casse-card::before, .retirer-card::before, .panier-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.commande-input-row, .ajouter-input-row, .casse-input-row, .retirer-input-row, .panier-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.commande-input-row input, .ajouter-input-row input, .casse-input-row input, .retirer-input-row input, .panier-input-row input {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 16px;
    text-align: center;
    text-transform: uppercase;
}

.ajouter-qte-input, .ajouter-dlc-input, .casse-date-input, .retirer-date-input {
    max-width: 150px;
}

.commande-btn, .ajouter-btn, .casse-btn, .retirer-btn, .panier-btn {
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    margin-top: 10px;
    text-transform: uppercase;
}

.commande-btn:hover {
    background: #2980b9;
}

.ajouter-btn {
    background: #27ae60;
}

.ajouter-btn:hover {
    background: #219653;
}

.casse-btn {
    background: #d35400;
}

.casse-btn:hover {
    background: #a04000;
}

.retirer-btn {
    background: #34495e;
}

.retirer-btn:hover {
    background: #2c3e50;
}

.panier-btn {
    background: #2ecc71;
}

.panier-btn:hover {
    background: #27ae60;
}

.commande-btn.secondary, .ajouter-btn.secondary, .casse-btn.secondary, .retirer-btn.secondary, .panier-btn.secondary {
    background: #e74c3c;
    border: 2px solid #c0392b;
}

.commande-btn.secondary:hover, .ajouter-btn.secondary:hover, .casse-btn.secondary:hover, .retirer-btn.secondary:hover, .panier-btn.secondary:hover {
    background: #c0392b;
}

.commande-summary, .ajouter-summary, .casse-summary, .retirer-summary, .panier-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    text-align: center;
    color: #2c3e50;
    border: 2px solid #3498db;
    text-transform: uppercase;
}

.ajouter-summary {
    border: 2px solid #27ae60;
}

.casse-summary {
    border: 2px solid #d35400;
}

.retirer-summary {
    border: 2px solid #34495e;
}

.panier-summary {
    border: 2px solid #2ecc71;
}

.commande-summary span, .ajouter-summary span, .casse-summary span, .retirer-summary span, .panier-summary span {
    color: #27ae60;
    font-size: 20px;
}

.produit-card {
    background: white;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db;
    position: relative;
    text-transform: uppercase;
}

.produit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ecf0f1;
}

.produit-code {
    background: #3498db;
    color: white;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 14px;
}

.produit-actions {
    display: flex;
    gap: 8px;
}

.produit-edit {
    background: #f39c12;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.produit-edit:hover {
    background: #d68910;
    transform: scale(1.1);
}

.produit-delete {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.produit-delete:hover {
    background: #c0392b;
    transform: scale(1.1);
}

.produit-name {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    color: #2c3e50;
    text-align: center;
}

.produit-qte {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
}

.qte-label {
    color: #7f8c8d;
}

.qte-value {
    color: #27ae60;
    font-size: 18px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: white;
    padding: 40px 30px;
    border-radius: 16px;
    max-width: 450px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.3s ease-out;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal h2 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 24px;
    text-transform: uppercase;
}

.modal p {
    color: #5a6c7d;
    font-size: 16px;
    line-height: 1.5;
    margin: 0;
    padding: 0 10px;
}

.modal-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    justify-content: center;
}

.modal-btn {
    flex: 1;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    max-width: 160px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-transform: uppercase;
}

.modal-btn.confirm {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.modal-btn.confirm:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.modal-btn.cancel {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.modal-btn.cancel:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.date-select-modal .modal-content {
    max-width: 400px;
}

.date-options {
    max-height: 300px;
    overflow-y: auto;
    margin: 20px 0;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 10px;
}

.date-option {
    background: #f8f9fa;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    text-transform: uppercase;
}

.date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

.date-option.selected {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
}

.alert-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    border-left: 3px solid #e74c3c;
    z-index: 3000;
    animation: alertSlideIn 0.3s ease-out;
    max-width: 350px;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
    text-transform: uppercase;
}

.alert-message.success {
    border-left-color: #27ae60;
}

.alert-message.info {
    border-left-color: #3498db;
}

.alert-message.warning {
    border-left-color: #f39c12;
}

.alert-icon {
    font-size: 20px;
}

@keyframes alertSlideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.ajouter-input-row.small-row {
    flex-wrap: nowrap;
    justify-content: space-between;
}

.ajouter-small-input {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 6px 8px;
    font-size: 14px;
    text-align: center;
    min-width: 0;
    box-sizing: border-box;
    text-transform: uppercase;
}

.ajouter-small-input.qte {
    max-width: 80px;
    margin-right: 5px;
}

.ajouter-small-input.date {
    flex: 2;
    min-width: 120px;
    margin-left: 5px;
}

.action-buttons {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    justify-content: center;
}

.action-btn {
    flex: 1;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
    text-align: center;
    color: white;
    min-width: 80px;
}

.action-btn.retirer {
    background: #34495e;
}

.action-btn.retirer:hover {
    background: #2c3e50;
    transform: translateY(-2px);
}

.action-btn.commander {
    background: #1abc9c;
}

.action-btn.commander:hover {
    background: #16a085;
    transform: translateY(-2px);
}

.action-btn.ajouter {
    background: #27ae60;
}

.action-btn.ajouter:hover {
    background: #219653;
    transform: translateY(-2px);
}

.quick-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.quick-modal-content {
    background: white;
    padding: 30px 25px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.3s ease-out;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.quick-modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

.quick-modal-title {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 22px;
    text-transform: uppercase;
}

.quick-modal-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 3px solid #3498db;
}

.quick-modal-info .code {
    color: #3498db;
    font-size: 16px;
    margin-bottom: 5px;
}

.quick-modal-info .name {
    color: #2c3e50;
    font-size: 14px;
    margin-bottom: 5px;
}

.quick-modal-info .adresse {
    color: #e74c3c;
    font-size: 16px;
}

.quick-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.quick-input-row input {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 16px;
    text-align: center;
    text-transform: uppercase;
}

.quick-input-row input:focus {
    outline: none;
    border-color: #3498db;
}

.quick-modal-buttons {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    justify-content: center;
}

.quick-modal-btn {
    flex: 1;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    max-width: 160px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-transform: uppercase;
}

.quick-modal-btn.confirm {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.quick-modal-btn.confirm:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.quick-modal-btn.cancel {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.quick-modal-btn.cancel:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.quick-modal-btn.retirer {
    background: linear-gradient(135deg, #34495e, #2c3e50);
    color: white;
}

.quick-modal-btn.retirer:hover {
    background: linear-gradient(135deg, #2c3e50, #1c2836);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(52, 73, 94, 0.3);
}

.quick-modal-btn.commander {
    background: linear-gradient(135deg, #1abc9c, #16a085);
    color: white;
}

.quick-modal-btn.commander:hover {
    background: linear-gradient(135deg, #16a085, #138d75);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(26, 188, 156, 0.3);
}

.quick-modal-btn.ajouter {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.quick-modal-btn.ajouter:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.infoChangementCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #FFA500;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.infoChangementCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #FFA500, #FF8C00);
}

.infoChangementCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.infoChangementCard .infoRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.infoChangementCard .lot-permanent {
    color: #27ae60 !important;
}

.infoChangementCard .lot-promo {
    color: #e74c3c !important;
}

.resultatChangementCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    font-weight: bold;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.resultatChangementCard.permanent {
    border-left: 3px solid #27ae60;
}

.resultatChangementCard.permanent::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #27ae60, #219653);
}

.resultatChangementCard.promo {
    border-left: 3px solid #e74c3c;
}

.resultatChangementCard.promo::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #e74c3c, #c0392b);
}

.resultatChangementCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.resultatChangementCard .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.resultatChangementCard .dataRow .label {
    color: #7f8c8d;
}

.resultatChangementCard .dataRow .value {
    color: #2c3e50;
}

.totalChangementCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #FFA500;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.totalChangementCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #FFA500, #FF8C00);
}

.totalChangementCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.totalChangementCard .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.totalChangementCard .dataRow .total-value {
    color: #FFA500;
    font-size: 16px;
}

.quick-modal-content.retirer-modal {
    border-left: none !important;
}

.quick-modal-content.retirer-modal::before {
    display: none !important;
}

.quick-retirer-info {
    background: white !important;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #ddd !important;
    text-align: left;
}

.quick-retirer-info .code {
    color: #2c3e50 !important;
    font-size: 16px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-retirer-info .name {
    color: #2c3e50 !important;
    font-size: 14px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-retirer-info .adresse {
    color: #FFA500 !important;
    font-size: 16px;
    text-align: center;
}

.quick-ajouter-info {
    background: white !important;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #ddd !important;
    text-align: left;
}

.quick-ajouter-info .adresse {
    color: #FFA500 !important;
    font-size: 16px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-ajouter-info .code {
    color: #2c3e50 !important;
    font-size: 16px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-ajouter-info .name {
    color: #2c3e50 !important;
    font-size: 14px;
    margin-bottom: 10px;
    text-align: center;
}

.quick-ajouter-label {
    color: #7f8c8d;
    font-size: 12px;
    margin-bottom: 5px;
    text-align: left;
}

.quick-ajouter-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.quick-ajouter-input-row input {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 14px;
    text-align: center;
    text-transform: uppercase;
}

.quick-ajouter-input-row.small-row {
    flex-wrap: nowrap;
}

.quick-ajouter-small-input {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 6px 8px;
    font-size: 14px;
    text-align: center;
    min-width: 0;
    box-sizing: border-box;
    text-transform: uppercase;
}

.quick-ajouter-small-input.qte {
    max-width: 80px;
}

.quick-ajouter-small-input.date {
    flex: 2;
    min-width: 120px;
}

.panier-produit-card {
    background: white;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #2ecc71;
    position: relative;
    text-transform: uppercase;
}

.panier-produit-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #2ecc71, #27ae60);
}

.panier-produit-card .produit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ecf0f1;
}

.panier-produit-card .produit-code {
    background: #2ecc71;
    color: white;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 14px;
}

.panier-produit-card .produit-name {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    color: #2c3e50;
    text-align: center;
}

.panier-produit-card .produit-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
}

.panier-produit-card .detail-item {
    text-align: center;
    flex: 1;
}

.panier-produit-card .detail-label {
    color: #7f8c8d;
    font-size: 12px;
    margin-bottom: 5px;
}

.panier-produit-card .detail-value {
    color: #2c3e50;
    font-size: 16px;
}

.panier-produit-card .detail-value.prix {
    color: #27ae60;
}

.panier-produit-card .detail-value.total {
    color: #e74c3c;
    font-size: 18px;
}

.panier-total-card {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #2ecc71;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.panier-total-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #2ecc71, #27ae60);
}

.panier-total-card h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.panier-total-card .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.panier-total-card .dataRow .label {
    color: #7f8c8d;
}

.panier-total-card .dataRow .value {
    color: #2c3e50;
}

.panier-total-card .dataRow .total-value {
    color: #2ecc71;
    font-size: 16px;
}

/* تعديل 2: الأنماط الجديدة للماسح الضوئي */
#scannerOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#scannerFrame {
    width: 90%;
    height: 70%;
    max-width: 600px;
    max-height: 600px;
    border: 4px solid #3498db;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
    position: relative;
}

#scannerFrame::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(0deg, rgba(0,0,0,0) 50%, rgba(255,255,255,0.1) 50%);
    background-size: 100% 4px;
    pointer-events: none;
    animation: scanLine 2s linear infinite;
}

@keyframes scanLine {
    0% { background-position: 0 -100%; }
    100% { background-position: 0 100%; }
}

#scannerLoading {
    display: none;
    color: white;
    font-size: 20px;
    margin-top: 20px;
    text-align: center;
}

#scannerLoading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#closeScanner {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 30px;
    cursor: pointer;
    z-index: 10000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#closeScanner:hover {
    background: #c0392b;
    transform: scale(1.1);
}

/* زر PARTAGER */
.partager-card {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #9b59b6 !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.partager-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #9b59b6, #8e44ad) !important;
}

/* تعديل 5: مربع التحديد في كروت نتائج البحث */
.checkbox-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

.adresse-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid #e74c3c;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #e74c3c;
    transition: all 0.2s;
}

.adresse-checkbox.checked {
    background: #e74c3c;
    color: white;
}

.adresse-checkbox:hover {
    transform: scale(1.1);
    box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
}

/* تعديل زر SCANNER في صفحة CONTINUE D'ADRESSE */
#adressePage .search-card button.searchBtn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    height: 50px;
    text-transform: uppercase;
    width: 100%;
    margin-top: 8px;
}

#adressePage .search-card button.searchBtn:hover {
    background: #2980b9;
}

/* أنماط جديدة للعناوين في الصفحة الرئيسية */
.footer-info {
    text-align: center;
    margin-top: 40px;
    padding-bottom: 40px;
}

.footer-spacing {
    height: 60px;
}

@media (max-width: 480px) {
    .container {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .btn {
        padding: 16px 10px;
        font-size: 16px;
        height: 75px;
    }
    
    .input-row {
        flex-direction: column;
    }
    
    #codeInput, #adresseInput, .scan-small {
        width: 100%;
    }
    
    .commande-input-row, .ajouter-input-row, .casse-input-row, .retirer-input-row, .panier-input-row {
        flex-direction: column;
    }
    
    .ajouter-qte-input, .ajouter-dlc-input, .casse-date-input, .retirer-date-input {
        max-width: 100%;
    }
    
    .modal-content {
        padding: 30px 20px;
    }
    
    .modal-buttons {
        flex-direction: column;
    }
    
    .modal-btn {
        max-width: 100%;
    }
    
    .alert-message {
        left: 20px;
        right: 20px;
        max-width: none;
    }
    
    .produit-actions {
        gap: 5px;
    }
    
    .ajouter-input-row.small-row {
        flex-wrap: wrap;
    }
    
    .ajouter-small-input.qte,
    .ajouter-small-input.date {
        max-width: 100%;
        width: 100%;
        margin: 5px 0;
    }
    
    .backBtn {
        padding: 10px 20px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
    }
    
    .quick-modal-content {
        padding: 20px 15px;
    }
    
    .quick-input-row {
        flex-direction: column;
    }
    
    .quick-modal-buttons {
        flex-direction: column;
    }
    
    .quick-modal-btn {
        max-width: 100%;
    }
    
    #scannerFrame {
        width: 95%;
        height: 60%;
        max-width: 400px;
        max-height: 400px;
    }
}

/* تحسينات للشاشات الصغيرة أقل من 400px */
@media (max-width: 400px) {
    .container {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 95%;
        padding: 10px;
    }
    
    .btn {
        padding: 14px 8px;
        font-size: 15px;
        height: 70px;
        line-height: 1.2;
    }
    
    h1 {
        font-size: 22px;
        margin-top: 15px;
    }
    
    .search-card, .commande-card, .ajouter-card, .casse-card, .retirer-card, .panier-card, .partager-card {
        padding: 12px;
    }
    
    .adresseCard, .reserveCard, .totalSummaryCard, .infoChangementCard, .resultatChangementCard, .totalChangementCard, .panier-produit-card, .panier-total-card {
        padding: 10px;
    }
    
    .adresseCard h3, .reserveCard h3, .totalSummaryCard h3, .infoChangementCard h3, .resultatChangementCard h3, .totalChangementCard h3, .panier-total-card h3 {
        font-size: 16px;
    }
    
    .backBtn {
        padding: 8px 16px;
        font-size: 13px;
        margin-bottom: 10px;
    }
    
    #codeInput, #adresseInput, #commandeCodeInput, #commandeQteInput, #ajouterCodeInput, #ajouterAdresseInput, #ajouterQte1Input, #ajouterDlc1Input, #ajouterQte2Input, #ajouterDlc2Input, #ajouterQte3Input, #ajouterDlc3Input, #casseCodeInput, #casseQteInput, #casseDateInput, #retirerCodeInput, #retirerAdresseInput, #retirerQteInput, #retirerDateInput, #changementCodeInput, #panierCodeInput, #panierQteInput {
        height: 45px;
        font-size: 14px;
    }
    
    button.scan, button.searchBtn, .scan-small {
        height: 45px;
        font-size: 13px;
    }
    
    .modal-content {
        padding: 20px 15px;
    }
    
    .modal h2 {
        font-size: 20px;
    }
    
    .modal-btn {
        padding: 12px 16px;
        font-size: 14px;
    }
    
    #scannerFrame {
        max-width: 320px;
        max-height: 320px;
    }
}
/* نافذة خيارات العناوين */
#addressOptionsModal .modal-content {
    max-width: 450px;
}

#addressOptionsModal .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
}

#addressOptionsModal .date-option:hover {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
    transform: translateX(5px);
}
/* نافذة خيارات التواريخ لـ RETIRER */
#dateOptionsModalRetirer .modal-content {
    max-width: 450px;
}

#dateOptionsModalRetirer .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
}

#dateOptionsModalRetirer .date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

/* أنماط نافذة خيارات العناوين لـ AJOUTER */
#addressOptionsModalAjouter .modal-content {
    max-width: 450px;
}

#addressOptionsModalAjouter .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    text-transform: uppercase;
}

#addressOptionsModalAjouter .date-option:hover {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
    transform: translateX(5px);
}
/* أنماط نافذة خيارات التواريخ لـ AJOUTER */
#dateOptionsModalAjouter .modal-content {
    max-width: 450px;
}

#dateOptionsModalAjouter .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    text-transform: uppercase;
}

#dateOptionsModalAjouter .date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

#dateOptionsModalAjouter .date-option[style*="background: #3498db"] {
    border-color: #3498db;
}

#dateOptionsModalAjouter .date-option[style*="background: #3498db"]:hover {
    background: #2980b9 !important;
    transform: translateX(5px);
}
/* أنماط نافذة خيارات التواريخ للنافذة السريعة AJOUTER */
#dateOptionsModalQuickAjouter .modal-content {
    max-width: 450px;
}

#dateOptionsModalQuickAjouter .date-option {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    text-transform: uppercase;
}

#dateOptionsModalQuickAjouter .date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

#dateOptionsModalQuickAjouter .date-option[style*="background: #3498db"] {
    border-color: #3498db;
}

#dateOptionsModalQuickAjouter .date-option[style*="background: #3498db"]:hover {
    background: #2980b9 !important;
    transform: translateX(5px);
}
/* ============================================
   تحسينات واجهة Quagga Scanner 
   ============================================ */

/* ============================================
   تحسينات واجهة Quagga Scanner - حجم مصغر
   ============================================ */

#scannerOverlay {
    background: rgba(0, 0, 0, 0.95) !important;
    backdrop-filter: blur(5px);
}

#scannerFrame {
    width: 85% !important; /* تصغير العرض */
    height: 45% !important; /* تصغير الارتفاع */
    max-width: 400px !important; /* تقليل الحد الأقصى */
    max-height: 300px !important; /* تقليل الحد الأقصى */
    border: 2px solid #3498db !important; /* تخفيف سمك الحدود */
    border-radius: 12px !important; /* زوايا أقل استدارة */
    overflow: hidden;
    box-shadow: 0 0 20px rgba(52, 152, 219, 0.6) !important;
    position: relative;
}

#scannerBox {
    position: absolute !important;
    top: 20% !important;
    left: 10% !important;
    width: 80% !important;
    height: 60% !important;
    border: 2px solid #00ff00 !important;
    border-radius: 8px !important;
    pointer-events: none;
    z-index: 100;
    box-shadow: 0 0 15px rgba(0, 255, 0, 0.5) !important;
}

.scanner-help-text {
    color: white;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    opacity: 0.8;
}

#closeScanner {
    position: absolute !important;
    top: 15px !important;
    right: 15px !important;
    background: #e74c3c !important;
    color: white !important;
    border: none !important;
    border-radius: 50% !important;
    width: 45px !important; /* تصغير */
    height: 45px !important; /* تصغير */
    font-size: 22px !important; /* تصغير */
    cursor: pointer !important;
    z-index: 10000 !important;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3) !important;
    transition: all 0.3s !important;
}

#closeScanner:hover {
    background: #c0392b !important;
    transform: scale(1.05) !important; /* تخفيف التأثير */
}


/* رسالة التحميل */
#scannerLoading {
    color: white;
    font-size: 18px;
    margin-top: 20px;
    text-align: center;
    font-weight: bold;
}

#scannerLoading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

/* إطار مساعدة إضافي */
.scanner-help-text {
    color: white;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    opacity: 0.8;
}
/* أنماط مربع التحديد في كروت نتائج البحث */
.checkbox-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

.adresse-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid #e74c3c;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #e74c3c;
    transition: all 0.2s;
}

.adresse-checkbox.checked {
    background: #e74c3c;
    color: white;
}

.adresse-checkbox:hover {
    transform: scale(1.1);
    box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
}
/* ============================================
   أنماط للتحقق من صحة التاريخ
   ============================================ */
.date-error-message {
    color: #e74c3c !important;
    font-size: 12px !important;
    margin-top: 2px !important;
    text-align: center !important;
    font-weight: bold !important;
    background: rgba(231, 76, 60, 0.1) !important;
    padding: 3px !important;
    border-radius: 4px !important;
    border: 1px solid #e74c3c !important;
}

/* تنسيق الحقول غير الصالحة */
.date-input-invalid {
    border: 2px solid #e74c3c !important;
    background: #ffe6e6 !important;
    color: #e74c3c !important;
    font-weight: bold !important;
}

/* تنسيق الحقول قريبة الانتهاء */
.date-input-warning {
    border: 2px solid #f39c12 !important;
    background: #fff3cd !important;
    color: #000000 !important;
    font-weight: bold !important;
}

/* تنسيق الحقول الصالحة */
.date-input-valid {
    border: 2px solid #27ae60 !important;
    background: #e8f8ef !important;
}
/* تحديث حجم زر / */
.slash-btn {
    width: 35px;
    height: 35px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    flex-shrink: 0;
    margin-left: 5px;
    padding: 0;
}

.slash-btn:hover {
    background: #2980b9;
    transform: scale(1.05);
}

/* تعديل ارتفاع حقل الإدخال ليناسب الزر الجديد */
.input-with-slash {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #bbb;
    padding: 8px;
    font-size: 16px;
    background: #f0f4f8;
    text-align: center;
    color: #1e2a38;
    box-sizing: border-box;
    text-transform: uppercase;
}

/* تعديل الحاوية */
/* ============================================
   أزرار / لحقول العنوان
   ============================================ */
.slash-btn-container {
    display: flex;
    gap: 5px;
    align-items: center;
    width: 100%;
}

.slash-btn {
    width: 40px;
    height: 40px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    flex-shrink: 0;
    padding: 0;
}

.slash-btn:hover {
    background: #2980b9;
    transform: scale(1.05);
}

.input-with-slash {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #bbb;
    padding: 8px;
    font-size: 16px;
    background: #f0f4f8;
    text-align: center;
    color: #1e2a38;
    box-sizing: border-box;
    text-transform: uppercase;
}

/* لمنع فتح النوافذ عند الضغط على زر / */
.slash-btn:active,
.slash-btn:focus {
    outline: 2px solid #3498db !important;
    outline-offset: 2px !important;
}

.slash-btn {
    -webkit-tap-highlight-color: transparent !important;
}
/* ============================================
   أنماط نافذة الإشعارات عند فتح التطبيق
   ============================================ */

.startup-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(8px);
}

.startup-modal-content {
    background: white;
    padding: 25px;
    border-radius: 16px;
    max-width: 380px;
    width: 85%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: startupFadeIn 0.4s ease-out;
    position: relative;
    overflow: hidden;
    border: 2px solid #3498db;
}

.startup-modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

.startup-modal-title {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 22px;
    text-transform: uppercase;
    font-weight: 900;
    letter-spacing: 1px;
}

.startup-page-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    border-left: 4px solid;
    text-align: center;
    transition: transform 0.3s;
}

.startup-page-info:hover {
    transform: translateY(-2px);
}

.page-name {
    font-size: 18px;
    font-weight: 800;
    color: #2c3e50;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.page-count {
    font-size: 32px;
    font-weight: 900;
    margin: 5px 0;
    color: #3498db;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
}

.page-unit {
    font-size: 14px;
    color: #7f8c8d;
    font-weight: 600;
    text-transform: uppercase;
}

/* ألوان خاصة لكل صفحة */
.page-commande .page-name { color: #1abc9c; }
.page-commande .startup-page-info { border-left-color: #1abc9c; }
.page-commande .page-count { color: #1abc9c; }

.page-ajouter .page-name { color: #27ae60; }
.page-ajouter .startup-page-info { border-left-color: #27ae60; }
.page-ajouter .page-count { color: #27ae60; }

.page-retirer .page-name { color: #34495e; }
.page-retirer .startup-page-info { border-left-color: #34495e; }
.page-retirer .page-count { color: #34495e; }

.page-casse .page-name { color: #d35400; }
.page-casse .startup-page-info { border-left-color: #d35400; }
.page-casse .page-count { color: #d35400; }

.page-panier .page-name { color: #2ecc71; }
.page-panier .startup-page-info { border-left-color: #2ecc71; }
.page-panier .page-count { color: #2ecc71; }

.startup-modal-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    justify-content: center;
}

.startup-modal-btn {
    flex: 1;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 140px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.startup-modal-btn.clear {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.startup-modal-btn.clear:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.startup-modal-btn.keep {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.startup-modal-btn.keep:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.startup-modal-btn.next {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.startup-modal-btn.next:hover {
    background: linear-gradient(135deg, #2980b9, #1c6ea4);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
}

.startup-modal-progress {
    margin-top: 20px;
    font-size: 14px;
    color: #7f8c8d;
    font-weight: 600;
}

@keyframes startupFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* تنسيق للشاشات الصغيرة */
@media (max-width: 480px) {
    .startup-modal-content {
        width: 90%;
        padding: 20px;
    }
    
    .startup-modal-title {
        font-size: 20px;
    }
    
    .page-name {
        font-size: 16px;
    }
    
    .page-count {
        font-size: 28px;
    }
    
    .startup-modal-buttons {
        flex-direction: column;
        gap: 10px;
    }
    
    .startup-modal-btn {
        min-width: 100%;
        padding: 12px;
        font-size: 15px;
    }
}
/* ============================================
   أنماط لحقل تصفية الكروت
   ============================================ */
.search-card.filter-card {
    border-left: 3px solid #27ae60 !important;
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
}

.search-card.filter-card::before {
    background: linear-gradient(to bottom, #27ae60, #219653) !important;
}

#filterCardsInput {
    background: #ffffff;
    border: 2px solid #27ae60;
    font-weight: bold;
    color: #2c3e50;
}

#filterCardsInput:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
}

#filterResultsInfo {
    animation: fadeIn 0.3s ease-in-out;
    transition: all 0.3s;
}

#filterResultsInfo mark {
    background: #FFEB3B !important;
    color: #000 !important;
    padding: 1px 4px !important;
    border-radius: 3px !important;
    font-weight: bold !important;
}
</style>
</head>

<body>

<!-- الماسح الضوئي -->
<div id="scannerOverlay">
    <button id="closeScanner" onclick="stopScanner()">×</button>
    <div id="scannerFrame"></div>
    <div id="scannerLoading">CHARGEMENT DU SCANNER...</div>
</div>

<!-- نافذة اختيار التواريخ -->
<div id="datePickerModal" class="date-picker-modal">
    <div class="date-picker-content">
        <h2 class="date-picker-title">SÉLECTIONNER UNE DATE</h2>
        <div id="dateList" class="date-list"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDatePicker()">ANNULER</button>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h2>CONFIRMATION</h2>
        <p id="confirmMessage"></p>
        <div class="modal-buttons">
            <button class="modal-btn confirm" onclick="confirmAction()">CONFIRMER</button>
            <button class="modal-btn cancel" onclick="cancelAction()">ANNULER</button>
        </div>
    </div>
</div>

<div id="dateSelectModal" class="modal date-select-modal">
    <div class="modal-content">
        <h2>SÉLECTIONNER UNE DATE</h2>
        <p id="dateSelectMessage">CHOISISSEZ UNE DATE POUR CE PRODUIT:</p>
        <div id="dateOptionsContainer" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateSelectModal()">ANNULER</button>
        </div>
    </div>
</div>

<div id="quickRetirerModal" class="quick-modal">
    <div class="quick-modal-content retirer-modal">
        <h2 class="quick-modal-title">RETIRER PRODUIT</h2>
        <div id="quickRetirerInfo" class="quick-retirer-info"></div>
        
        <!-- تغيير: حذف حقل العنوان وجعل الحقول مشابهة لـ AJOUTER -->
        <div class="quick-input-row small-row" style="margin-bottom: 10px;">
    <input type="tel" id="quickRetirerQte1Input" class="quick-ajouter-small-input qte" placeholder="Quantité 1" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)" onfocus="this.placeholder=''">
    <input type="tel" id="quickRetirerDlc1Input" class="quick-ajouter-small-input date" placeholder="Date 1" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickRetirer(1)">
</div>

<div class="quick-input-row small-row" style="margin-bottom: 10px;">
    <input type="tel" id="quickRetirerQte2Input" class="quick-ajouter-small-input qte" placeholder="Quantité 2" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)" onfocus="this.placeholder=''">
    <input type="tel" id="quickRetirerDlc2Input" class="quick-ajouter-small-input date" placeholder="Date 2" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickRetirer(2)">
</div>

<div class="quick-input-row small-row" style="margin-bottom: 15px;">
    <input type="tel" id="quickRetirerQte3Input" class="quick-ajouter-small-input qte" placeholder="Quantité 3" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)" onfocus="this.placeholder=''">
    <input type="tel" id="quickRetirerDlc3Input" class="quick-ajouter-small-input date" placeholder="Date 3" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickRetirer(3)">
</div>
        
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn retirer" onclick="quickRetirerProduit()">RETIRER</button>
            <button class="quick-modal-btn cancel" onclick="closeQuickRetirerModal()">ANNULER</button>
        </div>
    </div>
</div>

<div id="quickCommanderModal" class="quick-modal">
    <div class="quick-modal-content">
        <h2 class="quick-modal-title">COMMANDER PRODUIT</h2>
        <div id="quickCommanderInfo" class="quick-modal-info"></div>
        <div class="quick-input-row">
            <input type="tel" id="quickCommanderQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn commander" onclick="quickCommanderProduit()">COMMANDER</button>
            <button class="quick-modal-btn cancel" onclick="closeQuickCommanderModal()">ANNULER</button>
        </div>
    </div>
</div>

<div id="quickAjouterModal" class="quick-modal">
    <div class="quick-modal-content">
        <h2 class="quick-modal-title">AJOUTER PRODUIT</h2>
        <div id="quickAjouterInfo" class="quick-ajouter-info"></div>
        
        <!-- حقل العنوان مع زر التقويم -->
        <div class="quick-input-row" style="margin-bottom: 10px;">
    <div class="slash-btn-container">
        <input type="tel" id="quickAjouterAdresseInput" class="input-with-slash" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off" style="text-align: center;">
        <button type="button" class="slash-btn" onclick="return addSlashToAddressFinal('quickAjouterAdresseInput')">/</button>
    </div>
</div>
        
        <!-- حقول الكمية والتواريخ - مشابهة لصفحة AJOUTER الرئيسية -->
        <div class="quick-input-row small-row" style="margin-bottom: 10px;">
            <input type="tel" id="quickAjouterQte1Input" class="quick-ajouter-small-input qte" placeholder="QTE 1" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
            <input type="tel" id="quickAjouterDlc1Input" class="quick-ajouter-small-input date" placeholder="DLC 1 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickAjouter(1)">
        </div>

        <div class="quick-input-row small-row" style="margin-bottom: 10px;">
            <input type="tel" id="quickAjouterQte2Input" class="quick-ajouter-small-input qte" placeholder="QTE 2" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
            <input type="tel" id="quickAjouterDlc2Input" class="quick-ajouter-small-input date" placeholder="DLC 2 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickAjouter(2)">
        </div>

        <div class="quick-input-row small-row" style="margin-bottom: 15px;">
            <input type="tel" id="quickAjouterQte3Input" class="quick-ajouter-small-input qte" placeholder="QTE 3" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
            <input type="tel" id="quickAjouterDlc3Input" class="quick-ajouter-small-input date" placeholder="DLC 3 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForQuickAjouter(3)">
        </div>
        
        <!-- قسم معلومات الكمية -->
        <div id="quickAjouterQteValidationMessage" class="quick-ajouter-qte-validation" style="display: none;"></div>
        
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn ajouter" onclick="quickAjouterProduit()">AJOUTER</button>
            <button class="quick-modal-btn cancel" onclick="closeQuickAjouterModal()">ANNULER</button>
        </div>
    </div>
</div>

</div> <!-- إغلاق div للـ quickAjouterModal -->
<!-- ============== نافذة خيارات العناوين لـ AJOUTER ============== -->
<div id="addressOptionsModalAjouter" class="modal">
    <div class="modal-content">
        <h2>SÉLECTIONNER UNE ADRESSE</h2>
        <p id="addressSelectMessageAjouter">CHOISISSEZ UNE ADRESSE POUR CE PRODUIT:</p>
        <div id="addressOptionsContainerAjouter" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeAddressOptionsModalAjouter()">ANNULER</button>
        </div>
    </div>
</div>
<!-- أضف هذا الكود بعد نافذة خيارات العناوين لـ AJOUTER مباشرة -->
<!-- ============== نافذة خيارات التواريخ لـ AJOUTER ============== -->
<div id="dateOptionsModalAjouter" class="modal">
    <div class="modal-content">
        <h2>SÉLECTIONNER UNE DATE</h2>
        <p id="dateSelectMessageAjouter">CHOISISSEZ UNE DATE POUR CE PRODUIT:</p>
        <div id="dateOptionsContainerAjouter" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateOptionsModalAjouter()">ANNULER</button>
        </div>
    </div>
</div>
<!-- ============== نهاية الإضافة ============== -->
<!-- ============== أضف هنا ============== -->
<!-- نافذة خيارات التواريخ لنافذة RETIRER السريعة -->
<div id="dateOptionsModalQuickRetirer" class="modal">
    <div class="modal-content">
        <h2>SÉLECTIONNER UNE DATE</h2>
        <p id="dateSelectMessageQuickRetirer">CHOISISSEZ UNE DATE:</p>
        <div id="dateOptionsContainerQuickRetirer" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateOptionsModalQuickRetirer()">ANNULER</button>
        </div>
    </div>
</div>
<!-- ============== نهاية الإضافة ============== -->
<!-- ============== نافذة خيارات التواريخ للنافذة السريعة AJOUTER ============== -->
<div id="dateOptionsModalQuickAjouter" class="modal">
    <div class="modal-content">
        <h2>SÉLECTIONNER UNE DATE</h2>
        <p id="dateSelectMessageQuickAjouter">CHOISISSEZ UNE DATE:</p>
        <div id="dateOptionsContainerQuickAjouter" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateOptionsModalQuickAjouter()">ANNULER</button>
        </div>
    </div>
</div>
<!-- ============== نهاية الإضافة ============== -->
<button class="topBtn" onclick="scrollToTop()">↑</button>
<button class="bottomBtn" onclick="scrollToBottom()">↓</button>

<div id="mainPage">
    <!-- عنوان الصفحة الرئيسية -->
    <h1 class="main-title">GESTION RESERVE</h1>
    
    <div class="container">
        <button class="btn info" onclick="document.getElementById('mainPage').style.display='none'; document.getElementById('infoPage').style.display='block'">INFO PRODUIT</button>
        <button class="btn changement" onclick="openChangementPrix()">CHANGEMENT DE PRIX</button>
        <button class="btn adresse" onclick="openAdresse()">CONTENUE D'ADRESSE</button>
        <button class="btn rupture" onclick="openRupture()">REPTURE RAYON</button>
        <button class="btn dlc" onclick="openDLC()">DLC RESERVE</button>
        <button class="btn commande" onclick="openCommande()">COMMANDE</button>
        <button class="btn ajouter" onclick="openAjouter()">AJOUTER</button>
        <button class="btn retirer" onclick="openRetirer()">RETIRER</button>
        <button class="btn casse" onclick="openCasse()">CASSE FRAIS</button>
        <button class="btn panier" onclick="openPanier()">PANIER</button>
    </div>
    
    <!-- المعلومات في أسفل الصفحة الرئيسية -->
    <div class="footer-info">
        <div class="footer-line">MARJANE BERKANE</div>
        <div class="footer-line">DÉPARTEMENT PGC</div>
        <div class="footer-spacing"></div>
        <div class="footer-developer">DÉVELOPPÉ PAR ALA EDDINE ABDELLAOUI</div>
    </div>
</div>

<div id="infoPage">
    <button class="backBtn" onclick="goBack()">RETOUR</button>
    <h1 style="color: #3498db;">INFO PRODUIT</h1>

    <div class="search-card">
        <div class="input-row">
            <input type="tel" id="codeInput" placeholder="ENTRER CODE ARTICLE" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan scan-small" onclick="startScanner('codeInput')">SCANNER</button>
        </div>
    </div>

    <div id="infoDataContainer"></div>
    <div id="adresseContainer"></div>
</div>

<div id="changementPrixPage">
    <button class="backBtn" onclick="goBackFromChangementPrix()">RETOUR</button>
    <h1 style="color: #FFA500;">CHANGEMENT DE PRIX</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="prixEpicerieBtn" onclick="setPrixDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="prixBiscuiterieBtn" onclick="setPrixDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
        
        <div class="input-row">
            <input type="tel" id="changementCodeInput" placeholder="GENCODE" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan scan-small" onclick="startScanner('changementCodeInput')">SCANNER</button>
        </div>
        </div>
    <div id="changementInfoContainer"></div>
    <div id="changementResultsContainer"></div>
</div>

<div id="adressePage">
    <button class="backBtn" onclick="goBackFromAdresse()">RETOUR</button>
    <h1 style="color: #9b59b6;">CONTENUE D'ADRESSE</h1>
        <!-- ========== الحقل الجديد للبحث داخل الكروت المعروضة ========== -->
    <div class="search-card" style="margin-bottom: 10px;">
        <div class="input-row">
            <input type="tel" 
                   id="filterCardsInput" 
                   placeholder="RECHERCHER 4 DERNIERS CHIFFRES" 
                   pattern="[0-9]*" 
                   inputmode="numeric" 
                   autocomplete="off" 
                   style="text-align: center;"
                   oninput="filterDisplayedCards()">
        </div>
    </div>

    <div class="search-card">
        <div class="search-type">
            <button class="search-type-btn active" id="searchByAdresseBtn" onclick="setSearchType('adresse')">ADRESSE</button>
            <button class="search-type-btn" id="searchByCodeBtn" onclick="setSearchType('code')">CODE</button>
        </div>
        
        <div class="input-row">
            <div class="slash-btn-container" style="width: 100%;">
                <input type="tel" id="adresseInput" class="input-with-slash" placeholder="EX: 6/1 (POUR Z6P1)" pattern="[0-9/]*" inputmode="decimal" autocomplete="off" lang="fr">
                <button type="button" class="slash-btn" onclick="return addSlashToAddressFinal('adresseInput')">/</button>
            </div>
            <button class="scan scan-small" onclick="startScannerForAdresse()">SCANNER</button>
        </div>
        
        <div id="productNameDisplayAdresse" class="product-name-display" style="display: none;"></div>
    </div>

    <div id="resultatsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerAdresse()">PARTAGER</button>
    </div>
</div>

<div id="rupturePage">
    <button class="backBtn" onclick="goBackFromRupture()">RETOUR</button>
    <h1 style="color: #e74c3c;">REPTURE RAYON</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="epicerieBtn" onclick="setDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="biscuiterieBtn" onclick="setDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
    </div>

    <div id="ruptureContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerRupture()">PARTAGER</button>
    </div>
</div>

<div id="dlcPage">
    <button class="backBtn" onclick="goBackFromDLC()">RETOUR</button>
    <h1 style="color: #f39c12;">DLC RESERVE</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="dlcEpicerieBtn" onclick="setDLCDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="dlcBiscuiterieBtn" onclick="setDLCDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
        
        <div class="month-select">
            <select id="monthSelect" class="month-btn" onchange="displayDLCByMonth()">
                <option value="">SÉLECTIONNER UN MOIS</option>
            </select>
        </div>
    </div>

    <div id="dlcContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerDLC()">PARTAGER</button>
    </div>
</div>

<div id="commandePage">
    <button class="backBtn" onclick="goBackFromCommande()">RETOUR</button>
    <h1 style="color: #1abc9c;">COMMANDE</h1>

    <div class="commande-card">
        <div class="commande-input-row">
            <input type="tel" id="commandeCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('commandeCodeInput')">SCANNER</button>
        </div>
        
        <div id="commandeProductInfo"></div>
        
        <div class="commande-input-row">
            <input type="tel" id="commandeQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        
        <button class="commande-btn" onclick="ajouterProduit()" style="background: #27ae60;">COMMANDER</button>
        
        <div class="commande-summary">
            NOMBRE DES PRODUITS: <span id="produitCount">0</span>
        </div>
        
        <button class="commande-btn secondary" onclick="clearAllProduits()">EFFACER TOUT</button>
    </div>

    <div id="commandeProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerCommande()">PARTAGER</button>
    </div>
</div>

<div id="ajouterPage">
    <button class="backBtn" onclick="goBackFromAjouter()">RETOUR</button>
    <h1 style="color: #27ae60;">AJOUTER</h1>
    <!-- قسم البحث المضافة هنا -->
    <div class="search-card">
        <div class="input-row">
            <input type="tel" id="searchAjouterInput" placeholder="RECHERCHER PAR CODE" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan scan-small" onclick="startScanner('searchAjouterInput')">SCANNER</button>
        </div>
    </div>

    <!-- نتائج البحث -->
    <div id="ajouterSearchResultsContainer"></div>

    <!-- الباقي من الكود كما هو -->
    <div class="ajouter-card">
        <div class="ajouter-input-row">
            <input type="tel" id="ajouterCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('ajouterCodeInput')">SCANNER</button>
        </div>
    </div>

    <div id="ajouterSearchResultsContainer"></div>

    <div class="ajouter-card">
        <div id="ajouterProductInfo"></div>
        
        <!-- الجديد: -->
<div class="ajouter-input-row">
    <div class="slash-btn-container" style="width: 100%;">
        <input type="tel" id="ajouterAdresseInput" class="input-with-slash" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off" onfocus="showAddressOptionsForAjouter()">
        <button type="button" class="slash-btn" onclick="return addSlashToAddressFinal('ajouterAdresseInput')">/</button>
    </div>
</div>
        
        <!-- عدل هذه الأقسام الثلاثة في صفحة AJOUTER -->
<div class="ajouter-input-row small-row">
    <input type="tel" id="ajouterQte1Input" class="ajouter-small-input qte" placeholder="QTE 1" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="ajouterDlc1Input" class="ajouter-small-input date" placeholder="DLC 1 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForAjouter(1)">
</div>

<div class="ajouter-input-row small-row">
    <input type="tel" id="ajouterQte2Input" class="ajouter-small-input qte" placeholder="QTE 2" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="ajouterDlc2Input" class="ajouter-small-input date" placeholder="DLC 2 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForAjouter(2)">
</div>

<div class="ajouter-input-row small-row">
    <input type="tel" id="ajouterQte3Input" class="ajouter-small-input qte" placeholder="QTE 3" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
    <input type="tel" id="ajouterDlc3Input" class="ajouter-small-input date" placeholder="DLC 3 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off" onfocus="showDateOptionsForAjouter(3)">
</div>
        
        <button class="ajouter-btn" onclick="ajouterProduitAjouter()">AJOUTER</button>
        
        <div class="ajouter-summary">
            NOMBRE DES PRODUITS: <span id="ajouterProduitCount">0</span>
        </div>
        
        <button class="ajouter-btn secondary" onclick="clearAllAjouter()">EFFACER TOUT</button>
    </div>

    <div id="ajouterProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerAjouter()">PARTAGER</button>
    </div>
</div>

<div id="cassePage">
    <button class="backBtn" onclick="goBackFromCasse()">RETOUR</button>
    <h1 style="color: #d35400;">CASSE FRAIS</h1>

    <div class="casse-card">
        <div class="casse-input-row">
            <input type="tel" id="casseCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('casseCodeInput')">SCANNER</button>
        </div>
        
        <div id="casseProductInfo"></div>
        
        <div class="casse-input-row">
            <input type="tel" id="casseQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
            <input type="tel" id="casseDateInput" class="casse-date-input" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
            
        </div>
        
        <button class="casse-btn" onclick="ajouterProduitCasse()" style="background: #27ae60;">CASSER</button>
        
        <div class="casse-summary">
            NOMBRE DES PRODUITS: <span id="casseProduitCount">0</span>
        </div>
        
        <button class="casse-btn secondary" onclick="clearAllProduitsCasse()">EFFACER TOUT</button>
    </div>

    <div id="casseProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerCasse()">PARTAGER</button>
    </div>
</div>

<div id="retirerPage">
    <button class="backBtn" onclick="goBackFromRetirer()">RETOUR</button>
    <h1 style="color: #34495e;">RETIRER</h1>

    <div class="retirer-card">
        <div class="retirer-input-row">
            <input type="tel" id="retirerCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('retirerCodeInput')">SCANNER</button>
        </div>
    </div>

    <div id="retirerSearchResultsContainer"></div>

    <div class="retirer-card">
        <div id="retirerProductInfo"></div>
        
       <div class="retirer-input-row">
    <input type="tel" id="retirerAdresseInput" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off" onfocus="showAddressOptions()">
</div>

        
        <!-- الحقول الجديدة - نضيفها هنا -->
<div class="retirer-input-row small-row">
    <input type="tel" id="retirerQte1Input" class="retirer-small-input qte" placeholder="Quantité 1" onfocus="this.placeholder=''">
    <input type="tel" id="retirerDlc1Input" class="retirer-small-input date" placeholder="Date 1" onfocus="showDateOptionsForRetirer(1)">
</div>

<div class="retirer-input-row small-row">
    <input type="tel" id="retirerQte2Input" class="retirer-small-input qte" placeholder="Quantité 2" onfocus="this.placeholder=''">
    <input type="tel" id="retirerDlc2Input" class="retirer-small-input date" placeholder="Date 2" onfocus="showDateOptionsForRetirer(2)">
</div>

<div class="retirer-input-row small-row">
    <input type="tel" id="retirerQte3Input" class="retirer-small-input qte" placeholder="Quantité 3" onfocus="this.placeholder=''">
    <input type="tel" id="retirerDlc3Input" class="retirer-small-input date" placeholder="Date 3" onfocus="showDateOptionsForRetirer(3)">
</div>
        
        <button class="retirer-btn" onclick="ajouterProduitRetirer()" style="background: #27ae60;">RETIRER</button>
        
        <div class="retirer-summary">
            NOMBRE DES PRODUITS: <span id="retirerProduitCount">0</span>
        </div>
        
        <button class="retirer-btn secondary" onclick="clearAllProduitsRetirer()">EFFACER TOUT</button>
    </div>

    <div id="retirerProduitsContainer"></div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerRetirer()">PARTAGER</button>
    </div>
</div>

<div id="panierPage">
    <button class="backBtn" onclick="goBackFromPanier()">RETOUR</button>
    <h1 style="color: #2ecc71;">PANIER</h1>

    <div class="panier-card">
        <div class="panier-input-row">
            <input type="tel" id="panierCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="startScanner('panierCodeInput')">SCANNER</button>
        </div>
        
        <div id="panierProductInfo"></div>
        
        <div class="panier-input-row">
            <input type="tel" id="panierQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        
        <button class="panier-btn" onclick="ajouterProduitPanier()">AJOUTER AU PANIER</button>
        
        <div class="panier-summary">
            NOMBRE DES PRODUITS: <span id="panierProduitCount">0</span>
        </div>
        
        <button class="panier-btn secondary" onclick="clearAllPanier()">EFFACER TOUT</button>
    </div>

    <div id="panierContainer">
        <div id="panierTotalCard" style="display: none;"></div>
        <div id="panierProduitsContainer"></div>
    </div>
    
    <div class="partager-card">
        <button class="partager-btn" onclick="partagerPanier()">PARTAGER</button>
    </div>
</div>

<script>
// مصادر البيانات
const DATA_SOURCES = {
    produits: {
        url: "https://docs.google.com/spreadsheets/d/11YoNOkm_CWh4OouBTiE6aniRQxRmJOg0vOEW_SXxzqQ/export?format=tsv",
        storageKey: "produits_data",
        lastUpdateKey: "produits_last_update",
        cache: []
    },
    adresses: {
        url: "https://docs.google.com/spreadsheets/d/1gL4eDcnsECNmlhZ_F6jJlrDM3YW0UHdaClqPjxVQxQY/export?format=tsv",
        storageKey: "adresses_data",
        lastUpdateKey: "adresses_last_update",
        cache: []
    },
    ventes: {
        url: "https://docs.google.com/spreadsheets/d/18281vphP4T25wl_W82TheVyQtyERFtwWg8sHrnNCzKU/export?format=tsv",
        storageKey: "ventes_data",
        lastUpdateKey: "ventes_last_update",
        cache: []
    },
    prixEpicerie: {
        url: "https://docs.google.com/spreadsheets/d/1c8emdsPMVpK78W_504ucw-hcTjXajIfz8CXdtBcTTVg/export?format=csv",
        storageKey: "prix_epicerie_data",
        lastUpdateKey: "prix_epicerie_last_update",
        cache: []
    },
    prixBiscuiterie: {
        url: "https://docs.google.com/spreadsheets/d/1Cj9Y_ZYiQCfxxh4RhVLr6JWgBM4eX1YqE0GbF4NPTX8/export?format=csv",
        storageKey: "prix_biscuiterie_data",
        lastUpdateKey: "prix_biscuiterie_last_update",
        cache: []
    }
};

// متغيرات عامة
let produitsCache = [];
let csvCache = [];
let csvNewCache = [];
let searchType = 'adresse';
let totalGlobalReserve = 0;
let showTotalReserve = false;
let currentDepartement = 'epicerie';
let currentDLCDepartement = 'epicerie';
let allMonths = [];

// متغيرات صفحة COMMANDE
let commandeProduits = [];
let pendingAction = null;
let editingProduitIndex = -1;

// متغيرات صفحة AJOUTER
let ajouterProduits = [];
let editingAjouterProduitIndex = -1;

// متغيرات صفحة CASSE FRAIS
let casseProduits = [];
let editingCasseProduitIndex = -1;

// متغيرات صفحة RETIRER
let retirerProduits = [];
let editingRetirerProduitIndex = -1;

// متغيرات صفحة CHANGEMENT DE PRIX
let currentPrixDepartement = 'epicerie';
let prixDataCache = {
    epicerie: [],
    biscuiterie: []
};
let changementInfo = {};

// متغيرات للأزرار السريعة
let currentQuickProduct = null;

// متغيرات صفحة PANIER
let panierProduits = [];
let editingPanierProduitIndex = -1;

// متغير للماسح الضوئي
let html5QrCode = null;

// متغير لتخزين الحالة المحددة للعنوان
let selectedAddresses = new Set();

// متغير لتخزين حقل التاريخ الحالي
let currentDateField = null;
let currentProductCodeForDate = null;

// ============================================
// تحسينات للتحقق من صحة التاريخ في AJOUTER
// ============================================

function isValidDateStrict(dateString) {
    // التحقق من تنسيق التاريخ DD/MM/YYYY
    const pattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    if (!pattern.test(dateString)) {
        return { isValid: false, reason: 'FORMAT_INVALID' };
    }
    
    const parts = dateString.split('/');
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);
    
    // التحقق من أن الشهر بين 1 و 12
    if (month < 1 || month > 12) {
        return { isValid: false, reason: 'MONTH_INVALID' };
    }
    
    // التحقق من أن اليوم بين 1 و 31
    if (day < 1 || day > 31) {
        return { isValid: false, reason: 'DAY_INVALID' };
    }
    
    // التحقق من أيام الشهر
    const daysInMonth = new Date(year, month, 0).getDate();
    if (day > daysInMonth) {
        return { isValid: false, reason: 'DAY_OUT_OF_RANGE' };
    }
    
    // التحقق من أن التاريخ ليس في الماضي البعيد أو المستقبل البعيد
    const date = new Date(year, month - 1, day);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // لا تسمح بالتواريخ قبل سنة 2020
    const minDate = new Date(2024, 12, 31);
    if (date < minDate) {
        return { isValid: false, reason: 'DATE_TOO_OLD' };
    }
    
    // لا تسمح بالتواريخ بعد سنة 2030
    const maxDate = new Date(2099, 12, 31);
    if (date > maxDate) {
        return { isValid: false, reason: 'DATE_TOO_FAR' };
    }
    
    // التحقق من أن التاريخ صحيح
    if (date.getFullYear() !== year || 
        date.getMonth() !== month - 1 || 
        date.getDate() !== day) {
        return { isValid: false, reason: 'DATE_INVALID' };
    }
    
    return { isValid: true, date: date };
}

function checkIfDateExpired(dateString) {
    const validation = isValidDateStrict(dateString);
    if (!validation.isValid) {
        return { expired: true, reason: validation.reason };
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (validation.date < today) {
        return { expired: true, reason: 'EXPIRED' };
    }
    
    return { expired: false, date: validation.date };
}

function getDateErrorMessage(reason) {
    const messages = {
        'FORMAT_INVALID': 'FORMAT DE DATE INVALIDE. UTILISEZ JJ/MM/AAAA',
        'MONTH_INVALID': 'MOIS INVALIDE. DOIT ÊTRE ENTRE 01 ET 12',
        'DAY_INVALID': 'JOUR INVALIDE. DOIT ÊTRE ENTRE 01 ET 31',
        'DAY_OUT_OF_RANGE': 'JOUR INEXISTANT POUR CE MOIS',
        'DATE_TOO_OLD': 'DATE ANCIENNE (AVANT 2025)',
        'DATE_TOO_FAR': 'DATE TROP ÉLOIGNÉE (APRÈS 2099)',
        'DATE_INVALID': 'DATE INEXISTANTE',
        'EXPIRED': 'DATE DÉPASSÉE'
    };
    
    return messages[reason] || 'DATE INVALIDE';
}

// وظائف فتح الصفحات
function openInfo(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("infoPage").style.display = "block";
    document.getElementById("codeInput").focus();
}

function openChangementPrix(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("changementPrixPage").style.display = "block";
    
    loadPrixData();
    displayAllPrixData();
}

function openAdresse(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("adressePage").style.display = "block";
    
    document.getElementById("adresseInput").focus();
    setSearchType('adresse');
    
    // تفريغ مربعات التحديد عند فتح الصفحة
    selectedAddresses.clear();
    
    // تفريغ حقل التصفية عند فتح الصفحة
    clearFilterField();
}

function openRupture(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("rupturePage").style.display = "block";
    
    // تفريغ مربعات التحديد عند فتح الصفحة
    selectedAddresses.clear();
    
    displayRuptureProductsByDepartement();
}

function openDLC(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("dlcPage").style.display = "block";
    
    extractAvailableMonths();
}

function openCommande(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("commandePage").style.display = "block";
    
    updateCommandeDisplay();
}

function openAjouter(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("ajouterPage").style.display = "block";
    
    updateAjouterDisplay();
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    
    // إعداد التحقق من الكمية
    setupAjouterValidation();

    // إعداد التحقق من صحة التاريخ وتلوين الحقول
    setupDateValidationForAjouter();
}

function openCasse(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("cassePage").style.display = "block";
    
    updateCasseDisplay();
}

function openRetirer(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("retirerPage").style.display = "block";
    
    updateRetirerDisplay();
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
}

function openPanier(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("panierPage").style.display = "block";
    
    updatePanierDisplay();
}

// وظائف الرجوع
function goBack(){ 
    document.getElementById("infoPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block"; 
    resetFields();
}

function goBackFromAdresse(){ 
    document.getElementById("adressePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("adresseInput").value = "";
    document.getElementById("resultatsContainer").innerHTML = "";
    document.getElementById("productNameDisplayAdresse").style.display = "none";
    
    // تفريغ مربعات التحديد عند الخروج من الصفحة
    selectedAddresses.clear();
    
    // تفريغ حقل التصفية عند الرجوع للصفحة الرئيسية
    clearFilterField();
}

function goBackFromRupture(){ 
    document.getElementById("rupturePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("ruptureContainer").innerHTML = "";
    
    // تفريغ مربعات التحديد عند الخروج من الصفحة
    selectedAddresses.clear();
}

function goBackFromDLC(){ 
    document.getElementById("dlcPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("dlcContainer").innerHTML = "";
}

function goBackFromCommande(){ 
    document.getElementById("commandePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById('commandeCodeInput').value = '';
    document.getElementById('commandeQteInput').value = '';
    document.getElementById('commandeProductInfo').innerHTML = '';
}

function goBackFromAjouter(){ 
    document.getElementById("ajouterPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
     // مسح حقل البحث
    const searchInput = document.getElementById('searchAjouterInput');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // مسح نتائج البحث
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';   
    // 1. مسح جميع الحقول
    const inputIds = [
        'ajouterCodeInput', 'ajouterAdresseInput',
        'ajouterQte1Input', 'ajouterDlc1Input',
        'ajouterQte2Input', 'ajouterDlc2Input',
        'ajouterQte3Input', 'ajouterDlc3Input'
    ];
    
    inputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            // مسح القيمة
            input.value = '';
            
            // إعادة تعيين جميع الأنماط
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.style.color = '';
            input.style.fontWeight = '';
            input.style.backgroundImage = '';
            input.style.paddingRight = '';
            input.title = '';
        }
    });
    
    // 2. إزالة رسائل الخطأ من حقول التاريخ
    const dlcFields = ['ajouterDlc1Input', 'ajouterDlc2Input', 'ajouterDlc3Input'];
    dlcFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.parentNode) {
            const errorMessage = field.parentNode.querySelector('.date-error-message');
            if (errorMessage) {
                errorMessage.remove();
            }
        }
    });
    
    // 3. إزالة رسالة التحقق من الكمية
    const qteValidationMessage = document.getElementById('ajouterQteValidationMessage');
    if (qteValidationMessage) {
        qteValidationMessage.remove();
    }
    
    // 4. إعادة تعيين الدائرة الحمراء في العنوان
    const addressInput = document.getElementById('ajouterAdresseInput');
    if (addressInput) {
        addressInput.style.backgroundImage = '';
        addressInput.style.paddingRight = '10px';
    }
    
    // 5. مسح جميع المحتويات
    document.getElementById('ajouterProductInfo').innerHTML = '';
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    document.getElementById('ajouterProduitsContainer').innerHTML = '';
    
    // 6. إعادة تعيين العداد
    document.getElementById('ajouterProduitCount').textContent = '0';
    
    
    // 7. إعادة تعيين قائمة المنتجات (اختياري - إذا أردت مسح الكروت المحفوظة)
    // ajouterProduits = [];
    // saveAjouterProduits();
    
    // ملاحظة: إذا كنت تريد الاحتفاظ بالكروت المحفوظة، اترك السطرين أعلاه معقودين //
    // إذا كنت تريد مسح كل شيء بما في ذلك الكروت، فقم بإزالة التعليق //
}

function goBackFromCasse(){ 
    document.getElementById("cassePage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById('casseCodeInput').value = '';
    document.getElementById('casseQteInput').value = '';
    document.getElementById('casseDateInput').value = '';
    document.getElementById('casseProductInfo').innerHTML = '';
}

function goBackFromRetirer(){ 
    document.getElementById("retirerPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    
    // مسح جميع الحقول فقط (لا تمسح الكروت)
    document.getElementById('retirerCodeInput').value = '';
    document.getElementById('retirerAdresseInput').value = '';
    
    // مسح الحقول الجديدة فقط
    document.getElementById('retirerQte1Input').value = '';
    document.getElementById('retirerDlc1Input').value = '';
    document.getElementById('retirerQte2Input').value = '';
    document.getElementById('retirerDlc2Input').value = '';
    document.getElementById('retirerQte3Input').value = '';
    document.getElementById('retirerDlc3Input').value = '';
    
    // مسح معلومات البحث فقط (لا تمسح الكروت المحفوظة)
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    // لا تمسح retirerProduitsContainer لأنها تحتوي على الكروت المحفوظة
    
    // لا تمسح قائمة المنتجات (تترك الكروت كما هي)
    // retirerProduits = []; // تم التعليق على هذا السطر
    // saveRetirerProduits(); // تم التعليق على هذا السطر
    // updateRetirerDisplay(); // تم التعليق على هذا السطر
    
    // لا تعيد تعيين العداد (يبقى كما هو)
    // document.getElementById('retirerProduitCount').textContent = '0'; // تم التعليق على هذا السطر
}

function goBackFromChangementPrix(){ 
    document.getElementById("changementPrixPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById("changementCodeInput").value = "";
    document.getElementById("changementInfoContainer").innerHTML = "";
    document.getElementById("changementResultsContainer").innerHTML = "";
}

function goBackFromPanier(){ 
    document.getElementById("panierPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    document.getElementById('panierCodeInput').value = '';
    document.getElementById('panierQteInput').value = '';
    document.getElementById('panierProductInfo').innerHTML = '';
}

function resetFields(){
    document.getElementById("codeInput").value = "";
    document.getElementById("infoDataContainer").innerHTML = "";
    document.getElementById("adresseContainer").innerHTML = "";
}

// ============================================
// وظائف الماسح الضوئي
// ============================================

// ============================================
// ماسح QuaggaJS الجديد - مجاني للأبد
// ============================================

let quaggaScanner = null;

async function startScanner(targetInputId) {
    const scannerOverlay = document.getElementById("scannerOverlay");
    const scannerFrame = document.getElementById("scannerFrame");
    
    // إخفاء رسالة التحميل
    const scannerLoading = document.getElementById("scannerLoading");
    if (scannerLoading) scannerLoading.style.display = "none";
    
    // تفريغ الإطار
    scannerFrame.innerHTML = '';
    
    scannerOverlay.style.display = "flex";
    
    try {
        console.log("📷 Démarrage caméra...");
        
        // 1. طلب إذن الكاميرا مع إعدادات ثابتة (ليست هاربة)
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { exact: "environment" }, // الكاميرا الخلفية بالتحديد
                width: { min: 640, ideal: 1280 }, // دقة ثابتة
                height: { min: 480, ideal: 720 },
                frameRate: { ideal: 30, max: 30 } // معدل إطارات ثابت
            },
            audio: false
        });
        
        console.log("✅ Caméra démarrée");
        
        // 2. إنشاء واجهة الماسح
        scannerFrame.innerHTML = `
    <div id="scannerContainer" style="width:100%;height:100%;position:relative;overflow:hidden;">
        <video id="scannerVideo" autoplay playsinline 
               style="width:100%;height:100%;object-fit:cover;"></video>
        <!-- تمت إزالة المربع الأخضر والخط المتحرك لتوفير الطاقة -->
    </div>
`;
        
        // 3. عرض الفيديو (دون قلب)
        const video = document.getElementById('scannerVideo');
        video.srcObject = stream;
        
        // 4. إصلاح الاهتزاز: إضافة CSS لثبات الفيديو
        video.style.transform = "scaleX(1)"; // بدون قلب
        video.style.filter = "contrast(1.1) brightness(1.1) saturate(1.2)";
        
        // 5. بدء خط المسح المتحرك
       // startScanLineAnimation();
        
        // 6. بدء المسح بعد ثواني (للاستقرار)
        setTimeout(() => {
            startBarcodeScan(stream, targetInputId);
        }, 1000);
        
    } catch (error) {
        console.error("❌ Erreur caméra:", error);
        scannerOverlay.style.display = "none";
        
        // محاولة بكاميرا أمامية إذا الخلفية فشلت
        if (error.name === 'NotFoundError' || error.name === 'OverconstrainedError') {
            showAlert("🔄 Essai avec caméra avant...", 'info');
            setTimeout(() => tryFrontCamera(targetInputId), 500);
        } else {
            showAlert("❌ ERREUR CAMÉRA: " + error.message, 'warning');
        }
    }
}

// ============================================
// دالة بدء المسح بعد استقرار الكاميرا
// ============================================

function startBarcodeScan(stream, targetInputId) {
    console.log("🔍 Démarrage scan codes-barres...");
    
    // استخدام html5-qrcode بإعدادات ثابتة
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop();
    }
    
    html5QrCode = new Html5Qrcode("scannerContainer");
    
    // إعدادات محسنة للاستقرار
    const config = {
        fps: 15, // أقل سرعة = أكثر استقراراً
        qrbox: { width: 200, height: 150 },
        aspectRatio: 1.0,
        disableFlip: true, // منع القلب التلقائي
        experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
        }
    };
    
    html5QrCode.start(
        stream.getVideoTracks()[0].getSettings().deviceId,
        config,
        (decodedText) => {
            let scannedCode = decodedText.trim();
            if (scannedCode.length > 13) scannedCode = scannedCode.substring(0, 13);
            
            const targetInput = document.getElementById(targetInputId);
            if (targetInput) {
                targetInput.value = scannedCode;
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                // إبراز الحقل
                targetInput.style.backgroundColor = "#c6f6d5";
                targetInput.style.borderColor = "#9ae6b4";
                setTimeout(() => {
                    targetInput.style.backgroundColor = "";
                    targetInput.style.borderColor = "";
                }, 1000);
                
                showAlert(`✅ SCAN: ${scannedCode}`, 'success');
                stopScanner();
            }
        },
        (error) => {
            // تجاهل أخطاء المسح البسيطة
            if (!error.includes("NotFound")) {
                console.log("🔍 Scan en cours...");
            }
        }
    ).catch(err => {
        console.error("Erreur scan:", err);
        showAlert("⚠️ Scanner non supporté, utilisation manuelle", 'info');
    });
}

// ============================================
// خط المسح المتحرك (بدون اهتزاز)
// ============================================

function startScanLineAnimation() {
    const scannerLine = document.getElementById('scannerLine');
    if (!scannerLine) return;
    
    let position = 0;
    let direction = 1;
    
    function animateLine() {
        position += direction * 2; // حركة بطيئة
        scannerLine.style.top = position + '%';
        
        if (position >= 100) {
            direction = -1;
            scannerLine.style.background = "linear-gradient(90deg,transparent,#ff9900,transparent)";
        } else if (position <= 0) {
            direction = 1;
            scannerLine.style.background = "linear-gradient(90deg,transparent,#00ff00,transparent)";
        }
        
        if (window.scanAnimationActive) {
            requestAnimationFrame(animateLine);
        }
    }
    
    window.scanAnimationActive = true;
    animateLine();
}

// ============================================
// تجربة الكاميرا الأمامية إذا الخلفية فشلت
// ============================================

async function tryFrontCamera(targetInputId) {
    const scannerOverlay = document.getElementById("scannerOverlay");
    const scannerFrame = document.getElementById("scannerFrame");
    
    scannerFrame.innerHTML = '<div style="color:white;text-align:center;padding:20px;">🔄 Utilisation caméra avant...</div>';
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "user", // كاميرا أمامية
                width: { ideal: 720 },
                height: { ideal: 480 }
            }
        });
        
        scannerFrame.innerHTML = `
    <div id="scannerContainer" style="width:100%;height:100%;position:relative;">
        <video id="scannerVideo" autoplay playsinline 
               style="width:100%;height:100%;object-fit:cover;"></video>
        <!-- تمت إزالة المربع البرتقالي والخط المتحرك لتوفير الطاقة -->
    </div>
`;
        
        const video = document.getElementById('scannerVideo');
        video.srcObject = stream;
        video.style.transform = "scaleX(-1)"; // قلب للكاميرا الأمامية
        
        startBarcodeScan(stream, targetInputId);
        
    } catch (error) {
        scannerOverlay.style.display = "none";
        showAlert("❌ Aucune caméra disponible", 'warning');
    }
}

// ============================================
// إيقاف الماسح مع تنظيف الذاكرة
// ============================================

function stopScanner() {
    console.log("🛑 Arrêt scanner...");
    
    // 1. إيقاف الأنيميشن (إذا كانت لا تزال موجودة)
    window.scanAnimationActive = false;
    
    // 2. إيقاف html5QrCode
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            console.log("✅ Scanner arrêté");
            html5QrCode.clear();
        }).catch(err => {
            console.warn("⚠️ Erreur arrêt scanner:", err);
        });
        html5QrCode = null;
    }
    
    // 3. إيقاف الكاميرا فوراً (الأهم لتوفير الطاقة)
    const video = document.getElementById('scannerVideo');
    if (video && video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(track => {
            track.stop(); // ⬅️ هذا يوقف الكاميرا فوراً
            track.enabled = false;
        });
        video.srcObject = null;
        video.remove(); // ⬅️ يحرر الذاكرة
    }
    
    // 4. تنظيف stream العام
    if (window.scannerStream) {
        window.scannerStream.getTracks().forEach(track => {
            track.stop();
            track.enabled = false;
        });
        window.scannerStream = null;
    }
    
    // 5. إخفاء الواجهة
    const scannerOverlay = document.getElementById('scannerOverlay');
    if (scannerOverlay) {
        scannerOverlay.style.display = 'none';
        // تنظيف المحتوى (اختياري)
        scannerOverlay.innerHTML = '';
    }
    
    // 6. جمع المهملات (إن أمكن)
    if (window.gc) {
        window.gc();
    }
    
    console.log("✅ Camera et scanner complètement arrêtés");
}


// ============================================
// نسخة احتياطية محسنة
// ============================================

async function startScannerFallback(targetInputId) {
    const scannerOverlay = document.getElementById("scannerOverlay");
    const scannerLoading = document.getElementById("scannerLoading");

    scannerOverlay.style.display = "flex";
    scannerLoading.style.display = "block";

    try {
        if (html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
        }

        html5QrCode = new Html5Qrcode("scannerFrame");
        
        // إعدادات مُحسنة للباركود الصغير
        const config = { 
            fps: 30, 
            qrbox: { 
                width: 150, // أصغر للباركود الصغير
                height: 100 
            },
            aspectRatio: 1.0,
            disableFlip: false,
            // تحديد أنواع الباركود المدعومة
            formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128
            ]
        };

        await html5QrCode.start(
            { 
                facingMode: "environment",
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            config,
            (decodedText) => onScanSuccess(decodedText, targetInputId),
            onScanFailure
        );
        scannerLoading.style.display = "none";
        
        // إضافة خطوط التوجيه
        addScannerGuide();
        
    } catch (err) {
        console.error("Erreur scanner fallback:", err);
        scannerOverlay.style.display = "none";
        showAlert("Impossible de démarrer aucun scanner", 'warning');
    }
}
// بدء الماسح الضوئي لصفحة CONTINUE D'ADRESSE
function startScannerForAdresse() {
    startScanner('adresseInput');
}
// تهيئة التطبيق
function initApp() {
    loadAllDataFromStorage();
    updateAllData();
    window.addEventListener('scroll', toggleScrollButtons);
    loadCommandeProduits();
    loadAjouterProduits();
    loadCasseProduits();
    loadRetirerProduits();
    loadPanierProduits();
    loadPrixData();
    setupDateInput();
    setupQuantityInputs();
    setupDatePickerButtons();
}

// وظائف التمرير
function toggleScrollButtons() {
    const topBtn = document.querySelector('.topBtn');
    const bottomBtn = document.querySelector('.bottomBtn');
    
    if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        topBtn.style.display = 'flex';
    } else {
        topBtn.style.display = 'none';
    }
    
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const scrollPosition = window.scrollY || window.pageYOffset || document.body.scrollTop + (document.documentElement && document.documentElement.scrollTop || 0);
    
    if (documentHeight - (windowHeight + scrollPosition) > 100) {
        bottomBtn.style.display = 'flex';
    } else {
        bottomBtn.style.display = 'none';
    }
}

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

function scrollToBottom() {
    window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'smooth'
    });
}

// إعداد حقول التاريخ
function setupDateInput() {
    const dateInputs = [
        document.getElementById('casseDateInput'),
        document.getElementById('retirerDateInput'),
        document.getElementById('ajouterDlc1Input'),
        document.getElementById('ajouterDlc2Input'),
        document.getElementById('ajouterDlc3Input'),
        document.getElementById('quickRetirerDlc1Input'),
        document.getElementById('quickRetirerDlc2Input'),
        document.getElementById('quickRetirerDlc3Input'),
        document.getElementById('quickAjouterDlc1Input'),
        document.getElementById('quickAjouterDlc2Input'),
        document.getElementById('quickAjouterDlc3Input'),
        // أضف هذه الحقول الجديدة:
        document.getElementById('retirerDlc1Input'),
        document.getElementById('retirerDlc2Input'),
        document.getElementById('retirerDlc3Input')
    ];
    
    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
        }
    });
}

// إعداد أزرار التقويم
function setupDatePickerButtons() {
    // يتم إنشاء الأزرار ديناميكيًا في HTML
}

// إعداد حقول الكمية لتقييم التعبيرات الرياضية
function setupQuantityInputs() {
    const quantityInputs = [
        'commandeQteInput', 'ajouterQte1Input', 'ajouterQte2Input', 'ajouterQte3Input',
        'casseQteInput', 'retirerQteInput', 'panierQteInput', 'quickCommanderQteInput',
        'quickRetirerQte1Input', 'quickRetirerQte2Input', 'quickRetirerQte3Input',
        'quickAjouterQte1Input', 'quickAjouterQte2Input', 'quickAjouterQte3Input'
    ];
    
    quantityInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                delayedEvaluateExpression(this);
            });
        }
    });
}

// وظيفة لتقييم التعبيرات الرياضية مع تأخير
function delayedEvaluateExpression(inputElement) {
    const value = inputElement.value.trim();
    
    // مسح المهلة السابقة
    if (inputElement.timeoutId) {
        clearTimeout(inputElement.timeoutId);
    }
    
    // تعيين مهلة جديدة (800 مللي ثانية)
    inputElement.timeoutId = setTimeout(() => {
        evaluateExpression(inputElement);
    }, 800);
}

// وظيفة لتقييم التعبيرات الرياضية
function evaluateExpression(inputElement) {
    const value = inputElement.value.trim();
    
    if (value.includes('*') || value.includes('+') || value.includes('-') || value.includes('/')) {
        try {
            // استبدال × بـ * للتقييم
            const expression = value.replace(/×/g, '*').replace(/x/gi, '*');
            
            // التحقق من أن التعبير يحتوي فقط على أرقام وعوامل رياضية
            if (/^[0-9\s\+\-\*\/\(\)\.]+$/.test(expression)) {
                // استخدام parser آمن بدلاً من eval
                const result = safeEvaluate(expression);
                if (!isNaN(result) && isFinite(result)) {
                    // عرض النتيجة تلقائيًا في الحقل
                    inputElement.value = Math.round(result);
                    
                    // إبراز الحقل
                    const originalColor = inputElement.style.backgroundColor;
                    inputElement.style.backgroundColor = "#d6f0ff";
                    inputElement.style.borderColor = "#3498db";
                    setTimeout(() => {
                        inputElement.style.backgroundColor = originalColor;
                        inputElement.style.borderColor = "";
                    }, 1500);
                }
            }
        } catch (e) {
            console.log('Expression evaluation error:', e);
            // تجاهل الأخطاء، يبقى المستخدم حر في إدخال ما يريد
        }
    }
}

// دالة تقييم آمنة
function safeEvaluate(expression) {
    // إزالة جميع الأحرف غير الآمنة
    const sanitized = expression.replace(/[^0-9\+\-\*\/\(\)\.\s]/g, '');
    
    // تحقق من أن التعبير آمن
    if (!/^[\d\s\+\-\*\/\(\)\.]+$/.test(sanitized)) {
        throw new Error('Invalid expression');
    }
    
    try {
        // استخدام Function constructor مع تحقق إضافي
        const fn = new Function('return ' + sanitized);
        const result = fn();
        
        // تحقق من أن النتيجة عدد صالح
        if (typeof result !== 'number' || !isFinite(result)) {
            throw new Error('Invalid result');
        }
        
        return result;
    } catch (e) {
        throw e;
    }
}

// التحقق من صحة التاريخ
// ابحث عن هذا المكان في الكود وأضف الدالة هناك
function isValidDateYYYY(dateString) {
    const pattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    if (!pattern.test(dateString)) return false;
    
    const parts = dateString.split('/');
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);
    
    const date = new Date(year, month - 1, day);
    return date.getFullYear() === year && 
           date.getMonth() === month - 1 && 
           date.getDate() === day;
}

// أضف هذه الدالة مباشرة بعد isValidDateYYYY
function isValidProductDate(dateStr) {
    if (!dateStr || dateStr.trim() === '') return false;
    
    // قائمة التواريخ غير الصالحة
    const invalidDates = [
        "30/12/1899", "01/01/1900", "00/01/1900", "0000-00-00",
        "31/12/1899", "30/11/1899", "31/10/1899", "01/01/1899",
        "29/12/1899", "28/12/1899", "27/12/1899"
    ];
    
    // إذا كان التاريخ في القائمة غير الصالحة
    if (invalidDates.includes(dateStr)) {
        return false;
    }
    
    // إذا كان يحتوي على سنوات قديمة
    if (dateStr.includes("1899") || dateStr.includes("1900")) {
        return false;
    }
    
    // تحقق من التنسيق
    const pattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    if (!pattern.test(dateStr)) {
        return false;
    }
    
    const parts = dateStr.split('/');
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);
    
    // تحقق من السنة (بين 2020 و 2030)
    if (year < 2020 || year > 2030) {
        return false;
    }
    
    // تحقق من الشهر
    if (month < 1 || month > 12) {
        return false;
    }
    
    // تحقق من اليوم
    const daysInMonth = new Date(year, month, 0).getDate();
    if (day < 1 || day > daysInMonth) {
        return false;
    }
    
    return true;
}

// تحميل البيانات
function loadAllDataFromStorage() {
    const produitsData = localStorage.getItem(DATA_SOURCES.produits.storageKey);
    if (produitsData) {
        produitsCache = JSON.parse(produitsData);
        DATA_SOURCES.produits.cache = produitsCache;
    }
    
    const adressesData = localStorage.getItem(DATA_SOURCES.adresses.storageKey);
    if (adressesData) {
        csvCache = JSON.parse(adressesData);
        DATA_SOURCES.adresses.cache = csvCache;
    }
    
    const ventesData = localStorage.getItem(DATA_SOURCES.ventes.storageKey);
    if (ventesData) {
        csvNewCache = JSON.parse(ventesData);
        DATA_SOURCES.ventes.cache = csvNewCache;
    }
    
    const prixEpicerieData = localStorage.getItem(DATA_SOURCES.prixEpicerie.storageKey);
    if (prixEpicerieData) {
        prixDataCache.epicerie = JSON.parse(prixEpicerieData);
        DATA_SOURCES.prixEpicerie.cache = prixDataCache.epicerie;
    }
    
    const prixBiscuiterieData = localStorage.getItem(DATA_SOURCES.prixBiscuiterie.storageKey);
    if (prixBiscuiterieData) {
        prixDataCache.biscuiterie = JSON.parse(prixBiscuiterieData);
        DATA_SOURCES.prixBiscuiterie.cache = prixDataCache.biscuiterie;
    }
}

function saveDataToStorage(source, data) {
    localStorage.setItem(source.storageKey, JSON.stringify(data));
    localStorage.setItem(source.lastUpdateKey, new Date().toISOString());
}

async function updateDataSource(source) {
    try {
        console.log('MISE À JOUR DES DONNÉES:', source.storageKey);
        const response = await fetch(source.url);
        
        if (!response.ok) {
            throw new Error(`ERREUR HTTP: ${response.status}`);
        }
        
        const text = await response.text();
        const data = text.split("\n").map(l => l.split("\t"));
        
        saveDataToStorage(source, data);
        source.cache = data;
        
        console.log(`DONNÉES MISE À JOUR: ${source.storageKey}`, data.length, 'LIGNES');
        return true;
    } catch (error) {
        console.error(`ERREUR LORS DE LA MISE À JOUR DE ${source.storageKey}:`, error);
        return false;
    }
}

async function updatePrixDataSource(departement) {
    const source = departement === 'epicerie' ? DATA_SOURCES.prixEpicerie : DATA_SOURCES.prixBiscuiterie;
    
    try {
        console.log('MISE À JOUR DES DONNÉES DE PRIX:', source.storageKey);
        const response = await fetch(source.url);
        
        if (!response.ok) {
            throw new Error(`ERREUR HTTP: ${response.status}`);
        }
        
        const text = await response.text();
        const data = parseCSV(text);
        
        saveDataToStorage(source, data);
        source.cache = data;
        prixDataCache[departement] = data;
        
        console.log(`DONNÉES DE PRIX MISE À JOUR: ${source.storageKey}`, data.length, 'LIGNES');
        return true;
    } catch (error) {
        console.error(`ERREUR LORS DE LA MISE À JOUR DE ${source.storageKey}:`, error);
        createSamplePrixData(departement);
        return false;
    }
}

function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const result = [];
    
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].trim()) {
            const cells = lines[i].split(',').map(cell => {
                return cell.replace(/^"|"$/g, '').trim();
            });
            result.push(cells);
        }
    }
    
    return result;
}

function createSamplePrixData(departement) {
    const sampleData = [
        ["Date debut", "Date fin", "Numero Lot Permanent", "Numero Lot Promo", "Gencode", "Libelle", "Prix de vente a la date de debut", "Prix de vente a la date de fin", "Code tarif", "Qte en stock"],
        ["01/01/2024", "31/01/2024", "LP001", "PR001", "123456", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "10.00", "12.00", "PERMANENT", "67"],
        ["01/01/2024", "31/01/2024", "LP002", "PR002", "789012", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "15.00", "18.00", "PROMO", "42"],
        ["01/02/2024", "29/02/2024", "LP003", "PR003", "345678", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "20.00", "25.00", "PERMANENT", "89"],
        ["01/02/2024", "29/02/2024", "LP004", "PR004", "901234", "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G", "30.00", "35.00", "PROMO", "56"]
    ];
    
    if (departement === 'biscuiterie') {
        sampleData[1][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
        sampleData[2][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
        sampleData[3][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
        sampleData[4][5] = "CERELAC MULTI CEREALC 0 ADDED SUGAR 250G";
    }
    
    prixDataCache[departement] = sampleData;
    
    const storageKey = departement === 'epicerie' ? DATA_SOURCES.prixEpicerie.storageKey : DATA_SOURCES.prixBiscuiterie.storageKey;
    localStorage.setItem(storageKey, JSON.stringify(sampleData));
}

async function updateAllData() {
    try {
        const results = await Promise.allSettled([
            updateDataSource(DATA_SOURCES.produits),
            updateDataSource(DATA_SOURCES.adresses),
            updateDataSource(DATA_SOURCES.ventes),
            updatePrixDataSource('epicerie'),
            updatePrixDataSource('biscuiterie')
        ]);
        
        produitsCache = DATA_SOURCES.produits.cache;
        csvCache = DATA_SOURCES.adresses.cache;
        csvNewCache = DATA_SOURCES.ventes.cache;
        prixDataCache.epicerie = DATA_SOURCES.prixEpicerie.cache;
        prixDataCache.biscuiterie = DATA_SOURCES.prixBiscuiterie.cache;
        
        console.log('DONNÉES MISE À JOUR');
    } catch (error) {
        console.error('ERREUR LORS DE LA MISE À JOUR DES DONNÉES:', error);
    }
}
// دالة جديدة لتحميل البيانات عند الطلب فقط
let dataLoadPromises = {};

async function updateDataOnDemand(pageType) {
    try {
        const promises = [];
        
        // تحميل البيانات حسب الصفحة المطلوبة
        switch(pageType) {
            case 'info':
            case 'ajouter':
            case 'retirer':
            case 'commande':
            case 'panier':
                if (!dataLoadPromises.produits) {
                    dataLoadPromises.produits = updateDataSource(DATA_SOURCES.produits);
                }
                promises.push(dataLoadPromises.produits);
                break;
                
            case 'adresse':
            case 'dlc':
            case 'rupture':
                if (!dataLoadPromises.adresses) {
                    dataLoadPromises.adresses = updateDataSource(DATA_SOURCES.adresses);
                }
                promises.push(dataLoadPromises.adresses);
                break;
                
            case 'changement':
                if (currentPrixDepartement === 'epicerie' && !dataLoadPromises.prixEpicerie) {
                    dataLoadPromises.prixEpicerie = updatePrixDataSource('epicerie');
                    promises.push(dataLoadPromises.prixEpicerie);
                } else if (currentPrixDepartement === 'biscuiterie' && !dataLoadPromises.prixBiscuiterie) {
                    dataLoadPromises.prixBiscuiterie = updatePrixDataSource('biscuiterie');
                    promises.push(dataLoadPromises.prixBiscuiterie);
                }
                break;
        }
        
        // تحميل البيانات الضرورية فقط
        if (promises.length > 0) {
            const results = await Promise.allSettled(promises);
            
            // تحديث الكاشات فقط للبيانات المحملة
            results.forEach((result, index) => {
                if (result.status === 'fulfilled') {
                    const key = Object.keys(dataLoadPromises)[index];
                    switch(key) {
                        case 'produits':
                            produitsCache = DATA_SOURCES.produits.cache;
                            break;
                        case 'adresses':
                            csvCache = DATA_SOURCES.adresses.cache;
                            break;
                        case 'prixEpicerie':
                            prixDataCache.epicerie = DATA_SOURCES.prixEpicerie.cache;
                            break;
                        case 'prixBiscuiterie':
                            prixDataCache.biscuiterie = DATA_SOURCES.prixBiscuiterie.cache;
                            break;
                    }
                }
            });
            
            console.log(`Données chargées pour: ${pageType}`);
        }
        
    } catch (error) {
        console.error('Erreur lors du chargement des données:', error);
    }
}

// تحديث وظائف فتح الصفحات لتستخدم التحميل عند الطلب
function openInfo(){
    updateDataOnDemand('info').then(() => {
        document.getElementById("mainPage").style.display = "none";
        document.getElementById("infoPage").style.display = "block";
        document.getElementById("codeInput").focus();
    });
}

function openAjouter(){
    updateDataOnDemand('ajouter').then(() => {
        document.getElementById("mainPage").style.display = "none";
        document.getElementById("ajouterPage").style.display = "block";
        
        updateAjouterDisplay();
        document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
        
        // إعداد التحقق من الكمية
        setupAjouterValidation();

        // إعداد التحقق من صحة التاريخ وتلوين الحقول
        setupDateValidationForAjouter();
    });
}

async function loadPrixData() {
    try {
        if (prixDataCache.epicerie.length === 0) {
            const epicerieData = localStorage.getItem(DATA_SOURCES.prixEpicerie.storageKey);
            if (epicerieData) {
                prixDataCache.epicerie = JSON.parse(epicerieData);
            } else {
                await updatePrixDataSource('epicerie');
            }
        }
        
        if (prixDataCache.biscuiterie.length === 0) {
            const biscuiterieData = localStorage.getItem(DATA_SOURCES.prixBiscuiterie.storageKey);
            if (biscuiterieData) {
                prixDataCache.biscuiterie = JSON.parse(biscuiterieData);
            } else {
                await updatePrixDataSource('biscuiterie');
            }
        }
        
        console.log('DONNÉES DE PRIX CHARGÉES');
    } catch (error) {
        console.error('ERREUR LORS DU CHARGEMENT DES DONNÉES DE PRIX:', error);
    }
}

// عرض تنبيه
function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert-message ${type}`;
    alert.innerHTML = `
        <span class="alert-icon">${type === 'success' ? '✓' : type === 'warning' ? '⚠' : 'ℹ'}</span>
        <span>${message}</span>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.style.animation = 'alertSlideIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 300);
    }, 3000);
}

// ============================================
// وظائف PARTAGER
// ============================================

// وظيفة المشاركة الرئيسية - إصلاح لـ webtonotive
// ============================================
// وظائف PARTAGER مع العناوين في ملفات الإكسال
// ============================================

// دالة لإنشاء رأس ملف الإكسال
function createExcelHeader(title, dataLength) {
    const today = new Date();
    const dateStr = today.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
    
    return [
        [title], // عنوان الصفحة
        [""], // سطر فارغ
        ["MARJANE BERKANE"],
        ["DÉPARTEMENT P-G--C"],
        [dateStr], // التاريخ
        ["", ""], // سطرين فارغين
        // سطر رؤوس الأعمدة سيتم إضافته بعد
    ];
}

// وظيفة المشاركة الرئيسية - إصلاح لـ webtonotive (كما كانت بالضبط)
async function shareXLSXDirect(data, filename, title) {
    try {
        if (data.length === 0) {
            showAlert("AUCUN PRODUIT À PARTAGER!", 'warning');
            return;
        }
        
        // إظهار رسالة الانتظار
        showAlert("Please wait, downloading file to share", 'info');
        
        // 1. إنشاء الرأس
        const headerRows = createExcelHeader(title, data.length);
        
        // 2. تحضير البيانات مع الرأس
        let allData = [];
        
        // إضافة الصفوف الفارغة من الرأس
        headerRows.forEach(row => {
            allData.push(row);
        });
        
        // إضافة رؤوس الأعمدة (أول سطر من البيانات)
        if (data.length > 0) {
            const headers = Object.keys(data[0]);
            allData.push(headers);
        }
        
        // إضافة البيانات الفعلية
        data.forEach(item => {
            const row = [];
            Object.keys(item).forEach(key => {
                row.push(item[key]);
            });
            allData.push(row);
        });
        
        // 3. إنشاء ملف Excel
        const ws = XLSX.utils.aoa_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Produits");
        
        // 4. تخصيص عرض الأعمدة
        const colWidths = [];
        const maxColumns = data.length > 0 ? Object.keys(data[0]).length : 5;
        
        for (let i = 0; i < maxColumns; i++) {
    colWidths.push({ wch: 15 }); //
        }
        
        ws['!cols'] = colWidths;
        
        // 5. إنشاء الملف
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        
        // 6. تنزيل الملف أولاً بشكل إجباري (كما كان)
        const downloadUrl = URL.createObjectURL(blob);
        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = filename;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // انتظار قليل لتنزيل الملف
        setTimeout(async () => {
            try {
                // 7. محاولة المشاركة بعد التنزيل (كما كان)
                console.log('المحاولة بعد تنزيل الملف...');
                
                // المحاولة 1: كما في توثيق webtonotive بالضبط
                try {
                    await navigator.share({
                        type: "file",
                        url: downloadUrl,
                        extension: "xlsx",
                        text: `📋 ${title} - ${data.length} produits`
                    });
                    
                    showAlert("Fichier partagé avec succès!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err1) {
                    console.log('المحاولة 1 فشلت:', err1);
                }
                
                // المحاولة 2: مع مسار ملف محلي
                try {
                    const fakeLocalPath = `file:///storage/emulated/0/Download/${filename}`;
                    
                    await navigator.share({
                        type: "file",
                        url: fakeLocalPath,
                        extension: "xlsx",
                        text: `${title} - ${data.length} produits`
                    });
                    
                    showAlert("Fichier partagé avec succès!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err2) {
                    console.log('المحاولة 2 فشلت:', err2);
                }
                
                // المحاولة 3: كمشاركة نصية فقط
                try {
                    await navigator.share({
                        type: "url",
                        url: `Le fichier "${filename}" a été téléchargé dans votre dossier Téléchargements.`,
                        text: `${title} - ${data.length} produits`
                    });
                    
                    showAlert("Information partagée!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err3) {
                    console.log('المحاولة 3 فشلت:', err3);
                }
                
                // إذا فشلت كل المحاولات
                URL.revokeObjectURL(downloadUrl);
                showAlert("Le fichier a été téléchargé. Utilisez le menu de partage de votre appareil.", 'info');
                
            } catch (finalErr) {
                console.error('Erreur finale:', finalErr);
                showAlert("Le fichier a été téléchargé avec succès.", 'success');
            }
        }, 1500);
        
    } catch (err) {
        console.error('Erreur de partage:', err);
        showAlert("Erreur lors du téléchargement du fichier", 'warning');
    }
}

// وظائف PARTAGER لكل صفحة (كما كانت بالضبط)
function partagerAdresse() {
    const searchTerm = document.getElementById("adresseInput").value.trim();
    const container = document.getElementById("resultatsContainer");
    const cards = container.querySelectorAll('.adresseCard');
    
    let data = [];
    
    if (searchType === 'adresse' && searchTerm) {
        let rechercheFinale = searchTerm;
        if (searchTerm.includes('/')) {
            const parties = searchTerm.split('/');
            if (parties.length === 2) {
                const num1 = parties[0].trim();
                const num2 = parties[1].trim();
                rechercheFinale = `Z${num1}P${num2}`;
            }
        }
        
        // جمع البيانات من البطاقات المعروضة على الشاشة
        cards.forEach(card => {
            const title = card.querySelector('h3');
            const codeRow = card.querySelector('.codeRow');
            const nameRow = card.querySelector('.nameRow');
            const qteRows = card.querySelectorAll('.qteRow');
            const totalRow = card.querySelector('.totalRow');
            
            if (title && codeRow) {
                const adresse = title.textContent.trim();
                const codeProduit = codeRow.textContent.trim();
                const nomProduit = nameRow ? nameRow.textContent.trim() : getProductNameByCode(codeProduit);
                
                let totalQte = 0;
                let dlcPlusProche = "";
                let dateDlcPlusProche = null;
                let hasValidDate = false;
                
                // جمع البيانات من صفوف الكميات المعروضة
                qteRows.forEach(qteRow => {
                    const qteSpan = qteRow.querySelector('.qte-value');
                    const dateSpan = qteRow.querySelector('.date-value');
                    
                    if (qteSpan && dateSpan) {
                        const qteText = qteSpan.textContent.trim();
                        const dateText = dateSpan.textContent.trim();
                        
                        const qNum = parseFloat(qteText.replace(/[^0-9.-]+/g,"")) || 0;
                        totalQte += qNum;
                        
                        // التحقق من صحة التاريخ
                        const isValidDate = dateText && dateText !== "00/01/1900" && dateText !== "0000-00-00";
                        const dateObj = isValidDate ? parseDate(dateText) : null;
                        
                        if (dateObj) {
                            hasValidDate = true;
                            if (!dateDlcPlusProche || dateObj < dateDlcPlusProche) {
                                dateDlcPlusProche = dateObj;
                                dlcPlusProche = dateText;
                            }
                        }
                    }
                });
                
                // إذا لم يكن هناك تاريخ صالح، استخدم التاريخ من totalRow إذا كان موجوداً
                if (!hasValidDate && totalRow) {
                    const totalText = totalRow.textContent;
                    // محاولة استخراج التاريخ من totalRow (إن وجد)
                    const dateMatch = totalText.match(/\d{2}\/\d{2}\/\d{4}/);
                    if (dateMatch) {
                        const dateObj = parseDate(dateMatch[0]);
                        if (dateObj) {
                            dlcPlusProche = dateMatch[0];
                        }
                    }
                }
                
                if (totalQte > 0) {
                    data.push({
                        "ADRESSE": adresse,
                        "CODE": codeProduit,
                        "NOM": nomProduit || "PRODUIT INCONNU",
                        "QUANTITÉ": totalQte,
                        "DLC": dlcPlusProche || "N/A"
                    });
                }
            }
        });
    } else if (searchType === 'code' && searchTerm) {
        // في حالة البحث بالكود، نأخذ البيانات من البطاقات المعروضة
        cards.forEach(card => {
            const title = card.querySelector('h3');
            const codeRow = card.querySelector('.codeRow');
            const nameRow = card.querySelector('.nameRow');
            const qteRows = card.querySelectorAll('.qteRow');
            
            if (title && codeRow) {
                const adresse = title.textContent.trim();
                const codeProduit = codeRow.textContent.trim();
                
                // فقط المنتجات التي تطابق كود البحث
                if (codeProduit === searchTerm) {
                    const nomProduit = nameRow ? nameRow.textContent.trim() : getProductNameByCode(codeProduit);
                    
                    let totalQte = 0;
                    let dlcPlusProche = "";
                    let dateDlcPlusProche = null;
                    
                    // جمع البيانات من صفوف الكميات
                    qteRows.forEach(qteRow => {
                        const qteSpan = qteRow.querySelector('.qte-value');
                        const dateSpan = qteRow.querySelector('.date-value');
                        
                        if (qteSpan && dateSpan) {
                            const qteText = qteSpan.textContent.trim();
                            const dateText = dateSpan.textContent.trim();
                            
                            const qNum = parseFloat(qteText.replace(/[^0-9.-]+/g,"")) || 0;
                            totalQte += qNum;
                            
                            // التحقق من صحة التاريخ
                            const isValidDate = dateText && dateText !== "00/01/1900" && dateText !== "0000-00-00";
                            const dateObj = isValidDate ? parseDate(dateText) : null;
                            
                            if (dateObj && (!dateDlcPlusProche || dateObj < dateDlcPlusProche)) {
                                dateDlcPlusProche = dateObj;
                                dlcPlusProche = dateText;
                            }
                        }
                    });
                    
                    if (totalQte > 0) {
                        data.push({
                            "ADRESSE": adresse,
                            "CODE": codeProduit,
                            "NOM": nomProduit || "PRODUIT INCONNU",
                            "QUANTITÉ": totalQte,
                            "DLC": dlcPlusProche || "N/A"
                        });
                    }
                }
            }
        });
    }
    
    if (data.length === 0) {
        showAlert("AUCUN PRODUIT À PARTAGER!", 'warning');
        return;
    }
    
    shareXLSXDirect(data, "Contenu_Adresse.xlsx", "CONTENUE D'ADRESSE");
}

function partagerRupture() {
    const container = document.getElementById("ruptureContainer");
    const cards = container.querySelectorAll('.adresseCard');
    
    let data = [];
    
    // جمع البيانات من البطاقات المعروضة على الشاشة
    cards.forEach(card => {
        const title = card.querySelector('h3');
        const codeRow = card.querySelector('.codeRow');
        const nameRow = card.querySelector('.nameRow');
        const qteRows = card.querySelectorAll('.qteRow');
        const totalRow = card.querySelector('.totalRow');
        
        if (title && codeRow) {
            const adresse = title.textContent.trim();
            const codeProduit = codeRow.textContent.trim();
            const nomProduit = nameRow ? nameRow.textContent.trim() : getProductNameByCode(codeProduit);
            
            // الحصول على QTE GOLD و QTE RESERVE
            const qteGold = getQteGoldByCode(codeProduit);
            const qteReserve = getQteReserveByCode(codeProduit);
            const qteGoldNum = parseFloat(qteGold.replace(/[^0-9.-]+/g,"")) || 0;
            const qteReserveNum = parseFloat(qteReserve.replace(/[^0-9.-]+/g,"")) || 0;
            
            let totalQte = 0;
            let dlcPlusProche = "";
            let dateDlcPlusProche = null;
            
            // جمع البيانات من صفوف الكميات المعروضة
            qteRows.forEach(qteRow => {
                const qteSpan = qteRow.querySelector('.qte-value');
                const dateSpan = qteRow.querySelector('.date-value');
                
                if (qteSpan && dateSpan) {
                    const qteText = qteSpan.textContent.trim();
                    const dateText = dateSpan.textContent.trim();
                    
                    const qNum = parseFloat(qteText.replace(/[^0-9.-]+/g,"")) || 0;
                    totalQte += qNum;
                    
                    // التحقق من صحة التاريخ
                    const isValidDate = dateText && dateText !== "00/01/1900" && dateText !== "0000-00-00";
                    const dateObj = isValidDate ? parseDate(dateText) : null;
                    
                    if (dateObj && (!dateDlcPlusProche || dateObj < dateDlcPlusProche)) {
                        dateDlcPlusProche = dateObj;
                        dlcPlusProche = dateText;
                    }
                }
            });
            
            // إذا لم يكن هناك تاريخ صالح، استخدم التاريخ من totalRow إذا كان موجوداً
            if (!dlcPlusProche && totalRow) {
                const totalText = totalRow.textContent;
                const dateMatch = totalText.match(/\d{2}\/\d{2}\/\d{4}/);
                if (dateMatch) {
                    const dateObj = parseDate(dateMatch[0]);
                    if (dateObj) {
                        dlcPlusProche = dateMatch[0];
                    }
                }
            }
            
            if (totalQte > 0) {
                data.push({
                    "ADRESSE": adresse,
                    "CODE": codeProduit,
                    "NOM": nomProduit || "PRODUIT INCONNU",
                    "QTE Gold": qteGoldNum,
                    "QTE Reserve": qteReserveNum,
                    "QUANTITÉ": totalQte,
                    "DLC": dlcPlusProche || "N/A"
                });
            }
        }
    });
    
    if (data.length === 0) {
        showAlert("AUCUN PRODUIT À PARTAGER!", 'warning');
        return;
    }
    
    shareXLSXDirect(data, "Rupture_Rayon.xlsx", "REPTURE RAYON");
}

// ============================================
// وظائف PARTAGER لصفحة DLC RESERVE
// ============================================

function partagerDLC() {
    const monthSelect = document.getElementById('monthSelect');
    const selectedMonth = monthSelect.value;
    
    if (!selectedMonth) {
        showAlert("SÉLECTIONNEZ D'ABORD UN MOIS", 'warning');
        return;
    }
    
    let data = [];
    const rayonsSet = new Set(); // لتحديد نوع الرايون
    
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        const codeProduit = csvCache[i][0] || "";
        
        let adresseValide = false;
        let rayon = '';
        
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
            rayon = 'EPICERIE';
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
            rayon = 'BISCUITERIE';
        }
        
        if (adresseValide && codeProduit) {
            let datesDetails = [];
            
            for(let j = 2; j < 8; j += 2) {
                let q = (csvCache[i][j] || "").trim();
                let d = (csvCache[i][j+1] || "").trim();
                const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                const monthFromDate = getMonthFromDate(d);
                
                if (qNum > 0 && monthFromDate === selectedMonth) {
                    const dateObj = parseDate(d);
                    if (dateObj && dateObj > new Date('2020-01-01')) {
                        datesDetails.push({
                            qte: qNum,
                            date: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            // فرز التواريخ من الأقرب إلى الأبعد
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            // إضافة كل تاريخ كسطر منفصل
            datesDetails.forEach(detail => {
                const nomProduit = getProductNameByCode(codeProduit);
                
                data.push({
                    "ADRESSE": adresse,
                    "CODE": codeProduit,
                    "NOM": nomProduit || "PRODUIT INCONNU",
                    "QUANTITÉ": detail.qte,
                    "DLC": detail.date,
                    "RAYON": rayon
                });
            });
        }
    }
    
    // فرز البيانات حسب تاريخ DLC من الأقرب إلى الأبعد
    data.sort((a, b) => {
        const dateA = parseDate(a.DLC);
        const dateB = parseDate(b.DLC);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
    
    // مشاركة البيانات مع توسيط النص فقط
    shareXLSXDirectWithCentering(data, "DLC_Reserve.xlsx", "DLC RESERVE");
}

// دالة مساعدة لتطبيق التوسيع فقط
async function shareXLSXDirectWithCentering(data, filename, title) {
    // إعادة استخدام نفس الكود الأصلي مع تعديل بسيط
    await shareXLSXDirect(data, filename, title);
}

// الآن عدل دالة shareXLSXDirect الأصلية لإضافة التوسيط
async function shareXLSXDirect(data, filename, title) {
    try {
        if (data.length === 0) {
            showAlert("AUCUN PRODUIT À PARTAGER!", 'warning');
            return;
        }
        
        // إظهار رسالة الانتظار
        showAlert("Please wait, downloading file to share", 'info');
        
        // 1. إنشاء الرأس
        const headerRows = createExcelHeader(title, data.length);
        
        // 2. تحضير البيانات مع الرأس
        let allData = [];
        
        // إضافة الصفوف الفارغة من الرأس
        headerRows.forEach(row => {
            allData.push(row);
        });
        
        // إضافة رؤوس الأعمدة (أول سطر من البيانات)
        if (data.length > 0) {
            const headers = Object.keys(data[0]);
            allData.push(headers);
        }
        
        // إضافة البيانات الفعلية
        data.forEach(item => {
            const row = [];
            Object.keys(item).forEach(key => {
                row.push(item[key]);
            });
            allData.push(row);
        });
        
        // 3. إنشاء ملف Excel
        const ws = XLSX.utils.aoa_to_sheet(allData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Produits");
        
        // 4. تطبيق تنسيق التوسيط على جميع الخلايا
        const range = XLSX.utils.decode_range(ws['!ref']);
        for(let R = range.s.r; R <= range.e.r; ++R) {
            for(let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = {c: C, r: R};
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                
                if (!ws[cell_ref]) continue;
                
                // إضافة تنسيق التوسيط فقط
                if (!ws[cell_ref].s) {
                    ws[cell_ref].s = {};
                }
                if (!ws[cell_ref].s.alignment) {
                    ws[cell_ref].s.alignment = {};
                }
                ws[cell_ref].s.alignment.horizontal = 'center';
                ws[cell_ref].s.alignment.vertical = 'center';
                ws[cell_ref].s.alignment.wrapText = true;
            }
        }
        
        // 5. تخصيص عرض الأعمدة
        const colWidths = [];
        const maxColumns = data.length > 0 ? Object.keys(data[0]).length : 5;
        
        for (let i = 0; i < maxColumns; i++) {
            colWidths.push({ wch: 15 }); //
        }
        
        ws['!cols'] = colWidths;
        
        // 6. إنشاء الملف
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        
        // 7. تنزيل الملف أولاً بشكل إجباري (كما كان)
        const downloadUrl = URL.createObjectURL(blob);
        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = filename;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // انتظار قليل لتنزيل الملف
        setTimeout(async () => {
            try {
                // 8. محاولة المشاركة بعد التنزيل (كما كان)
                console.log('المحاولة بعد تنزيل الملف...');
                
                // المحاولة 1: كما في توثيق webtonotive بالضبط
                try {
                    await navigator.share({
                        type: "file",
                        url: downloadUrl,
                        extension: "xlsx",
                        text: `📋 ${title} - ${data.length} produits`
                    });
                    
                    showAlert("Fichier partagé avec succès!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err1) {
                    console.log('المحاولة 1 فشلت:', err1);
                }
                
                // المحاولة 2: مع مسار ملف محلي
                try {
                    const fakeLocalPath = `file:///storage/emulated/0/Download/${filename}`;
                    
                    await navigator.share({
                        type: "file",
                        url: fakeLocalPath,
                        extension: "xlsx",
                        text: `${title} - ${data.length} produits`
                    });
                    
                    showAlert("Fichier partagé avec succès!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err2) {
                    console.log('المحاولة 2 فشلت:', err2);
                }
                
                // المحاولة 3: كمشاركة نصية فقط
                try {
                    await navigator.share({
                        type: "url",
                        url: `Le fichier "${filename}" a été téléchargé dans votre dossier Téléchargements.`,
                        text: `${title} - ${data.length} produits`
                    });
                    
                    showAlert("Information partagée!", 'success');
                    URL.revokeObjectURL(downloadUrl);
                    return;
                } catch (err3) {
                    console.log('المحاولة 3 فشلت:', err3);
                }
                
                // إذا فشلت كل المحاولات
                URL.revokeObjectURL(downloadUrl);
                showAlert("Le fichier a été téléchargé. Utilisez le menu de partage de votre appareil.", 'info');
                
            } catch (finalErr) {
                console.error('Erreur finale:', finalErr);
                showAlert("Le fichier a été téléchargé avec succès.", 'success');
            }
        }, 1500);
        
    } catch (err) {
        console.error('Erreur de partage:', err);
        showAlert("Erreur lors du téléchargement du fichier", 'warning');
    }
}

// ============================================
// دالة مساعدة لمقارنة التواريخ
// ============================================

function isEarlierDate(dateStr1, dateStr2) {
    const date1 = parseDate(dateStr1);
    const date2 = parseDate(dateStr2);
    
    if (!date1 || !date2) return false;
    return date1 < date2;
}

// ============================================
// دالة مساعدة للحصول على الشهر من التاريخ
// ============================================

function getMonthFromDate(dateStr) {
    if (!dateStr || dateStr === "00/01/1900" || dateStr === "0000-00-00") {
        return null;
    }
    
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const month = parts[1];
        let year = parts[2];
        
        if (year.length === 2) {
            year = '20' + year;
        }
        
        return `${month}/${year}`;
    }
    
    return null;
}

function partagerCommande() {
    const data = commandeProduits.map(p => ({
        "CODE": p.code,
        "NOM": p.nom,
        "Quantité": p.qte
    }));
    
    shareXLSXDirect(data, "Commande.xlsx", "COMMANDE");
}

function partagerAjouter() {
    const data = ajouterProduits.map(p => ({
        "ADRESSE": p.adresse,
        "CODE": p.code,
        "NOM": p.nom,
        "QTE 1": p.qte1,
        "DLC 1": p.dlc1,
        "QTE 2": p.qte2,
        "DLC 2": p.dlc2,
        "QTE 3": p.qte3,
        "DLC 3": p.dlc3
    }));
    
    shareXLSXDirect(data, "Ajouter.xlsx", "AJOUTER");
}

function partagerCasse() {
    const data = casseProduits.map(p => ({
        "CODE": p.code,
        "NOM": p.nom,
        "Quantité": p.qte,
        "Date": p.date
    }));
    
    shareXLSXDirect(data, "Casse_Frais.xlsx", "CASSE FRAIS");
}

function partagerRetirer() {
    const data = retirerProduits.map(p => ({
        "ADRESSE": p.adresse,
        "CODE": p.code,
        "NOM": p.nom,
        "QTE 1": p.qte1,
        "DLC 1": p.dlc1,
        "QTE 2": p.qte2,
        "DLC 2": p.dlc2,
        "QTE 3": p.qte3,
        "DLC 3": p.dlc3
    }));
    
    shareXLSXDirect(data, "Retirer.xlsx", "RETIRER");
}

function partagerPanier() {
    const data = panierProduits.map(p => {
        const prixVente = parseFloat(p.prix.replace(',', '.')) || 0;
        const totalProduit = prixVente * p.qte;
        return {
            "CODE": p.code,
            "NOM": p.nom,
            "QUANTITÉ": p.qte,
            "PRIX UNITAIRE": p.prix,
            "PRIX TOTAL": totalProduit.toFixed(2)
        };
    });
    
    // حساب الإجماليات
    let totalArticles = 0;
    let totalPrixGlobal = 0;
    
    panierProduits.forEach(p => {
        totalArticles += p.qte;
        const prixVente = parseFloat(p.prix.replace(',', '.')) || 0;
        totalPrixGlobal += prixVente * p.qte;
    });
    
    // إضافة سطر فارغ ثم TOTAL
    if (panierProduits.length > 0) {
        // سطر فارغ
        data.push({
            "CODE": "",
            "NOM": "",
            "QUANTITÉ": "",
            "PRIX UNITAIRE": "",
            "PRIX TOTAL": ""
        });
        
        // TOTAL
        data.push({
            "CODE": "",
            "NOM": "TOTAL",
            "QUANTITÉ": totalArticles,
            "PRIX UNITAIRE": "",
            "PRIX TOTAL": totalPrixGlobal.toFixed(2)
        });
    }
    
    shareXLSXDirect(data, "Panier.xlsx", "PANIER");
}

// تحديد قسم الأسعار
function setPrixDepartement(dep) {
    currentPrixDepartement = dep;
    
    document.getElementById('prixEpicerieBtn').classList.remove('active');
    document.getElementById('prixBiscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('prixEpicerieBtn').classList.add('active');
    } else {
        document.getElementById('prixBiscuiterieBtn').classList.add('active');
    }
    
    displayAllPrixData();
}

// استخراج معلومات التغيير
function extractChangementInfo(data) {
    if (data.length < 2) return {};
    
    const firstDataRow = data[1];
    
    return {
        dateDebut: firstDataRow[0] || "",
        dateFin: firstDataRow[1] || "",
        lotPermanent: firstDataRow[2] || "",
        lotPromo: firstDataRow[3] || ""
    };
}

// عرض جميع بيانات الأسعار
function displayAllPrixData() {
    const container = document.getElementById('changementResultsContainer');
    const infoContainer = document.getElementById('changementInfoContainer');
    
    container.innerHTML = '';
    infoContainer.innerHTML = '';
    
    const currentData = prixDataCache[currentPrixDepartement];
    
    if (!currentData || currentData.length === 0) {
        const noDataCard = document.createElement('div');
        noDataCard.className = 'resultatChangementCard';
        noDataCard.innerHTML = `<h3>AUCUNE DONNÉE DISPONIBLE POUR ${currentPrixDepartement.toUpperCase()}</h3>`;
        container.appendChild(noDataCard);
        return;
    }
    
    changementInfo = extractChangementInfo(currentData);
    
    if (changementInfo.dateDebut || changementInfo.dateFin || changementInfo.lotPermanent || changementInfo.lotPromo) {
        const infoCard = document.createElement('div');
        infoCard.className = 'infoChangementCard';
        
        const title = document.createElement('h3');
        title.textContent = 'INFORMATIONS DE CHANGEMENT';
        infoCard.appendChild(title);
        
        if (changementInfo.dateDebut) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE DEBUT:</span> <span class="value">${changementInfo.dateDebut}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.dateFin) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE FIN:</span> <span class="value">${changementInfo.dateFin}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPermanent) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PERMANENT:</span> <span class="value lot-permanent">${changementInfo.lotPermanent}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPromo) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PROMO:</span> <span class="value lot-promo">${changementInfo.lotPromo}</span>`;
            infoCard.appendChild(row);
        }
        
        infoContainer.appendChild(infoCard);
    }
    
    let produitsTrouves = 0;
    
    for (let i = 1; i < currentData.length; i++) {
        const row = currentData[i];
        
        if (row.length >= 10) {
            const gencode = row[4] || "";
            const libelle = row[5] || "";
            const prixDebut = row[6] || "";
            const prixFin = row[7] || "";
            const codeTarif = row[8] || "";
            const qteStock = row[9] || "";
            
            if (gencode) {
                produitsTrouves++;
                createPrixResultCard(container, gencode, libelle, prixDebut, prixFin, codeTarif, qteStock);
            }
        }
    }
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement('div');
        totalCard.className = 'totalChangementCard';
        
        const totalTitle = document.createElement('h3');
        totalTitle.textContent = `TOTAL ${currentPrixDepartement.toUpperCase()}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement('div');
        totalRow.className = 'dataRow';
        totalRow.innerHTML = `<span class="label">NOMBRE DE PRODUITS:</span> <span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement('div');
        noResultCard.className = 'resultatChangementCard';
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT TROUVÉ</h3>`;
        container.appendChild(noResultCard);
    }
}

// إنشاء كارد نتيجة الأسعار
function createPrixResultCard(container, gencode, libelle, prixDebut, prixFin, codeTarif, qteStock) {
    const card = document.createElement('div');
    
    if (codeTarif.toUpperCase() === 'PERMANENT') {
        card.className = 'resultatChangementCard permanent';
    } else if (codeTarif.toUpperCase() === 'PROMO') {
        card.className = 'resultatChangementCard promo';
    } else {
        card.className = 'resultatChangementCard';
    }
    
    const title = document.createElement('h3');
    title.textContent = gencode;
    card.appendChild(title);
    
    if (libelle) {
        const libelleRow = document.createElement('div');
        libelleRow.className = 'dataRow';
        libelleRow.innerHTML = `<span class="value">${libelle}</span>`;
        card.appendChild(libelleRow);
    }
    
    if (prixDebut) {
        const prixDebutRow = document.createElement('div');
        prixDebutRow.className = 'dataRow';
        prixDebutRow.innerHTML = `<span class="label">PRIX DEBUT:</span> <span class="value">${prixDebut}</span>`;
        card.appendChild(prixDebutRow);
    }
    
    if (prixFin) {
        const prixFinRow = document.createElement('div');
        prixFinRow.className = 'dataRow';
        prixFinRow.innerHTML = `<span class="label">PRIX FIN:</span> <span class="value">${prixFin}</span>`;
        card.appendChild(prixFinRow);
    }
    
    if (codeTarif) {
        const codeTarifRow = document.createElement('div');
        codeTarifRow.className = 'dataRow';
        
        let colorClass = '';
        if (codeTarif.toUpperCase() === 'PERMANENT') {
            colorClass = 'lot-permanent';
        } else if (codeTarif.toUpperCase() === 'PROMO') {
            colorClass = 'lot-promo';
        }
        
        codeTarifRow.innerHTML = `<span class="label">CODE TARIF:</span> <span class="value ${colorClass}">${codeTarif}</span>`;
        card.appendChild(codeTarifRow);
    }
    
    if (qteStock) {
        const qteStockClean = qteStock.replace('.00', '').replace('.0', '');
        const qteStockRow = document.createElement('div');
        qteStockRow.className = 'dataRow';
        qteStockRow.innerHTML = `<span class="label">QTE EN STOCK:</span> <span class="value">${qteStockClean}</span>`;
        card.appendChild(qteStockRow);
    }
    
    container.appendChild(card);
}

// البحث في بيانات الأسعار
function rechercherChangementPrix() {
    const searchTerm = document.getElementById('changementCodeInput').value.trim();
    const container = document.getElementById('changementResultsContainer');
    const infoContainer = document.getElementById('changementInfoContainer');
    
    container.innerHTML = '';
    infoContainer.innerHTML = '';
    
    const currentData = prixDataCache[currentPrixDepartement];
    
    if (!currentData || currentData.length === 0) {
        const noDataCard = document.createElement('div');
        noDataCard.className = 'resultatChangementCard';
        noDataCard.innerHTML = `<h3>AUCUNE DONNÉE DISPONIBLE</h3>`;
        container.appendChild(noDataCard);
        return;
    }
    
    changementInfo = extractChangementInfo(currentData);
    
    if (changementInfo.dateDebut || changementInfo.dateFin || changementInfo.lotPermanent || changementInfo.lotPromo) {
        const infoCard = document.createElement('div');
        infoCard.className = 'infoChangementCard';
        
        const title = document.createElement('h3');
        title.textContent = 'INFORMATIONS DE CHANGEMENT';
        infoCard.appendChild(title);
        
        if (changementInfo.dateDebut) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE DEBUT:</span> <span class="value">${changementInfo.dateDebut}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.dateFin) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">DATE FIN:</span> <span class="value">${changementInfo.dateFin}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPermanent) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PERMANENT:</span> <span class="value lot-permanent">${changementInfo.lotPermanent}</span>`;
            infoCard.appendChild(row);
        }
        
        if (changementInfo.lotPromo) {
            const row = document.createElement('div');
            row.className = 'infoRow';
            row.innerHTML = `<span class="label">NUMERO LOT PROMO:</span> <span class="value lot-promo">${changementInfo.lotPromo}</span>`;
            infoCard.appendChild(row);
        }
        
        infoContainer.appendChild(infoCard);
    }
    
    let produitsTrouves = 0;
    
    for (let i = 1; i < currentData.length; i++) {
        const row = currentData[i];
        
        if (row.length >= 10) {
            const gencode = row[4] || "";
            
            if (!searchTerm || gencode.includes(searchTerm)) {
                const libelle = row[5] || "";
                const prixDebut = row[6] || "";
                const prixFin = row[7] || "";
                const codeTarif = row[8] || "";
                const qteStock = row[9] || "";
                
                if (gencode) {
                    produitsTrouves++;
                    createPrixResultCard(container, gencode, libelle, prixDebut, prixFin, codeTarif, qteStock);
                }
            }
        }
    }
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement('div');
        totalCard.className = 'totalChangementCard';
        
        const totalTitle = document.createElement('h3');
        totalTitle.textContent = `RÉSULTATS DE RECHERCHE - ${currentPrixDepartement.toUpperCase()}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement('div');
        totalRow.className = 'dataRow';
        totalRow.innerHTML = `<span class="label">PRODUITS TROUVÉS:</span> <span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement('div');
        noResultCard.className = 'resultatChangementCard';
        noResultCard.innerHTML = `<h3>AUCUN RÉSULTAT POUR "${searchTerm}"</h3>`;
        container.appendChild(noResultCard);
    }
}

// البحث التلقائي عند الكتابة
document.getElementById('changementCodeInput').addEventListener('input', function() {
    const searchTerm = this.value.trim();
    
    clearTimeout(window.changementSearchTimeout);
    window.changementSearchTimeout = setTimeout(() => {
        if (searchTerm.length > 0) {
            rechercherChangementPrix();
        } else {
            displayAllPrixData();
        }
    }, 300);
});

// البحث عند الضغط على Enter
document.getElementById('changementCodeInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        rechercherChangementPrix();
    }
});

// وظائف البحث العامة
function setSearchType(type) {
    searchType = type;
    showTotalReserve = (type === 'code');
    
    document.getElementById('searchByAdresseBtn').classList.remove('active');
    document.getElementById('searchByCodeBtn').classList.remove('active');
    
    if (type === 'adresse') {
        document.getElementById('searchByAdresseBtn').classList.add('active');
        document.getElementById('adresseInput').placeholder = "EX: 6/1 (POUR Z6P1)";
    } else {
        document.getElementById('searchByCodeBtn').classList.add('active');
        document.getElementById('adresseInput').placeholder = "ENTRER LE CODE PRODUIT";
    }
    
    document.getElementById('adresseInput').value = "";
    document.getElementById("resultatsContainer").innerHTML = "";
    document.getElementById("productNameDisplayAdresse").style.display = "none";
    
    // تفريغ مربعات التحديد عند تغيير نوع البحث
    selectedAddresses.clear();
    
    // تفريغ حقل التصفية عند تغيير نوع البحث
    clearFilterField();
}

function setDepartement(dep) {
    currentDepartement = dep;
    
    document.getElementById('epicerieBtn').classList.remove('active');
    document.getElementById('biscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('epicerieBtn').classList.add('active');
    } else {
        document.getElementById('biscuiterieBtn').classList.add('active');
    }
    
    // تفريغ مربعات التحديد عند تغيير القسم
    selectedAddresses.clear();
    
    displayRuptureProductsByDepartement();
}

function setDLCDepartement(dep) {
    currentDLCDepartement = dep;
    
    document.getElementById('dlcEpicerieBtn').classList.remove('active');
    document.getElementById('dlcBiscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('dlcEpicerieBtn').classList.add('active');
    } else {
        document.getElementById('dlcBiscuiterieBtn').classList.add('active');
    }
    
    extractAvailableMonths();
    displayDLCByMonth();
}

// الحصول على اسم المنتج
function getProductNameByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][1] || "";
        }
    }
    return "";
}

// الحصول على QTE STOCK (بدلاً من QTE GOLD)
function getQteGoldByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][6] || "0";
        }
    }
    return "0";
}

// الحصول على QTE RESERVE
function getQteReserveByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < csvCache.length; i++) {
        if(csvCache[i][0] && csvCache[i][0].trim() === codeRecherche) {
            return csvCache[i][9] || "0";
        }
    }
    return "0";
}

// الحصول على PRIX DE VENTE
function getPrixVenteByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][3] || "0";
        }
    }
    return "0";
}

// الحصول على VENTE J-1
function getVenteJ1ByCode(codeProduit) {
    const codeTrim = codeProduit.trim();
    for(let i = 1; i < csvNewCache.length; i++) {
        if(!csvNewCache[i]) continue;
        const row = csvNewCache[i].map(c=>c.trim());
        if(row[0] == codeTrim){
            return row[1] || "0";
        }
    }
    return "0";
}

document.getElementById("codeInput").addEventListener("input", function(){
    const c = this.value.trim();
    if(c!==""){ 
        chercherProduit(c); 
        remplirQTEReserve(c); 
        remplirCartesAdresse(c); 
    }
    else { 
        resetFields(); 
    }
});

// إصدار معدل: يعرض VENTE J-1 مرة واحدة فقط في القسم الصحيح
// إصدار مصحح: يظهر VENTE J-1 و COMMANDE كحقلين منفصلين
// إصدار مصحح: يظهر VENTE J-1 و COMMANDE كحقلين منفصلين بقيم منفصلة
function chercherProduit(code){
    for(let i=1;i<produitsCache.length;i++){
        if(produitsCache[i][0] && produitsCache[i][0].trim() == code){
            const nomProduit = produitsCache[i][1] || "";
            
            const container = document.getElementById("infoDataContainer");
            container.innerHTML = "";
            
            const card = document.createElement("div");
            card.className = "reserveCard";
            
            const title = document.createElement("h3"); 
            title.textContent = nomProduit; 
            card.appendChild(title);
            
            // الحصول على القيم من الدوال المناسبة
            const venteJ1Value = getVenteJ1ByCode(code);
            const commandeValue = getCommandeByCode(code); // دالة جديدة
            
            const infos = [
                {label: "RAYON", value: produitsCache[i][2] || ""},
                {label: "PRIX DE VENTE", value: formatPrix(produitsCache[i][3] || "")},
                {label: "VENTE J-1", value: venteJ1Value},
                {label: "COMMANDE", value: commandeValue}, // هنا القيمة الصحيحة للطلب
                {label: "FOURNISSEUR", value: produitsCache[i][4] || ""},
                {label: "CNEUF", value: produitsCache[i][5] || ""},
                {label: "QTE STOCK", value: produitsCache[i][6] || ""}
            ];
            
            infos.forEach(info => {
                if(info.value !== undefined && info.value !== null) {
                    const row = document.createElement("div");
                    row.className = "dataRow";
                    row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
                    card.appendChild(row);
                }
            });
            
            container.appendChild(card);
            return;
        }
    }
    document.getElementById("infoDataContainer").innerHTML = "";
}

// دالة جديدة للحصول على قيمة COMMANDE (من العمود التالي لـ VENTE J-1)
function getCommandeByCode(codeProduit) {
    const codeTrim = codeProduit.trim();
    for(let i = 1; i < csvNewCache.length; i++) {
        if(!csvNewCache[i]) continue;
        const row = csvNewCache[i].map(c=>c.trim());
        if(row[0] == codeTrim){
            // إذا كان VENTE J-1 في العمود 1، فالطلب في العمود 2
            return row[2] || "0"; // غير 1 إلى 2 للحصول على العمود التالي
        }
    }
    return "0";
}

function formatPrix(prixValue) {
    if (!prixValue) return "";
    
    prixValue = prixValue.replace(/"/g, '');
    prixValue = prixValue.replace('.', ',');
    
    if (prixValue !== "") {
        prixValue = prixValue + " DH";
    }
    
    return prixValue;
}

function remplirQTEReserve(codeProduit){
    for(let i=1;i<csvCache.length;i++){
        if(csvCache[i][0] && csvCache[i][0].trim() == codeProduit.trim()){
            const container = document.getElementById("infoDataContainer");
            const card = container.querySelector('.reserveCard');
            
            if(card) {
                const row = document.createElement("div");
                row.className = "dataRow";
                row.innerHTML = `<span class="label">QTE RESERVE:</span> <span class="value">${csvCache[i][9] || ""}</span>`;
                card.appendChild(row);
            }
            return;
        }
    }
}

function remplirCartesAdresse(codeProduit){
    const container = document.getElementById("adresseContainer");
    container.innerHTML = "";
    
    let totalQte = 0;
    let adressesTrouvees = 0;
    
    for(let i=1;i<csvCache.length;i++){
        if(csvCache[i][0] && csvCache[i][0].trim() == codeProduit.trim()){
            const adresse = csvCache[i][1] || "";
            const card = document.createElement("div");
            card.className = "adresseCard";
            const title = document.createElement("h3"); 
            title.textContent = adresse; 
            card.appendChild(title);
            
            let compteur = 1;
            let qteAdresse = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    qteAdresse += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(qteAdresse > 0){
                totalQte += qteAdresse;
                adressesTrouvees++;
                
                const totalAdresseRow = document.createElement("div");
                totalAdresseRow.className = "totalRow";
                totalAdresseRow.innerHTML = `<span class="total-value">TOTAL ${qteAdresse} UNITÉS</span>`;
                card.appendChild(totalAdresseRow);
                
                container.appendChild(card);
            }
        }
    }
    
    if(totalQte > 0){
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSE";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${adressesTrouvees} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    }
}

function rechercher() {
    const searchTerm = document.getElementById("adresseInput").value.trim();
    
    // مسح حقل التصفية عند بحث جديد
    clearFilterField();
    
    if (searchType === 'code' && searchTerm) {
        const nomProduit = getProductNameByCode(searchTerm);
        const displayElement = document.getElementById("productNameDisplayAdresse");
        if (nomProduit) {
            displayElement.textContent = nomProduit;
            displayElement.style.display = "block";
        } else {
            displayElement.style.display = "none";
        }
    } else {
        document.getElementById("productNameDisplayAdresse").style.display = "none";
    }
    
    if (searchType === 'adresse') {
        rechercherParAdresse(searchTerm);
    } else {
        rechercherParCodeProduit(searchTerm);
    }
}

function rechercherParCodeProduit(searchTerm) {
    const container = document.getElementById("resultatsContainer");
    container.innerHTML = "";
    totalGlobalReserve = 0;
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    // إصلاح: عرض معلومات المنتج مرة واحدة فقط
    const infoCard = document.createElement('div');
    infoCard.className = 'reserveCard';
    
    const title = document.createElement('h3');
    title.textContent = nomProduit || "PRODUIT INCONNU";
    infoCard.appendChild(title);
    
    const infos = [];
    
    if (venteJ1 && venteJ1 !== "0") {
        infos.push({label: "VENTE J-1", value: venteJ1});
    } else {
        infos.push({label: "VENTE J-1", value: "0"});
    }
    
    if (qteGold && qteGold !== "0") {
        infos.push({label: "QTE STOCK", value: qteGold}); // تغيير QTE GOLD إلى QTE STOCK
    } else {
        infos.push({label: "QTE STOCK", value: "0"}); // تغيير QTE GOLD إلى QTE STOCK
    }
    
    if (qteReserve && qteReserve !== "0") {
        infos.push({label: "QTE RESERVE", value: qteReserve});
    } else {
        infos.push({label: "QTE RESERVE", value: "0"});
    }
    
    infos.forEach(info => {
        const row = document.createElement('div');
        row.className = 'dataRow';
        row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
        infoCard.appendChild(row);
    });
    
    container.appendChild(infoCard);
    
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            // === إضافة مربع الاختيار هنا ===
            const checkboxContainer = document.createElement("div");
            checkboxContainer.className = "checkbox-container";
            
            const checkbox = document.createElement("div");
            checkbox.className = "adresse-checkbox";
            checkbox.innerHTML = "□";
            checkbox.dataset.code = codeProduit;
            checkbox.dataset.adresse = adresse;
            
            checkbox.onclick = function() {
                const isChecked = this.classList.contains('checked');
                if (isChecked) {
                    this.classList.remove('checked');
                    this.innerHTML = "□";
                    selectedAddresses.delete(this.dataset.code + "_" + this.dataset.adresse);
                } else {
                    this.classList.add('checked');
                    this.innerHTML = "✓";
                    selectedAddresses.add(this.dataset.code + "_" + this.dataset.adresse);
                }
            };
            
            checkboxContainer.appendChild(checkbox);
            card.appendChild(checkboxContainer);
            // === نهاية الإضافة ===
            
            
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                totalGlobalReserve += totalQte;
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
            
            const actionButtons = document.createElement("div");
            actionButtons.className = "action-buttons";
            
            const retirerBtn = document.createElement("button");
            retirerBtn.className = "action-btn retirer";
            retirerBtn.textContent = "RETIRER";
            retirerBtn.onclick = function() {
                openQuickRetirerModal(codeProduit, adresse, nomProduit);
            };
            
            const commanderBtn = document.createElement("button");
            commanderBtn.className = "action-btn commander";
            commanderBtn.textContent = "COMMANDER";
            commanderBtn.onclick = function() {
                openQuickCommanderModal(codeProduit, nomProduit);
            };
            
            const ajouterBtn = document.createElement("button");
            ajouterBtn.className = "action-btn ajouter";
            ajouterBtn.textContent = "AJOUTER";
            ajouterBtn.onclick = function() {
                openQuickAjouterModal(codeProduit, nomProduit, adresse);
            };
            
            actionButtons.appendChild(retirerBtn);
            actionButtons.appendChild(commanderBtn);
            actionButtons.appendChild(ajouterBtn);
            
            card.appendChild(actionButtons);
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

function rechercherParAdresse(searchTerm) {
    const container = document.getElementById("resultatsContainer");
    container.innerHTML = "";
    totalGlobalReserve = 0;
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let rechercheFinale = searchTerm;
    
    if (searchTerm.includes('/')) {
        const parties = searchTerm.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            rechercheFinale = `Z${num1}P${num2}`;
        }
    }
    
    for(let i=1;i<csvCache.length;i++){
        const adresse = csvCache[i][1] || "";
        
        if(adresse === rechercheFinale){
            resultatsTrouves++;
            const codeProduit = csvCache[i][0] || "";
            const nomProduit = getProductNameByCode(codeProduit);
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            // === إضافة مربع الاختيار هنا ===
            const checkboxContainer = document.createElement("div");
            checkboxContainer.className = "checkbox-container";
            
            const checkbox = document.createElement("div");
            checkbox.className = "adresse-checkbox";
            checkbox.innerHTML = "□";
            checkbox.dataset.code = codeProduit;
            checkbox.dataset.adresse = adresse;
            
            checkbox.onclick = function() {
                const isChecked = this.classList.contains('checked');
                if (isChecked) {
                    this.classList.remove('checked');
                    this.innerHTML = "□";
                    selectedAddresses.delete(this.dataset.code + "_" + this.dataset.adresse);
                } else {
                    this.classList.add('checked');
                    this.innerHTML = "✓";
                    selectedAddresses.add(this.dataset.code + "_" + this.dataset.adresse);
                }
            };
            
            checkboxContainer.appendChild(checkbox);
            card.appendChild(checkboxContainer);
            // === نهاية الإضافة ===
           
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                totalGlobalReserve += totalQte;
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
            
            const actionButtons = document.createElement("div");
            actionButtons.className = "action-buttons";
            
            const retirerBtn = document.createElement("button");
            retirerBtn.className = "action-btn retirer";
            retirerBtn.textContent = "RETIRER";
            retirerBtn.onclick = function() {
                openQuickRetirerModal(codeProduit, adresse, nomProduit);
            };
            
            const commanderBtn = document.createElement("button");
            commanderBtn.className = "action-btn commander";
            commanderBtn.textContent = "COMMANDER";
            commanderBtn.onclick = function() {
                openQuickCommanderModal(codeProduit, nomProduit);
            };
            
            const ajouterBtn = document.createElement("button");
            ajouterBtn.className = "action-btn ajouter";
            ajouterBtn.textContent = "AJOUTER";
            ajouterBtn.onclick = function() {
                openQuickAjouterModal(codeProduit, nomProduit, adresse);
            };
            
            actionButtons.appendChild(retirerBtn);
            actionButtons.appendChild(commanderBtn);
            actionButtons.appendChild(ajouterBtn);
            
            card.appendChild(actionButtons);
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves > 0){
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL PRODUITS";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${resultatsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else if(resultatsTrouves === 0){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN RÉSULTAT POUR "${searchTerm}"</h3>`;
        container.appendChild(noResultCard);
    }
}

// التحكم في إدخال الأرقام
document.getElementById("adresseInput").addEventListener("input", function(e){
    const value = this.value;
    const allowedChars = /^[0-9/]*$/;
    
    if (!allowedChars.test(value)) {
        this.value = value.replace(/[^0-9/]/g, '');
    }
    
    if (searchType === 'code' && value.trim()) {
        const nomProduit = getProductNameByCode(value.trim());
        const displayElement = document.getElementById("productNameDisplayAdresse");
        if (nomProduit) {
            displayElement.textContent = nomProduit;
            displayElement.style.display = "block";
        } else {
            displayElement.style.display = "none";
        }
    } else {
        document.getElementById("productNameDisplayAdresse").style.display = "none";
    }
    
    // إذا بدأ المستخدم بالكتابة في الحقل الرئيسي، افرغ حقل التصفية
    if (value.trim() !== '') {
        clearFilterField();
    }
    
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(() => {
        const searchTerm = this.value.trim();
        if(searchTerm.length > 0) {
            rechercher();
        } else {
            document.getElementById("resultatsContainer").innerHTML = "";
            document.getElementById("productNameDisplayAdresse").style.display = "none";
        }
    }, 300);
});

document.getElementById("adresseInput").addEventListener("keypress", function(event){
    if(event.key === "Enter"){
        event.preventDefault();
        rechercher();
    }
    
    const allowedKeys = /[0-9/]/;
    if (!allowedKeys.test(event.key) && 
        event.key !== 'Backspace' && 
        event.key !== 'Delete' && 
        event.key !== 'Tab' && 
        event.key !== 'ArrowLeft' && 
        event.key !== 'ArrowRight') {
        event.preventDefault();
    }
});

// تحويل التاريخ
function parseDate(dateStr) {
    if (!dateStr || dateStr === "00/01/1900" || dateStr === "0000-00-00") {
        return null;
    }
    
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1;
        let year = parseInt(parts[2]);
        
        if (year < 100) {
            year += 2000;
        }
        
        return new Date(year, month, day);
    }
    
    return null;
}

function getMonthFromDate(dateStr) {
    if (!dateStr || dateStr === "00/01/1900" || dateStr === "0000-00-00") {
        return null;
    }
    
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const month = parts[1];
        let year = parts[2];
        
        if (year.length === 2) {
            year = '20' + year;
        }
        
        return `${month}/${year}`;
    }
    
    return null;
}

// استخراج الأشهر المتوفرة
function extractAvailableMonths() {
    const monthSet = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        
        let adresseValide = false;
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
        }
        
        if (adresseValide) {
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        const month = parts[1];
                        let year = parts[2];
                        
                        if (year.length === 2) {
                            year = '20' + year;
                        }
                        
                        const monthYear = `${month}/${year}`;
                        monthSet.add(monthYear);
                    }
                }
            }
        }
    }
    
    allMonths = Array.from(monthSet).sort((a, b) => {
        const [monthA, yearA] = a.split('/');
        const [monthB, yearB] = b.split('/');
        if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
        return parseInt(monthA) - parseInt(monthB);
    });
    
    const monthSelect = document.getElementById('monthSelect');
    monthSelect.innerHTML = '<option value="">SÉLECTIONNER UN MOIS</option>';
    
    allMonths.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
    });
}

// عرض منتجات DLC حسب الشهر
function displayDLCByMonth() {
    const monthSelect = document.getElementById('monthSelect');
    const selectedMonth = monthSelect.value;
    
    const container = document.getElementById("dlcContainer");
    container.innerHTML = "";
    
    if (!selectedMonth) {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>SÉLECTIONNEZ UN MOIS</h3>`;
        container.appendChild(noResultCard);
        return;
    }
    
    let produitsTrouves = 0;
    let totalGlobalReserve = 0;
    let produitsMap = new Map();
    
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        const codeProduit = csvCache[i][0] || "";
        
        let adresseValide = false;
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
        }
        
        if (adresseValide && codeProduit) {
            let produitTrouveDansAdresse = false;
            let datesDetails = [];
            
            for(let j = 2; j < 8; j += 2) {
                let q = (csvCache[i][j] || "").trim();
                let d = (csvCache[i][j+1] || "").trim();
                const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                const monthFromDate = getMonthFromDate(d);
                
                if (qNum > 0 && monthFromDate === selectedMonth) {
                    produitTrouveDansAdresse = true;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            adresse: adresse,
                            qte: q,
                            date: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            if (produitTrouveDansAdresse) {
                if (!produitsMap.has(codeProduit)) {
                    produitsMap.set(codeProduit, {
                        nom: getProductNameByCode(codeProduit),
                        totalQte: 0,
                        details: []
                    });
                }
                
                const produit = produitsMap.get(codeProduit);
                datesDetails.forEach(detail => {
                    const qNum = parseFloat(detail.qte.replace(/[^0-9.-]+/g,"")) || 0;
                    produit.totalQte += qNum;
                });
                produit.details.push(...datesDetails);
            }
        }
    }
    
    const produitsArray = Array.from(produitsMap.entries());
    
    produitsArray.forEach(([code, produit]) => {
        produit.details.sort((a, b) => a.dateObj - b.dateObj);
        produit.nearestDate = produit.details.length > 0 ? produit.details[0].dateObj : new Date(9999, 11, 31);
    });
    
    produitsArray.sort((a, b) => a[1].nearestDate - b[1].nearestDate);
    
    produitsArray.forEach(([codeProduit, produit]) => {
        if (produit.totalQte > 0) {
            produitsTrouves++;
            totalGlobalReserve += produit.totalQte;
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const adresse = produit.details.length > 0 ? produit.details[0].adresse : "";
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (produit.nom) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = produit.nom;
                card.appendChild(nameRow);
            }
            
            produit.details.forEach(detail => {
                const detailRow = document.createElement("div");
                detailRow.className = "qteRow";
                detailRow.innerHTML = `<span class="label">QTE :</span> <span class="qte-value">${detail.qte}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.date}</span>`;
                card.appendChild(detailRow);
            });
            
            const totalRow = document.createElement("div");
            totalRow.className = "totalRow";
            totalRow.innerHTML = `<span class="total-value">TOTAL ${produit.totalQte} UNITÉ</span>`;
            card.appendChild(totalRow);
            
            container.appendChild(card);
        }
    });
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = `TOTAL ${currentDLCDepartement.toUpperCase()} - MOIS ${selectedMonth}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT TROUVÉ POUR LE MOIS ${selectedMonth} DANS ${currentDLCDepartement.toUpperCase()}</h3>`;
        container.appendChild(noResultCard);
    }
}

// التحقق من العناوين
function isEpicerieAdresse(adresse) {
    if (!adresse) return false;
    
    for (let i = 6; i <= 15; i++) {
        for (let j = 1; j <= 9; j++) {
            if (adresse === `Z${i}P${j}`) {
                return true;
            }
        }
    }
    
    if (adresse === 'Z107P1') {
        return true;
    }
    
    return false;
}

function isBiscuiterieAdresse(adresse) {
    if (!adresse) return false;
    
    for (let i = 16; i <= 106; i++) {
        for (let j = 1; j <= 12; j++) {
            if (adresse === `Z${i}P${j}`) {
                return true;
            }
        }
    }
    
    if (adresse === 'Z107P2') {
        return true;
    }
    
    return false;
}

// عرض منتجات الروتور
function displayRuptureProductsByDepartement() {
    const container = document.getElementById("ruptureContainer");
    container.innerHTML = "";
    
    let produitsTrouves = 0;
    let totalGlobalReserve = 0;
    
    const codesUniques = [];
    const codesAdresses = {};
    
    for(let i = 1; i < csvCache.length; i++) {
        const code = csvCache[i][0];
        const adresse = csvCache[i][1];
        
        if (code) {
            let adresseValide = false;
            if (currentDepartement === 'epicerie') {
                adresseValide = isEpicerieAdresse(adresse);
            } else {
                adresseValide = isBiscuiterieAdresse(adresse);
            }
            
            if (adresseValide) {
                if (!codesUniques.includes(code)) {
                    codesUniques.push(code);
                    codesAdresses[code] = [];
                }
                
                if (adresse && !codesAdresses[code].includes(adresse)) {
                    codesAdresses[code].push(adresse);
                }
            }
        }
    }
    
    codesUniques.forEach(code => {
        const qteGold = getQteGoldByCode(code);
        const qteReserve = getQteReserveByCode(code);
        
        const qteGoldNum = parseFloat(qteGold.replace(/[^0-9.-]+/g,"")) || 0;
        const qteReserveNum = parseFloat(qteReserve.replace(/[^0-9.-]+/g,"")) || 0;
        
        if (qteGoldNum === qteReserveNum && qteGoldNum > 0) {
            produitsTrouves++;
            
            let totalQte = 0;
            let allDetails = [];
            
            for(let i = 1; i < csvCache.length; i++) {
                if(csvCache[i][0] && csvCache[i][0].trim() === code.trim()) {
                    const adresse = csvCache[i][1] || "";
                    
                    let adresseValide = false;
                    if (currentDepartement === 'epicerie') {
                        adresseValide = isEpicerieAdresse(adresse);
                    } else {
                        adresseValide = isBiscuiterieAdresse(adresse);
                    }
                    
                    if (adresseValide) {
                        for(let j = 2; j < 8; j += 2) {
                            let q = (csvCache[i][j] || "").trim();
                            let d = (csvCache[i][j+1] || "").trim();
                            const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                            const dateInvalid = (d === "" || d === "00/01/1900" || d === "0000-00-00");
                            
                            if(qNum > 0 && !dateInvalid) {
                                totalQte += qNum;
                                const dateObj = parseDate(d);
                                if (dateObj) {
                                    allDetails.push({
                                        adresse: adresse,
                                        qte: qNum,
                                        date: d,
                                        dateObj: dateObj
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            if (totalQte > 0) {
                totalGlobalReserve += totalQte;
                
                const card = document.createElement("div");
                card.className = "adresseCard";
                
                const adresse = allDetails.length > 0 ? allDetails[0].adresse : "";
                const title = document.createElement("h3"); 
                title.textContent = `${adresse}`; 
                card.appendChild(title);
                
                if (code) {
                    const codeRow = document.createElement("div");
                    codeRow.className = "codeRow";
                    codeRow.textContent = `${code}`;
                    card.appendChild(codeRow);
                }
                
                const nomProduit = getProductNameByCode(code);
                if (nomProduit) {
                    const nameRow = document.createElement("div");
                    nameRow.className = "nameRow";
                    nameRow.textContent = nomProduit;
                    card.appendChild(nameRow);
                }
                
                allDetails.sort((a, b) => a.dateObj - b.dateObj);
                
                let compteur = 1;
                allDetails.forEach(detail => {
                    const qteRow = document.createElement("div");
                    qteRow.className = "qteRow";
                    qteRow.innerHTML = `<span class="label">QTE ${compteur} :</span> <span class="qte-value">${detail.qte}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.date}</span>`;
                    card.appendChild(qteRow);
                    compteur++;
                });
                
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉ</span>`;
                card.appendChild(totalRow);
                
                // === إضافة مربع الاختيار هنا ===
const checkboxContainer = document.createElement("div");
checkboxContainer.className = "checkbox-container";

const checkbox = document.createElement("div");
checkbox.className = "adresse-checkbox";
checkbox.innerHTML = "□";
checkbox.dataset.code = code;
checkbox.dataset.adresse = adresse;

checkbox.onclick = function() {
    const isChecked = this.classList.contains('checked');
    if (isChecked) {
        this.classList.remove('checked');
        this.innerHTML = "□";
        selectedAddresses.delete(this.dataset.code + "_" + this.dataset.adresse);
    } else {
        this.classList.add('checked');
        this.innerHTML = "✓";
        selectedAddresses.add(this.dataset.code + "_" + this.dataset.adresse);
    }
};

checkboxContainer.appendChild(checkbox);
card.appendChild(checkboxContainer);
// === نهاية الإضافة ===

const actionButtons = document.createElement("div");
actionButtons.className = "action-buttons";

const retirerBtn = document.createElement("button");
retirerBtn.className = "action-btn retirer";
retirerBtn.textContent = "RETIRER";
retirerBtn.onclick = function() {
    openQuickRetirerModal(code, adresse, nomProduit);
};

const commanderBtn = document.createElement("button");
commanderBtn.className = "action-btn commander";
commanderBtn.textContent = "COMMANDER";
commanderBtn.onclick = function() {
    openQuickCommanderModal(code, nomProduit);
};

// إزالة زر AJOUTER هنا - لا تضفه
actionButtons.appendChild(retirerBtn);
actionButtons.appendChild(commanderBtn);

card.appendChild(actionButtons);
                
                container.appendChild(card);
            }
        }
    });
    
    if (produitsTrouves > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = `TOTAL ${currentDepartement.toUpperCase()}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC QTE RESERVE = QTE STOCK DANS ${currentDepartement.toUpperCase()}</h3>`;
        container.appendChild(noResultCard);
    }
}

// ============================================
// وظائف صفحة COMMANDE
// ============================================

function loadCommandeProduits() {
    const savedProduits = localStorage.getItem('commande_produits');
    if (savedProduits) {
        commandeProduits = JSON.parse(savedProduits);
        updateCommandeDisplay();
    }
}

function saveCommandeProduits() {
    localStorage.setItem('commande_produits', JSON.stringify(commandeProduits));
}

function updateCommandeDisplay() {
    document.getElementById('produitCount').textContent = commandeProduits.length;
    
    const container = document.getElementById('commandeProduitsContainer');
    container.innerHTML = '';
    
    commandeProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deleteProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <span class="qte-label">QUANTITÉ:</span>
                <span class="qte-value">${produit.qte}</span>
            </div>
        `;
        
        container.appendChild(card);
    });
}

document.getElementById('commandeCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForCommande(code);
    } else {
        document.getElementById('commandeProductInfo').innerHTML = '';
    }
});

function showProductInfoForCommande(code) {
    const container = document.getElementById('commandeProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // تغيير QTE GOLD إلى QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // تغيير QTE GOLD إلى QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

function ajouterProduit() {
    const codeInput = document.getElementById('commandeCodeInput');
    const qteInput = document.getElementById('commandeQteInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÉ DU PRODUIT', 'warning');
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    
    const produitNom = nomProduit || "PRODUIT NON RÉFÉRENCÉ";
    
    const existingIndex = commandeProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        commandeProduits[existingIndex].qte = parseInt(qte);
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        commandeProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte)
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    saveCommandeProduits();
    updateCommandeDisplay();
    
    codeInput.value = '';
    qteInput.value = '';
    document.getElementById('commandeProductInfo').innerHTML = '';
    
    codeInput.focus();
}

function editProduit(index) {
    editingProduitIndex = index;
    const produit = commandeProduits[index];
    
    const container = document.getElementById('commandeProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="edit-modal-overlay">
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3><span class="edit-icon">✏️</span> MODIFICATION PRODUIT</h3>
                    <button class="edit-modal-close" onclick="cancelEditProduit()">✕</button>
                </div>
                
                <div class="edit-modal-body">
                    <div class="edit-product-info">
                        <div class="edit-product-code">${produit.code}</div>
                        <div class="edit-product-name">${produit.nom}</div>
                    </div>
                    
                    <div class="edit-form-row">
                        <div class="edit-label">QUANTITÉ</div>
                        <input type="tel" 
                               id="editQteInput" 
                               class="edit-input"
                               value="${produit.qte}" 
                               min="1" 
                               oninput="delayedEvaluateExpression(this)"
                               placeholder="ENTRER LA QUANTITÉ">
                    </div>
                    
                    <div class="edit-summary-row">
                        <span class="edit-summary-label">QUANTITÉ ACTUELLE:</span>
                        <span class="edit-summary-value">${produit.qte}</span>
                    </div>
                </div>
                
                <div class="edit-modal-footer">
                    <button class="edit-modal-btn cancel" onclick="cancelEditProduit()">
                        <span>ANNULER</span>
                    </button>
                    <button class="edit-modal-btn save" onclick="saveEditProduit()">
                        <span class="save-icon">✓</span>
                        <span>ENREGISTRER</span>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // إضافة الأنماط المباشرة
    const style = document.createElement('style');
    style.innerHTML = `
        .edit-modal-overlay {
            position: relative;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #3498db;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.2);
        }
        
        .edit-modal-content {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .edit-modal-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-modal-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edit-icon {
            font-size: 20px;
        }
        
        .edit-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .edit-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .edit-modal-body {
            padding: 20px;
        }
        
        .edit-product-info {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .edit-product-code {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .edit-product-name {
            color: #2c3e50;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .edit-form-row {
            margin-bottom: 15px;
        }
        
        .edit-label {
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .edit-input {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            border: 2px solid #ddd;
            padding: 0 15px;
            font-size: 16px;
            text-align: center;
            box-sizing: border-box;
            transition: border 0.3s;
        }
        
        .edit-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .edit-summary-row {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .edit-summary-label {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .edit-summary-value {
            color: #3498db;
            font-size: 18px;
            font-weight: bold;
        }
        
        .edit-modal-footer {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .edit-modal-btn {
            flex: 1;
            height: 50px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .edit-modal-btn.cancel {
            background: #e74c3c;
            color: white;
        }
        
        .edit-modal-btn.cancel:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .edit-modal-btn.save {
            background: #27ae60;
            color: white;
        }
        
        .edit-modal-btn.save:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .save-icon {
            font-size: 18px;
        }
    `;
    
    card.appendChild(style);
    
    document.getElementById('editQteInput').focus();
    document.getElementById('editQteInput').select();
}

function saveEditProduit() {
    const newQte = document.getElementById('editQteInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    commandeProduits[editingProduitIndex].qte = parseInt(newQte);
    saveCommandeProduits();
    updateCommandeDisplay();
    editingProduitIndex = -1;
    showAlert('QUANTITÉ MODIFIÉE AVEC SUCCÈS', 'success');
}

function cancelEditProduit() {
    editingProduitIndex = -1;
    updateCommandeDisplay();
}

function deleteProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        commandeProduits.splice(index, 1);
        saveCommandeProduits();
        updateCommandeDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

function showConfirmModal(message, callback) {
    document.getElementById('confirmMessage').textContent = message;
    pendingAction = callback;
    document.getElementById('confirmModal').style.display = 'flex';
}

function confirmAction() {
    if (typeof pendingAction === 'function') {
        pendingAction();
    }
    
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
}

function cancelAction() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
}

function clearAllProduits() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        commandeProduits = [];
        saveCommandeProduits();
        updateCommandeDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// ============================================
// وظائف صفحة AJOUTER
// ============================================

function loadAjouterProduits() {
    const savedProduits = localStorage.getItem('ajouter_produits');
    if (savedProduits) {
        ajouterProduits = JSON.parse(savedProduits);
        updateAjouterDisplay();
    }
}

function saveAjouterProduits() {
    localStorage.setItem('ajouter_produits', JSON.stringify(ajouterProduits));
}

function updateAjouterDisplay() {
    document.getElementById('ajouterProduitCount').textContent = ajouterProduits.length;
    
    const container = document.getElementById('ajouterProduitsContainer');
    container.innerHTML = '';
    
    ajouterProduits.forEach((produit, index) => {
        const card = document.createElement("div");
        card.className = "adresseCard";
        
        const headerRow = document.createElement("div");
        headerRow.className = "produit-header";
        headerRow.style.marginBottom = "10px";
        
        const title = document.createElement("h3"); 
        title.textContent = `${produit.adresse}`; 
        title.style.marginBottom = "0";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "produit-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "produit-edit";
        editBtn.textContent = "✏️";
        editBtn.onclick = function() {
            editAjouterProduit(index);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "produit-delete";
        deleteBtn.textContent = "✕";
        deleteBtn.onclick = function() {
            deleteAjouterProduit(index);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        headerRow.appendChild(title);
        headerRow.appendChild(actionsDiv);
        card.appendChild(headerRow);
        
        if (produit.code) {
            const codeRow = document.createElement("div");
            codeRow.className = "codeRow";
            codeRow.textContent = `${produit.code}`;
            card.appendChild(codeRow);
        }
        
        if (produit.nom) {
            const nameRow = document.createElement("div");
            nameRow.className = "nameRow";
            nameRow.textContent = produit.nom;
            card.appendChild(nameRow);
        }
        
        let compteur = 1;
        
        if (produit.qte1 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte1}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc1}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte2 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte2}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc2}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte3 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte3}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc3}</span>`;
            card.appendChild(row);
        }
        
        container.appendChild(card);
    });
}

document.getElementById('ajouterCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForAjouter(code);
        afficherResultatsRechercheAjouter(code);
    } else {
        document.getElementById('ajouterProductInfo').innerHTML = '';
        document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    }
});

function showProductInfoForAjouter(code) {
    const container = document.getElementById('ajouterProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    // إصلاح: عرض معلومات المنتج مرة واحدة فقط
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // تغيير QTE GOLD إلى QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // تغيير QTE GOLD إلى QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

function afficherResultatsRechercheAjouter(searchTerm) {
    const container = document.getElementById('ajouterSearchResultsContainer');
    container.innerHTML = "";
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    // إصلاح: عدم عرض معلومات المنتج هنا لأنها تظهر مرة واحدة في showProductInfoForAjouter
    
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    // تمت إزالة قسم TOTAL ADRESSES بناءً على طلب المستخدم
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

// ============================================
// تحسين دالة ajouterProduitAjouter
// ============================================

function ajouterProduitAjouter() {
    // إضافة timeout لمنع التجميد الطويل
    const operationTimeout = setTimeout(() => {
        showAlert('العملية تأخذ وقتاً طويلاً، يرجى التحقق من البيانات', 'warning');
        return;
    }, 3000);
    
    try {
        const codeInput = document.getElementById('ajouterCodeInput');
        const adresseInput = document.getElementById('ajouterAdresseInput');
        const qte1Input = document.getElementById('ajouterQte1Input');
        const dlc1Input = document.getElementById('ajouterDlc1Input');
        const qte2Input = document.getElementById('ajouterQte2Input');
        const dlc2Input = document.getElementById('ajouterDlc2Input');
        const qte3Input = document.getElementById('ajouterQte3Input');
        const dlc3Input = document.getElementById('ajouterDlc3Input');
        
        const code = codeInput.value.trim();
        const adresse = adresseInput.value.trim();
        
        if (!code) {
            showAlert('VEUILLEZ ENTRER LE CODE DU PRODUIT', 'warning');
            clearTimeout(operationTimeout);
            return;
        }
        
        if (!adresse) {
            showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
            clearTimeout(operationTimeout);
            return;
        }
        
        // التحقق من صحة تنسيق العنوان
        if (!validateAddressFormat(adresse)) {
            showAlert('FORMAT ADRESSE INVALIDE. FORMATS ACCEPTÉS:\n- 6/1 (1-3 chiffres/1-2 chiffres)\n- 6/12\n- 16/1\n- 16/12\n- 116/1\n- 116/12', 'warning');
            adresseInput.style.borderColor = '#e74c3c';
            adresseInput.style.backgroundColor = '#ffe6e6';
            adresseInput.focus();
            adresseInput.select();
            clearTimeout(operationTimeout);
            return;
        } else {
            adresseInput.style.borderColor = '';
            adresseInput.style.backgroundColor = '';
        }
        
        let adresseFinale = adresse;
        if (adresse.includes('/')) {
            const parties = adresse.split('/');
            if (parties.length === 2) {
                const num1 = parties[0].trim();
                const num2 = parties[1].trim();
                adresseFinale = `Z${num1}P${num2}`;
            }
        }
        
        const nomProduit = getProductNameByCode(code);
        const produitNom = nomProduit || "PRODUIT NON RÉFÉRENCÉ";
        
        const qte1 = qte1Input.value.trim();
        const dlc1 = dlc1Input.value.trim();
        const qte2 = qte2Input.value.trim();
        const dlc2 = dlc2Input.value.trim();
        const qte3 = qte3Input.value.trim();
        const dlc3 = dlc3Input.value.trim();
        
        // التحقق من وجود كمية على الأقل
        if (!qte1 && !qte2 && !qte3) {
            showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
            clearTimeout(operationTimeout);
            return;
        }
        
        // التحقق من صحة الكميات
        const qte1Num = qte1 ? parseInt(qte1) : 0;
        const qte2Num = qte2 ? parseInt(qte2) : 0;
        const qte3Num = qte3 ? parseInt(qte3) : 0;
        
        if ((qte1 && qte1Num <= 0) || (qte2 && qte2Num <= 0) || (qte3 && qte3Num <= 0)) {
            showAlert('LES QUANTITÉS DOIVENT ÊTRE SUPÉRIEURES À 0', 'warning');
            clearTimeout(operationTimeout);
            return;
        }
        
        // التحقق من التواريخ مع رسائل تفصيلية
        const dateChecks = [];
        
        if (dlc1) {
            const check1 = checkIfDateExpired(dlc1);
            dateChecks.push({ field: dlc1Input, check: check1, dlcNumber: 1 });
        }
        
        if (dlc2) {
            const check2 = checkIfDateExpired(dlc2);
            dateChecks.push({ field: dlc2Input, check: check2, dlcNumber: 2 });
        }
        
        if (dlc3) {
            const check3 = checkIfDateExpired(dlc3);
            dateChecks.push({ field: dlc3Input, check: check3, dlcNumber: 3 });
        }
        
        // التحقق من جميع التواريخ
        let hasDateError = false;
        let errorMessage = '';
        
        for (const dateCheck of dateChecks) {
            if (dateCheck.check.expired) {
                hasDateError = true;
                errorMessage = getDateErrorMessage(dateCheck.check.reason);
                
                // تلوين الحقل باللون الأحمر
                dateCheck.field.style.borderColor = '#e74c3c';
                dateCheck.field.style.backgroundColor = '#ffe6e6';
                dateCheck.field.style.color = '#e74c3c';
                dateCheck.field.style.fontWeight = 'bold';
                
                // إضافة تحذير بصري
                const errorDiv = document.createElement('div');
                errorDiv.className = 'date-error-message';
                errorDiv.style.cssText = `
                    color: #e74c3c;
                    font-size: 12px;
                    margin-top: 2px;
                    text-align: center;
                    font-weight: bold;
                `;
                errorDiv.textContent = `DLC ${dateCheck.dlcNumber}: ${errorMessage}`;
                
                // إزالة أي رسالة خطأ سابقة
                const existingError = dateCheck.field.parentNode.querySelector('.date-error-message');
                if (existingError) {
                    existingError.remove();
                }
                
                // إضافة الرسالة الجديدة
                dateCheck.field.parentNode.appendChild(errorDiv);
                
                showAlert(`DLC ${dateCheck.dlcNumber}: ${errorMessage}`, 'warning');
                dateCheck.field.focus();
                dateCheck.field.select();
                clearTimeout(operationTimeout);
                return;
            } else {
                // إعادة تعيين الأنماط إذا كان التاريخ صالحاً
                dateCheck.field.style.borderColor = '';
                dateCheck.field.style.backgroundColor = '';
                dateCheck.field.style.color = '';
                dateCheck.field.style.fontWeight = '';
                
                // إزالة رسائل الخطأ السابقة
                const existingError = dateCheck.field.parentNode.querySelector('.date-error-message');
                if (existingError) {
                    existingError.remove();
                }
            }
        }
        
        // التحقق من أن التواريخ ليست متطابقة إذا تم إدخال أكثر من واحد
        const dates = [dlc1, dlc2, dlc3].filter(d => d);
        const uniqueDates = new Set(dates);
        
        if (dates.length > 1 && uniqueDates.size !== dates.length) {
            showAlert('LES DATES NE PEUVENT PAS ÊTRE IDENTIQUES', 'warning');
            clearTimeout(operationTimeout);
            return;
        }
        
        // التحقق من أن الكميات مقترنة بتواريخ
        if ((qte1 && !dlc1) || (qte2 && !dlc2) || (qte3 && !dlc3)) {
            showAlert('CHAQUE QUANTITÉ DOIT AVOIR UNE DATE ASSOCIÉE', 'warning');
            clearTimeout(operationTimeout);
            return;
        }
        
        // استخدام requestAnimationFrame لمنع تجميد واجهة المستخدم
        requestAnimationFrame(() => {
            // التحقق من وجود منتج مكرر
            const existingIndex = ajouterProduits.findIndex(p => p.adresse === adresseFinale && p.code === code);
            
            if (existingIndex >= 0) {
                showAlert('CE PRODUIT AVEC LE MÊME CODE ET ADRESSE EXISTE DÉJÀ!', 'warning');
                clearTimeout(operationTimeout);
                return;
            }
            
            // إضافة المنتج
            ajouterProduits.push({
                code: code,
                adresse: adresseFinale,
                nom: produitNom,
                qte1: qte1Num,
                dlc1: dlc1,
                qte2: qte2Num,
                dlc2: dlc2,
                qte3: qte3Num,
                dlc3: dlc3
            });
            
            showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
            
            // حفظ في الخلفية لتجنب تجميد الواجهة
            setTimeout(() => {
                saveAjouterProduits();
                updateAjouterDisplay();
            }, 100);
            
            // مسح الحقول
            clearAjouterFields();
            
            codeInput.focus();
            
            clearTimeout(operationTimeout);
        });
        
    } catch (error) {
        console.error('Error in ajouterProduitAjouter:', error);
        showAlert('خطأ في إضافة المنتج، يرجى المحاولة مرة أخرى', 'warning');
        clearTimeout(operationTimeout);
    }
}

function editAjouterProduit(index) {
    editingAjouterProduitIndex = index;
    const produit = ajouterProduits[index];
    
    const container = document.getElementById('ajouterProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
    <div class="adresseCard">
        <h3 style="color: #3498db;">MODIFICATION</h3>
        
        <div class="codeRow" style="background: #3498db; color: white;">${produit.code}</div>
        
        <div class="nameRow">${produit.nom}</div>
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 8px;">
            <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">ADRESSE:</div>
            <input type="tel" id="editAjouterAdresseInput" value="${produit.adresse}" pattern="[0-9/]*" inputmode="numeric" style="width: 100%; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <!-- حقول الكمية والتاريخ -->
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 1:</div>
                <input type="tel" id="editAjouterQte1Input" 
                       value="${produit.qte1 || ''}" 
                       pattern="[0-9]*" 
                       inputmode="numeric"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" 
                       oninput="validateNumericInput(this); delayedEvaluateExpression(this)">
            </div>
            <div style="flex: 1;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 1:</div>
                <input type="tel" id="editAjouterDlc1Input" 
                       value="${produit.dlc1 || ''}" 
                       pattern="\\d{2}/\\d{2}/\\d{4}" 
                       inputmode="numeric"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 2:</div>
                <input type="tel" id="editAjouterQte2Input" 
                       value="${produit.qte2 || ''}" 
                       pattern="[0-9]*" 
                       inputmode="numeric"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" 
                       oninput="validateNumericInput(this); delayedEvaluateExpression(this)">
            </div>
            <div style="flex: 1;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 2:</div>
                <input type="tel" id="editAjouterDlc2Input" 
                       value="${produit.dlc2 || ''}" 
                       pattern="\\d{2}/\\d{2}/\\d{4}" 
                       inputmode="numeric"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 3:</div>
                <input type="tel" id="editAjouterQte3Input" 
                       value="${produit.qte3 || ''}" 
                       pattern="[0-9]*" 
                       inputmode="numeric"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" 
                       oninput="validateNumericInput(this); delayedEvaluateExpression(this)">
            </div>
            <div style="flex: 1;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 3:</div>
                <input type="tel" id="editAjouterDlc3Input" 
                       value="${produit.dlc3 || ''}" 
                       pattern="\\d{2}/\\d{2}/\\d{4}" 
                       inputmode="numeric"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="ajouter-btn" onclick="saveEditAjouterProduit()" style="flex: 1; padding: 10px; background: #27ae60;">ENREGISTRER</button>
            <button class="ajouter-btn" onclick="cancelEditAjouterProduit()" style="flex: 1; padding: 10px; background: #e74c3c;">ANNULER</button>
        </div>
    </div>
`;
    
    const dateInputs = [
        document.getElementById('editAjouterDlc1Input'),
        document.getElementById('editAjouterDlc2Input'),
        document.getElementById('editAjouterDlc3Input')
    ];
    
    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
        }
    });
    
    document.getElementById('editAjouterAdresseInput').focus();
}

function saveEditAjouterProduit() {
    const newAdresse = document.getElementById('editAjouterAdresseInput').value;
    const newQte1 = document.getElementById('editAjouterQte1Input').value;
    const newDlc1 = document.getElementById('editAjouterDlc1Input').value;
    const newQte2 = document.getElementById('editAjouterQte2Input').value;
    const newDlc2 = document.getElementById('editAjouterDlc2Input').value;
    const newQte3 = document.getElementById('editAjouterQte3Input').value;
    const newDlc3 = document.getElementById('editAjouterDlc3Input').value;
    
    if (!newAdresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    let adresseFinale = newAdresse;
    if (newAdresse.includes('/')) {
        const parties = newAdresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    if (newDlc1 && !isValidDateYYYY(newDlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc2 && !isValidDateYYYY(newDlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc3 && !isValidDateYYYY(newDlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (!newQte1 && !newQte2 && !newQte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    const produitOriginal = ajouterProduits[editingAjouterProduitIndex];
    if (adresseFinale !== produitOriginal.adresse) {
        const existingIndex = ajouterProduits.findIndex((p, i) => i !== editingAjouterProduitIndex && p.adresse === adresseFinale && p.code === produitOriginal.code);
        
        if (existingIndex >= 0) {
            showAlert('UN PRODUIT AVEC LE MÊME CODE ET ADRESSE EXISTE DÉJÀ!', 'warning');
            return;
        }
    }
    
    ajouterProduits[editingAjouterProduitIndex].adresse = adresseFinale;
    ajouterProduits[editingAjouterProduitIndex].qte1 = newQte1 ? parseInt(newQte1) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc1 = newDlc1;
    ajouterProduits[editingAjouterProduitIndex].qte2 = newQte2 ? parseInt(newQte2) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc2 = newDlc2;
    ajouterProduits[editingAjouterProduitIndex].qte3 = newQte3 ? parseInt(newQte3) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc3 = newDlc3;
    
    saveAjouterProduits();
    updateAjouterDisplay();
    editingAjouterProduitIndex = -1;
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

function cancelEditAjouterProduit() {
    editingAjouterProduitIndex = -1;
    updateAjouterDisplay();
}

function deleteAjouterProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        ajouterProduits.splice(index, 1);
        saveAjouterProduits();
        updateAjouterDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

function clearAllAjouter() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        ajouterProduits = [];
        saveAjouterProduits();
        updateAjouterDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// ============================================
// وظائف صفحة CASSE FRAIS
// ============================================

function loadCasseProduits() {
    const savedProduits = localStorage.getItem('casse_produits');
    if (savedProduits) {
        casseProduits = JSON.parse(savedProduits);
        updateCasseDisplay();
    }
}

function saveCasseProduits() {
    localStorage.setItem('casse_produits', JSON.stringify(casseProduits));
}

function updateCasseDisplay() {
    document.getElementById('casseProduitCount').textContent = casseProduits.length;
    
    const container = document.getElementById('casseProduitsContainer');
    container.innerHTML = '';
    
    casseProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editCasseProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deleteCasseProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <div style="display: flex; justify-content: space-between; width: 100%;">
                    <div>
                        <span class="qte-label">QTE:</span>
                        <span class="qte-value">${produit.qte}</span>
                    </div>
                    <div>
                        <span class="qte-label">DATE:</span>
                        <span class="qte-value">${produit.date}</span>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

document.getElementById('casseCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForCasse(code);
    } else {
        document.getElementById('casseProductInfo').innerHTML = '';
    }
});

function showProductInfoForCasse(code) {
    const container = document.getElementById('casseProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // تغيير QTE GOLD إلى QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // تغيير QTE GOLD إلى QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

function ajouterProduitCasse() {
    const codeInput = document.getElementById('casseCodeInput');
    const qteInput = document.getElementById('casseQteInput');
    const dateInput = document.getElementById('casseDateInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    const date = dateInput.value.trim();
    
    if (!date) {
        showAlert('VEUILLEZ ENTRER LA DATE (JJ/MM/AAAA)', 'warning');
        dateInput.focus();
        return;
    }
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÉ DU PRODUIT', 'warning');
        return;
    }
    
    if (!isValidDateYYYY(date)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dateInput.focus();
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    
    const produitNom = nomProduit || "PRODUIT NON RÉFÉRENCÉ";
    
    const existingIndex = casseProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        casseProduits[existingIndex].qte = parseInt(qte);
        casseProduits[existingIndex].date = date;
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        casseProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte),
            date: date
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    saveCasseProduits();
    updateCasseDisplay();
    
    codeInput.value = '';
    qteInput.value = '';
    dateInput.value = '';
    document.getElementById('casseProductInfo').innerHTML = '';
    
    codeInput.focus();
}

function editCasseProduit(index) {
    editingCasseProduitIndex = index;
    const produit = casseProduits[index];
    
    const container = document.getElementById('casseProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="edit-modal-overlay">
            <div class="edit-modal-content">
                <div class="edit-modal-header" style="background: linear-gradient(135deg, #d35400, #a04000);">
                    <h3><span class="edit-icon">✏️</span> MODIFICATION CASSE</h3>
                    <button class="edit-modal-close" onclick="cancelEditCasseProduit()">✕</button>
                </div>
                
                <div class="edit-modal-body">
                    <div class="edit-product-info">
                        <div class="edit-product-code" style="background: #d35400;">${produit.code}</div>
                        <div class="edit-product-name">${produit.nom}</div>
                    </div>
                    
                    <div class="edit-form-grid">
                        <div class="edit-form-column">
                            <div class="edit-label">QUANTITÉ</div>
                            <input type="tel" 
                                   id="editCasseQteInput" 
                                   class="edit-input"
                                   value="${produit.qte}" 
                                   min="1" 
                                   oninput="delayedEvaluateExpression(this)"
                                   placeholder="QUANTITÉ">
                        </div>
                        
                        <div class="edit-form-column">
                            <div class="edit-label">DATE CASSE</div>
                            <input type="tel" 
                                   id="editCasseDateInput" 
                                   class="edit-input date-input"
                                   value="${produit.date}" 
                                   pattern="\\d{2}/\\d{2}/\\d{4}"
                                   placeholder="JJ/MM/AAAA">
                        </div>
                    </div>
                    
                    <div class="edit-summary-grid">
                        <div class="edit-summary-item">
                            <span class="edit-summary-label">QTE ACTUELLE:</span>
                            <span class="edit-summary-value">${produit.qte}</span>
                        </div>
                        <div class="edit-summary-item">
                            <span class="edit-summary-label">DATE ACTUELLE:</span>
                            <span class="edit-summary-value">${produit.date}</span>
                        </div>
                    </div>
                    
                    <div class="edit-help-text">
                        <span class="help-icon">ℹ️</span>
                        Date format: JJ/MM/AAAA
                    </div>
                </div>
                
                <div class="edit-modal-footer">
                    <button class="edit-modal-btn cancel" onclick="cancelEditCasseProduit()">
                        <span>ANNULER</span>
                    </button>
                    <button class="edit-modal-btn save" onclick="saveEditCasseProduit()">
                        <span class="save-icon">✓</span>
                        <span>ENREGISTRER</span>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // إضافة الأنماط المباشرة
    const style = document.createElement('style');
    style.innerHTML = `
        .edit-modal-overlay {
            position: relative;
            background: rgba(211, 84, 0, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #d35400;
            box-shadow: 0 8px 25px rgba(211, 84, 0, 0.2);
        }
        
        .edit-modal-content {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .edit-modal-header {
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-modal-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edit-icon {
            font-size: 20px;
        }
        
        .edit-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .edit-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .edit-modal-body {
            padding: 20px;
        }
        
        .edit-product-info {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .edit-product-code {
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .edit-product-name {
            color: #2c3e50;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .edit-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .edit-form-column {
            display: flex;
            flex-direction: column;
        }
        
        .edit-label {
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .edit-input {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            border: 2px solid #ddd;
            padding: 0 15px;
            font-size: 16px;
            text-align: center;
            box-sizing: border-box;
            transition: border 0.3s;
        }
        
        .edit-input:focus {
            border-color: #d35400;
            outline: none;
        }
        
        .date-input {
            font-family: monospace;
        }
        
        .edit-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .edit-summary-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .edit-summary-label {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .edit-summary-value {
            color: #d35400;
            font-size: 16px;
            font-weight: bold;
        }
        
        .edit-help-text {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .help-icon {
            font-size: 14px;
        }
        
        .edit-modal-footer {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .edit-modal-btn {
            flex: 1;
            height: 50px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .edit-modal-btn.cancel {
            background: #e74c3c;
            color: white;
        }
        
        .edit-modal-btn.cancel:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .edit-modal-btn.save {
            background: #27ae60;
            color: white;
        }
        
        .edit-modal-btn.save:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .save-icon {
            font-size: 18px;
        }
    `;
    
    card.appendChild(style);
    
    // إضافة تنسيق التاريخ
    const dateInput = document.getElementById('editCasseDateInput');
    if (dateInput) {
        dateInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            this.value = value;
        });
    }
    
    document.getElementById('editCasseQteInput').focus();
    document.getElementById('editCasseQteInput').select();
}

function saveEditCasseProduit() {
    const newQte = document.getElementById('editCasseQteInput').value;
    const newDate = document.getElementById('editCasseDateInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    if (!newDate || !isValidDateYYYY(newDate)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    casseProduits[editingCasseProduitIndex].qte = parseInt(newQte);
    casseProduits[editingCasseProduitIndex].date = newDate;
    saveCasseProduits();
    updateCasseDisplay();
    editingCasseProduitIndex = -1;
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

function cancelEditCasseProduit() {
    editingCasseProduitIndex = -1;
    updateCasseDisplay();
}

function deleteCasseProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        casseProduits.splice(index, 1);
        saveCasseProduits();
        updateCasseDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

function clearAllProduitsCasse() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        casseProduits = [];
        saveCasseProduits();
        updateCasseDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// ============================================
// وظائف صفحة RETIRER
// ============================================

function loadRetirerProduits() {
    const savedProduits = localStorage.getItem('retirer_produits');
    if (savedProduits) {
        retirerProduits = JSON.parse(savedProduits);
        updateRetirerDisplay();
    }
}

function saveRetirerProduits() {
    localStorage.setItem('retirer_produits', JSON.stringify(retirerProduits));
}

function updateRetirerDisplay() {
    document.getElementById('retirerProduitCount').textContent = retirerProduits.length;
    
    const container = document.getElementById('retirerProduitsContainer');
    container.innerHTML = '';
    
    retirerProduits.forEach((produit, index) => {
        const card = document.createElement("div");
        card.className = "adresseCard";
        
        const headerRow = document.createElement("div");
        headerRow.className = "produit-header";
        headerRow.style.marginBottom = "10px";
        
        const title = document.createElement("h3"); 
        title.textContent = `${produit.adresse}`; 
        title.style.marginBottom = "0";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "produit-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "produit-edit";
        editBtn.textContent = "✏️";
        editBtn.onclick = function() {
            editRetirerProduit(index);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "produit-delete";
        deleteBtn.textContent = "✕";
        deleteBtn.onclick = function() {
            deleteRetirerProduit(index);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        headerRow.appendChild(title);
        headerRow.appendChild(actionsDiv);
        card.appendChild(headerRow);
        
        if (produit.code) {
            const codeRow = document.createElement("div");
            codeRow.className = "codeRow";
            codeRow.textContent = `${produit.code}`;
            card.appendChild(codeRow);
        }
        
        if (produit.nom) {
            const nameRow = document.createElement("div");
            nameRow.className = "nameRow";
            nameRow.textContent = produit.nom;
            card.appendChild(nameRow);
        }
        
        let compteur = 1;
        
        if (produit.qte1 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte1}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc1}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte2 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte2}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc2}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        if (produit.qte3 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte3}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc3}</span>`;
            card.appendChild(row);
        }
        
        container.appendChild(card);
    });
}

document.getElementById('retirerCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForRetirer(code);
        afficherResultatsRechercheRetirer(code);
    } else {
        document.getElementById('retirerProductInfo').innerHTML = '';
        document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    }
});

function showProductInfoForRetirer(code) {
    const container = document.getElementById('retirerProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    // إصلاح: عرض معلومات المنتج مرة واحدة فقط
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold}); // تغيير QTE GOLD إلى QTE STOCK
        } else {
            infos.push({label: "QTE STOCK", value: "0"}); // تغيير QTE GOLD إلى QTE STOCK
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

function afficherResultatsRechercheRetirer(searchTerm) {
    const container = document.getElementById('retirerSearchResultsContainer');
    container.innerHTML = "";
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    // إصلاح: عدم عرض معلومات المنتج هنا لأنها تظهر مرة واحدة في showProductInfoForRetirer
    
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
    
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
    
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
    
            if(totalQte > 0){
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
    
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

// تعديل: إزالة نافذة خيارات التواريخ وإضافة نافذة AJOUTER بدلاً منها
function showDateOptionsForRetirer() {
    const code = document.getElementById('retirerCodeInput').value.trim();
    const adresse = document.getElementById('retirerAdresseInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('retirerCodeInput').focus();
        return;
    }
    
    if (!adresse) {
        showAlert('VEUILLEZ D\'ABORD ENTRER L\'ADRESSE', 'warning');
        document.getElementById('retirerAdresseInput').focus();
        return;
    }
    
    openQuickAjouterModalForRetirer(code, adresse);
}

// وظيفة جديدة لفتح نافذة AJOUTER لصفحة RETIRER
function openQuickAjouterModalForRetirer(code, adresse) {
    const nomProduit = getProductNameByCode(code);
    
    // استدعاء نفس وظيفة AJOUTER ولكن مع إضافة المنتج إلى قائمة RETIRER
    currentQuickProduct = {
        code: code,
        nom: nomProduit,
        adresse: adresse,
        type: 'ajouter-retirer'
    };
    
    const infoDiv = document.getElementById('quickAjouterInfo');
    const displayAdresse = adresse || "Z6P1";
    infoDiv.innerHTML = `
        <div class="adresse" style="color: #FFA500 !important;">ADRESSE: ${displayAdresse}</div>
        <div class="code" style="color: #2c3e50 !important;">CODE: ${code}</div>
        <div class="name" style="color: #2c3e50 !important;">NOM: ${nomProduit}</div>
    `;
    
    if (adresse && adresse.startsWith('Z') && adresse.includes('P')) {
        const match = adresse.match(/Z(\d+)P(\d+)/);
        if (match) {
            document.getElementById('quickAjouterAdresseInput').value = `${match[1]}/${match[2]}`;
        } else {
            document.getElementById('quickAjouterAdresseInput').value = adresse;
        }
    } else {
        document.getElementById('quickAjouterAdresseInput').value = adresse;
    }
    
    document.getElementById('quickAjouterQte1Input').value = '';
    document.getElementById('quickAjouterDlc1Input').value = '';
    document.getElementById('quickAjouterQte2Input').value = '';
    document.getElementById('quickAjouterDlc2Input').value = '';
    document.getElementById('quickAjouterQte3Input').value = '';
    document.getElementById('quickAjouterDlc3Input').value = '';
    
    // تغيير النص في النافذة
    document.querySelector('#quickAjouterModal .quick-modal-title').textContent = "AJOUTER POUR RETIRER";
    
    // تغيير النص على الزر
    const ajouterBtn = document.querySelector('#quickAjouterModal .quick-modal-btn.ajouter');
    if (ajouterBtn) {
        ajouterBtn.textContent = "AJOUTER POUR RETIRER";
    }
    
    document.getElementById('quickAjouterModal').style.display = 'flex';
    // إعداد التحقق من صحة التاريخ وتلوين الحقول للنافذة السريعة
    setupDateValidationForQuickAjouter();
}

function closeDateSelectModal() {
    document.getElementById('dateSelectModal').style.display = 'none';
    document.getElementById('dateOptionsContainer').innerHTML = '';
}

function getAvailableDatesForProduct(code) {
    const dates = [];
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    if (!dates.includes(dateStr)) {
                        dates.push(dateStr);
                    }
                }
            }
        }
    }
    
    dates.sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
    
    return dates;
}

function ajouterProduitRetirer() {
    const codeInput = document.getElementById('retirerCodeInput');
    const adresseInput = document.getElementById('retirerAdresseInput');
    const qte1Input = document.getElementById('retirerQte1Input');
    const dlc1Input = document.getElementById('retirerDlc1Input');
    const qte2Input = document.getElementById('retirerQte2Input');
    const dlc2Input = document.getElementById('retirerDlc2Input');
    const qte3Input = document.getElementById('retirerQte3Input');
    const dlc3Input = document.getElementById('retirerDlc3Input');
    
    const code = codeInput.value.trim();
    const adresse = adresseInput.value.trim();
    
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        adresseInput.focus();
        return;
    }
    
    if (!code) {
        showAlert('VEUILLEZ ENTRER LE CODE DU PRODUIT', 'warning');
        codeInput.focus();
        return;
    }
    
    const qte1 = qte1Input.value.trim();
    const dlc1 = dlc1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    if (!nomProduit) {
        showAlert('PRODUIT NON TROUVÉ DANS LA BASE DE DONNÉES', 'warning');
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const existingIndex = retirerProduits.findIndex(p => p.code === code && p.adresse === adresseFinale);
    
    if (existingIndex >= 0) {
        // تحديث المنتج الموجود
        retirerProduits[existingIndex] = {
            code: code,
            adresse: adresseFinale,
            nom: nomProduit,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        };
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        // إضافة منتج جديد
        retirerProduits.push({
            code: code,
            adresse: adresseFinale,
            nom: nomProduit,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    saveRetirerProduits();
    updateRetirerDisplay();
    
    // مسح الحقول
    codeInput.value = '';
    adresseInput.value = '';
    qte1Input.value = '';
    dlc1Input.value = '';
    qte2Input.value = '';
    dlc2Input.value = '';
    qte3Input.value = '';
    dlc3Input.value = '';
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    
    codeInput.focus();
}

function editRetirerProduit(index) {
    editingRetirerProduitIndex = index;
    const produit = retirerProduits[index];
    
    const container = document.getElementById('retirerProduitsContainer');
    const card = container.children[index];
    
    // === ابدأ النسخ من هنا ===
    card.innerHTML = `
        <div class="adresseCard">
            <h3 style="color: #3498db;">MODIFICATION</h3>
            
            <div class="codeRow" style="background: #3498db; color: white;">${produit.code}</div>
            
            <div class="nameRow">${produit.nom}</div>
            
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 8px;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">ADRESSE:</div>
                <input type="tel" id="editRetirerAdresseInput" 
                       value="${produit.adresse}" 
                       pattern="[0-9/]*" 
                       inputmode="numeric"
                       style="width: 100%; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <!-- حقول الكمية والتاريخ -->
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 1:</div>
                    <input type="tel" id="editRetirerQte1Input" 
                           value="${produit.qte1 || ''}" 
                           pattern="[0-9]*" 
                           inputmode="numeric"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" 
                           oninput="validateNumericInput(this); delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 1:</div>
                    <input type="tel" id="editRetirerDlc1Input" 
                           value="${produit.dlc1 || ''}" 
                           pattern="\\d{2}/\\d{2}/\\d{4}" 
                           inputmode="numeric"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 2:</div>
                    <input type="tel" id="editRetirerQte2Input" 
                           value="${produit.qte2 || ''}" 
                           pattern="[0-9]*" 
                           inputmode="numeric"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" 
                           oninput="validateNumericInput(this); delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 2:</div>
                    <input type="tel" id="editRetirerDlc2Input" 
                           value="${produit.dlc2 || ''}" 
                           pattern="\\d{2}/\\d{2}/\\d{4}" 
                           inputmode="numeric"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 3:</div>
                    <input type="tel" id="editRetirerQte3Input" 
                           value="${produit.qte3 || ''}" 
                           pattern="[0-9]*" 
                           inputmode="numeric"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" 
                           oninput="validateNumericInput(this); delayedEvaluateExpression(this)">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 3:</div>
                    <input type="tel" id="editRetirerDlc3Input" 
                           value="${produit.dlc3 || ''}" 
                           pattern="\\d{2}/\\d{2}/\\d{4}" 
                           inputmode="numeric"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="retirer-btn" onclick="saveEditRetirerProduit()" style="flex: 1; padding: 10px; background: #34495e;">ENREGISTRER</button>
                <button class="retirer-btn" onclick="cancelEditRetirerProduit()" style="flex: 1; padding: 10px; background: #e74c3c;">ANNULER</button>
            </div>
        </div>
    `;
    // === انتهاء النسخ ===

    // إضافة تنسيق التواريخ تلقائياً
    const dateInputs = [
        document.getElementById('editRetirerDlc1Input'),
        document.getElementById('editRetirerDlc2Input'),
        document.getElementById('editRetirerDlc3Input')
    ];

    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
        }
    });

    // إعادة تفعيل delayedEvaluateExpression
    setTimeout(() => {
        const qteInputs = [
            'editRetirerQte1Input',
            'editRetirerQte2Input',
            'editRetirerQte3Input'
        ];
        
        qteInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', function() {
                    delayedEvaluateExpression(this);
                });
            }
        });
    }, 100);

    document.getElementById('editRetirerAdresseInput').focus();
    document.getElementById('editRetirerAdresseInput').select();
}
function saveEditRetirerProduit() {
    const newAdresse = document.getElementById('editRetirerAdresseInput').value;
    const newQte1 = document.getElementById('editRetirerQte1Input').value;
    const newDlc1 = document.getElementById('editRetirerDlc1Input').value;
    const newQte2 = document.getElementById('editRetirerQte2Input').value;
    const newDlc2 = document.getElementById('editRetirerDlc2Input').value;
    const newQte3 = document.getElementById('editRetirerQte3Input').value;
    const newDlc3 = document.getElementById('editRetirerDlc3Input').value;
    
    if (!newAdresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    let adresseFinale = newAdresse;
    if (newAdresse.includes('/')) {
        const parties = newAdresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    // التحقق من التواريخ
    if (newDlc1 && !isValidDateYYYY(newDlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc2 && !isValidDateYYYY(newDlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc3 && !isValidDateYYYY(newDlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (!newQte1 && !newQte2 && !newQte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    // تحديث المنتج مع الحقول الجديدة
    retirerProduits[editingRetirerProduitIndex].adresse = adresseFinale;
    retirerProduits[editingRetirerProduitIndex].qte1 = newQte1 ? parseInt(newQte1) : 0;
    retirerProduits[editingRetirerProduitIndex].dlc1 = newDlc1;
    retirerProduits[editingRetirerProduitIndex].qte2 = newQte2 ? parseInt(newQte2) : 0;
    retirerProduits[editingRetirerProduitIndex].dlc2 = newDlc2;
    retirerProduits[editingRetirerProduitIndex].qte3 = newQte3 ? parseInt(newQte3) : 0;
    retirerProduits[editingRetirerProduitIndex].dlc3 = newDlc3;
    
    saveRetirerProduits();
    updateRetirerDisplay();
    editingRetirerProduitIndex = -1;
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}


function cancelEditRetirerProduit() {
    editingRetirerProduitIndex = -1;
    updateRetirerDisplay();
}

function deleteRetirerProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        retirerProduits.splice(index, 1);
        saveRetirerProduits();
        updateRetirerDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

function clearAllProduitsRetirer() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        retirerProduits = [];
        saveRetirerProduits();
        updateRetirerDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// ============================================
// وظائف صفحة PANIER
// ============================================

function loadPanierProduits() {
    const savedProduits = localStorage.getItem('panier_produits');
    if (savedProduits) {
        panierProduits = JSON.parse(savedProduits);
        updatePanierDisplay();
    }
}

function savePanierProduits() {
    localStorage.setItem('panier_produits', JSON.stringify(panierProduits));
}

function updatePanierDisplay() {
    document.getElementById('panierProduitCount').textContent = panierProduits.length;
    
    const container = document.getElementById('panierProduitsContainer');
    const totalContainer = document.getElementById('panierTotalCard');
    
    container.innerHTML = '';
    totalContainer.innerHTML = '';
    
    if (panierProduits.length === 0) {
        totalContainer.style.display = 'none';
        return;
    }
    
    totalContainer.style.display = 'block';
    
    let totalProduits = 0;
    let totalPrix = 0;
    
    panierProduits.forEach((produit, index) => {
        totalProduits++;
        
        const prixVente = parseFloat(produit.prix.replace(',', '.')) || 0;
        const totalProduit = prixVente * produit.qte;
        totalPrix += totalProduit;
        
        const card = document.createElement('div');
        card.className = 'panier-produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editPanierProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deletePanierProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-details">
                <div class="detail-item">
                    <div class="detail-label">QTE</div>
                    <div class="detail-value">${produit.qte}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">PRIX</div>
                    <div class="detail-value prix">${produit.prix} DH</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">TOTAL</div>
                    <div class="detail-value total">${totalProduit.toFixed(2)} DH</div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    totalContainer.innerHTML = `
        <div class="panier-total-card">
            <h3>RÉSUMÉ DU PANIER</h3>
            <div class="dataRow">
                <span class="label">NOMBRE DE PRODUITS:</span>
                <span class="value">${totalProduits}</span>
            </div>
            <div class="dataRow">
                <span class="label">PRIX TOTAL:</span>
                <span class="total-value">${totalPrix.toFixed(2)} DH</span>
            </div>
        </div>
    `;
    
    totalContainer.prepend(totalContainer.firstChild);
}

document.getElementById('panierCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForPanier(code);
    } else {
        document.getElementById('panierProductInfo').innerHTML = '';
    }
});

function showProductInfoForPanier(code) {
    const container = document.getElementById('panierProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const prixVente = getPrixVenteByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || prixVente || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        if (prixVente && prixVente !== "0") {
            const prixRow = document.createElement('div');
            prixRow.className = 'dataRow';
            prixRow.innerHTML = `<span class="label">PRIX DE VENTE:</span> <span class="value">${formatPrix(prixVente)}</span>`;
            card.appendChild(prixRow);
        }
        
        if (qteGold && qteGold !== "0") {
            const qteGoldRow = document.createElement('div');
            qteGoldRow.className = 'dataRow';
            qteGoldRow.innerHTML = `<span class="label">QTE STOCK:</span> <span class="value">${qteGold}</span>`; // تغيير QTE GOLD إلى QTE STOCK
            card.appendChild(qteGoldRow);
        } else {
            const qteGoldRow = document.createElement('div');
            qteGoldRow.className = 'dataRow';
            qteGoldRow.innerHTML = `<span class="label">QTE STOCK:</span> <span class="value">0</span>`; // تغيير QTE GOLD إلى QTE STOCK
            card.appendChild(qteGoldRow);
        }
        
        if (qteReserve && qteReserve !== "0") {
            const qteReserveRow = document.createElement('div');
            qteReserveRow.className = 'dataRow';
            qteReserveRow.innerHTML = `<span class="label">QTE RESERVE:</span> <span class="value">${qteReserve}</span>`;
            card.appendChild(qteReserveRow);
        } else {
            const qteReserveRow = document.createElement('div');
            qteReserveRow.className = 'dataRow';
            qteReserveRow.innerHTML = `<span class="label">QTE RESERVE:</span> <span class="value">0</span>`;
            card.appendChild(qteReserveRow);
        }
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

function ajouterProduitPanier() {
    const codeInput = document.getElementById('panierCodeInput');
    const qteInput = document.getElementById('panierQteInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÉ DU PRODUIT', 'warning');
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    const prixVente = getPrixVenteByCode(code);
    
    if (!nomProduit) {
        showAlert('PRODUIT NON TROUVÉ DANS LA BASE DE DONNÉES', 'warning');
        return;
    }
    
    const produitNom = nomProduit;
    const produitPrix = prixVente || "0";
    
    const existingIndex = panierProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        panierProduits[existingIndex].qte = parseInt(qte);
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        panierProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte),
            prix: produitPrix
        });
        showAlert('PRODUIT AJOUTÉ AU PANIER AVEC SUCCÈS', 'success');
    }
    
    savePanierProduits();
    updatePanierDisplay();
    
    codeInput.value = '';
    qteInput.value = '';
    document.getElementById('panierProductInfo').innerHTML = '';
    
    codeInput.focus();
}

function editPanierProduit(index) {
    editingPanierProduitIndex = index;
    const produit = panierProduits[index];
    
    const container = document.getElementById('panierProduitsContainer');
    const card = container.children[index];
    
    const prixVente = parseFloat(produit.prix.replace(',', '.')) || 0;
    const totalActuel = prixVente * produit.qte;
    
    card.innerHTML = `
        <div class="edit-modal-overlay">
            <div class="edit-modal-content">
                <div class="edit-modal-header" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                    <h3><span class="edit-icon">✏️</span> MODIFICATION PANIER</h3>
                    <button class="edit-modal-close" onclick="cancelEditPanierProduit()">✕</button>
                </div>
                
                <div class="edit-modal-body">
                    <div class="edit-product-info">
                        <div class="edit-product-code" style="background: #2ecc71;">${produit.code}</div>
                        <div class="edit-product-name">${produit.nom}</div>
                        <div class="edit-product-price">${produit.prix} DH</div>
                    </div>
                    
                    <div class="edit-form-section">
                        <div class="edit-label">QUANTITÉ</div>
                        <input type="tel" 
                               id="editPanierQteInput" 
                               class="edit-input"
                               value="${produit.qte}" 
                               min="1" 
                               oninput="delayedEvaluateExpression(this)"
                               placeholder="QUANTITÉ">
                    </div>
                    
                    <div class="edit-summary-section">
                        <div class="edit-summary-row">
                            <span class="edit-summary-label">PRIX UNITAIRE:</span>
                            <span class="edit-summary-value">${produit.prix} DH</span>
                        </div>
                        
                        <div class="edit-summary-row">
                            <span class="edit-summary-label">QUANTITÉ ACTUELLE:</span>
                            <span class="edit-summary-value">${produit.qte}</span>
                        </div>
                        
                        <div class="edit-summary-row">
                            <span class="edit-summary-label">TOTAL ACTUEL:</span>
                            <span class="edit-summary-total">${totalActuel.toFixed(2)} DH</span>
                        </div>
                    </div>
                    
                    <div class="edit-calculator">
                        <div class="calculator-label">
                            <span class="calculator-icon">🧮</span>
                            CALCULATEUR
                        </div>
                        <div class="calculator-hint">
                            Format: 3*6 (3×6=18) | 12+5 (12+5=17) | 24/2 (24÷2=12)
                        </div>
                    </div>
                </div>
                
                <div class="edit-modal-footer">
                    <button class="edit-modal-btn cancel" onclick="cancelEditPanierProduit()">
                        <span>ANNULER</span>
                    </button>
                    <button class="edit-modal-btn save" onclick="saveEditPanierProduit()">
                        <span class="save-icon">✓</span>
                        <span>ENREGISTRER</span>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // إضافة الأنماط المباشرة
    const style = document.createElement('style');
    style.innerHTML = `
        .edit-modal-overlay {
            position: relative;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #2ecc71;
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.2);
        }
        
        .edit-modal-content {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .edit-modal-header {
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-modal-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edit-icon {
            font-size: 20px;
        }
        
        .edit-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .edit-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .edit-modal-body {
            padding: 20px;
        }
        
        .edit-product-info {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .edit-product-code {
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .edit-product-name {
            color: #2c3e50;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 5px;
        }
        
        .edit-product-price {
            color: #27ae60;
            font-size: 16px;
            font-weight: bold;
            background: #e8f8ef;
            padding: 5px 10px;
            border-radius: 6px;
            display: inline-block;
        }
        
        .edit-form-section {
            margin-bottom: 20px;
        }
        
        .edit-label {
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .edit-input {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            border: 2px solid #ddd;
            padding: 0 15px;
            font-size: 16px;
            text-align: center;
            box-sizing: border-box;
            transition: border 0.3s;
        }
        
        .edit-input:focus {
            border-color: #2ecc71;
            outline: none;
        }
        
        .edit-summary-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .edit-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .edit-summary-row:last-child {
            border-bottom: none;
        }
        
        .edit-summary-label {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .edit-summary-value {
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
        }
        
        .edit-summary-total {
            color: #2ecc71;
            font-size: 18px;
            font-weight: bold;
        }
        
        .edit-calculator {
            background: #e8f8ef;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .calculator-label {
            color: #27ae60;
            font-size: 13px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .calculator-hint {
            color: #7f8c8d;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .edit-modal-footer {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .edit-modal-btn {
            flex: 1;
            height: 50px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .edit-modal-btn.cancel {
            background: #e74c3c;
            color: white;
        }
        
        .edit-modal-btn.cancel:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .edit-modal-btn.save {
            background: #27ae60;
            color: white;
        }
        
        .edit-modal-btn.save:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .save-icon {
            font-size: 18px;
        }
    `;
    
    card.appendChild(style);
    
    document.getElementById('editPanierQteInput').focus();
    document.getElementById('editPanierQteInput').select();
}

function saveEditPanierProduit() {
    const newQte = document.getElementById('editPanierQteInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    panierProduits[editingPanierProduitIndex].qte = parseInt(newQte);
    savePanierProduits();
    updatePanierDisplay();
    editingPanierProduitIndex = -1;
    showAlert('QUANTITÉ MODIFIÉE AVEC SUCCÈS', 'success');
}

function cancelEditPanierProduit() {
    editingPanierProduitIndex = -1;
    updatePanierDisplay();
}

function deletePanierProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT DU PANIER?', () => {
        panierProduits.splice(index, 1);
        savePanierProduits();
        updatePanierDisplay();
        showAlert('PRODUIT SUPPRIMÉ DU PANIER AVEC SUCCÈS', 'success');
    });
}

function clearAllPanier() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUT LE PANIER?', function() {
        panierProduits = [];
        savePanierProduits();
        updatePanierDisplay();
        showAlert('PANIER VIDÉ AVEC SUCCÈS', 'success');
    });
}

// ============================================
// وظائف الأزرار السريعة
// ============================================

function openQuickRetirerModal(code, adresse, nomProduit) {
    currentQuickProduct = {
        code: code,
        adresse: adresse,
        nom: nomProduit,
        type: 'retirer'
    };
    
    const infoDiv = document.getElementById('quickRetirerInfo');
    infoDiv.innerHTML = `
        <div class="code" style="color: #2c3e50 !important;">CODE: ${code}</div>
        <div class="name" style="color: #2c3e50 !important;">NOM: ${nomProduit}</div>
        <div class="adresse" style="color: #FFA500 !important;">ADRESSE: ${adresse}</div>
    `;
    
    document.getElementById('quickRetirerQte1Input').value = '';
    document.getElementById('quickRetirerDlc1Input').value = '';
    document.getElementById('quickRetirerQte2Input').value = '';
    document.getElementById('quickRetirerDlc2Input').value = '';
    document.getElementById('quickRetirerQte3Input').value = '';
    document.getElementById('quickRetirerDlc3Input').value = '';
    
    document.getElementById('quickRetirerModal').style.display = 'flex';
}

function closeQuickRetirerModal() {
    document.getElementById('quickRetirerModal').style.display = 'none';
    currentQuickProduct = null;
}

function quickRetirerProduit() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'retirer') {
        return;
    }
    
    const qte1Input = document.getElementById('quickRetirerQte1Input');
    const dlc1Input = document.getElementById('quickRetirerDlc1Input');
    const qte2Input = document.getElementById('quickRetirerQte2Input');
    const dlc2Input = document.getElementById('quickRetirerDlc2Input');
    const qte3Input = document.getElementById('quickRetirerQte3Input');
    const dlc3Input = document.getElementById('quickRetirerDlc3Input');
    
    const dlc1 = dlc1Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    const existingIndex = retirerProduits.findIndex(p => p.code === currentQuickProduct.code && p.adresse === currentQuickProduct.adresse);
    
    if (existingIndex >= 0) {
        retirerProduits[existingIndex] = {
            code: currentQuickProduct.code,
            adresse: currentQuickProduct.adresse,
            nom: currentQuickProduct.nom,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        };
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        retirerProduits.push({
            code: currentQuickProduct.code,
            adresse: currentQuickProduct.adresse,
            nom: currentQuickProduct.nom,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    saveRetirerProduits();
    updateRetirerDisplay();
    closeQuickRetirerModal();
}

function validateQuickAjouterTotal() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'ajouter') {
        return;
    }
    
    const code = currentQuickProduct.code;
    const adresseInput = document.getElementById('quickAjouterAdresseInput');
    const adresse = adresseInput ? adresseInput.value.trim() : '';
    
    const qte1Input = document.getElementById('quickAjouterQte1Input');
    const qte2Input = document.getElementById('quickAjouterQte2Input');
    const qte3Input = document.getElementById('quickAjouterQte3Input');
    
    const qte1 = qte1Input ? qte1Input.value.trim() : '';
    const qte2 = qte2Input ? qte2Input.value.trim() : '';
    const qte3 = qte3Input ? qte3Input.value.trim() : '';
    
    // حساب إجمالي الكمية المدخلة
    const totalInputQte = 
        (qte1 ? parseInt(qte1) : 0) + 
        (qte2 ? parseInt(qte2) : 0) + 
        (qte3 ? parseInt(qte3) : 0);
    
    if (!code) {
        // إعادة تعيين الأنماط
        const inputs = [qte1Input, qte2Input, qte3Input];
        inputs.forEach(input => {
            if (input) {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        });
        
        // إخفاء رسالة التحقق
        const validationMessage = document.getElementById('quickAjouterQteValidationMessage');
        if (validationMessage) {
            validationMessage.innerHTML = '';
            validationMessage.style.display = 'none';
        }
        
        return;
    }
    
    // الحصول على QTE STOCK و QTE RESERVE
    const qteStock = parseInt(getQteGoldByCode(code).replace(/[^0-9.-]+/g, "")) || 0;
    const qteReserve = parseInt(getQteReserveByCode(code).replace(/[^0-9.-]+/g, "")) || 0;
    
    // حساب الكمية الإجمالية بعد الإضافة
    const totalAfterAdd = qteReserve + totalInputQte;
    
    // التحقق من التطابق والتجاوز
    const isExactMatch = (totalAfterAdd === qteStock);
    const isOverStock = (totalAfterAdd > qteStock);
    
    // تلوين حقول الكمية
    const inputs = [qte1Input, qte2Input, qte3Input];
    inputs.forEach(input => {
        if (input) {
            if (isExactMatch && totalInputQte > 0) {
                input.style.borderColor = '#e74c3c';
                input.style.backgroundColor = '#ffe6e6';
            } else if (isOverStock) {
                input.style.borderColor = '#f39c12';
                input.style.backgroundColor = '#fff3cd';
            } else if (totalInputQte > 0) {
                input.style.borderColor = '#27ae60';
                input.style.backgroundColor = '#e8f8ef';
            } else {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        }
    });
    
    // تحديث رسالة التحقق
    const validationMessage = document.getElementById('quickAjouterQteValidationMessage');
    
    if (totalInputQte > 0 || isExactMatch || isOverStock) {
        let messageHTML = '';
        let messageColor = '';
        let messageBg = '';
        let messageBorder = '';
        
        if (isExactMatch) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #e74c3c;"></div>
                    <div>
                        <strong>ATTENTION:</strong> RÉSERVE SATURÉE<br>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL: ${totalAfterAdd} = QTE STOCK
                    </div>
                </div>
            `;
            messageColor = '#e74c3c';
            messageBg = '#fdedec';
            messageBorder = '#e74c3c';
        } else if (isOverStock) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #f39c12;"></div>
                    <div>
                        <strong>ATTENTION:</strong> DÉPASSEMENT STOCK<br>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL: ${totalAfterAdd} > QTE STOCK (${qteStock})
                    </div>
                </div>
            `;
            messageColor = '#f39c12';
            messageBg = '#fff3cd';
            messageBorder = '#f39c12';
        } else if (totalInputQte > 0) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #27ae60;"></div>
                    <div>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL APRÈS AJOUT: ${totalAfterAdd}
                    </div>
                </div>
            `;
            messageColor = '#27ae60';
            messageBg = '#e8f8ef';
            messageBorder = '#27ae60';
        }
        
        if (validationMessage) {
            validationMessage.innerHTML = messageHTML;
            validationMessage.style.color = messageColor;
            validationMessage.style.background = messageBg;
            validationMessage.style.borderColor = messageBorder;
            validationMessage.style.display = 'block';
            validationMessage.style.cssText += `
                text-align: center;
                font-weight: bold;
                margin: 10px 0;
                padding: 12px;
                border-radius: 8px;
                transition: all 0.3s;
                font-size: 14px;
                border: 2px solid;
            `;
        }
    } else {
        if (validationMessage) {
            validationMessage.innerHTML = '';
            validationMessage.style.display = 'none';
        }
    }
}

function openQuickCommanderModal(code, nomProduit) {
    currentQuickProduct = {
        code: code,
        nom: nomProduit,
        type: 'commander'
    };
    
    const infoDiv = document.getElementById('quickCommanderInfo');
    infoDiv.innerHTML = `
        <div class="code">CODE: ${code}</div>
        <div class="name">NOM: ${nomProduit}</div>
    `;
    
    document.getElementById('quickCommanderQteInput').value = '';
    document.getElementById('quickCommanderModal').style.display = 'flex';
}

function closeQuickCommanderModal() {
    document.getElementById('quickCommanderModal').style.display = 'none';
    currentQuickProduct = null;
}

function quickCommanderProduit() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'commander') {
        return;
    }
    
    const qteInput = document.getElementById('quickCommanderQteInput');
    const qte = qteInput.value.trim();
    
    if (!qte) {
        showAlert('VEUILLEZ ENTRER LA QUANTITÉ DU PRODUIT', 'warning');
        return;
    }
    
    const existingIndex = commandeProduits.findIndex(p => p.code === currentQuickProduct.code);
    
    if (existingIndex >= 0) {
        commandeProduits[existingIndex].qte = parseInt(qte);
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        commandeProduits.push({
            code: currentQuickProduct.code,
            nom: currentQuickProduct.nom,
            qte: parseInt(qte)
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    saveCommandeProduits();
    updateCommandeDisplay();
    closeQuickCommanderModal();
}

 function openQuickAjouterModal(code, nomProduit, adresse) {
    currentQuickProduct = {
        code: code,
        nom: nomProduit,
        adresse: adresse,
        type: 'ajouter'
    };
    
    // أولاً: إعادة تعيين جميع الحقول والرسائل
    resetQuickAjouterFields();
    
    const infoDiv = document.getElementById('quickAjouterInfo');
    const displayAdresse = adresse || "Z6P1";
    infoDiv.innerHTML = `
        <div class="adresse" style="color: #FFA500 !important;">ADRESSE: ${displayAdresse}</div>
        <div class="code" style="color: #2c3e50 !important;">CODE: ${code}</div>
        <div class="name" style="color: #2c3e50 !important;">NOM: ${nomProduit}</div>
    `;
    
    if (adresse && adresse.startsWith('Z') && adresse.includes('P')) {
        const match = adresse.match(/Z(\d+)P(\d+)/);
        if (match) {
            document.getElementById('quickAjouterAdresseInput').value = `${match[1]}/${match[2]}`;
        } else {
            document.getElementById('quickAjouterAdresseInput').value = adresse;
        }
    } else {
        document.getElementById('quickAjouterAdresseInput').value = adresse;
    }
    
    document.getElementById('quickAjouterModal').style.display = 'flex';
    
    // إعداد التحقق من صحة التاريخ
    setupDateValidationForQuickAjouter();
    
    // التركيز على حقل العنوان
    setTimeout(() => {
        document.getElementById('quickAjouterAdresseInput').focus();
        document.getElementById('quickAjouterAdresseInput').select();
    }, 100);
}

function closeQuickAjouterModal() {
    document.getElementById('quickAjouterModal').style.display = 'none';
    currentQuickProduct = null;
    
    // إعادة تعيين جميع الحقول
    const inputs = [
        'quickAjouterAdresseInput',
        'quickAjouterQte1Input', 'quickAjouterDlc1Input',
        'quickAjouterQte2Input', 'quickAjouterDlc2Input',
        'quickAjouterQte3Input', 'quickAjouterDlc3Input'
    ];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.style.color = '';
            input.style.fontWeight = '';
            input.title = '';
            
            // إزالة رسائل الخطأ من حقول التاريخ
            const errorMessage = input.parentNode.querySelector('.date-error-message');
            if (errorMessage) {
                errorMessage.remove();
            }
        }
    });
    
    // إخفاء وإعادة تعيين رسالة التحقق
    const validationMessage = document.getElementById('quickAjouterQteValidationMessage');
    if (validationMessage) {
        validationMessage.innerHTML = '';
        validationMessage.style.display = 'none';
        validationMessage.style.color = '';
        validationMessage.style.background = '';
        validationMessage.style.borderColor = '';
    }
}

// ============================================
// تحقق من صحة العنوان في نافذة AJOUTER السريعة
// ============================================

function validateAddressFormat(address) {
    // إذا كان العنوان فارغاً، لا نحاول التحقق
    if (!address.trim()) {
        return true;
    }
    
    // التحقق من التنسيقات المسموحة:
    // رقم/رقم (مثل: 6/1)
    // رقم/رقمان (مثل: 6/12)
    // رقمين/رقم (مثل: 16/1)
    // رقمين/رقمان (مثل: 16/12)
    // ثلاثة أرقام/رقم (مثل: 116/1)
    // ثلاثة أرقام/رقمان (مثل: 116/12)
    
    const addressPatterns = [
        /^\d{1,3}\/\d{1,2}$/, // يتطابق مع جميع التنسيقات المطلوبة
    ];
    
    // التحقق من أن العنوان يطابق أحد الأنماط المسموحة
    for (const pattern of addressPatterns) {
        if (pattern.test(address)) {
            return true;
        }
    }
    
    return false;
}

// ============================================
// تحقق من الكمية في صفحة AJOUTER
// ============================================

function validateAjouterTotal() {
    const code = document.getElementById('ajouterCodeInput').value.trim();
    const adresse = document.getElementById('ajouterAdresseInput').value.trim();
    
    const qte1Input = document.getElementById('ajouterQte1Input');
    const qte2Input = document.getElementById('ajouterQte2Input');
    const qte3Input = document.getElementById('ajouterQte3Input');
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    // حساب إجمالي الكمية المدخلة
    const totalInputQte = 
        (qte1 ? parseInt(qte1) : 0) + 
        (qte2 ? parseInt(qte2) : 0) + 
        (qte3 ? parseInt(qte3) : 0);
    
    if (!code) {
        // إعادة تعيين أنماط الحقول
        const inputs = [qte1Input, qte2Input, qte3Input];
        inputs.forEach(input => {
            if (input) {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        });
        
        // إزالة الدائرة الحمراء من حقل العنوان
        const addressInput = document.getElementById('ajouterAdresseInput');
        if (addressInput) {
            addressInput.style.backgroundImage = '';
            addressInput.style.backgroundRepeat = 'no-repeat';
            addressInput.style.backgroundPosition = 'right 10px center';
            addressInput.style.backgroundSize = '20px 20px';
            addressInput.style.paddingRight = '10px';
        }
        
        // إزالة رسالة التحقق
        const validationMessage = document.getElementById('ajouterQteValidationMessage');
        if (validationMessage) {
            validationMessage.remove();
        }
        
        return;
    }
    
    // الحصول على QTE STOCK و QTE RESERVE
    const qteStock = parseInt(getQteGoldByCode(code).replace(/[^0-9.-]+/g, "")) || 0;
    const qteReserve = parseInt(getQteReserveByCode(code).replace(/[^0-9.-]+/g, "")) || 0;
    
    // حساب الكمية الإجمالية بعد الإضافة
    const totalAfterAdd = qteReserve + totalInputQte;
    
    // التحقق: إذا كان مجموع الكميات المدخلة + QTE RESERVE يساوي QTE STOCK
    const isExactMatch = (totalAfterAdd === qteStock);
    
    // التحقق: إذا تجاوزت الكمية المدخلة QTE STOCK
    const isOverStock = (totalAfterAdd > qteStock);
    
    // إضافة الدائرة الحمراء على حقل العنوان إذا كان هناك تطابق تام
    const addressInput = document.getElementById('ajouterAdresseInput');
    if (addressInput) {
        if (isExactMatch && totalInputQte > 0) {
            // إضافة دائرة حمراء
            addressInput.style.backgroundImage = 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 20 20\'%3E%3Ccircle cx=\'10\' cy=\'10\' r=\'9\' fill=\'%23e74c3c\'/%3E%3C/svg%3E")';
            addressInput.style.backgroundRepeat = 'no-repeat';
            addressInput.style.backgroundPosition = 'right 10px center';
            addressInput.style.backgroundSize = '20px 20px';
            addressInput.style.paddingRight = '40px';
        } else {
            addressInput.style.backgroundImage = '';
            addressInput.style.backgroundRepeat = 'no-repeat';
            addressInput.style.backgroundPosition = 'right 10px center';
            addressInput.style.backgroundSize = '20px 20px';
            addressInput.style.paddingRight = '10px';
        }
    }
    
    // تغيير لون حقول الكمية
    const inputs = [qte1Input, qte2Input, qte3Input];
    inputs.forEach(input => {
        if (input) {
            if (isExactMatch && totalInputQte > 0) {
                input.style.borderColor = '#e74c3c';
                input.style.backgroundColor = '#ffe6e6';
            } else if (isOverStock) {
                input.style.borderColor = '#f39c12';
                input.style.backgroundColor = '#fff3cd';
            } else if (totalInputQte > 0) {
                input.style.borderColor = '#27ae60';
                input.style.backgroundColor = '#e8f8ef';
            } else {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        }
    });
    
    // تحديث رسالة التحقق
    const existingMessage = document.getElementById('ajouterQteValidationMessage');
    
    // إنشاء أو تحديث الرسالة
    if (totalInputQte > 0 || isExactMatch || isOverStock) {
        let messageHTML = '';
        let messageColor = '';
        let messageBg = '';
        let messageBorder = '';
        
        if (isExactMatch) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #e74c3c;"></div>
                    <div>
                        <strong>ATTENTION:</strong> RÉSERVE SATURÉE<br>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL: ${totalAfterAdd} = QTE STOCK
                    </div>
                </div>
            `;
            messageColor = '#e74c3c';
            messageBg = '#fdedec';
            messageBorder = '#e74c3c';
        } else if (isOverStock) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #f39c12;"></div>
                    <div>
                        <strong>ATTENTION:</strong> DÉPASSEMENT STOCK<br>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL: ${totalAfterAdd} > QTE STOCK (${qteStock})
                    </div>
                </div>
            `;
            messageColor = '#f39c12';
            messageBg = '#fff3cd';
            messageBorder = '#f39c12';
        } else if (totalInputQte > 0) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #27ae60;"></div>
                    <div>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL APRÈS AJOUT: ${totalAfterAdd}
                    </div>
                </div>
            `;
            messageColor = '#27ae60';
            messageBg = '#e8f8ef';
            messageBorder = '#27ae60';
        }
        
        if (existingMessage) {
            existingMessage.innerHTML = messageHTML;
            existingMessage.style.color = messageColor;
            existingMessage.style.background = messageBg;
            existingMessage.style.borderColor = messageBorder;
        } else {
            const message = document.createElement('div');
            message.id = 'ajouterQteValidationMessage';
            message.className = 'ajouter-qte-validation';
            message.style.cssText = `
                text-align: center;
                font-weight: bold;
                margin: 10px 0;
                padding: 12px;
                border-radius: 8px;
                transition: all 0.3s;
                font-size: 14px;
                border: 2px solid;
            `;
            message.innerHTML = messageHTML;
            message.style.color = messageColor;
            message.style.background = messageBg;
            message.style.borderColor = messageBorder;
            
            // إدراج الرسالة قبل زر AJOUTER
            const inputsContainer = document.querySelector('.ajouter-card');
            if (inputsContainer) {
                const addButton = inputsContainer.querySelector('.ajouter-btn[onclick="ajouterProduitAjouter()"]');
                if (addButton) {
                    inputsContainer.insertBefore(message, addButton);
                }
            }
        }
    } else if (existingMessage) {
        existingMessage.remove();
    }
}

function quickAjouterProduit() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'ajouter') {
        return;
    }
    
    const adresseInput = document.getElementById('quickAjouterAdresseInput');
    const qte1Input = document.getElementById('quickAjouterQte1Input');
    const dlc1Input = document.getElementById('quickAjouterDlc1Input');
    const qte2Input = document.getElementById('quickAjouterQte2Input');
    const dlc2Input = document.getElementById('quickAjouterDlc2Input');
    const qte3Input = document.getElementById('quickAjouterQte3Input');
    const dlc3Input = document.getElementById('quickAjouterDlc3Input');
    
    const adresse = adresseInput.value.trim();
    const dlc1 = dlc1Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    // التحقق من صحة تنسيق العنوان
    if (!validateAddressFormat(adresse)) {
        showAlert('FORMAT ADRESSE INVALIDE. FORMATS ACCEPTÉS:\n- 6/1 (1-3 chiffres/1-2 chiffres)\n- 6/12\n- 16/1\n- 16/12\n- 116/1\n- 116/12', 'warning');
        adresseInput.style.borderColor = '#e74c3c';
        adresseInput.style.backgroundColor = '#ffe6e6';
        adresseInput.focus();
        adresseInput.select();
        return;
    } else {
        adresseInput.style.borderColor = '';
        adresseInput.style.backgroundColor = '';
    }
    
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    // التحقق من وجود كمية على الأقل
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    // التحقق من صحة الكميات
    const qte1Num = qte1 ? parseInt(qte1) : 0;
    const qte2Num = qte2 ? parseInt(qte2) : 0;
    const qte3Num = qte3 ? parseInt(qte3) : 0;
    
    if ((qte1 && qte1Num <= 0) || (qte2 && qte2Num <= 0) || (qte3 && qte3Num <= 0)) {
        showAlert('LES QUANTITÉS DOIVENT ÊTRE SUPÉRIEURES À 0', 'warning');
        return;
    }
    
    // التحقق من التواريخ مع رسائل تفصيلية
    const dateChecks = [];
    
    if (dlc1) {
        const check1 = checkIfDateExpired(dlc1);
        dateChecks.push({ field: dlc1Input, check: check1, dlcNumber: 1 });
    }
    
    if (dlc2) {
        const check2 = checkIfDateExpired(dlc2);
        dateChecks.push({ field: dlc2Input, check: check2, dlcNumber: 2 });
    }
    
    if (dlc3) {
        const check3 = checkIfDateExpired(dlc3);
        dateChecks.push({ field: dlc3Input, check: check3, dlcNumber: 3 });
    }
    
    // التحقق من جميع التواريخ
    let hasDateError = false;
    
    for (const dateCheck of dateChecks) {
        if (dateCheck.check.expired) {
            hasDateError = true;
            const errorMessage = getDateErrorMessage(dateCheck.check.reason);
            
            // تلوين الحقل باللون الأحمر
            dateCheck.field.style.borderColor = '#e74c3c';
            dateCheck.field.style.backgroundColor = '#ffe6e6';
            dateCheck.field.style.color = '#e74c3c';
            dateCheck.field.style.fontWeight = 'bold';
            
            showAlert(`DLC ${dateCheck.dlcNumber}: ${errorMessage}`, 'warning');
            dateCheck.field.focus();
            dateCheck.field.select();
            return;
        } else {
            // إعادة تعيين الأنماط إذا كان التاريخ صالحاً
            dateCheck.field.style.borderColor = '';
            dateCheck.field.style.backgroundColor = '';
            dateCheck.field.style.color = '';
            dateCheck.field.style.fontWeight = '';
        }
    }
    
    // التحقق من أن التواريخ ليست متطابقة إذا تم إدخال أكثر من واحد
    const dates = [dlc1, dlc2, dlc3].filter(d => d);
    const uniqueDates = new Set(dates);
    
    if (dates.length > 1 && uniqueDates.size !== dates.length) {
        showAlert('LES DATES NE PEUVENT PAS ÊTRE IDENTIQUES', 'warning');
        return;
    }
    
    // التحقق من أن الكميات مقترنة بتواريخ
    if ((qte1 && !dlc1) || (qte2 && !dlc2) || (qte3 && !dlc3)) {
        showAlert('CHAQUE QUANTITÉ DOIT AVOIR UNE DATE ASSOCIÉE', 'warning');
        return;
    }
    
    // التحقق من وجود منتج مكرر
    const existingIndex = ajouterProduits.findIndex(p => p.adresse === adresseFinale && p.code === currentQuickProduct.code);
    
    if (existingIndex >= 0) {
        showAlert('CE PRODUIT AVEC LE MÊME CODE ET ADRESSE EXISTE DÉJÀ!', 'warning');
        return;
    }
    
    // إضافة المنتج
    ajouterProduits.push({
        code: currentQuickProduct.code,
        adresse: adresseFinale,
        nom: currentQuickProduct.nom,
        qte1: qte1Num,
        dlc1: dlc1,
        qte2: qte2Num,
        dlc2: dlc2,
        qte3: qte3Num,
        dlc3: dlc3
    });
    
    showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    
    saveAjouterProduits();
    updateAjouterDisplay();
    closeQuickAjouterModal();
}

// ============================================
// وظائف زر التقويم
// ============================================

function showDatePicker(dateFieldId, productCode) {
    currentDateField = dateFieldId;
    currentProductCodeForDate = productCode;
    
    if (!productCode) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    const dates = getAvailableDatesForProduct(productCode);
    
    const dateList = document.getElementById('dateList');
    dateList.innerHTML = '';
    
    if (dates.length === 0) {
        dateList.innerHTML = '<div class="date-option">AUCUNE DATE DISPONIBLE POUR CE PRODUIT</div>';
    } else {
        dates.forEach(date => {
            const dateOption = document.createElement('div');
            dateOption.className = 'date-option';
            dateOption.textContent = date;
            dateOption.onclick = function() {
                selectDate(date);
            };
            dateList.appendChild(dateOption);
        });
    }
    
    document.getElementById('datePickerModal').style.display = 'flex';
}

function closeDatePicker() {
    document.getElementById('datePickerModal').style.display = 'none';
    currentDateField = null;
    currentProductCodeForDate = null;
}

function selectDate(date) {
    if (currentDateField) {
        const dateInput = document.getElementById(currentDateField);
        if (dateInput) {
            dateInput.value = date;
            dateInput.focus();
        }
    }
    closeDatePicker();
}

// ============================================
// تهيئة التطبيق
// ============================================

// ============================================
// دالة لعرض خيارات العناوين
// ============================================

// دالة لعرض خيارات العناوين
function showAddressOptions() {
    // إذا النافذة مفتوحة بالفعل، لا تفتحها ثانية
    if (document.getElementById('addressOptionsModal')) {
        return;
    }
    
    const code = document.getElementById('retirerCodeInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('retirerCodeInput').focus();
        return;
    }
    
    const addresses = getAddressesForProduct(code);
    
    if (addresses.length === 0) {
        showAlert('AUCUNE ADRESSE TROUVÉE POUR CE PRODUIT', 'warning');
        return;
    }
    
    // إنشاء نافذة الخيارات
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'addressOptionsModal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>SÉLECTIONNER UNE ADRESSE</h2>
            <p>CHOISISSEZ UNE ADRESSE POUR LE CODE: ${code}</p>
            <div id="addressOptionsList" class="date-options" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAddressOptions()">ANNULER</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const addressList = document.getElementById('addressOptionsList');
    
    addresses.forEach(address => {
        const option = document.createElement('div');
        option.className = 'date-option';
        option.textContent = address;
        option.onclick = function() {
            selectAddress(address);
        };
        addressList.appendChild(option);
    });
    
    modal.style.display = 'flex';
}

// دالة للحصول على العناوين للمنتج
function getAddressesForProduct(code) {
    const addresses = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            const adresse = csvCache[i][1] || "";
            if (adresse) {
                addresses.add(adresse);
            }
        }
    }
    
    return Array.from(addresses).sort();
}

// دالة لاختيار العنوان
function selectAddress(address) {
    document.getElementById('retirerAdresseInput').value = address;
    
    // تحويل Z6P1 إلى 6/1
    if (address.startsWith('Z') && address.includes('P')) {
        const match = address.match(/Z(\d+)P(\d+)/);
        if (match) {
            document.getElementById('retirerAdresseInput').value = `${match[1]}/${match[2]}`;
        }
    }
    
    closeAddressOptions();
}

// دالة لإغلاق نافذة العناوين
function closeAddressOptions() {
    const modal = document.getElementById('addressOptionsModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.removeChild(modal);
    }
}

// دالة لعرض خيارات التواريخ لحقول DLC
function showDateOptionsForRetirer(dlcNumber) {
    // إذا النافذة مفتوحة بالفعل، لا تفتحها ثانية
    if (document.getElementById('dateOptionsModalRetirer')) {
        return;
    }
    
    const code = document.getElementById('retirerCodeInput').value.trim();
    const adresse = document.getElementById('retirerAdresseInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('retirerCodeInput').focus();
        return;
    }
    
    if (!adresse) {
        showAlert('VEUILLEZ D\'ABORD ENTRER L\'ADRESSE', 'warning');
        document.getElementById('retirerAdresseInput').focus();
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const dates = getDatesForProductAtAddress(code, adresseFinale);
    
    if (dates.length === 0) {
        showAlert('AUCUNE DATE DISPONIBLE POUR CE PRODUIT À CETTE ADRESSE', 'warning');
        return;
    }
    
    // إنشاء نافذة الخيارات
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'dateOptionsModalRetirer';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>SÉLECTIONNER UNE DATE</h2>
            <p>CHOISISSEZ UNE DATE POUR DLC ${dlcNumber} (${code} - ${adresseFinale})</p>
            <div id="dateOptionsListRetirer" class="date-options" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeDateOptionsForRetirer()">ANNULER</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const dateList = document.getElementById('dateOptionsListRetirer');
    
    dates.forEach(date => {
        const option = document.createElement('div');
        option.className = 'date-option';
        option.textContent = date;
        option.onclick = function() {
            selectDateForRetirer(date, dlcNumber);
        };
        dateList.appendChild(option);
    });
    
    modal.style.display = 'flex';
}

// دالة للحصول على التواريخ للمنتج في عنوان محدد
function getDatesForProductAtAddress(code, adresse) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            // جمع التواريخ من الأعمدة 3, 5, 7 (الدلال هي 1, 3, 5 في المصفوفة)
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}

// دالة لاختيار التاريخ
function selectDateForRetirer(date, dlcNumber) {
    const dlcField = document.getElementById(`retirerDlc${dlcNumber}Input`);
    if (dlcField) {
        dlcField.value = date;
    }
    
    closeDateOptionsForRetirer();
}
// متغير لتخزين حقل DLC الحالي في نافذة Quick Retirer
let currentQuickRetirerDlcField = null;
let currentQuickRetirerDlcNumber = null;

// دالة لعرض خيارات التواريخ لنافذة Quick Retirer
function showDateOptionsForQuickRetirer(dlcNumber) {
    currentQuickRetirerDlcNumber = dlcNumber;
    
    if (!currentQuickProduct || !currentQuickProduct.code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    const dates = getDatesForProductAtAddress(currentQuickProduct.code, currentQuickProduct.adresse);
    
    if (dates.length === 0) {
        showAlert('AUCUNE DATE DISPONIBLE POUR CE PRODUIT À CETTE ADRESSE', 'warning');
        return;
    }
    
    const dateList = document.getElementById('dateOptionsContainerQuickRetirer');
    dateList.innerHTML = '';
    
    dates.forEach(date => {
        const option = document.createElement('div');
        option.className = 'date-option';
        option.textContent = date;
        option.onclick = function() {
            selectDateForQuickRetirer(date);
        };
        dateList.appendChild(option);
    });
    
    document.getElementById('dateOptionsModalQuickRetirer').style.display = 'flex';
}

// دالة لاختيار التاريخ لنافذة Quick Retirer
function selectDateForQuickRetirer(date) {
    if (currentQuickRetirerDlcNumber) {
        const dlcField = document.getElementById(`quickRetirerDlc${currentQuickRetirerDlcNumber}Input`);
        if (dlcField) {
            dlcField.value = date;
            dlcField.focus();
        }
    }
    
    closeDateOptionsModalQuickRetirer();
}

// دالة لإغلاق نافذة التواريخ لنافذة Quick Retirer
function closeDateOptionsModalQuickRetirer() {
    document.getElementById('dateOptionsModalQuickRetirer').style.display = 'none';
    currentQuickRetirerDlcField = null;
    currentQuickRetirerDlcNumber = null;
    document.getElementById('dateOptionsContainerQuickRetirer').innerHTML = '';
}

// دالة للحصول على التواريخ للمنتج في عنوان محدد
function getDatesForProductAtAddress(code, adresse) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            // جمع التواريخ من الأعمدة 3, 5, 7 (الدلال هي 1, 3, 5 في المصفوفة)
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}
// دالة لإغلاق نافذة التواريخ
function closeDateOptionsForRetirer() {
    const modal = document.getElementById('dateOptionsModalRetirer');
    if (modal) {
        modal.style.display = 'none';
        document.body.removeChild(modal);
    }
}

// ============================================
// وظائف نافذة خيارات العناوين لصفحة AJOUTER
// ============================================

// دالة لفتح نافذة اختيار العناوين
function showAddressOptionsForAjouter() {
    const code = document.getElementById('ajouterCodeInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('ajouterCodeInput').focus();
        return;
    }
    
    const addresses = getAddressesForProduct(code);
    
    if (addresses.length === 0) {
        showAlert('AUCUNE ADRESSE TROUVÉE POUR CE PRODUIT', 'warning');
        return;
    }
    
    const container = document.getElementById('addressOptionsContainerAjouter');
    container.innerHTML = '';
    
    // إضافة خيار "NOUVELLE ADRESSE"
    const newAddressOption = document.createElement('div');
    newAddressOption.className = 'date-option';
    newAddressOption.style.background = '#3498db';
    newAddressOption.style.color = 'white';
    newAddressOption.style.borderColor = '#3498db';
    newAddressOption.innerHTML = '<strong>NOUVELLE ADRESSE</strong>';
    newAddressOption.onclick = function() {
        selectAddressForAjouter('');
    };
    container.appendChild(newAddressOption);
    
    // إضافة العناوين الموجودة
    addresses.forEach(address => {
        const option = document.createElement('div');
        option.className = 'date-option';
        
        // تحويل Z6P1 إلى 6/1 للعرض
        let displayAddress = address;
        if (address.startsWith('Z') && address.includes('P')) {
            const match = address.match(/Z(\d+)P(\d+)/);
            if (match) {
                displayAddress = `${match[1]}/${match[2]}`;
            }
        }
        
        option.textContent = displayAddress;
        option.setAttribute('data-address', address);
        option.onclick = function() {
            selectAddressForAjouter(address);
        };
        container.appendChild(option);
    });
    
    document.getElementById('addressSelectMessageAjouter').textContent = `CHOISISSEZ UNE ADRESSE POUR LE CODE: ${code}`;
    document.getElementById('addressOptionsModalAjouter').style.display = 'flex';
}

// دالة لاختيار العنوان
function selectAddressForAjouter(address) {
    if (address === '') {
        // إذا اختار "NOUVELLE ADRESSE"، اترك الحقل فارغاً للكتابة
        document.getElementById('ajouterAdresseInput').value = '';
        document.getElementById('ajouterAdresseInput').focus();
    } else {
        // تحويل Z6P1 إلى 6/1 للإدخال
        if (address.startsWith('Z') && address.includes('P')) {
            const match = address.match(/Z(\d+)P(\d+)/);
            if (match) {
                document.getElementById('ajouterAdresseInput').value = `${match[1]}/${match[2]}`;
            } else {
                document.getElementById('ajouterAdresseInput').value = address;
            }
        } else {
            document.getElementById('ajouterAdresseInput').value = address;
        }
        
        // إبراز الحقل
        const input = document.getElementById('ajouterAdresseInput');
        input.style.backgroundColor = "#d6f0ff";
        input.style.borderColor = "#3498db";
        setTimeout(() => {
            input.style.backgroundColor = "";
            input.style.borderColor = "";
        }, 1500);
    }
    
    closeAddressOptionsModalAjouter();
}

// دالة لإغلاق نافذة العناوين
function closeAddressOptionsModalAjouter() {
    document.getElementById('addressOptionsModalAjouter').style.display = 'none';
    document.getElementById('addressOptionsContainerAjouter').innerHTML = '';
}

// دالة للحصول على جميع العناوين للمنتج
function getAddressesForProduct(code) {
    const addresses = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            const adresse = csvCache[i][1] || "";
            if (adresse && adresse.trim() !== '') {
                addresses.add(adresse);
            }
        }
    }
    
    // فرز العناوين
    return Array.from(addresses).sort((a, b) => {
        // تحويل Z6P1 إلى أرقام للمقارنة
        const aMatch = a.match(/Z(\d+)P(\d+)/);
        const bMatch = b.match(/Z(\d+)P(\d+)/);
        
        if (aMatch && bMatch) {
            const aZone = parseInt(aMatch[1]);
            const bZone = parseInt(bMatch[1]);
            const aPos = parseInt(aMatch[2]);
            const bPos = parseInt(bMatch[2]);
            
            if (aZone !== bZone) {
                return aZone - bZone;
            }
            return aPos - bPos;
        }
        
        return a.localeCompare(b);
    });
}
// ============================================
// وظائف نافذة خيارات التواريخ لصفحة AJOUTER
// ============================================

let currentAjouterDlcNumber = null; // لتخزين رقم حقل DLC الحالي

// دالة لفتح نافذة اختيار التواريخ
// تحديث دالة showDateOptionsForAjouter
function showDateOptionsForAjouter(dlcNumber) {
    currentAjouterDlcNumber = dlcNumber;
    
    const code = document.getElementById('ajouterCodeInput').value.trim();
    const adresse = document.getElementById('ajouterAdresseInput').value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        document.getElementById('ajouterCodeInput').focus();
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    let dates = [];
    
    if (adresseFinale) {
        dates = getDatesForProductAtAddress(code, adresseFinale);
    }
    
    if (dates.length === 0) {
        dates = getAllDatesForProduct(code);
    }
    
    // تطبيق تنقية إضافية للطوارئ
    dates = filterInvalidDates(dates);
    
    // إذا لم توجد تواريخ صالحة، لا تفتح النافذة
    if (dates.length === 0) {
        const dlcField = document.getElementById(`ajouterDlc${dlcNumber}Input`);
        if (dlcField) {
            dlcField.focus();
            dlcField.select();
        }
        // رسالة تنبيه
        showAlert('AUCUNE DATE VALIDE DISPONIBLE POUR CE PRODUIT', 'info');
        return;
    }
    
    displayDateOptionsForAjouter(dates, dlcNumber, code, adresseFinale);
}
// دالة لعرض خيارات التواريخ مع تلوين حسب الصلاحية
function displayDateOptionsForAjouter(dates, dlcNumber, code, adresse) {
    const container = document.getElementById('dateOptionsContainerAjouter');
    container.innerHTML = '';
    
    let titleText = `CHOISISSEZ UNE DATE POUR DLC ${dlcNumber}`;
    if (code) {
        titleText += ` (${code})`;
    }
    if (adresse) {
        titleText += ` - ${adresse}`;
    }
    
    document.getElementById('dateSelectMessageAjouter').textContent = titleText;
    
    // إضافة خيار "NOUVELLE DATE" في البداية
    const newDateOption = document.createElement('div');
    newDateOption.className = 'date-option';
    newDateOption.style.background = '#3498db';
    newDateOption.style.color = 'white';
    newDateOption.style.borderColor = '#3498db';
    newDateOption.innerHTML = '<strong>NOUVELLE DATE</strong>';
    newDateOption.onclick = function() {
        selectDateForAjouter('');
    };
    container.appendChild(newDateOption);
    
    // إضافة التواريخ الموجودة مع تلوين حسب الصلاحية
    dates.forEach(date => {
        if (date !== "NOUVELLE DATE") {
            const option = document.createElement('div');
            option.className = 'date-option';
            
            // التحقق من صلاحية التاريخ
            const today = new Date();
            const inputDate = parseDate(date);
            let optionStyle = '';
            
            if (inputDate) {
                const diffTime = inputDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // تلوين الخيار حسب الصلاحية
                if (diffDays <= 0) {
                    // منتهي الصلاحية - أحمر
                    optionStyle = 'background: #e74c3c; color: white; border-color: #c0392b;';
                    option.innerHTML = `<strong>${date} - EXPIRÉE</strong>`;
                    option.title = `DLC EXPIRÉE (${date})`;
                } else if (diffDays <= 30) {
                    // شهر واحد أو أقل - برتقالي
                    optionStyle = 'background: #f39c12; color: black; border-color: #e67e22;';
                    option.innerHTML = `<strong>${date} - ${diffDays} JOURS</strong>`;
                    option.title = `DLC PROCHAIN (${diffDays} JOURS)`;
                } else {
                    // ساري المفعول - أخضر
                    optionStyle = 'background: #27ae60; color: white; border-color: #219653;';
                    option.innerHTML = `<strong>${date} - ${diffDays} JOURS</strong>`;
                    option.title = `DLC VALIDE (${diffDays} JOURS)`;
                }
            } else {
                option.textContent = date;
                option.title = date;
            }
            
            option.style.cssText += optionStyle;
            option.onclick = function() {
                selectDateForAjouter(date);
            };
            container.appendChild(option);
        }
    });
    
    document.getElementById('dateOptionsModalAjouter').style.display = 'flex';
}
// دالة لجلب جميع تواريخ المنتج
 function getAllDatesForProduct(code) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            // جمع التواريخ من الأعمدة 3, 5, 7 (الدلال هي 1, 3, 5 في المصفوفة)
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                
                // استخدم الدالة الجديدة للتحقق - هذا هو المكان الحرج
                if (isValidProductDate(dateStr)) {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    // فرز التواريخ
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}

// دالة لعرض خيارات التواريخ
// تعديل دالة displayDateOptionsForAjouter
function displayDateOptionsForAjouter(dates, dlcNumber, code, adresse) {
    const container = document.getElementById('dateOptionsContainerAjouter');
    container.innerHTML = '';
    
    let titleText = `CHOISISSEZ UNE DATE POUR DLC ${dlcNumber}`;
    if (code) {
        titleText += ` (${code})`;
    }
    if (adresse) {
        titleText += ` - ${adresse}`;
    }
    
    document.getElementById('dateSelectMessageAjouter').textContent = titleText;
    
    // إضافة خيار "NOUVELLE DATE" في البداية
    const newDateOption = document.createElement('div');
    newDateOption.className = 'date-option';
    newDateOption.style.background = '#3498db';
    newDateOption.style.color = 'white';
    newDateOption.style.borderColor = '#3498db';
    newDateOption.innerHTML = '<strong>NOUVELLE DATE</strong>';
    newDateOption.onclick = function() {
        selectDateForAjouter('');
    };
    container.appendChild(newDateOption);
    
    // تصفية صارمة للتواريخ - استخدم isValidProductDate مباشرة
    const filteredDates = dates.filter(date => {
        if (date === "NOUVELLE DATE") return false;
        
        // استخدم الدالة الجديدة للتحقق
        return isValidProductDate(date);
    });
    
    // التحقق النهائي: إذا كانت هناك تواريخ غير صالحة بعد التصفية
    const finalFilteredDates = filteredDates.filter(date => {
        // تحقق إضافي: تأكد من أن التاريخ ليس 30/12/1899
        if (date === "30/12/1899") {
            console.warn("Date 30/12/1899 still found after filtering!");
            return false;
        }
        
        // تحقق من أن السنة ليست 1899 أو 1900
        const year = date.split('/')[2];
        if (year === "1899" || year === "1900") {
            console.warn(`Invalid year found: ${date}`);
            return false;
        }
        
        return true;
    });
    
    // إضافة التواريخ الصالحة فقط
    finalFilteredDates.forEach(date => {
        // تحقق إضافي قبل العرض
        if (!isValidProductDate(date)) {
            console.error(`Invalid date skipped: ${date}`);
            return; // تخطي هذا التاريخ
        }
        
        const option = document.createElement('div');
        option.className = 'date-option';
        
        // التحقق من صلاحية التاريخ
        const today = new Date();
        const inputDate = parseDate(date);
        
        if (!inputDate) {
            console.error(`Cannot parse date: ${date}`);
            return; // تخطي إذا كان التاريخ غير قابل للتحليل
        }
        
        const diffTime = inputDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        let optionStyle = '';
        
        if (diffDays <= 0) {
            // منتهي الصلاحية - أحمر
            optionStyle = 'background: #e74c3c; color: white; border-color: #c0392b;';
            option.innerHTML = `<strong>${date} - EXPIRÉE</strong>`;
            option.title = `DLC EXPIRÉE (${date})`;
        } else if (diffDays <= 30) {
            // شهر واحد أو أقل - برتقالي
            optionStyle = 'background: #f39c12; color: black; border-color: #e67e22;';
            option.innerHTML = `<strong>${date} - ${diffDays} JOURS</strong>`;
            option.title = `DLC PROCHAIN (${diffDays} JOURS)`;
        } else {
            // ساري المفعول - أخضر
            optionStyle = 'background: #27ae60; color: white; border-color: #219653;';
            option.innerHTML = `<strong>${date} - ${diffDays} JOURS</strong>`;
            option.title = `DLC VALIDE (${diffDays} JOURS)`;
        }
        
        option.style.cssText += optionStyle;
        option.onclick = function() {
            selectDateForAjouter(date);
        };
        container.appendChild(option);
    });
    
    // إذا لم توجد تواريخ صالحة بعد التصفية
    if (finalFilteredDates.length === 0) {
        const noDatesMessage = document.createElement('div');
        noDatesMessage.className = 'date-option';
        noDatesMessage.style.background = '#f8f9fa';
        noDatesMessage.style.color = '#6c757d';
        noDatesMessage.style.textAlign = 'center';
        noDatesMessage.textContent = 'AUCUNE DATE VALIDE DISPONIBLE';
        container.appendChild(noDatesMessage);
    }
    
    document.getElementById('dateOptionsModalAjouter').style.display = 'flex';
}
// أضف هذه الدالة بعد isValidProductDate
function filterInvalidDates(datesArray) {
    if (!Array.isArray(datesArray)) return [];
    
    return datesArray.filter(date => {
        // تجاهل التواريخ الفارغة
        if (!date || date.trim() === '') return false;
        
        // تجاهل التواريخ المعروفة غير الصالحة
        const invalidPatterns = [
            /1899/, /1900/, /0000/, /00\/01/, /30\/12\/1899/
        ];
        
        for (const pattern of invalidPatterns) {
            if (pattern.test(date)) {
                return false;
            }
        }
        
        // تحقق من التنسيق الأساسي
        const datePattern = /^\d{2}\/\d{2}\/\d{4}$/;
        if (!datePattern.test(date)) {
            return false;
        }
        
        // تحقق من السنة
        const year = date.split('/')[2];
        const yearNum = parseInt(year, 10);
        
        if (yearNum < 2020 || yearNum > 2030) {
            return false;
        }
        
        return true;
    });
}

// دالة لاختيار التاريخ
function selectDateForAjouter(date) {
    if (currentAjouterDlcNumber) {
        const dlcField = document.getElementById(`ajouterDlc${currentAjouterDlcNumber}Input`);
        if (dlcField) {
            if (date === '') {
                // إذا اختار "NOUVELLE DATE"، اترك الحقل فارغاً للكتابة
                dlcField.value = '';
                dlcField.focus();
            } else {
                // تعبئة الحقل بالتاريخ المحدد
                dlcField.value = date;
                
                // إبراز الحقل
                dlcField.style.backgroundColor = "#d6f0ff";
                dlcField.style.borderColor = "#3498db";
                setTimeout(() => {
                    dlcField.style.backgroundColor = "";
                    dlcField.style.borderColor = "";
                }, 1500);
                
                // إذا كان حقل الكمية المقابل فارغاً، انتقل إليه تلقائياً
                const qteField = document.getElementById(`ajouterQte${currentAjouterDlcNumber}Input`);
                if (qteField && !qteField.value.trim()) {
                    setTimeout(() => {
                        qteField.focus();
                    }, 100);
                }
            }
        }
    }
    
    closeDateOptionsModalAjouter();
}

// دالة لإغلاق نافذة التواريخ
function closeDateOptionsModalAjouter() {
    document.getElementById('dateOptionsModalAjouter').style.display = 'none';
    currentAjouterDlcNumber = null;
    document.getElementById('dateOptionsContainerAjouter').innerHTML = '';
}

// دالة للحصول على التواريخ للمنتج في عنوان محدد
function getDatesForProductAtAddress(code, adresse) {
    const dates = new Set();
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            // جمع التواريخ من الأعمدة 3, 5, 7
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                
                // استخدم الدالة الجديدة للتحقق - هذا هو المكان الحرج
                if (isValidProductDate(dateStr)) {
                    dates.add(dateStr);
                }
            }
        }
    }
    
    // فرز التواريخ
    return Array.from(dates).sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
}
// ============================================
// وظائف نافذة خيارات التواريخ للنافذة السريعة AJOUTER
// ============================================

let currentQuickAjouterDlcNumber = null; // لتخزين رقم حقل DLC الحالي

// دالة لفتح نافذة اختيار التواريخ للنافذة السريعة
function showDateOptionsForQuickAjouter(dlcNumber) {
    currentQuickAjouterDlcNumber = dlcNumber;
    
    if (!currentQuickProduct || !currentQuickProduct.code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    const adresseInput = document.getElementById('quickAjouterAdresseInput');
    const adresse = adresseInput ? adresseInput.value.trim() : '';
    
    let adresseFinale = adresse;
    if (adresse && adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    let dates = [];
    
    if (adresseFinale) {
        // إذا كان هناك عنوان، جلب التواريخ من ذلك العنوان المحدد
        dates = getDatesForProductAtAddress(currentQuickProduct.code, adresseFinale);
    }
    
    // إذا لم توجد تواريخ للعنوان المحدد، جلب جميع تواريخ المنتج
    if (dates.length === 0) {
        dates = getAllDatesForProduct(currentQuickProduct.code);
    }
    
    // إضافة خيار "NOUVELLE DATE" إذا لم توجد تواريخ
    if (dates.length === 0) {
        dates = ["NOUVELLE DATE"];
    }
    
    displayDateOptionsForQuickAjouter(dates, dlcNumber);
}

// دالة لعرض خيارات التواريخ للنافذة السريعة
function displayDateOptionsForQuickAjouter(dates, dlcNumber) {
    const container = document.getElementById('dateOptionsContainerQuickAjouter');
    container.innerHTML = '';
    
    let titleText = `CHOISISSEZ UNE DATE POUR DLC ${dlcNumber}`;
    if (currentQuickProduct && currentQuickProduct.code) {
        titleText += ` (${currentQuickProduct.code})`;
    }
    if (currentQuickProduct && currentQuickProduct.adresse) {
        titleText += ` - ${currentQuickProduct.adresse}`;
    }
    
    document.getElementById('dateSelectMessageQuickAjouter').textContent = titleText;
    
    // إضافة خيار "NOUVELLE DATE" في البداية
    const newDateOption = document.createElement('div');
    newDateOption.className = 'date-option';
    newDateOption.style.background = '#3498db';
    newDateOption.style.color = 'white';
    newDateOption.style.borderColor = '#3498db';
    newDateOption.innerHTML = '<strong>NOUVELLE DATE</strong>';
    newDateOption.onclick = function() {
        selectDateForQuickAjouter('');
    };
    container.appendChild(newDateOption);
    
    // إضافة التواريخ الموجودة
    dates.forEach(date => {
        if (date !== "NOUVELLE DATE") {
            const option = document.createElement('div');
            option.className = 'date-option';
            option.textContent = date;
            option.onclick = function() {
                selectDateForQuickAjouter(date);
            };
            container.appendChild(option);
        }
    });
    
    document.getElementById('dateOptionsModalQuickAjouter').style.display = 'flex';
}

// دالة لاختيار التاريخ للنافذة السريعة
function selectDateForQuickAjouter(date) {
    if (currentQuickAjouterDlcNumber) {
        const dlcField = document.getElementById(`quickAjouterDlc${currentQuickAjouterDlcNumber}Input`);
        if (dlcField) {
            if (date === '') {
                // إذا اختار "NOUVELLE DATE"، اترك الحقل فارغاً للكتابة
                dlcField.value = '';
                dlcField.focus();
            } else {
                // تعبئة الحقل بالتاريخ المحدد
                dlcField.value = date;
                
                // إبراز الحقل
                dlcField.style.backgroundColor = "#d6f0ff";
                dlcField.style.borderColor = "#3498db";
                setTimeout(() => {
                    dlcField.style.backgroundColor = "";
                    dlcField.style.borderColor = "";
                }, 1500);
                
                // إذا كان حقل الكمية المقابل فارغاً، انتقل إليه تلقائياً
                const qteField = document.getElementById(`quickAjouterQte${currentQuickAjouterDlcNumber}Input`);
                if (qteField && !qteField.value.trim()) {
                    setTimeout(() => {
                        qteField.focus();
                    }, 100);
                }
            }
        }
    }
    
    closeDateOptionsModalQuickAjouter();
}

// دالة لإغلاق نافذة التواريخ للنافذة السريعة
function closeDateOptionsModalQuickAjouter() {
    document.getElementById('dateOptionsModalQuickAjouter').style.display = 'none';
    currentQuickAjouterDlcNumber = null;
    document.getElementById('dateOptionsContainerQuickAjouter').innerHTML = '';
}
// ============================================
// تحقق أثناء الكتابة في حقول العنوان
// ============================================

function setupAddressValidation() {
    const quickAddressInput = document.getElementById('quickAjouterAdresseInput');
    const mainAddressInput = document.getElementById('ajouterAdresseInput');
    
    // للعنوان السريع
    if (quickAddressInput) {
        quickAddressInput.addEventListener('input', function() {
            validateAddressInput(this);
        });
    }
    
    // للعنوان الرئيسي
    if (mainAddressInput) {
        mainAddressInput.addEventListener('input', function() {
            validateAddressInput(this);
        });
    }
}

function validateAddressInput(inputElement) {
    const address = inputElement.value.trim();
    
    if (address && !validateAddressFormat(address)) {
        inputElement.style.borderColor = '#e74c3c';
        inputElement.style.backgroundColor = '#ffe6e6';
    } else {
        inputElement.style.borderColor = '';
        inputElement.style.backgroundColor = '';
    }
}

// تحديث window.onload لإضافة هذا التحقق// تحديث window.onload لإضافة هذا التحقق
window.addEventListener('load', function() {
    // ... الكود الحالي ...
    setupAddressValidation(); // أضف هذه السطر
    // التحقق من التواريخ في جميع الحقول عند التحميل
    setupDateValidationForAjouter();
    setupDateValidationForRetirer();
    setupDateValidationForQuickAjouter();
    setupDateValidationForQuickRetirer();
});
// ============================================
// تحقق من الكمية في صفحة AJOUTER
// ============================================

function validateAjouterTotal() {
    const code = document.getElementById('ajouterCodeInput').value.trim();
    const adresse = document.getElementById('ajouterAdresseInput').value.trim();
    
    const qte1Input = document.getElementById('ajouterQte1Input');
    const qte2Input = document.getElementById('ajouterQte2Input');
    const qte3Input = document.getElementById('ajouterQte3Input');
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    // حساب إجمالي الكمية المدخلة
    const totalInputQte = 
        (qte1 ? parseInt(qte1) : 0) + 
        (qte2 ? parseInt(qte2) : 0) + 
        (qte3 ? parseInt(qte3) : 0);
    
    if (!code) {
        // إعادة تعيين أنماط الحقول
        const inputs = [qte1Input, qte2Input, qte3Input];
        inputs.forEach(input => {
            if (input) {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        });
        
        // إزالة الدائرة الحمراء من حقل العنوان
        const addressInput = document.getElementById('ajouterAdresseInput');
        if (addressInput) {
            addressInput.style.backgroundImage = '';
            addressInput.style.backgroundRepeat = 'no-repeat';
            addressInput.style.backgroundPosition = 'right 10px center';
            addressInput.style.backgroundSize = '20px 20px';
            addressInput.style.paddingRight = '10px';
        }
        
        // إزالة رسالة التحقق
        const validationMessage = document.getElementById('ajouterQteValidationMessage');
        if (validationMessage) {
            validationMessage.remove();
        }
        
        return;
    }
    
    // الحصول على QTE STOCK و QTE RESERVE
    const qteStock = parseInt(getQteGoldByCode(code).replace(/[^0-9.-]+/g, "")) || 0;
    const qteReserve = parseInt(getQteReserveByCode(code).replace(/[^0-9.-]+/g, "")) || 0;
    
    // حساب الكمية الإجمالية بعد الإضافة
    const totalAfterAdd = qteReserve + totalInputQte;
    
    // التحقق: إذا كان مجموع الكميات المدخلة + QTE RESERVE يساوي QTE STOCK
    const isExactMatch = (totalAfterAdd === qteStock);
    
    // التحقق: إذا تجاوزت الكمية المدخلة QTE STOCK
    const isOverStock = (totalAfterAdd > qteStock);
    
    // إضافة الدائرة الحمراء على حقل العنوان إذا كان هناك تطابق تام
    const addressInput = document.getElementById('ajouterAdresseInput');
    if (addressInput) {
        if (isExactMatch && totalInputQte > 0) {
            // إضافة دائرة حمراء
            addressInput.style.backgroundImage = 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 20 20\'%3E%3Ccircle cx=\'10\' cy=\'10\' r=\'9\' fill=\'%23e74c3c\'/%3E%3C/svg%3E")';
            addressInput.style.backgroundRepeat = 'no-repeat';
            addressInput.style.backgroundPosition = 'right 10px center';
            addressInput.style.backgroundSize = '20px 20px';
            addressInput.style.paddingRight = '40px';
        } else {
            addressInput.style.backgroundImage = '';
            addressInput.style.backgroundRepeat = 'no-repeat';
            addressInput.style.backgroundPosition = 'right 10px center';
            addressInput.style.backgroundSize = '20px 20px';
            addressInput.style.paddingRight = '10px';
        }
    }
    
    // تغيير لون حقول الكمية
    const inputs = [qte1Input, qte2Input, qte3Input];
    inputs.forEach(input => {
        if (input) {
            if (isExactMatch && totalInputQte > 0) {
                input.style.borderColor = '#e74c3c';
                input.style.backgroundColor = '#ffe6e6';
            } else if (isOverStock) {
                input.style.borderColor = '#f39c12';
                input.style.backgroundColor = '#fff3cd';
            } else if (totalInputQte > 0) {
                input.style.borderColor = '#27ae60';
                input.style.backgroundColor = '#e8f8ef';
            } else {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        }
    });
    
    // تحديث رسالة التحقق
    const existingMessage = document.getElementById('ajouterQteValidationMessage');
    
    // إنشاء أو تحديث الرسالة
    if (totalInputQte > 0 || isExactMatch || isOverStock) {
        let messageHTML = '';
        let messageColor = '';
        let messageBg = '';
        let messageBorder = '';
        
        if (isExactMatch) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #e74c3c;"></div>
                    <div>
                        <strong>ATTENTION:</strong> RÉSERVE SATURÉE<br>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL: ${totalAfterAdd} = QTE STOCK
                    </div>
                </div>
            `;
            messageColor = '#e74c3c';
            messageBg = '#fdedec';
            messageBorder = '#e74c3c';
        } else if (isOverStock) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #f39c12;"></div>
                    <div>
                        <strong>ATTENTION:</strong> DÉPASSEMENT STOCK<br>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL: ${totalAfterAdd} > QTE STOCK (${qteStock})
                    </div>
                </div>
            `;
            messageColor = '#f39c12';
            messageBg = '#fff3cd';
            messageBorder = '#f39c12';
        } else if (totalInputQte > 0) {
            messageHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border-radius: 50%; background-color: #27ae60;"></div>
                    <div>
                        QTE STOCK: ${qteStock} | QTE RESERVE: ${qteReserve} | AJOUT: ${totalInputQte}<br>
                        TOTAL APRÈS AJOUT: ${totalAfterAdd}
                    </div>
                </div>
            `;
            messageColor = '#27ae60';
            messageBg = '#e8f8ef';
            messageBorder = '#27ae60';
        }
        
        if (existingMessage) {
            existingMessage.innerHTML = messageHTML;
            existingMessage.style.color = messageColor;
            existingMessage.style.background = messageBg;
            existingMessage.style.borderColor = messageBorder;
        } else {
            const message = document.createElement('div');
            message.id = 'ajouterQteValidationMessage';
            message.className = 'ajouter-qte-validation';
            message.style.cssText = `
                text-align: center;
                font-weight: bold;
                margin: 10px 0;
                padding: 12px;
                border-radius: 8px;
                transition: all 0.3s;
                font-size: 14px;
                border: 2px solid;
            `;
            message.innerHTML = messageHTML;
            message.style.color = messageColor;
            message.style.background = messageBg;
            message.style.borderColor = messageBorder;
            
            // إدراج الرسالة قبل زر AJOUTER
            const inputsContainer = document.querySelector('.ajouter-card');
            if (inputsContainer) {
                const addButton = inputsContainer.querySelector('.ajouter-btn[onclick="ajouterProduitAjouter()"]');
                if (addButton) {
                    inputsContainer.insertBefore(message, addButton);
                }
            }
        }
    } else if (existingMessage) {
        existingMessage.remove();
    }
}
// دالة منفصلة للمتابعة بعد التحقق
function proceedWithAjouter(code, adresseFinale, produitNom, qte1, dlc1, qte2, dlc2, qte3, dlc3) {
    const existingIndex = ajouterProduits.findIndex(p => p.adresse === adresseFinale && p.code === code);
    
    if (existingIndex >= 0) {
        showAlert('CE PRODUIT AVEC LE MÊME CODE ET ADRESSE EXISTE DÉJÀ!', 'warning');
        return;
    }
    
    ajouterProduits.push({
        code: code,
        adresse: adresseFinale,
        nom: produitNom,
        qte1: qte1 ? parseInt(qte1) : 0,
        dlc1: dlc1,
        qte2: qte2 ? parseInt(qte2) : 0,
        dlc2: dlc2,
        qte3: qte3 ? parseInt(qte3) : 0,
        dlc3: dlc3
    });
    showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    
    saveAjouterProduits();
    updateAjouterDisplay();
    
    // مسح الحقول
    const inputs = [
        'ajouterCodeInput', 'ajouterAdresseInput',
        'ajouterQte1Input', 'ajouterDlc1Input',
        'ajouterQte2Input', 'ajouterDlc2Input',
        'ajouterQte3Input', 'ajouterDlc3Input'
    ];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) input.value = '';
    });
    
    // إزالة الدائرة الحمراء
    const addressInput = document.getElementById('ajouterAdresseInput');
    if (addressInput) {
        addressInput.style.backgroundImage = '';
        addressInput.style.paddingRight = '10px';
    }
    
    document.getElementById('ajouterProductInfo').innerHTML = '';
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    
    // إزالة رسالة التحقق
    const validationMessage = document.getElementById('ajouterQteValidationMessage');
    if (validationMessage) {
        validationMessage.remove();
    }
    
    document.getElementById('ajouterCodeInput').focus();
}

// ============================================
// تحقق من صحة التاريخ وتلوين الحقول
// ============================================

function validateAndColorDateInput(dateInputElement) {
    const dateStr = dateInputElement.value.trim();
    
    if (!dateStr || !isValidDateYYYY(dateStr)) {
        dateInputElement.style.color = '';
        dateInputElement.style.backgroundColor = '';
        dateInputElement.style.borderColor = '';
        dateInputElement.style.fontWeight = '';
        return;
    }
    
    const today = new Date();
    const inputDate = parseDate(dateStr);
    
    if (!inputDate) {
        dateInputElement.style.color = '';
        dateInputElement.style.backgroundColor = '';
        dateInputElement.style.borderColor = '';
        dateInputElement.style.fontWeight = '';
        return;
    }
    
    // حساب الفرق بالأيام
    const diffTime = inputDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    // إذا كان التاريخ منتهي الصلاحية
    if (diffDays <= 0) {
        dateInputElement.style.color = '#ffffff';
        dateInputElement.style.backgroundColor = '#e74c3c';
        dateInputElement.style.borderColor = '#c0392b';
        dateInputElement.style.fontWeight = 'bold';
        dateInputElement.title = `DLC EXPIRÉE (${dateStr})`;
    }
    // إذا كان التاريخ فيه شهر واحد أو أقل للانتهاء
    else if (diffDays <= 30) {
        dateInputElement.style.color = '#000000';
        dateInputElement.style.backgroundColor = '#f8d7da';
        dateInputElement.style.borderColor = '#f5c6cb';
        dateInputElement.style.fontWeight = 'bold';
        dateInputElement.title = `DLC PROCHAIN (${diffDays} JOURS)`;
    }
    // إذا كان التاريخ ساري المفعول لأكثر من شهر
    else {
        dateInputElement.style.color = '';
        dateInputElement.style.backgroundColor = '';
        dateInputElement.style.borderColor = '';
        dateInputElement.style.fontWeight = '';
        dateInputElement.title = `DLC VALIDE (${diffDays} JOURS)`;
    }
}

// دالة لتفعيل التحقق التلقائي لحقول التاريخ
function setupDateValidationForAjouter() {
    const dateInputs = [
        'ajouterDlc1Input',
        'ajouterDlc2Input',
        'ajouterDlc3Input'
    ];
    
    dateInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            // التحقق عند تغيير القيمة
            input.addEventListener('input', function() {
                validateAndColorDateInput(this);
            });
            
            // التحقق عند فقدان التركيز
            input.addEventListener('blur', function() {
                validateAndColorDateInput(this);
            });
            
            // التحقق عند التحميل (إذا كان هناك قيمة مسبقة)
            if (input.value.trim()) {
                validateAndColorDateInput(input);
            }
        }
    });
}

// دالة لتفعيل التحقق التلقائي لحقول التاريخ في النافذة السريعة
function setupDateValidationForQuickAjouter() {
    const dateInputs = [
        'quickAjouterDlc1Input',
        'quickAjouterDlc2Input',
        'quickAjouterDlc3Input'
    ];
    
    dateInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            // إزالة أي مستمعات سابقة
            input.removeEventListener('input', validateAndColorDateInput);
            input.removeEventListener('blur', validateAndColorDateInput);
            
            // إضافة مستمعات جديدة
            input.addEventListener('input', function() {
                validateAndColorDateInput(this);
            });
            
            input.addEventListener('blur', function() {
                validateAndColorDateInput(this);
            });
            
            // تطبيق التحقق على القيمة الحالية
            if (input.value.trim()) {
                validateAndColorDateInput(input);
            }
        }
    });
}

// دالة لتفعيل التحقق التلقائي لحقول التاريخ في RETIRER
function setupDateValidationForRetirer() {
    const dateInputs = [
        'retirerDlc1Input',
        'retirerDlc2Input',
        'retirerDlc3Input'
    ];
    
    dateInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                validateAndColorDateInput(this);
            });
            
            input.addEventListener('blur', function() {
                validateAndColorDateInput(this);
            });
        }
    });
}

// دالة لتفعيل التحقق التلقائي لحقول التاريخ في النافذة السريعة RETIRER
function setupDateValidationForQuickRetirer() {
    const dateInputs = [
        'quickRetirerDlc1Input',
        'quickRetirerDlc2Input',
        'quickRetirerDlc3Input'
    ];
    
    dateInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                validateAndColorDateInput(this);
            });
            
            input.addEventListener('blur', function() {
                validateAndColorDateInput(this);
            });
        }
    });
}

// إعداد مستمعات الأحداث لحقول الكمية في AJOUTER
function setupAjouterValidation() {
    const qteInputs = [
        'ajouterQte1Input',
        'ajouterQte2Input',
        'ajouterQte3Input'
    ];
    
    qteInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            // إضافة التحقق من التعبيرات الرياضية
            input.addEventListener('input', function() {
                delayedEvaluateExpression(this);
                validateAjouterTotal();
            });
            
            // إضافة تنسيق للكميات السالبة
            input.addEventListener('change', function() {
                const value = parseInt(this.value);
                if (value < 0) {
                    this.value = Math.abs(value);
                }
            });
        }
    });
    
    // تحديث عند تغيير العنوان أو الكود
    const addressInput = document.getElementById('ajouterAdresseInput');
    const codeInput = document.getElementById('ajouterCodeInput');
    
    if (addressInput) {
        addressInput.addEventListener('input', function() {
            validateAjouterTotal();
        });
    }
    
    if (codeInput) {
        codeInput.addEventListener('input', function() {
            validateAjouterTotal();
        });
    }
}
function setupQuickAjouterValidation() {
    const qteInputs = [
        'quickAjouterQte1Input',
        'quickAjouterQte2Input',
        'quickAjouterQte3Input'
    ];
    
    qteInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                validateQuickAjouterTotal();
            });
        }
    });
    
    const addressInput = document.getElementById('quickAjouterAdresseInput');
    if (addressInput) {
        addressInput.addEventListener('input', function() {
            validateQuickAjouterTotal();
        });
    }
}

// أضف هذا السطر في نهاية window.onload
window.addEventListener('load', function() {
    // ... الكود الحالي ...
    setupQuickAjouterValidation();
});
document.getElementById('retirerAdresseInput').addEventListener('blur', function() {
    autoFillQuantitiesForRetirer();
});

function autoFillQuantitiesForRetirer() {
    const code = document.getElementById('retirerCodeInput').value.trim();
    const adresse = document.getElementById('retirerAdresseInput').value.trim();
    
    if (!code || !adresse) {
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const quantities = getQuantitiesForProductAtAddress(code, adresseFinale);
    
    // ملء حقول الكمية
    if (quantities.qte1 > 0) {
        document.getElementById('retirerQte1Input').value = quantities.qte1;
        document.getElementById('retirerQte1Input').placeholder = `${quantities.qte1}`;
    }
    
    if (quantities.qte2 > 0) {
        document.getElementById('retirerQte2Input').value = quantities.qte2;
        document.getElementById('retirerQte2Input').placeholder = `${quantities.qte2}`;
    }
    
    if (quantities.qte3 > 0) {
        document.getElementById('retirerQte3Input').value = quantities.qte3;
        document.getElementById('retirerQte3Input').placeholder = `${quantities.qte3}`;
    }
    
    // ملء حقول التواريخ
    if (quantities.dlc1) {
        document.getElementById('retirerDlc1Input').value = quantities.dlc1;
        document.getElementById('retirerDlc1Input').placeholder = `${quantities.dlc1}`;
    }
    
    if (quantities.dlc2) {
        document.getElementById('retirerDlc2Input').value = quantities.dlc2;
        document.getElementById('retirerDlc2Input').placeholder = `${quantities.dlc2}`;
    }
    
    if (quantities.dlc3) {
        document.getElementById('retirerDlc3Input').value = quantities.dlc3;
        document.getElementById('retirerDlc3Input').placeholder = `${quantities.dlc3}`;
    }
    
    // تحديث رسالة الكمية المتوفرة
    const availableQte = quantities.qte1 + quantities.qte2 + quantities.qte3;
    const quantityInfo = document.getElementById('retirerAvailableQuantityInfo');
    if (quantityInfo) {
        if (availableQte > 0) {
            quantityInfo.innerHTML = `<span>QUANTITÉS CHARGÉES: ${availableQte} unités disponibles</span>`;
            quantityInfo.style.color = '#27ae60';
            quantityInfo.style.background = '#e8f8ef';
            quantityInfo.style.borderColor = '#27ae60';
        } else {
            quantityInfo.innerHTML = `<span>AUCUNE QUANTITÉ DISPONIBLE DANS CETTE ADRESSE</span>`;
            quantityInfo.style.color = '#e74c3c';
            quantityInfo.style.background = '#fdedec';
            quantityInfo.style.borderColor = '#e74c3c';
        }
    }
    
    // تحديث التحقق من الكمية
    validateRetirerMainTotal();
}
// تهيئة التطبيق عند تحميل الصفحة
// ============================================
window.onload = function() {
    initApp();
};

// تحديث حقول الكمية في صفحة RETIRER الرئيسية
// ============================================

// دالة showProductInfoForRetirer مع رسالة أولية
function showProductInfoForRetirer(code) {
    const container = document.getElementById('retirerProductInfo');
    container.innerHTML = '';
    
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE STOCK", value: qteGold});
        } else {
            infos.push({label: "QTE STOCK", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        // رسالة أولية
        const quantityRow = document.createElement('div');
        quantityRow.id = 'retirerAvailableQuantityInfo';
        quantityRow.className = 'dataRow';
        quantityRow.style.cssText = `
            background: #f8f9fa !important;
            color: #3498db !important;
            font-size: 14px !important;
            text-align: center !important;
            font-weight: bold !important;
            border: 1px solid #3498db !important;
        `;
        quantityRow.innerHTML = `<span>ENTREZ UNE ADRESSE POUR CHARGER LES QUANTITÉS</span>`;
        card.appendChild(quantityRow);
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

// دالة لفحص إجمالي الكمية في صفحة RETIRER الرئيسية
function validateRetirerMainTotal() {
    const code = document.getElementById('retirerCodeInput').value.trim();
    const adresse = document.getElementById('retirerAdresseInput').value.trim();
    
    const qte1Input = document.getElementById('retirerQte1Input');
    const qte2Input = document.getElementById('retirerQte2Input');
    const qte3Input = document.getElementById('retirerQte3Input');
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    // حساب إجمالي الكمية المدخلة
    const totalInputQte = 
        (qte1 ? parseInt(qte1) : 0) + 
        (qte2 ? parseInt(qte2) : 0) + 
        (qte3 ? parseInt(qte3) : 0);
    
    if (!code || !adresse) {
        // إذا لم يكن هناك عنوان أو كود
        const quantityInfo = document.getElementById('retirerAvailableQuantityInfo');
        if (quantityInfo) {
            quantityInfo.innerHTML = `<span>ENTREZ UNE ADRESSE POUR VOIR LA QUANTITÉ DISPONIBLE</span>`;
            quantityInfo.style.color = '#3498db';
            quantityInfo.style.background = '#f8f9fa';
            quantityInfo.style.borderColor = '#3498db';
        }
        
        // إعادة تعيين أنماط الحقول
        const inputs = [qte1Input, qte2Input, qte3Input];
        inputs.forEach(input => {
            if (input) {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        });
        
        // إزالة رسالة التحقق
        const validationMessage = document.getElementById('retirerQteValidationMessage');
        if (validationMessage) {
            validationMessage.remove();
        }
        
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    // الحصول على الكمية المتوفرة
    const availableQte = getAvailableQuantityForProductAtAddress(code, adresseFinale);
    
    // تحديث رسالة الكمية المتوفرة في card المعلومات
    const quantityInfo = document.getElementById('retirerAvailableQuantityInfo');
    if (quantityInfo) {
        if (availableQte > 0) {
            quantityInfo.innerHTML = `<span>QUANTITÉ DISPONIBLE: <strong style="color:#27ae60;font-size:16px;">${availableQte}</strong> unités</span>`;
            quantityInfo.style.color = '#27ae60';
            quantityInfo.style.background = '#e8f8ef';
            quantityInfo.style.borderColor = '#27ae60';
        } else {
            quantityInfo.innerHTML = `<span>QUANTITÉ DISPONIBLE: <strong style="color:#e74c3c;font-size:16px;">${availableQte}</strong> unités (VIDE)</span>`;
            quantityInfo.style.color = '#e74c3c';
            quantityInfo.style.background = '#fdedec';
            quantityInfo.style.borderColor = '#e74c3c';
        }
    }
    
    // تغيير لون الحقول إذا تجاوزت الكمية
    const inputs = [qte1Input, qte2Input, qte3Input];
    inputs.forEach(input => {
        if (input) {
            if (totalInputQte > availableQte) {
                input.style.borderColor = '#e74c3c';
                input.style.backgroundColor = '#ffe6e6';
            } else if (totalInputQte > 0 && totalInputQte <= availableQte) {
                input.style.borderColor = '#27ae60';
                input.style.backgroundColor = '#e8f8ef';
            } else {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }
        }
    });
    
    // تحديث رسالة التحقق إذا كانت موجودة
    const existingMessage = document.getElementById('retirerQteValidationMessage');
    if (existingMessage) {
        if (totalInputQte > 0) {
            existingMessage.innerHTML = `QUANTITÉ DISPONIBLE: ${availableQte} | DEMANDÉE: ${totalInputQte}`;
            existingMessage.style.color = totalInputQte > availableQte ? '#e74c3c' : '#27ae60';
            existingMessage.style.background = totalInputQte > availableQte ? '#fdedec' : '#e8f8ef';
            existingMessage.style.borderColor = totalInputQte > availableQte ? '#e74c3c' : '#27ae60';
        } else {
            existingMessage.remove();
        }
    } else if (totalInputQte > 0) {
        // إنشاء رسالة جديدة إذا لم تكن موجودة
        const message = document.createElement('div');
        message.id = 'retirerQteValidationMessage';
        message.className = 'retirer-qte-validation';
        message.style.cssText = `
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s;
        `;
        message.innerHTML = `QUANTITÉ DISPONIBLE: ${availableQte} | DEMANDÉE: ${totalInputQte}`;
        
        if (totalInputQte > availableQte) {
            message.style.color = '#e74c3c';
            message.style.background = '#fdedec';
            message.style.borderColor = '#e74c3c';
        } else {
            message.style.color = '#27ae60';
            message.style.background = '#e8f8ef';
            message.style.borderColor = '#27ae60';
        }
        
        // إدراج الرسالة بعد حقول الكمية
        const inputsContainer = document.querySelector('.retirer-card');
        if (inputsContainer) {
            const addButton = inputsContainer.querySelector('.retirer-btn[onclick="ajouterProduitRetirer()"]');
            if (addButton) {
                inputsContainer.insertBefore(message, addButton);
            }
        }
    }
}

// تحديث دالة ajouterProduitRetirer للتحقق من الكمية
function ajouterProduitRetirer() {
    const codeInput = document.getElementById('retirerCodeInput');
    const adresseInput = document.getElementById('retirerAdresseInput');
    const qte1Input = document.getElementById('retirerQte1Input');
    const dlc1Input = document.getElementById('retirerDlc1Input');
    const qte2Input = document.getElementById('retirerQte2Input');
    const dlc2Input = document.getElementById('retirerDlc2Input');
    const qte3Input = document.getElementById('retirerQte3Input');
    const dlc3Input = document.getElementById('retirerDlc3Input');
    
    const code = codeInput.value.trim();
    const adresse = adresseInput.value.trim();
    
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        adresseInput.focus();
        return;
    }
    
    if (!code) {
        showAlert('VEUILLEZ ENTRER LE CODE DU PRODUIT', 'warning');
        codeInput.focus();
        return;
    }
    
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    const qte1 = qte1Input.value.trim();
    const dlc1 = dlc1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    // حساب إجمالي الكمية المدخلة
    const totalInputQte = 
        (qte1 ? parseInt(qte1) : 0) + 
        (qte2 ? parseInt(qte2) : 0) + 
        (qte3 ? parseInt(qte3) : 0);
    
    // الحصول على الكمية المتوفرة
    const availableQte = getAvailableQuantityForProductAtAddress(code, adresseFinale);
    
    // التحقق من أن الكمية المدخلة لا تتجاوز الكمية المتوفرة
    if (totalInputQte > availableQte) {
        showAlert(`QUANTITÉ INSUFFISANTE! DISPONIBLE: ${availableQte}, DEMANDÉE: ${totalInputQte}`, 'warning');
        return;
    }
    
    // التحقق من أن الكمية المدخلة أكبر من 0
    if (totalInputQte <= 0) {
        showAlert('LA QUANTITÉ DOIT ÊTRE SUPÉRIEURE À 0', 'warning');
        return;
    }
    
    const nomProduit = getProductNameByCode(code);
    if (!nomProduit) {
        showAlert('PRODUIT NON TROUVÉ DANS LA BASE DE DONNÉES', 'warning');
        return;
    }
    
    const existingIndex = retirerProduits.findIndex(p => p.code === code && p.adresse === adresseFinale);
    
    if (existingIndex >= 0) {
        // تحديث المنتج الموجود
        retirerProduits[existingIndex] = {
            code: code,
            adresse: adresseFinale,
            nom: nomProduit,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3,
            totalQte: totalInputQte,
            availableQte: availableQte
        };
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        // إضافة منتج جديد
        retirerProduits.push({
            code: code,
            adresse: adresseFinale,
            nom: nomProduit,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3,
            totalQte: totalInputQte,
            availableQte: availableQte
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    saveRetirerProduits();
    updateRetirerDisplay();
    
    // مسح الحقول
    codeInput.value = '';
    adresseInput.value = '';
    qte1Input.value = '';
    dlc1Input.value = '';
    qte2Input.value = '';
    dlc2Input.value = '';
    qte3Input.value = '';
    dlc3Input.value = '';
    
    // إزالة رسالة التحقق
    const validationMessage = document.getElementById('retirerQteValidationMessage');
    if (validationMessage) {
        validationMessage.remove();
    }
    
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    
    codeInput.focus();
}

// إعداد مستمعات الأحداث لحقول الكمية
function setupRetirerMainValidation() {
    const qteInputs = [
        'retirerQte1Input',
        'retirerQte2Input',
        'retirerQte3Input'
    ];
    
    qteInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            // إضافة التحقق من التعبيرات الرياضية
            input.addEventListener('input', function() {
                delayedEvaluateExpression(this);
                validateRetirerMainTotal();
            });
            
            // إضافة تنسيق للكميات السالبة
            input.addEventListener('change', function() {
                const value = parseInt(this.value);
                if (value < 0) {
                    this.value = Math.abs(value);
                }
            });
        }
    });
    
    // تحديث عند تغيير العنوان أو الكود
    const addressInput = document.getElementById('retirerAdresseInput');
    const codeInput = document.getElementById('retirerCodeInput');
    
    if (addressInput) {
        addressInput.addEventListener('input', function() {
            validateRetirerMainTotal();
        });
    }
    
    if (codeInput) {
        codeInput.addEventListener('input', function() {
            validateRetirerMainTotal();
        });
    }
}

// ============================================
// تحديث دالة openRetirer لإضافة الإعدادات
// ============================================
function openRetirer(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("retirerPage").style.display = "block";
    
    updateRetirerDisplay();
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    
    // إعداد التحقق من الكمية
    setupRetirerMainValidation();
    // إعداد التحقق من صحة التاريخ وتلوين الحقول
    setupDateValidationForRetirer();
}

// ============================================
// تحديث دالة goBackFromRetirer للحفاظ على الكروت
// ============================================
function goBackFromRetirer(){ 
    document.getElementById("retirerPage").style.display = "none"; 
    document.getElementById("mainPage").style.display = "block";
    
    // مسح جميع الحقول فقط (لا تمسح الكروت)
    document.getElementById('retirerCodeInput').value = '';
    document.getElementById('retirerAdresseInput').value = '';
    
    // مسح الحقول الجديدة فقط
    document.getElementById('retirerQte1Input').value = '';
    document.getElementById('retirerDlc1Input').value = '';
    document.getElementById('retirerQte2Input').value = '';
    document.getElementById('retirerDlc2Input').value = '';
    document.getElementById('retirerQte3Input').value = '';
    document.getElementById('retirerDlc3Input').value = '';
    
    // مسح رسالة التحقق
    const validationMessage = document.getElementById('retirerQteValidationMessage');
    if (validationMessage) {
        validationMessage.remove();
    }
    
    // إعادة تعيين أنماط الحقول
    const qteInputs = [
        'retirerQte1Input',
        'retirerQte2Input',
        'retirerQte3Input'
    ];
    
    qteInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
        }
    });
    
    // مسح معلومات البحث فقط (لا تمسح الكروت المحفوظة)
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
}

      
// ============================================
// دالة للحصول على الكمية المتوفرة للمنتج في عنوان محدد
// ============================================
function getAvailableQuantityForProductAtAddress(code, adresse) {
    let totalQuantity = 0;
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            // جمع الكميات من الأعمدة 2, 4, 6 (الكميات هي 0, 2, 4 في المصفوفة)
            for(let j = 2; j <= 6; j += 2) {
                const qteStr = csvCache[i][j] || "";
                const dateStr = csvCache[i][j+1] || "";
                
                // تحقق من أن التاريخ صالح
                const dateInvalid = (dateStr === "" || dateStr === "00/01/1900" || dateStr === "0000-00-00");
                
                if (qteStr && !dateInvalid) {
                    const qteNum = parseFloat(qteStr.replace(/[^0-9.-]+/g,"")) || 0;
                    totalQuantity += qteNum;
                }
            }
        }
    }
    
    return totalQuantity;
}

// ============================================
// تحديث دالة quickRetirerProduit للتحقق من الكمية
// ============================================
function quickRetirerProduit() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'retirer') {
        return;
    }
    
    const qte1Input = document.getElementById('quickRetirerQte1Input');
    const dlc1Input = document.getElementById('quickRetirerDlc1Input');
    const qte2Input = document.getElementById('quickRetirerQte2Input');
    const dlc2Input = document.getElementById('quickRetirerDlc2Input');
    const qte3Input = document.getElementById('quickRetirerQte3Input');
    const dlc3Input = document.getElementById('quickRetirerDlc3Input');
    
    const dlc1 = dlc1Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    // حساب إجمالي الكمية المدخلة
    const totalInputQte = 
        (qte1 ? parseInt(qte1) : 0) + 
        (qte2 ? parseInt(qte2) : 0) + 
        (qte3 ? parseInt(qte3) : 0);
    
    // الحصول على الكمية المتوفرة للمنتج في هذا العنوان
    const availableQte = getAvailableQuantityForProductAtAddress(
        currentQuickProduct.code, 
        currentQuickProduct.adresse
    );
    
    // التحقق من أن الكمية المدخلة لا تتجاوز الكمية المتوفرة
    if (totalInputQte > availableQte) {
        showAlert(`QUANTITÉ INSUFFISANTE! DISPONIBLE: ${availableQte}, DEMANDÉE: ${totalInputQte}`, 'warning');
        return;
    }
    
    // التحقق من أن الكمية المدخلة أكبر من 0
    if (totalInputQte <= 0) {
        showAlert('LA QUANTITÉ DOIT ÊTRE SUPÉRIEURE À 0', 'warning');
        return;
    }
    
    const existingIndex = retirerProduits.findIndex(p => p.code === currentQuickProduct.code && p.adresse === currentQuickProduct.adresse);
    
    if (existingIndex >= 0) {
        retirerProduits[existingIndex] = {
            code: currentQuickProduct.code,
            adresse: currentQuickProduct.adresse,
            nom: currentQuickProduct.nom,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3,
            totalQte: totalInputQte,
            availableQte: availableQte
        };
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        retirerProduits.push({
            code: currentQuickProduct.code,
            adresse: currentQuickProduct.adresse,
            nom: currentQuickProduct.nom,
            qte1: qte1 ? parseInt(qte1) : 0,
            dlc1: dlc1,
            qte2: qte2 ? parseInt(qte2) : 0,
            dlc2: dlc2,
            qte3: qte3 ? parseInt(qte3) : 0,
            dlc3: dlc3,
            totalQte: totalInputQte,
            availableQte: availableQte
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    saveRetirerProduits();
    updateRetirerDisplay();
    closeQuickRetirerModal();
}
function resetQuickRetirerModalFull() {

    // مسح info
    const infoDiv = document.getElementById('quickRetirerInfo');
    if (infoDiv) infoDiv.innerHTML = '';

    // مسح inputs QTE
    [
        'quickRetirerQte1Input',
        'quickRetirerQte2Input',
        'quickRetirerQte3Input',
        'quickRetirerDlc1Input',
        'quickRetirerDlc2Input',
        'quickRetirerDlc3Input'
    ].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.value = '';
            el.placeholder = '';
        }
    });

    // مسح المنتج الحالي
    currentQuickProduct = null;
}
// ============================================
// تحديث دالة openQuickRetirerModal لإظهار الكمية المتوفرة
// ============================================
function openQuickRetirerModal(code, adresse, nomProduit) {

    resetQuickRetirerModalFull(); // 🔥 ضروري

    currentQuickProduct = {
        code,
        adresse,
        nom: nomProduit,
        type: 'retirer'
    };

    const quantities = getQuantitiesForProductAtAddress(code, adresse);

    const qte1 = quantities.qte1 || 0;
    const qte2 = quantities.qte2 || 0;
    const qte3 = quantities.qte3 || 0;

    const dlc1 = quantities.dlc1 || '';
    const dlc2 = quantities.dlc2 || '';
    const dlc3 = quantities.dlc3 || '';

    const availableQte = qte1 + qte2 + qte3;

    // INFO
    const infoDiv = document.getElementById('quickRetirerInfo');
    infoDiv.innerHTML = `
        <div class="code">CODE: ${code}</div>
        <div class="name">NOM: ${nomProduit}</div>
        <div class="adresse">ADRESSE: ${adresse}</div>
        <div class="available" style="color:${availableQte > 0 ? '#27ae60' : '#e74c3c'}">
            QUANTITÉS DISPONIBLES: ${availableQte}
        </div>
    `;

    // 🔥 تعمير تلقائي مضمون
    document.getElementById('quickRetirerQte1Input').value = qte1;
    document.getElementById('quickRetirerQte2Input').value = qte2;
    document.getElementById('quickRetirerQte3Input').value = qte3;

    document.getElementById('quickRetirerQte1Input').placeholder = qte1;
    document.getElementById('quickRetirerQte2Input').placeholder = qte2;
    document.getElementById('quickRetirerQte3Input').placeholder = qte3;

    document.getElementById('quickRetirerDlc1Input').value = dlc1;
    document.getElementById('quickRetirerDlc2Input').value = dlc2;
    document.getElementById('quickRetirerDlc3Input').value = dlc3;

    document.getElementById('quickRetirerModal').style.display = 'flex';
    setupDateValidationForQuickRetirer();
}

// ============================================
// إضافة تحقق عند إدخال الكميات في النافذة السريعة
// ============================================

// إضافة مستمعات للأحداث لحقول الكمية في النافذة السريعة
function setupQuickRetirerValidation() {
    const qteInputs = [
        'quickRetirerQte1Input',
        'quickRetirerQte2Input',
        'quickRetirerQte3Input'
    ];
    
    qteInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                validateQuickRetirerTotal();
            });
        }
    });
}

// دالة للتحقق من إجمالي الكمية المدخلة
function validateQuickRetirerTotal() {
    if (!currentQuickProduct || currentQuickProduct.type !== 'retirer') {
        return;
    }
    
    const qte1Input = document.getElementById('quickRetirerQte1Input');
    const qte2Input = document.getElementById('quickRetirerQte2Input');
    const qte3Input = document.getElementById('quickRetirerQte3Input');
    
    const qte1 = qte1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    
    // حساب إجمالي الكمية المدخلة
    const totalInputQte = 
        (qte1 ? parseInt(qte1) : 0) + 
        (qte2 ? parseInt(qte2) : 0) + 
        (qte3 ? parseInt(qte3) : 0);
    
    // الحصول على الكمية المتوفرة
    const availableQte = getAvailableQuantityForProductAtAddress(
        currentQuickProduct.code, 
        currentQuickProduct.adresse
    );
    
    // تحديث عرض الكمية المتوفرة في النافذة
    const availableElement = document.querySelector('#quickRetirerInfo .available');
    if (availableElement) {
        availableElement.innerHTML = `QUANTITÉ DISPONIBLE: ${availableQte} | DEMANDÉE: ${totalInputQte}`;
        
        // تغيير اللون إذا تجاوزت الكمية المدخلة الكمية المتوفرة
        if (totalInputQte > availableQte) {
            availableElement.style.color = '#e74c3c !important';
        } else {
            availableElement.style.color = '#27ae60 !important';
        }
    }
    
    // تغيير لون الحقول إذا تجاوزت الكمية
    const inputs = [qte1Input, qte2Input, qte3Input];
    inputs.forEach(input => {
        if (totalInputQte > availableQte) {
            input.style.borderColor = '#e74c3c';
            input.style.backgroundColor = '#ffe6e6';
        } else {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
        }
    });
}

// وظيفة للبحث في كروت AJOUTER
function searchInAjouterCards(searchTerm) {
    const container = document.getElementById('ajouterSearchResultsContainer');
    container.innerHTML = '';
    
    if (!searchTerm) {
        updateAjouterDisplay(); // إعادة عرض جميع الكروت
        return;
    }
    
    let resultsFound = 0;
    
    ajouterProduits.forEach((produit, index) => {
        // البحث في الكود
        if (produit.code.includes(searchTerm)) {
            resultsFound++;
            displayAjouterResultCard(produit, index, container);
        }
    });
    
    if (resultsFound === 0) {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT TROUVÉ AVEC LE CODE "${searchTerm}"</h3>`;
        container.appendChild(noResultCard);
    }
}

// وظيفة لعرض كروت نتائج البحث
function displayAjouterResultCard(produit, index, container) {
    const card = document.createElement("div");
    card.className = "adresseCard";
    
    const headerRow = document.createElement("div");
    headerRow.className = "produit-header";
    headerRow.style.marginBottom = "10px";
    
    const title = document.createElement("h3"); 
    title.textContent = `${produit.adresse}`; 
    title.style.marginBottom = "0";
    
    const actionsDiv = document.createElement("div");
    actionsDiv.className = "produit-actions";
    
    const editBtn = document.createElement("button");
    editBtn.className = "produit-edit";
    editBtn.textContent = "✏️";
    editBtn.onclick = function() {
        editAjouterProduit(index);
    };
    
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "produit-delete";
    deleteBtn.textContent = "✕";
    deleteBtn.onclick = function() {
        deleteAjouterProduit(index);
    };
    
    actionsDiv.appendChild(editBtn);
    actionsDiv.appendChild(deleteBtn);
    headerRow.appendChild(title);
    headerRow.appendChild(actionsDiv);
    card.appendChild(headerRow);
    
    if (produit.code) {
        const codeRow = document.createElement("div");
        codeRow.className = "codeRow";
        codeRow.textContent = `${produit.code}`;
        card.appendChild(codeRow);
    }
    
    if (produit.nom) {
        const nameRow = document.createElement("div");
        nameRow.className = "nameRow";
        nameRow.textContent = produit.nom;
        card.appendChild(nameRow);
    }
    
    let compteur = 1;
    
    if (produit.qte1 > 0) {
        const row = document.createElement("div");
        row.className = "qteRow";
        row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte1}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc1}</span>`;
        card.appendChild(row);
        compteur++;
    }
    
    if (produit.qte2 > 0) {
        const row = document.createElement("div");
        row.className = "qteRow";
        row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte2}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc2}</span>`;
        card.appendChild(row);
        compteur++;
    }
    
    if (produit.qte3 > 0) {
        const row = document.createElement("div");
        row.className = "qteRow";
        row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte3}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc3}</span>`;
        card.appendChild(row);
    }
    
    container.appendChild(card);
}

// ============================================
// دالة لإضافة "/" لحقول العنوان
// ============================================

// ============================================
// دالة لإضافة "/" لحقول العنوان (محدثة)
// ============================================

// ============================================
// الحل النهائي - إضافة / دون فتح أي نوافذ
// ============================================

// ============================================
// دالة نهائية لإضافة / لحقول العنوان
// ============================================

// ============================================
// الإصدار النهائي - يمنع تماماً فتح النوافذ
// ============================================

function addSlashToAddressFinal(inputId) {
    // منع كامل لجميع الأحداث
    const stopAllEvents = function(e) {
        if (e) {
            e.stopPropagation();
            e.preventDefault();
            e.stopImmediatePropagation();
            
            if (e.cancelBubble !== undefined) e.cancelBubble = true;
            if (e.returnValue !== undefined) e.returnValue = false;
        }
        return false;
    };
    
    // تطبيق على الحدث الحالي
    stopAllEvents(event || window.event);
    
    const input = document.getElementById(inputId);
    if (!input) return false;
    
    // تعطيل جميع الأحداث المؤقتة على الحقل
    const originalEvents = {
        onfocus: input.onfocus,
        onclick: input.onclick,
        onmousedown: input.onmousedown
    };
    
    input.onfocus = null;
    input.onclick = null;
    input.onmousedown = null;
    
    // إضافة "/"
    const cursorPos = input.selectionStart;
    const currentVal = input.value;
    const newVal = currentVal.substring(0, cursorPos) + '/' + currentVal.substring(cursorPos);
    
    input.value = newVal;
    
    // التركيز وتحديد الموضع
    input.focus();
    setTimeout(() => {
        input.setSelectionRange(cursorPos + 1, cursorPos + 1);
    }, 20);
    
    // إبراز الحقل
    input.style.backgroundColor = "#d6f0ff";
    input.style.borderColor = "#3498db";
    
    // استعادة الأحداث بعد 500ms
    setTimeout(() => {
        input.style.backgroundColor = "";
        input.style.borderColor = "";
        
        // استعادة الأحداث الأصلية
        input.onfocus = originalEvents.onfocus;
        input.onclick = originalEvents.onclick;
        input.onmousedown = originalEvents.onmousedown;
    }, 500);
    
    return false;
}
// دالة للتحقق من أن المدخلات أرقام فقط
function validateNumericInput(inputElement) {
    // السماح فقط بالأرقام والرموز الرياضية (*, +, -, /)
    let value = inputElement.value;
    
    // السماح بالتعبيرات الرياضية
    if (/^[0-9\s\+\-\*\/\(\)\.]+$/.test(value) || value === '') {
        // السماح بالقيمة
        return true;
    } else {
        // إزالة الأحرف غير المسموحة
        inputElement.value = value.replace(/[^0-9\+\-\*\/\(\)\.]/g, '');
        return false;
    }
}

// دالة للتحقق من أن القيمة أكبر من 0 قبل الحفظ
function validateQuantityBeforeSave(qteInput) {
    const value = qteInput.value.trim();
    if (value && parseInt(value) <= 0) {
        showAlert('LA QUANTITÉ DOIT ÊTRE SUPÉRIEURE À 0', 'warning');
        qteInput.focus();
        qteInput.select();
        return false;
    }
    return true;
}
function preventExpiredDatesInAllForms() {
    // جميع حقول التواريخ
    const dateInputs = document.querySelectorAll('input[type="tel"][pattern*="\\d{2}/\\d{2}/\\d{4}"]');
    
    dateInputs.forEach(input => {
        // منع فقدان التركيز إذا كان التاريخ منتهياً
        input.addEventListener('blur', function() {
            const dateStr = this.value.trim();
            
            if (dateStr.length === 10) { // تاريخ كامل
                const checkResult = checkIfDateExpired(dateStr);
                
                if (checkResult.expired && checkResult.reason === 'EXPIRED') {
                    showAlert('❌ DATE DÉPASSÉE NON AUTORISÉE', 'warning');
                    this.value = ''; // مسح الحقل
                    this.focus(); // العودة للحقل
                    
                    // إضافة رسالة خطأ واضحة
                    this.placeholder = '❌ DATE DÉPASSÉE INTERDITE';
                    setTimeout(() => {
                        this.placeholder = 'JJ/MM/AAAA';
                    }, 3000);
                }
            }
        });
        
        // التحقق أثناء الكتابة
        input.addEventListener('input', function(e) {
            const value = this.value;
            
            // إذا كان التاريخ يكاد يكتمل (8 أرقام أو أكثر)
            if (value.replace(/\D/g, '').length >= 8) {
                setTimeout(() => {
                    const dateStr = this.value.trim();
                    if (dateStr.length === 10) {
                        const checkResult = checkIfDateExpired(dateStr);
                        
                        if (checkResult.expired && checkResult.reason === 'EXPIRED') {
                            // إظهار تحذير فوري
                            const warning = document.createElement('div');
                            warning.style.cssText = `
                                position: absolute;
                                background: #e74c3c;
                                color: white;
                                padding: 5px 10px;
                                border-radius: 5px;
                                z-index: 10000;
                                font-size: 12px;
                                font-weight: bold;
                            `;
                            warning.textContent = 'DATE DÉPASSÉE';
                            
                            const rect = this.getBoundingClientRect();
                            warning.style.top = (rect.top - 30) + 'px';
                            warning.style.left = rect.left + 'px';
                            
                            document.body.appendChild(warning);
                            setTimeout(() => warning.remove(), 2000);
                        }
                    }
                }, 100);
            }
        });
    });
}

// استدعاء الدالة عند تحميل الصفحة
window.addEventListener('load', function() {
    preventExpiredDatesInAllForms();
});
// دالة منع شاملة
function blockExpiredDatesEverywhere() {
    // تعطيل أزرار الإضافة إذا كان هناك تاريخ منتهي
    const addButtons = document.querySelectorAll('.ajouter-btn, .quick-modal-btn.ajouter, .retirer-btn');
    
    addButtons.forEach(button => {
        const originalOnclick = button.onclick;
        
        button.onclick = function(e) {
            // البحث عن جميع حقول التواريخ في النموذج
            const form = this.closest('.ajouter-card, .quick-modal-content, .retirer-card');
            if (form) {
                const dateInputs = form.querySelectorAll('input[type="tel"][pattern*="\\d{2}/\\d{2}/\\d{4}"]');
                let hasExpiredDate = false;
                
                dateInputs.forEach(input => {
                    const dateStr = input.value.trim();
                    if (dateStr && dateStr.length === 10) {
                        const checkResult = checkIfDateExpired(dateStr);
                        if (checkResult.expired && checkResult.reason === 'EXPIRED') {
                            hasExpiredDate = true;
                            input.style.borderColor = '#e74c3c';
                            input.style.backgroundColor = '#ffe6e6';
                            showAlert('❌ DATE DÉPASSÉE DÉTECTÉE - OPÉRATION BLOQUÉE', 'warning');
                            input.focus();
                        }
                    }
                });
                
                if (hasExpiredDate) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }
            
            // إذا لم توجد تواريخ منتهية، تنفيذ العملية الأصلية
            if (originalOnclick) {
                return originalOnclick.call(this, e);
            }
        };
    });
}
// ============================================
// وظائف نافذة تعديل COMMANDE
// ============================================

let currentEditCommandeIndex = null;

function openEditCommandeModal(index) {
    currentEditCommandeIndex = index;
    const produit = commandeProduits[index];
    
    const infoDiv = document.getElementById('editCommandeInfo');
    infoDiv.innerHTML = `
        <div class="code">CODE: ${produit.code}</div>
        <div class="name">NOM: ${produit.nom}</div>
    `;
    
    document.getElementById('editCommandeQteInput').value = produit.qte;
    
    // إعداد تنسيق التاريخ
    const dateInput = document.getElementById('editCasseDateInput');
    if (dateInput) {
        dateInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            this.value = value;
        });
    }
    
    document.getElementById('editCommandeModal').style.display = 'flex';
    document.getElementById('editCommandeQteInput').focus();
    document.getElementById('editCommandeQteInput').select();
}

function closeEditCommandeModal() {
    document.getElementById('editCommandeModal').style.display = 'none';
    currentEditCommandeIndex = null;
    document.getElementById('editCommandeQteInput').value = '';
}

function saveEditCommande() {
    const newQte = document.getElementById('editCommandeQteInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    commandeProduits[currentEditCommandeIndex].qte = parseInt(newQte);
    saveCommandeProduits();
    updateCommandeDisplay();
    closeEditCommandeModal();
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

// تحديث دالة editProduit للاستخدام الجديد
function editProduit(index) {
    openEditCommandeModal(index);
}

// ============================================
// وظائف نافذة تعديل CASSE FRAIS
// ============================================

let currentEditCasseIndex = null;

function openEditCasseModal(index) {
    currentEditCasseIndex = index;
    const produit = casseProduits[index];
    
    const infoDiv = document.getElementById('editCasseInfo');
    infoDiv.innerHTML = `
        <div class="code">CODE: ${produit.code}</div>
        <div class="name">NOM: ${produit.nom}</div>
    `;
    
    document.getElementById('editCasseQteInput').value = produit.qte;
    document.getElementById('editCasseDateInput').value = produit.date;
    
    // إعداد تنسيق التاريخ
    const dateInput = document.getElementById('editCasseDateInput');
    if (dateInput) {
        dateInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            this.value = value;
        });
    }
    
    document.getElementById('editCasseModal').style.display = 'flex';
    document.getElementById('editCasseQteInput').focus();
    document.getElementById('editCasseQteInput').select();
}

function closeEditCasseModal() {
    document.getElementById('editCasseModal').style.display = 'none';
    currentEditCasseIndex = null;
    document.getElementById('editCasseQteInput').value = '';
    document.getElementById('editCasseDateInput').value = '';
}

function saveEditCasse() {
    const newQte = document.getElementById('editCasseQteInput').value;
    const newDate = document.getElementById('editCasseDateInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    if (!newDate || !isValidDateYYYY(newDate)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    casseProduits[currentEditCasseIndex].qte = parseInt(newQte);
    casseProduits[currentEditCasseIndex].date = newDate;
    saveCasseProduits();
    updateCasseDisplay();
    closeEditCasseModal();
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

// تحديث دالة editCasseProduit للاستخدام الجديد
function editCasseProduit(index) {
    openEditCasseModal(index);
}

// ============================================
// وظائف نافذة تعديل PANIER
// ============================================

let currentEditPanierIndex = null;

function openEditPanierModal(index) {
    currentEditPanierIndex = index;
    const produit = panierProduits[index];
    
    const infoDiv = document.getElementById('editPanierInfo');
    infoDiv.innerHTML = `
        <div class="code">CODE: ${produit.code}</div>
        <div class="name">NOM: ${produit.nom}</div>
        <div class="prix">PRIX: ${produit.prix} DH</div>
    `;
    
    document.getElementById('editPanierQteInput').value = produit.qte;
    
    document.getElementById('editPanierModal').style.display = 'flex';
    document.getElementById('editPanierQteInput').focus();
    document.getElementById('editPanierQteInput').select();
}

function closeEditPanierModal() {
    document.getElementById('editPanierModal').style.display = 'none';
    currentEditPanierIndex = null;
    document.getElementById('editPanierQteInput').value = '';
}

function saveEditPanier() {
    const newQte = document.getElementById('editPanierQteInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    panierProduits[currentEditPanierIndex].qte = parseInt(newQte);
    savePanierProduits();
    updatePanierDisplay();
    closeEditPanierModal();
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

// تحديث دالة editPanierProduit للاستخدام الجديد
function editPanierProduit(index) {
    openEditPanierModal(index);
}

// ============================================
// تحديث كروت العرض للاستخدام مع النوافذ الجديدة
// ============================================

// تحديث عرض كروت COMMANDE
function updateCommandeDisplay() {
    document.getElementById('produitCount').textContent = commandeProduits.length;
    
    const container = document.getElementById('commandeProduitsContainer');
    container.innerHTML = '';
    
    commandeProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deleteProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <span class="qte-label">QUANTITÉ:</span>
                <span class="qte-value">${produit.qte}</span>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// تحديث عرض كروت CASSE FRAIS
function updateCasseDisplay() {
    document.getElementById('casseProduitCount').textContent = casseProduits.length;
    
    const container = document.getElementById('casseProduitsContainer');
    container.innerHTML = '';
    
    casseProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editCasseProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deleteCasseProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <div style="display: flex; justify-content: space-between; width: 100%;">
                    <div>
                        <span class="qte-label">QTE:</span>
                        <span class="qte-value">${produit.qte}</span>
                    </div>
                    <div>
                        <span class="qte-label">DATE:</span>
                        <span class="qte-value">${produit.date}</span>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// تحديث عرض كروت PANIER
function updatePanierDisplay() {
    document.getElementById('panierProduitCount').textContent = panierProduits.length;
    
    const container = document.getElementById('panierProduitsContainer');
    const totalContainer = document.getElementById('panierTotalCard');
    
    container.innerHTML = '';
    totalContainer.innerHTML = '';
    
    if (panierProduits.length === 0) {
        totalContainer.style.display = 'none';
        return;
    }
    
    totalContainer.style.display = 'block';
    
    let totalProduits = 0;
    let totalPrix = 0;
    
    panierProduits.forEach((produit, index) => {
        totalProduits++;
        
        const prixVente = parseFloat(produit.prix.replace(',', '.')) || 0;
        const totalProduit = prixVente * produit.qte;
        totalPrix += totalProduit;
        
        const card = document.createElement('div');
        card.className = 'panier-produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editPanierProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deletePanierProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-details">
                <div class="detail-item">
                    <div class="detail-label">QTE</div>
                    <div class="detail-value">${produit.qte}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">PRIX</div>
                    <div class="detail-value prix">${produit.prix} DH</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">TOTAL</div>
                    <div class="detail-value total">${totalProduit.toFixed(2)} DH</div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    totalContainer.innerHTML = `
        <div class="panier-total-card">
            <h3>RÉSUMÉ DU PANIER</h3>
            <div class="dataRow">
                <span class="label">NOMBRE DE PRODUITS:</span>
                <span class="value">${totalProduits}</span>
            </div>
            <div class="dataRow">
                <span class="label">PRIX TOTAL:</span>
                <span class="total-value">${totalPrix.toFixed(2)} DH</span>
            </div>
        </div>
    `;
    
    totalContainer.prepend(totalContainer.firstChild);
}
function getQuantitiesForProductAtAddress(code, adresse) {
    const quantities = {
        qte1: 0,
        dlc1: "",
        qte2: 0,
        dlc2: "",
        qte3: 0,
        dlc3: ""
    };
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        const adresseProduit = csvCache[i][1] || "";
        
        if(codeProduit === code && adresseProduit === adresse) {
            let counter = 1;
            
            for(let j = 2; j <= 6; j += 2) {
                const qteStr = csvCache[i][j] || "";
                const dateStr = csvCache[i][j+1] || "";
                
                // تحقق من أن التاريخ صالح
                const dateInvalid = (dateStr === "" || dateStr === "00/01/1900" || dateStr === "0000-00-00");
                
                if (qteStr && qteStr.trim() !== "" && !dateInvalid) {
                    const qteNum = parseFloat(qteStr.replace(/[^0-9.-]+/g,"")) || 0;
                    
                    if (qteNum > 0) {
                        if (counter === 1) {
                            quantities.qte1 = qteNum;
                            quantities.dlc1 = dateStr;
                        } else if (counter === 2) {
                            quantities.qte2 = qteNum;
                            quantities.dlc2 = dateStr;
                        } else if (counter === 3) {
                            quantities.qte3 = qteNum;
                            quantities.dlc3 = dateStr;
                        }
                        counter++;
                    }
                }
            }
            break;
        }
    }
    
    return quantities;
}
// ============================================
// استدعاء دالة الإعداد عند تحميل الصفحة
// ============================================
window.addEventListener('load', function() {
    setupQuickRetirerValidation();
});
// مستمع لحقل البحث في AJOUTER
document.getElementById('searchAjouterInput')?.addEventListener('input', function(e) {
    const searchTerm = this.value.trim();
    
    clearTimeout(window.ajouterSearchTimeout);
    window.ajouterSearchTimeout = setTimeout(() => {
        if (searchTerm.length > 0) {
            searchInAjouterCards(searchTerm);
        } else {
            document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
            updateAjouterDisplay();
        }
    }, 300);
});

// للبحث عند الضغط على Enter
document.getElementById('searchAjouterInput')?.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const searchTerm = this.value.trim();
        searchInAjouterCards(searchTerm);
    }
});
// منع نسخ النصوص من الصفحة
document.addEventListener('copy', function(e) {
    const selection = window.getSelection();
    const selectedText = selection.toString();
    
    // السماح بنسخ كود المنتج فقط
    const isCode = /^\d+$/.test(selectedText.trim());
    const isInputField = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';
    
    if (!isCode && !isInputField && selectedText.length > 0) {
        e.preventDefault();
        showAlert('LA COPIE EST INTERDITE SAUF POUR LES CODES PRODUITS', 'warning');
    }
});

// منع القطع
document.addEventListener('cut', function(e) {
    e.preventDefault();
    showAlert('LE COUPER EST INTERDIT', 'warning');
});

// منع اللصق
document.addEventListener('paste', function(e) {
    const target = e.target;
    const isInputField = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
    
    if (!isInputField) {
        e.preventDefault();
        showAlert('LE COPIER-COLLER EST INTERDIT', 'warning');
    }
});
// ============================================
// دالة لمسح حقول AJOUTER
// ============================================

function clearAjouterFields() {
    const inputs = [
        'ajouterCodeInput', 'ajouterAdresseInput',
        'ajouterQte1Input', 'ajouterDlc1Input',
        'ajouterQte2Input', 'ajouterDlc2Input',
        'ajouterQte3Input', 'ajouterDlc3Input'
    ];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            // إعادة تنسيق الحقول
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.style.color = '';
            input.style.fontWeight = '';
            
            // إزالة رسائل الخطأ
            const errorMessage = input.parentNode.querySelector('.date-error-message');
            if (errorMessage) {
                errorMessage.remove();
            }
        }
    });
    
    // إزالة رسالة التحقق
    const validationMessage = document.getElementById('ajouterQteValidationMessage');
    if (validationMessage) {
        validationMessage.remove();
    }
    
    // إزالة الدائرة الحمراء من العنوان
    const addressInput = document.getElementById('ajouterAdresseInput');
    if (addressInput) {
        addressInput.style.backgroundImage = '';
        addressInput.style.paddingRight = '10px';
    }
    
    document.getElementById('ajouterProductInfo').innerHTML = '';
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
}
function resetQuickAjouterFields() {
    const inputs = [
        'quickAjouterAdresseInput',
        'quickAjouterQte1Input', 'quickAjouterDlc1Input',
        'quickAjouterQte2Input', 'quickAjouterDlc2Input',
        'quickAjouterQte3Input', 'quickAjouterDlc3Input'
    ];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            // مسح القيمة
            input.value = '';
            
            // إعادة تعيين جميع الأنماط
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.style.color = '';
            input.style.fontWeight = '';
            input.style.backgroundImage = '';
            input.style.paddingRight = '';
            input.title = '';
            
            // إزالة رسائل الخطأ
            if (input.parentNode) {
                const errorMessage = input.parentNode.querySelector('.date-error-message');
                if (errorMessage) {
                    errorMessage.remove();
                }
            }
        }
    });
    
    // إعادة تعيين رسالة التحقق
    const validationMessage = document.getElementById('quickAjouterQteValidationMessage');
    if (validationMessage) {
        validationMessage.innerHTML = '';
        validationMessage.style.display = 'none';
        validationMessage.style.color = '';
        validationMessage.style.background = '';
        validationMessage.style.borderColor = '';
    }
}

// ============================================
// تحسين دالة validateAndColorDateInput
// ============================================

function validateAndColorDateInput(dateInputElement) {
    const dateStr = dateInputElement.value.trim();
    
    // إزالة أي رسائل خطأ سابقة
    const existingError = dateInputElement.parentNode.querySelector('.date-error-message');
    if (existingError) {
        existingError.remove();
    }
    
    if (!dateStr) {
        dateInputElement.style.borderColor = '';
        dateInputElement.style.backgroundColor = '';
        dateInputElement.style.color = '';
        dateInputElement.style.fontWeight = '';
        return;
    }
    
    const checkResult = checkIfDateExpired(dateStr);
    
    if (checkResult.expired) {
        // التاريخ غير صالح أو منتهي
        dateInputElement.style.borderColor = '#e74c3c';
        dateInputElement.style.backgroundColor = '#ffe6e6';
        dateInputElement.style.color = '#e74c3c';
        dateInputElement.style.fontWeight = 'bold';
        
        // إضافة رسالة خطأ تحذيرية
        const errorMessage = getDateErrorMessage(checkResult.reason);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'date-error-message';
        errorDiv.style.cssText = `
            color: #e74c3c;
            font-size: 12px;
            margin-top: 2px;
            text-align: center;
            font-weight: bold;
        `;
        errorDiv.textContent = errorMessage;
        dateInputElement.parentNode.appendChild(errorDiv);
        
    } else if (checkResult.date) {
        // التاريخ صالح - التحقق من الصلاحية
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const diffTime = checkResult.date.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 0) {
            // منتهي الصلاحية
            dateInputElement.style.borderColor = '#e74c3c';
            dateInputElement.style.backgroundColor = '#ffe6e6';
            dateInputElement.style.color = '#e74c3c';
            dateInputElement.style.fontWeight = 'bold';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'date-error-message';
            errorDiv.style.cssText = `
                color: #e74c3c;
                font-size: 12px;
                margin-top: 2px;
                text-align: center;
                font-weight: bold;
            `;
            errorDiv.textContent = 'DLC DÉPASSÉE';
            dateInputElement.parentNode.appendChild(errorDiv);
            
        } else if (diffDays <= 30) {
            // شهر واحد أو أقل
            dateInputElement.style.color = '#000000';
            dateInputElement.style.backgroundColor = '#f8d7da';
            dateInputElement.style.borderColor = '#f5c6cb';
            dateInputElement.style.fontWeight = 'bold';
            dateInputElement.title = `DLC PROCHAIN (${diffDays} JOURS)`;
            
        } else {
            // ساري المفعول لأكثر من شهر
            dateInputElement.style.color = '';
            dateInputElement.style.backgroundColor = '';
            dateInputElement.style.borderColor = '';
            dateInputElement.style.fontWeight = '';
            dateInputElement.title = `DLC VALIDE (${diffDays} JOURS)`;
        }
    } else {
        // حالة غير متوقعة
        dateInputElement.style.borderColor = '';
        dateInputElement.style.backgroundColor = '';
        dateInputElement.style.color = '';
        dateInputElement.style.fontWeight = '';
    }
}

// ============================================
// تحديث دالة openAjouter لإضافة التحقق
// ============================================

function openAjouter(){
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("ajouterPage").style.display = "block";
    
    updateAjouterDisplay();
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    
    // إعداد التحقق من الكمية
    setupAjouterValidation();
    
    // إعداد التحقق من صحة التاريخ وتلوين الحقول
    setupDateValidationForAjouter();
    
    // إضافة مستمعات أحداث إضافية للتحقق في الوقت الحقيقي
    setupRealTimeDateValidation();
}

// ============================================
// دالة للتحقق في الوقت الحقيقي
// ============================================

function setupRealTimeDateValidation() {
    const dateInputs = [
        'ajouterDlc1Input',
        'ajouterDlc2Input',
        'ajouterDlc3Input'
    ];
    
    dateInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            // التحقق عند كل ضغطة مفتاح
            input.addEventListener('keyup', function() {
                validateAndColorDateInput(this);
            });
            
            // التحقق عند تغيير القيمة
            input.addEventListener('change', function() {
                validateAndColorDateInput(this);
            });
            
            // التحقق عند ترك الحقل
            input.addEventListener('blur', function() {
                validateAndColorDateInput(this);
            });
            
            // التحقق التلقائي عند التحميل
            if (input.value.trim()) {
                validateAndColorDateInput(input);
            }
        }
    });
}
</script>
<!-- ... الكود الحالي ... -->

<!-- ============================================
   نوافذ التعديل للصفحات الأخرى
   ============================================ -->

<!-- نافذة تعديل COMMANDE -->
<div id="editCommandeModal" class="modal">
    <div class="modal-content">
        <h2>MODIFIER COMMANDE</h2>
        <div id="editCommandeInfo" class="quick-modal-info"></div>
        
        <div class="quick-input-row">
            <input type="tel" id="editCommandeQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn confirm" onclick="saveEditCommande()">ENREGISTRER</button>
            <button class="quick-modal-btn cancel" onclick="closeEditCommandeModal()">ANNULER</button>
        </div>
    </div>
</div>

<!-- نافذة تعديل CASSE FRAIS -->
<div id="editCasseModal" class="modal">
    <div class="modal-content">
        <h2>MODIFIER CASSE FRAIS</h2>
        <div id="editCasseInfo" class="quick-modal-info"></div>
        
        <div class="quick-input-row">
            <input type="tel" id="editCasseQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        
        <div class="quick-input-row">
            <input type="tel" id="editCasseDateInput" placeholder="DATE (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
        </div>
        
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn confirm" onclick="saveEditCasse()">ENREGISTRER</button>
            <button class="quick-modal-btn cancel" onclick="closeEditCasseModal()">ANNULER</button>
        </div>
    </div>
</div>

<!-- نافذة تعديل PANIER -->
<div id="editPanierModal" class="modal">
    <div class="modal-content">
        <h2>MODIFIER PANIER</h2>
        <div id="editPanierInfo" class="quick-modal-info"></div>
        
        <div class="quick-input-row">
            <input type="tel" id="editPanierQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off" oninput="delayedEvaluateExpression(this)">
        </div>
        
        <div class="quick-modal-buttons">
            <button class="quick-modal-btn confirm" onclick="saveEditPanier()">ENREGISTRER</button>
            <button class="quick-modal-btn cancel" onclick="closeEditPanierModal()">ANNULER</button>
        </div>
    </div>
</div>
<script>
/* ===============================
   AJOUTER – FIX FINAL CLEAN
   =============================== */

let ajouterLocked = false;

/* غلق جميع المودالات */
function closeAllModals() {
    document.querySelectorAll(
        '.modal, .quick-modal, .date-picker-modal'
    ).forEach(m => m.style.display = 'none');
}

/* إيقاف أي Scanner شغّال */
function stopScannerSafely() {
    try {
        if (window.html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop();
        }
    } catch (e) {}

    try {
        if (window.Quagga) {
            Quagga.stop();
        }
    } catch (e) {}
}

/* Reset صفحة AJOUTER */
function resetAjouterPage() {
    const page = document.getElementById('ajouterPage');
    if (!page) return;

    page.querySelectorAll('input').forEach(i => i.value = '');
    closeAllModals();
    stopScannerSafely();
}

/* Override آمن لـ showAjouter بلا لمسها */
if (typeof window.showAjouter === 'function') {

    const _originalShowAjouter = window.showAjouter;

    window.showAjouter = function () {

        resetAjouterPage();

        try {
            _originalShowAjouter();
        } catch (e) {
            console.error("Erreur showAjouter:", e);
        }

        ajouterLocked = false;
    };
}

/* حماية زر الإضافة */
document.addEventListener('DOMContentLoaded', () => {

    const ajouterBtn = document.getElementById('ajouterBtn');
    if (!ajouterBtn) return;

    ajouterBtn.onclick = function () {

        if (ajouterLocked) return;
        ajouterLocked = true;

        // 🔽 منطق الإضافة ديالك هنا 🔽

        setTimeout(() => {
            ajouterLocked = false;
        }, 600);
    };

});
// ============================================
// نظام الإشعارات عند فتح التطبيق
// ============================================

let startupPages = [];
let currentStartupPageIndex = 0;
let startupModalActive = false;

// تعريف الصفحات التي يجب التحقق منها
const PAGES_TO_CHECK = [
    {
        id: 'commande',
        name: 'COMMANDE',
        color: '#1abc9c',
        getCount: () => commandeProduits.length,
        clearFunction: () => {
            commandeProduits = [];
            saveCommandeProduits();
            updateCommandeDisplay();
        }
    },
    {
        id: 'ajouter',
        name: 'AJOUTER',
        color: '#27ae60',
        getCount: () => ajouterProduits.length,
        clearFunction: () => {
            ajouterProduits = [];
            saveAjouterProduits();
            updateAjouterDisplay();
        }
    },
    {
        id: 'retirer',
        name: 'RETIRER',
        color: '#34495e',
        getCount: () => retirerProduits.length,
        clearFunction: () => {
            retirerProduits = [];
            saveRetirerProduits();
            updateRetirerDisplay();
        }
    },
    {
        id: 'casse',
        name: 'CASSE FRAIS',
        color: '#d35400',
        getCount: () => casseProduits.length,
        clearFunction: () => {
            casseProduits = [];
            saveCasseProduits();
            updateCasseDisplay();
        }
    },
    {
        id: 'panier',
        name: 'PANIER',
        color: '#2ecc71',
        getCount: () => panierProduits.length,
        clearFunction: () => {
            panierProduits = [];
            savePanierProduits();
            updatePanierDisplay();
        }
    }
];

// التحقق من الصفحات التي تحتوي على منتجات
function checkPagesWithProducts() {
    startupPages = PAGES_TO_CHECK.filter(page => {
        const count = page.getCount();
        return count > 0;
    });
    
    return startupPages.length > 0;
}

// عرض نافذة الإشعار للصفحة الحالية
function showStartupModalForPage(pageIndex) {
    if (pageIndex >= startupPages.length) {
        // انتهاء جميع الصفحات
        closeStartupModal();
        return;
    }
    
    currentStartupPageIndex = pageIndex;
    const page = startupPages[pageIndex];
    const count = page.getCount();
    
    // تحديث العنوان
    document.getElementById('startupModalTitle').textContent = `PRODUITS ${page.name}`;
    
    // تحديث عرض العدد
    const container = document.getElementById('startupPagesContainer');
    container.innerHTML = `
        <div class="startup-page-info page-${page.id}">
            <div class="page-name">${page.name}</div>
            <div class="page-count">${count}</div>
            <div class="page-unit">${count === 1 ? 'PRODUIT' : 'PRODUITS'}</div>
        </div>
    `;
    
    // تحديث الأزرار
    const buttonsContainer = document.getElementById('startupButtonsContainer');
    buttonsContainer.innerHTML = `
        <button class="startup-modal-btn clear" onclick="clearCurrentPageProducts()">
            EFFACER (${count})
        </button>
        <button class="startup-modal-btn keep" onclick="keepCurrentPageProducts()">
            CONSERVER
        </button>
        ${
            pageIndex < startupPages.length - 1 
            ? `<button class="startup-modal-btn next" onclick="showStartupModalForPage(${pageIndex + 1})">
                   PAGE SUIVANTE
               </button>`
            : `<button class="startup-modal-btn next" onclick="closeStartupModal()">
                   TERMINER
               </button>`
        }
    `;
    
    // تحديث شريط التقدم
    const progressContainer = document.getElementById('startupProgress');
    progressContainer.textContent = `Page ${pageIndex + 1} sur ${startupPages.length}`;
    
    // عرض النافذة
    document.getElementById('startupModal').style.display = 'flex';
    startupModalActive = true;
}

// مسح منتجات الصفحة الحالية
function clearCurrentPageProducts() {
    const page = startupPages[currentStartupPageIndex];
    const count = page.getCount();
    
    // تنفيذ دالة المسح
    page.clearFunction();
    
    // إظهار رسالة تأكيد
    showAlert(`✓ ${count} PRODUITS ${page.name} EFFACÉS`, 'success');
    
    // الانتقال إلى الصفحة التالية أو الإغلاق
    if (currentStartupPageIndex < startupPages.length - 1) {
        // إعادة تحميل القائمة بعد المسح
        startupPages = startupPages.filter(p => p.getCount() > 0);
        
        if (startupPages.length > 0) {
            if (currentStartupPageIndex >= startupPages.length) {
                currentStartupPageIndex = startupPages.length - 1;
            }
            setTimeout(() => showStartupModalForPage(currentStartupPageIndex), 300);
        } else {
            closeStartupModal();
        }
    } else {
        closeStartupModal();
    }
}

// الاحتفاظ بمنتجات الصفحة الحالية
function keepCurrentPageProducts() {
    const page = startupPages[currentStartupPageIndex];
    const count = page.getCount();
    
    showAlert(`✓ ${count} PRODUITS ${page.name} CONSERVÉS`, 'success');
    
    // الانتقال إلى الصفحة التالية
    if (currentStartupPageIndex < startupPages.length - 1) {
        setTimeout(() => showStartupModalForPage(currentStartupPageIndex + 1), 300);
    } else {
        closeStartupModal();
    }
}

// إغلاق نافذة الإشعارات
function closeStartupModal() {
    document.getElementById('startupModal').style.display = 'none';
    startupModalActive = false;
    
    // إخفاء الصفحة الرئيسية مؤقتاً إذا كانت الإشعارات ظهرت
    if (document.getElementById('mainPage').style.display === 'none') {
        document.getElementById('mainPage').style.display = 'block';
    }
}

// تهيئة نظام الإشعارات عند تحميل الصفحة
function initStartupNotifications() {
    // انتظار تحميل البيانات أولاً
    setTimeout(() => {
        if (checkPagesWithProducts()) {
            // إخفاء الصفحة الرئيسية مؤقتاً
            document.getElementById('mainPage').style.display = 'none';
            
            // عرض أول نافذة إشعار
            showStartupModalForPage(0);
        }
    }, 1000); // تأخير 1 ثانية لتحميل البيانات من localStorage
}

// تحديث دالة initApp لتفعيل الإشعارات
function initApp() {
    loadAllDataFromStorage();
    updateAllData();
    window.addEventListener('scroll', toggleScrollButtons);
    loadCommandeProduits();
    loadAjouterProduits();
    loadCasseProduits();
    loadRetirerProduits();
    loadPanierProduits();
    loadPrixData();
    setupDateInput();
    setupQuantityInputs();
    setupDatePickerButtons();
    
    // تفعيل نظام الإشعارات
    initStartupNotifications();
}
// ============================================
// دوال جديدة لتصفية الكروت المعروضة
// ============================================

// دالة لتصفية الكروت المعروضة بناءً على آخر 4 أرقام من الكود
function filterDisplayedCards() {
    const filterInput = document.getElementById('filterCardsInput');
    const filterValue = filterInput.value.trim();
    const container = document.getElementById('resultatsContainer');
    const cards = container.querySelectorAll('.adresseCard');
    const filterInfo = document.getElementById('filterResultsInfo');
    
    // إظهار أو إخفاء قسم المعلومات
    if (filterInfo) {
        filterInfo.style.display = filterValue ? 'block' : 'none';
    }
    
    if (!filterValue) {
        // إذا كان الحقل فارغاً، أظهر جميع الكروت
        cards.forEach(card => {
            card.style.display = 'block';
            // استعادة النص الأصلي
            restoreCardText(card);
        });
        if (filterInfo) filterInfo.innerHTML = '';
        return;
    }
    
    let foundCount = 0;
    
    cards.forEach(card => {
        const codeRow = card.querySelector('.codeRow');
        if (codeRow) {
            const codeText = codeRow.textContent.trim();
            const codeDigits = codeText.replace(/\D/g, ''); // استخراج الأرقام فقط
            const last4Digits = codeDigits.slice(-4); // أخذ آخر 4 أرقام
            
            // حفظ النص الأصلي إذا لم يكن محفوظاً
            if (!codeRow.dataset.originalText) {
                codeRow.dataset.originalText = codeRow.innerHTML;
            }
            
            if (last4Digits.includes(filterValue) || codeDigits.endsWith(filterValue)) {
                card.style.display = 'block';
                foundCount++;
                
                // إبراز النص المطابق
                highlightMatchedText(codeRow, filterValue);
            } else {
                card.style.display = 'none';
                restoreCardText(card);
            }
        } else {
            card.style.display = 'none';
        }
    });
    
    // عرض عدد النتائج
    if (filterInfo) {
        if (foundCount > 0) {
            filterInfo.innerHTML = `<strong>${foundCount}</strong> CARTE(S) TROUVÉE(S) POUR: <strong>${filterValue}</strong>`;
            filterInfo.style.color = '#27ae60';
            filterInfo.style.background = '#e8f8ef';
            filterInfo.style.borderLeft = '3px solid #27ae60';
        } else {
            filterInfo.innerHTML = `AUCUNE CARTE TROUVÉE POUR: <strong>${filterValue}</strong>`;
            filterInfo.style.color = '#e74c3c';
            filterInfo.style.background = '#ffe6e6';
            filterInfo.style.borderLeft = '3px solid #e74c3c';
        }
    }
}

// دالة لإبراز النص المطابق
function highlightMatchedText(element, searchText) {
    const originalText = element.dataset.originalText || element.innerHTML;
    const regex = new RegExp(`(${searchText})`, 'gi');
    
    // البحث في النص فقط (بدون HTML tags)
    const textContent = element.textContent || element.innerText;
    if (regex.test(textContent)) {
        element.innerHTML = originalText.replace(regex, '<mark style="background: #FFEB3B; color: #000; padding: 1px 3px; border-radius: 2px; font-weight: bold;">$1</mark>');
    }
}

// دالة لاستعادة النص الأصلي للكارت
function restoreCardText(card) {
    const codeRow = card.querySelector('.codeRow');
    if (codeRow && codeRow.dataset.originalText) {
        codeRow.innerHTML = codeRow.dataset.originalText;
    }
}

// دالة لمسح حقل التصفية عند البحث الجديد// دالة لمسح حقل التصفية وعرض جميع الكروت
function clearFilterField() {
    const filterInput = document.getElementById('filterCardsInput');
    const filterInfo = document.getElementById('filterResultsInfo');
    
    if (filterInput) {
        filterInput.value = '';
    }
    
    if (filterInfo) {
        filterInfo.style.display = 'none';
        filterInfo.innerHTML = '';
    }
    
    // إعادة عرض جميع الكروت واستعادة النصوص الأصلية
    const container = document.getElementById('resultatsContainer');
    if (container) {
        const cards = container.querySelectorAll('.adresseCard');
        cards.forEach(card => {
            card.style.display = 'block';
            restoreCardText(card);
        });
    }
}

// تحديث دالة rechercher() لتفعيل التصفية
// سأبحث عن دالة rechercher() الموجودة وأعدلها
</script>
<!-- ============================================
   نافذة الإشعارات عند فتح التطبيق
   ============================================ -->

<div id="startupModal" class="startup-modal">
    <div class="startup-modal-content">
        <h2 class="startup-modal-title" id="startupModalTitle"></h2>
        
        <div id="startupPagesContainer"></div>
        
        <div id="startupButtonsContainer" class="startup-modal-buttons"></div>
        
        <div id="startupProgress" class="startup-modal-progress"></div>
    </div>
</div>
</body>
</html>