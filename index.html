<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MENU PRINCIPAL</title>

<style>
/* جميع الأنماط السابقة تبقى كما هي */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f0f4f8, #ffffff);
    margin: 0;
    padding: 0;
}

h1 {
    text-align: center;
    margin-top: 25px;
    font-size: 28px;
    color: #1e2a38;
    font-weight: bold;
    text-transform: uppercase;
}

.container {
    width: 90%;
    max-width: 500px;
    margin: 20px auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border-left: 3px solid #3498db !important;
    position: relative;
    overflow: hidden;
    padding-left: 15px;
}

.container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.btn {
    padding: 18px;
    text-align: center;
    border-radius: 12px;
    font-size: 20px;
    font-weight: bold;
    color: white;
    text-decoration: none;
    transition: 0.25s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    border: none;
    text-transform: uppercase;
}

.btn:hover { transform: scale(1.03); }

.info     { background: #3498db; }
.adresse  { background: #9b59b6; }
.rupture  { background: #e74c3c; }
.dlc      { background: #f39c12; }
.commande { background: #1abc9c; }
.ajouter  { background: #27ae60; }
.retirer  { background: #34495e; }
.casse    { background: #d35400; }

#infoPage, #adressePage, #rupturePage, #dlcPage, #commandePage, #ajouterPage, #cassePage, #retirerPage { 
    display: none; 
    padding: 20px; 
    animation: fadeIn 0.3s ease-in-out; 
    max-width: 600px;
    margin: 0 auto;
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

.adresseCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    font-weight: bold;
    border-left: 3px solid #f39c12;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.adresseCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #f39c12, #e67e22);
}

.adresseCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    font-weight: 700;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.adresseCard .infoRow, .adresseCard .codeRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    font-weight: 600;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 16px;
    letter-spacing: 0.5px;
    border: 1px solid #e0e0e0;
    text-transform: uppercase;
}

.adresseCard .nameRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    font-weight: 500;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 14px;
    font-style: normal;
    border: 1px solid #e0e0e0;
    text-transform: uppercase;
}

.adresseCard .qteRow {
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 13px;
    text-transform: uppercase;
}

.adresseCard .qteRow .qte-value {
    color: #27ae60;
    font-weight: 600;
    font-size: 14px;
}

.adresseCard .qteRow .date-value {
    color: #e74c3c;
    font-weight: 600;
    font-size: 14px;
}

.adresseCard .qteRow .label {
    color: #7f8c8d;
    font-weight: 500;
    font-size: 13px;
}

.reserveCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    font-weight: bold;
    border-left: 3px solid #3498db;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.reserveCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9);
}

.reserveCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    font-weight: 700;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.reserveCard .dataRow {
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.reserveCard .dataRow .label {
    color: #7f8c8d;
    font-weight: 500;
}

.reserveCard .dataRow .value {
    color: #2c3e50;
    font-weight: 600;
}

.totalReserveCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    font-weight: bold;
    border-left: 3px solid #3498db;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.totalReserveCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9);
}

.totalReserveCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    font-weight: 700;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.totalReserveCard .dataRow {
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 8px;
    color: #2c3e50;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    text-transform: uppercase;
}

.totalSummaryCard {
    background: white;
    color: #000000;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    font-weight: bold;
    border-left: 3px solid #3498db;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.totalSummaryCard::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9);
}

.totalSummaryCard h3 { 
    margin-bottom: 12px; 
    font-size: 18px; 
    color: #2c3e50; 
    text-align: center;
    font-weight: 700;
    padding-bottom: 6px;
    border-bottom: 1px solid #ecf0f1;
    text-transform: uppercase;
}

.totalSummaryCard .dataRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 8px;
    color: #27ae60;
    font-weight: 600;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    border: 1px solid #bdc3c7;
    font-size: 15px;
    text-transform: uppercase;
}

.totalSummaryCard .dataRow .total-value {
    color: #27ae60;
    font-weight: 700;
    font-size: 16px;
    margin-left: 5px;
}

.totalRow {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 12px;
    color: #27ae60;
    font-weight: 600;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    border: 1px solid #bdc3c7;
    font-size: 15px;
    text-transform: uppercase;
}

.totalRow .total-value {
    color: #27ae60;
    font-weight: 700;
    font-size: 16px;
    margin-left: 5px;
}

.search-card {
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    color: white;
    font-weight: bold;
    transition: transform 0.3s, box-shadow 0.3s;
    background: white;
    border-left: 3px solid #3498db !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.search-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.search-card:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
}

.input-row { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
    gap: 8px;
}

#codeInput, #adresseInput, #commandeCodeInput, #commandeQteInput, #ajouterCodeInput, #ajouterAdresseInput, #ajouterQte1Input, #ajouterDlc1Input, #ajouterQte2Input, #ajouterDlc2Input, #ajouterQte3Input, #ajouterDlc3Input, #casseCodeInput, #casseQteInput, #casseDateInput, #retirerCodeInput, #retirerAdresseInput, #retirerQteInput, #retirerDateInput {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #bbb;
    padding: 8px;
    font-size: 16px;
    background: #f0f4f8;
    text-align: center;
    font-weight: bold;
    color: #1e2a38;
    box-sizing: border-box;
    text-transform: uppercase;
}

button.scan, button.searchBtn, .scan-small {
    padding: 8px 12px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    margin-top: 8px;
    height: 50px;
    text-transform: uppercase;
}

.scan-small {
    width: 100px;
    height: 50px;
    margin-top: 0;
}

button.scan:hover, button.searchBtn:hover, .scan-small:hover {
    background: #2980b9;
}

/* زر الرجوع المحسن */
.backBtn { 
    display: inline-block; 
    margin-bottom: 20px; 
    font-weight: bold; 
    cursor: pointer; 
    color: #fff; 
    font-size: 16px; 
    text-decoration: none;
    text-transform: uppercase;
    padding: 12px 24px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s;
    border: none;
    width: auto;
    text-align: center;
}

.backBtn:hover { 
    background: linear-gradient(135deg, #2980b9, #1c6ea4);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
}

.backBtn::before {
    content: '← ';
    font-weight: bold;
    margin-right: 8px;
}

.hideZero { display: none !important; }
#adresseContainer, #resultatsContainer, #infoDataContainer, #ruptureContainer, #dlcContainer, #commandeContainer, #commandeProduitsContainer, #ajouterContainer, #ajouterProduitsContainer, #casseContainer, #casseProduitsContainer, #retirerContainer, #retirerProduitsContainer { margin-top: 6px; margin-bottom: 30px; }

.search-type {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.search-type-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    text-transform: uppercase;
}

.search-type-btn.active {
    background: #3498db;
    color: white;
}

.search-type-btn:hover {
    background: #2980b9;
    color: white;
}

.departement-select {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.departement-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    width: 48%;
    text-transform: uppercase;
}

.departement-btn.active {
    background: #3498db;
    color: white;
}

.departement-btn:hover {
    background: #2980b9;
    color: white;
}

.month-select {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    gap: 8px;
}

.month-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #3498db;
    background: white;
    color: #3498db;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    width: 100%;
    text-transform: uppercase;
}

.month-btn.active {
    background: #3498db;
    color: white;
}

.month-btn:hover {
    background: #2980b9;
    color: white;
}

.topBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
}

.topBtn:hover {
    background: #2980b9;
    transform: scale(1.1);
}

.commande-card, .ajouter-card, .casse-card, .retirer-card {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db !important;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.commande-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.ajouter-card {
    border-left: 3px solid #3498db !important;
}

.ajouter-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.casse-card {
    border-left: 3px solid #3498db !important;
}

.casse-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.retirer-card {
    border-left: 3px solid #3498db !important;
}

.retirer-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(to bottom, #3498db, #2980b9) !important;
}

.commande-input-row, .ajouter-input-row, .casse-input-row, .retirer-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.commande-input-row input, .ajouter-input-row input, .casse-input-row input, .retirer-input-row input {
    flex: 1;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 16px;
    text-align: center;
    text-transform: uppercase;
}

.ajouter-qte-input, .ajouter-dlc-input, .casse-date-input, .retirer-date-input {
    max-width: 150px;
}

.commande-btn, .ajouter-btn, .casse-btn, .retirer-btn {
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    margin-top: 10px;
    text-transform: uppercase;
}

.commande-btn:hover {
    background: #2980b9;
}

.ajouter-btn {
    background: #27ae60;
}

.ajouter-btn:hover {
    background: #219653;
}

.casse-btn {
    background: #d35400;
}

.casse-btn:hover {
    background: #a04000;
}

.retirer-btn {
    background: #34495e;
}

.retirer-btn:hover {
    background: #2c3e50;
}

.commande-btn.secondary, .ajouter-btn.secondary, .casse-btn.secondary, .retirer-btn.secondary {
    background: #e74c3c;
    border: 2px solid #c0392b;
}

.commande-btn.secondary:hover, .ajouter-btn.secondary:hover, .casse-btn.secondary:hover, .retirer-btn.secondary:hover {
    background: #c0392b;
}

.commande-btn.danger, .ajouter-btn.danger, .casse-btn.danger, .retirer-btn.danger {
    background: #e74c3c;
}

.commande-btn.danger:hover, .ajouter-btn.danger:hover, .casse-btn.danger:hover, .retirer-btn.danger:hover {
    background: #c0392b;
}

.commande-summary, .ajouter-summary, .casse-summary, .retirer-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    text-align: center;
    font-weight: bold;
    color: #2c3e50;
    border: 2px solid #3498db;
    text-transform: uppercase;
}

.ajouter-summary {
    border: 2px solid #27ae60;
}

.casse-summary {
    border: 2px solid #d35400;
}

.retirer-summary {
    border: 2px solid #34495e;
}

.commande-summary span, .ajouter-summary span, .casse-summary span, .retirer-summary span {
    color: #27ae60;
    font-size: 20px;
}

.produit-card {
    background: white;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    border-left: 3px solid #3498db;
    position: relative;
    text-transform: uppercase;
}

.produit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ecf0f1;
}

.produit-code {
    background: #3498db;
    color: white;
    padding: 5px 10px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 14px;
}

.produit-actions {
    display: flex;
    gap: 8px;
}

.produit-edit {
    background: #f39c12;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.produit-edit:hover {
    background: #d68910;
    transform: scale(1.1);
}

.produit-delete {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.produit-delete:hover {
    background: #c0392b;
    transform: scale(1.1);
}

.produit-name {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    font-weight: 500;
    color: #2c3e50;
    text-align: center;
}

.produit-qte {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
}

.qte-label {
    color: #7f8c8d;
    font-weight: 500;
}

.qte-value {
    color: #27ae60;
    font-weight: bold;
    font-size: 18px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: white;
    padding: 40px 30px;
    border-radius: 16px;
    max-width: 450px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.3s ease-out;
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #3498db, #2980b9);
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal h2 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: 700;
    text-transform: uppercase;
}

.modal p {
    color: #5a6c7d;
    font-size: 16px;
    line-height: 1.5;
    margin: 0;
    padding: 0 10px;
}

.modal-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    justify-content: center;
}

.modal-btn {
    flex: 1;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    max-width: 160px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-transform: uppercase;
}

.modal-btn.confirm {
    background: linear-gradient(135deg, #27ae60, #219653);
    color: white;
}

.modal-btn.confirm:hover {
    background: linear-gradient(135deg, #219653, #1e874b);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
}

.modal-btn.cancel {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.modal-btn.cancel:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
}

.date-select-modal .modal-content {
    max-width: 400px;
}

.date-options {
    max-height: 300px;
    overflow-y: auto;
    margin: 20px 0;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 10px;
}

.date-option {
    background: #f8f9fa;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-weight: 500;
    color: #2c3e50;
    text-transform: uppercase;
}

.date-option:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
    transform: translateX(5px);
}

.date-option.selected {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
}

.alert-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    border-left: 3px solid #e74c3c;
    z-index: 3000;
    animation: alertSlideIn 0.3s ease-out;
    max-width: 350px;
    font-weight: 500;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
    text-transform: uppercase;
}

.alert-message.success {
    border-left-color: #27ae60;
}

.alert-message.info {
    border-left-color: #3498db;
}

.alert-message.warning {
    border-left-color: #f39c12;
}

.alert-icon {
    font-size: 20px;
}

@keyframes alertSlideIn {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* أنماط جديدة لحقول AJOUTER الصغيرة */
.ajouter-input-row.small-row {
    flex-wrap: nowrap;
    justify-content: space-between;
}

.ajouter-small-input {
    flex: 1;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 6px 8px;
    font-size: 14px;
    text-align: center;
    min-width: 0;
    box-sizing: border-box;
    text-transform: uppercase;
}

.ajouter-small-input.qte {
    max-width: 80px;
    margin-right: 5px;
}

.ajouter-small-input.date {
    flex: 2;
    min-width: 120px;
    margin-left: 5px;
}

@media (max-width: 480px) {
    .input-row {
        flex-direction: column;
    }
    
    #codeInput, #adresseInput, .scan-small {
        width: 100%;
    }
    
    .commande-input-row, .ajouter-input-row, .casse-input-row, .retirer-input-row {
        flex-direction: column;
    }
    
    .ajouter-qte-input, .ajouter-dlc-input, .casse-date-input, .retirer-date-input {
        max-width: 100%;
    }
    
    .modal-content {
        padding: 30px 20px;
    }
    
    .modal-buttons {
        flex-direction: column;
    }
    
    .modal-btn {
        max-width: 100%;
    }
    
    .alert-message {
        left: 20px;
        right: 20px;
        max-width: none;
    }
    
    .produit-actions {
        gap: 5px;
    }
    
    .ajouter-input-row.small-row {
        flex-wrap: wrap;
    }
    
    .ajouter-small-input.qte,
    .ajouter-small-input.date {
        max-width: 100%;
        width: 100%;
        margin: 5px 0;
    }
    
    .backBtn {
        padding: 10px 20px;
        font-size: 14px;
        margin-bottom: 15px;
    }
}
</style>
</head>

<body>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h2>CONFIRMATION</h2>
        <p id="confirmMessage"></p>
        <div class="modal-buttons">
            <button class="modal-btn confirm" onclick="confirmAction()">CONFIRMER</button>
            <button class="modal-btn cancel" onclick="cancelAction()">ANNULER</button>
        </div>
    </div>
</div>

<div id="dateSelectModal" class="modal date-select-modal">
    <div class="modal-content">
        <h2>SÉLECTIONNER UNE DATE</h2>
        <p id="dateSelectMessage">CHOISISSEZ UNE DATE POUR CE PRODUIT:</p>
        <div id="dateOptionsContainer" class="date-options"></div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDateSelectModal()">ANNULER</button>
        </div>
    </div>
</div>

<button class="topBtn" onclick="scrollToTop()">↑</button>

<div id="mainPage">
<h1>MENU PRINCIPAL</h1>
<div class="container">
    <button class="btn info" onclick="openInfo()">INFO PRODUIT</button>
    <button class="btn adresse" onclick="openAdresse()">CONTENUE D'ADRESSE</button>
    <button class="btn rupture" onclick="openRupture()">REPTURE RAYON</button>
    <button class="btn dlc" onclick="openDLC()">DLC RESERVE</button>
    <button class="btn commande" onclick="openCommande()">COMMANDE</button>
    <button class="btn ajouter" onclick="openAjouter()">AJOUTER</button>
    <button class="btn retirer" onclick="openRetirer()">RETIRER</button>
    <button class="btn casse" onclick="openCasse()">CASSE FRAIS</button>
</div>
</div>

<div id="infoPage">
    <button class="backBtn" onclick="goBack()">RETOUR</button>
    <h1>INFO PRODUIT</h1>

    <div class="search-card">
        <div class="input-row">
            <input type="tel" id="codeInput" placeholder="ENTRER CODE ARTICLE" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan scan-small" onclick="scanner()">SCANNER</button>
        </div>
    </div>

    <div id="infoDataContainer"></div>
    <div id="adresseContainer"></div>
</div>

<div id="adressePage">
    <button class="backBtn" onclick="goBackFromAdresse()">RETOUR</button>
    <h1>CONTENUE D'ADRESSE</h1>

    <div class="search-card">
        <div class="search-type">
            <button class="search-type-btn active" id="searchByAdresseBtn" onclick="setSearchType('adresse')">ADRESSE</button>
            <button class="search-type-btn" id="searchByCodeBtn" onclick="setSearchType('code')">CODE</button>
        </div>
        
        <div class="input-row">
            <input type="tel" id="adresseInput" placeholder="EX: 6/1 (POUR Z6P1)" pattern="[0-9/]*" inputmode="decimal" autocomplete="off" lang="fr" inputmode="numeric">
        </div>
        <button class="searchBtn" onclick="rechercher()">SCANNER</button>
        <div id="productNameDisplayAdresse" class="product-name-display" style="display: none;"></div>
    </div>

    <div id="resultatsContainer"></div>
</div>

<div id="rupturePage">
    <button class="backBtn" onclick="goBackFromRupture()">RETOUR</button>
    <h1>REPTURE RAYON</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="epicerieBtn" onclick="setDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="biscuiterieBtn" onclick="setDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
    </div>

    <div id="ruptureContainer"></div>
</div>

<div id="dlcPage">
    <button class="backBtn" onclick="goBackFromDLC()">RETOUR</button>
    <h1>DLC RESERVE</h1>

    <div class="search-card">
        <div class="departement-select">
            <button class="departement-btn active" id="dlcEpicerieBtn" onclick="setDLCDepartement('epicerie')">EPICERIE</button>
            <button class="departement-btn" id="dlcBiscuiterieBtn" onclick="setDLCDepartement('biscuiterie')">BISCUITERIE</button>
        </div>
        
        <div class="month-select">
            <select id="monthSelect" class="month-btn" onchange="displayDLCByMonth()">
                <option value="">SÉLECTIONNER UN MOIS</option>
            </select>
        </div>
    </div>

    <div id="dlcContainer"></div>
</div>

<div id="commandePage">
    <button class="backBtn" onclick="goBackFromCommande()">RETOUR</button>
    <h1>COMMANDE</h1>

    <div class="commande-card">
        <div class="commande-input-row">
            <input type="tel" id="commandeCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="scannerCommande()">SCANNER</button>
        </div>
        
        <div id="commandeProductInfo"></div>
        
        <div class="commande-input-row">
            <input type="tel" id="commandeQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
        </div>
        
        <button class="commande-btn" onclick="ajouterProduit()">AJOUTER</button>
        
        <div class="commande-summary">
            NOMBRE DES PRODUITS: <span id="produitCount">0</span>
        </div>
        
        <button class="commande-btn secondary" onclick="showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', clearAllProduits)">EFFACER TOUT</button>
    </div>

    <div id="commandeProduitsContainer"></div>
</div>

<div id="ajouterPage">
    <button class="backBtn" onclick="goBackFromAjouter()">RETOUR</button>
    <h1>AJOUTER</h1>

    <!-- البحث عن المنتج -->
    <div class="ajouter-card">
        <div class="ajouter-input-row">
            <input type="tel" id="ajouterCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="scannerAjouter()">SCANNER</button>
        </div>
    </div>

    <!-- الحاوية الجديدة لعرض كروت نتائج البحث في صفحة AJOUTER -->
    <div id="ajouterSearchResultsContainer"></div>

    <!-- إضافة المنتج -->
    <div class="ajouter-card">
        <div id="ajouterProductInfo"></div>
        
        <div class="ajouter-input-row">
            <input type="tel" id="ajouterAdresseInput" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off">
        </div>
        
        <!-- QTE 1 و DLC 1 في سطر واحد -->
        <div class="ajouter-input-row small-row">
            <input type="tel" id="ajouterQte1Input" class="ajouter-small-input qte" placeholder="QTE 1" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <input type="tel" id="ajouterDlc1Input" class="ajouter-small-input date" placeholder="DLC 1 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
        </div>
        
        <!-- QTE 2 و DLC 2 في سطر واحد -->
        <div class="ajouter-input-row small-row">
            <input type="tel" id="ajouterQte2Input" class="ajouter-small-input qte" placeholder="QTE 2" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <input type="tel" id="ajouterDlc2Input" class="ajouter-small-input date" placeholder="DLC 2 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
        </div>
        
        <!-- QTE 3 و DLC 3 في سطر واحد -->
        <div class="ajouter-input-row small-row">
            <input type="tel" id="ajouterQte3Input" class="ajouter-small-input qte" placeholder="QTE 3" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <input type="tel" id="ajouterDlc3Input" class="ajouter-small-input date" placeholder="DLC 3 (JJ/MM/AAAA)" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
        </div>
        
        <button class="ajouter-btn" onclick="ajouterProduitAjouter()">AJOUTER</button>
        
        <div class="ajouter-summary">
            NOMBRE DES PRODUITS: <span id="ajouterProduitCount">0</span>
        </div>
        
        <button class="ajouter-btn secondary" onclick="clearAllAjouter()">EFFACER TOUT</button>
    </div>

    <div id="ajouterProduitsContainer"></div>
</div>

<div id="cassePage">
    <button class="backBtn" onclick="goBackFromCasse()">RETOUR</button>
    <h1>CASSE FRAIS</h1>

    <div class="casse-card">
        <div class="casse-input-row">
            <input type="tel" id="casseCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="scannerCasse()">SCANNER</button>
        </div>
        
        <div id="casseProductInfo"></div>
        
        <div class="casse-input-row">
            <input type="tel" id="casseQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <input type="tel" id="casseDateInput" class="casse-date-input" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
        </div>
        
        <button class="casse-btn" onclick="ajouterProduitCasse()">AJOUTER</button>
        
        <div class="casse-summary">
            NOMBRE DES PRODUITS: <span id="casseProduitCount">0</span>
        </div>
        
        <button class="casse-btn secondary" onclick="clearAllProduitsCasse()">EFFACER TOUT</button>
    </div>

    <div id="casseProduitsContainer"></div>
</div>

<div id="retirerPage">
    <button class="backBtn" onclick="goBackFromRetirer()">RETOUR</button>
    <h1>RETIRER</h1>

    <!-- البحث عن المنتج -->
    <div class="retirer-card">
        <div class="retirer-input-row">
            <input type="tel" id="retirerCodeInput" placeholder="CODE PRODUIT" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <button class="scan-small" onclick="scannerRetirer()">SCANNER</button>
        </div>
    </div>

    <!-- الحاوية الجديدة لعرض كروت نتائج البحث في صفحة RETIRER -->
    <div id="retirerSearchResultsContainer"></div>

    <!-- إضافة المنتج -->
    <div class="retirer-card">
        <div id="retirerProductInfo"></div>
        
        <div class="retirer-input-row">
            <input type="tel" id="retirerAdresseInput" placeholder="ADRESSE (EX: 6/1)" pattern="[0-9/]*" inputmode="numeric" autocomplete="off">
        </div>
        
        <div class="retirer-input-row">
            <input type="tel" id="retirerQteInput" placeholder="QUANTITÉ" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
            <input type="tel" id="retirerDateInput" class="retirer-date-input" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}" inputmode="numeric" autocomplete="off">
        </div>
        
        <button class="retirer-btn" onclick="ajouterProduitRetirer()">AJOUTER</button>
        
        <div class="retirer-summary">
            NOMBRE DES PRODUITS: <span id="retirerProduitCount">0</span>
        </div>
        
        <button class="retirer-btn secondary" onclick="clearAllProduitsRetirer()">EFFACER TOUT</button>
    </div>

    <div id="retirerProduitsContainer"></div>
</div>

<script>
// مصادر البيانات
const DATA_SOURCES = {
    produits: {
        url: "https://docs.google.com/spreadsheets/d/11YoNOkm_CWh4OouBTiE6aniRQxRmJOg0vOEW_SXxzqQ/export?format=tsv",
        storageKey: "produits_data",
        lastUpdateKey: "produits_last_update",
        cache: []
    },
    adresses: {
        url: "https://docs.google.com/spreadsheets/d/1gL4eDcnsECNmlhZ_F6jJlrDM3YW0UHdaClqPjxVQxQY/export?format=tsv",
        storageKey: "adresses_data",
        lastUpdateKey: "adresses_last_update",
        cache: []
    },
    ventes: {
        url: "https://docs.google.com/spreadsheets/d/18281vphP4T25wl_W82TheVyQtyERFtwWg8sHrnNCzKU/export?format=tsv",
        storageKey: "ventes_data",
        lastUpdateKey: "ventes_last_update",
        cache: []
    }
};

// متغيرات عامة
let produitsCache = [];
let csvCache = [];
let csvNewCache = [];
let searchType = 'adresse';
let totalGlobalReserve = 0;
let showTotalReserve = false;
let currentDepartement = 'epicerie';
let currentDLCDepartement = 'epicerie';
let allMonths = [];

// متغيرات صفحة COMMANDE
let commandeProduits = [];
let pendingAction = null;
let editingProduitIndex = -1;

// متغيرات صفحة AJOUTER
let ajouterProduits = [];
let editingAjouterProduitIndex = -1;

// متغيرات صفحة CASSE FRAIS
let casseProduits = [];
let editingCasseProduitIndex = -1;

// متغيرات صفحة RETIRER
let retirerProduits = [];
let editingRetirerProduitIndex = -1;
let pendingDateSelection = null;

// تهيئة التطبيق
function initApp() {
    // تحميل البيانات من التخزين المحلي
    loadAllDataFromStorage();
    
    // تحميل البيانات مباشرة
    updateAllData();
    
    // إضافة حدث التمرير للتحكم في زر الرجوع إلى الأعلى
    window.addEventListener('scroll', toggleTopButton);
    
    // تحميل المنتجات المخزنة محليًا لصفحة COMMANDE و AJOUTER و CASSE و RETIRER
    loadCommandeProduits();
    loadAjouterProduits();
    loadCasseProduits();
    loadRetirerProduits();
    
    // إعداد حقول التاريخ
    setupDateInput();
}

// إعداد حقول التاريخ لإدخال تلقائي لـ /
function setupDateInput() {
    const dateInputs = [
        document.getElementById('casseDateInput'),
        document.getElementById('retirerDateInput'),
        document.getElementById('ajouterDlc1Input'),
        document.getElementById('ajouterDlc2Input'),
        document.getElementById('ajouterDlc3Input')
    ];
    
    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
            
            // التحقق من صحة التاريخ عند فقدان التركيز
            dateInput.addEventListener('blur', function() {
                const value = this.value;
                if (value && !isValidDateYYYY(value)) {
                    showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
                    this.value = '';
                }
            });
        }
    });
}

// التحقق من صحة التاريخ بصيغة YYYY
function isValidDateYYYY(dateString) {
    const pattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    if (!pattern.test(dateString)) return false;
    
    const parts = dateString.split('/');
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);
    
    const date = new Date(year, month - 1, day);
    return date.getFullYear() === year && 
           date.getMonth() === month - 1 && 
           date.getDate() === day;
}

// التحكم في ظهور زر الرجوع إلى الأعلى
function toggleTopButton() {
    const topBtn = document.querySelector('.topBtn');
    if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        topBtn.style.display = 'flex';
    } else {
        topBtn.style.display = 'none';
    }
}

// التمرير إلى الأعلى
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// تحميل جميع البيانات من التخزين المحلي
function loadAllDataFromStorage() {
    // تحميل بيانات المنتجات
    const produitsData = localStorage.getItem(DATA_SOURCES.produits.storageKey);
    if (produitsData) {
        produitsCache = JSON.parse(produitsData);
        DATA_SOURCES.produits.cache = produitsCache;
    }
    
    // تحميل بيانات العناوين
    const adressesData = localStorage.getItem(DATA_SOURCES.adresses.storageKey);
    if (adressesData) {
        csvCache = JSON.parse(adressesData);
        DATA_SOURCES.adresses.cache = csvCache;
    }
    
    // تحميل بيانات المبيعات
    const ventesData = localStorage.getItem(DATA_SOURCES.ventes.storageKey);
    if (ventesData) {
        csvNewCache = JSON.parse(ventesData);
        DATA_SOURCES.ventes.cache = csvNewCache;
    }
    
    console.log('DONNÉES CHARGÉES DEPUIS LE STOCKAGE LOCAL');
}

// حفظ البيانات في التخزين المحلي
function saveDataToStorage(source, data) {
    localStorage.setItem(source.storageKey, JSON.stringify(data));
    localStorage.setItem(source.lastUpdateKey, new Date().toISOString());
}

// تحديث بيانات مصدر معين
async function updateDataSource(source) {
    try {
        console.log('MISE À JOUR DES DONNÉES:', source.storageKey);
        const response = await fetch(source.url);
        
        if (!response.ok) {
            throw new Error(`ERREUR HTTP: ${response.status}`);
        }
        
        const text = await response.text();
        const data = text.split("\n").map(l => l.split("\t"));
        
        // حفظ البيانات في التخزين المحلي
        saveDataToStorage(source, data);
        
        // تحديث الكاش
        source.cache = data;
        
        console.log(`DONNÉES MISE À JOUR: ${source.storageKey}`, data.length, 'LIGNES');
        return true;
    } catch (error) {
        console.error(`ERREUR LORS DE LA MISE À JOUR DE ${source.storageKey}:`, error);
        return false;
    }
}

// تحديث جميع البيانات
async function updateAllData() {
    try {
        const results = await Promise.allSettled([
            updateDataSource(DATA_SOURCES.produits),
            updateDataSource(DATA_SOURCES.adresses),
            updateDataSource(DATA_SOURCES.ventes)
        ]);
        
        // تحديث المتغيرات العالمية
        produitsCache = DATA_SOURCES.produits.cache;
        csvCache = DATA_SOURCES.adresses.cache;
        csvNewCache = DATA_SOURCES.ventes.cache;
        
        console.log('DONNÉES MISE À JOUR');
    } catch (error) {
        console.error('ERREUR LORS DE LA MISE À JOUR DES DONNÉES:', error);
    }
}

// عرض تنبيه
function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert-message ${type}`;
    alert.innerHTML = `
        <span class="alert-icon">${type === 'success' ? '✓' : type === 'warning' ? '⚠' : 'ℹ'}</span>
        <span>${message}</span>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.style.animation = 'alertSlideIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 300);
    }, 3000);
}

// الوظائف الأخرى تبقى كما هي مع تعديلات طفيفة
function setSearchType(type) {
    searchType = type;
    showTotalReserve = (type === 'code');
    
    document.getElementById('searchByAdresseBtn').classList.remove('active');
    document.getElementById('searchByCodeBtn').classList.remove('active');
    
    if (type === 'adresse') {
        document.getElementById('searchByAdresseBtn').classList.add('active');
        document.getElementById('adresseInput').placeholder = "EX: 6/1 (POUR Z6P1)";
    } else {
        document.getElementById('searchByCodeBtn').classList.add('active');
        document.getElementById('adresseInput').placeholder = "ENTRER LE CODE PRODUIT";
    }
    
    document.getElementById('adresseInput').value = "";
    document.getElementById("resultatsContainer").innerHTML = "";
    document.getElementById("productNameDisplayAdresse").style.display = "none";
}

function setDepartement(dep) {
    currentDepartement = dep;
    
    document.getElementById('epicerieBtn').classList.remove('active');
    document.getElementById('biscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('epicerieBtn').classList.add('active');
    } else {
        document.getElementById('biscuiterieBtn').classList.add('active');
    }
    
    // عرض المنتجات مباشرة عند تغيير القسم
    displayRuptureProductsByDepartement();
}

function setDLCDepartement(dep) {
    currentDLCDepartement = dep;
    
    document.getElementById('dlcEpicerieBtn').classList.remove('active');
    document.getElementById('dlcBiscuiterieBtn').classList.remove('active');
    
    if (dep === 'epicerie') {
        document.getElementById('dlcEpicerieBtn').classList.add('active');
    } else {
        document.getElementById('dlcBiscuiterieBtn').classList.add('active');
    }
    
    // استخراج الأشهر المتوفرة عند تغيير القسم
    extractAvailableMonths();
    // عرض المنتجات مباشرة إذا كان هناك شهر محدد
    displayDLCByMonth();
}

function openInfo(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("infoPage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    if(csvNewCache.length===0) {
        csvNewCache = DATA_SOURCES.ventes.cache;
    }
}

function openAdresse(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("adressePage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    
    document.getElementById("adresseInput").focus();
    setSearchType('adresse');
}

function openRupture(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("rupturePage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    
    // عرض منتجات القسم الافتراضي (EPICERIE)
    displayRuptureProductsByDepartement();
}

function openDLC(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("dlcPage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    
    // استخراج الأشهر المتوفرة وعرضها
    extractAvailableMonths();
}

function openCommande(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("commandePage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    if(csvNewCache.length===0) {
        csvNewCache = DATA_SOURCES.ventes.cache;
    }
    
    // تحديث عرض المنتجات
    updateCommandeDisplay();
}

function openAjouter(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("ajouterPage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    if(csvNewCache.length===0) {
        csvNewCache = DATA_SOURCES.ventes.cache;
    }
    
    // تحديث عرض المنتجات
    updateAjouterDisplay();
    
    // إفراغ نتائج البحث عند فتح الصفحة
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
}

function openCasse(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("cassePage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    if(csvNewCache.length===0) {
        csvNewCache = DATA_SOURCES.ventes.cache;
    }
    
    // تحديث عرض المنتجات
    updateCasseDisplay();
}

function openRetirer(){
    document.getElementById("mainPage").style.display="none";
    document.getElementById("retirerPage").style.display="block";
    
    // استخدام البيانات من الكاش المحلي
    if(produitsCache.length===0) {
        produitsCache = DATA_SOURCES.produits.cache;
    }
    if(csvCache.length===0) {
        csvCache = DATA_SOURCES.adresses.cache;
    }
    if(csvNewCache.length===0) {
        csvNewCache = DATA_SOURCES.ventes.cache;
    }
    
    // تحديث عرض المنتجات
    updateRetirerDisplay();
    
    // إفراغ نتائج البحث عند فتح الصفحة
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
}

function resetFields(){
    document.getElementById("codeInput").value = "";
    document.getElementById("infoDataContainer").innerHTML = "";
    document.getElementById("adresseContainer").innerHTML = "";
}

function goBack(){ 
    resetFields(); 
    document.getElementById("infoPage").style.display="none"; 
    document.getElementById("mainPage").style.display="block"; 
}

function goBackFromAdresse(){ 
    document.getElementById("adressePage").style.display="none"; 
    document.getElementById("mainPage").style.display="block";
    document.getElementById("adresseInput").value = "";
    document.getElementById("resultatsContainer").innerHTML = "";
    document.getElementById("productNameDisplayAdresse").style.display = "none";
}

function goBackFromRupture(){ 
    document.getElementById("rupturePage").style.display="none"; 
    document.getElementById("mainPage").style.display="block";
    document.getElementById("ruptureContainer").innerHTML = "";
}

function goBackFromDLC(){ 
    document.getElementById("dlcPage").style.display="none"; 
    document.getElementById("mainPage").style.display="block";
    document.getElementById("dlcContainer").innerHTML = "";
}

function goBackFromCommande(){ 
    // إفراغ المعلومات عند الرجوع
    document.getElementById('commandeCodeInput').value = '';
    document.getElementById('commandeQteInput').value = '';
    document.getElementById('commandeProductInfo').innerHTML = '';
    
    document.getElementById("commandePage").style.display="none"; 
    document.getElementById("mainPage").style.display="block";
}

function goBackFromAjouter(){ 
    // إفراغ المعلومات عند الرجوع
    document.getElementById('ajouterCodeInput').value = '';
    document.getElementById('ajouterAdresseInput').value = '';
    document.getElementById('ajouterQte1Input').value = '';
    document.getElementById('ajouterDlc1Input').value = '';
    document.getElementById('ajouterQte2Input').value = '';
    document.getElementById('ajouterDlc2Input').value = '';
    document.getElementById('ajouterQte3Input').value = '';
    document.getElementById('ajouterDlc3Input').value = '';
    document.getElementById('ajouterProductInfo').innerHTML = '';
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    
    document.getElementById("ajouterPage").style.display="none"; 
    document.getElementById("mainPage").style.display="block";
}

function goBackFromCasse(){ 
    // إفراغ المعلومات عند الرجوع
    document.getElementById('casseCodeInput').value = '';
    document.getElementById('casseQteInput').value = '';
    document.getElementById('casseDateInput').value = '';
    document.getElementById('casseProductInfo').innerHTML = '';
    
    document.getElementById("cassePage").style.display="none"; 
    document.getElementById("mainPage").style.display="block";
}

function goBackFromRetirer(){ 
    // إفراغ المعلومات عند الرجوع
    document.getElementById('retirerCodeInput').value = '';
    document.getElementById('retirerAdresseInput').value = '';
    document.getElementById('retirerQteInput').value = '';
    document.getElementById('retirerDateInput').value = '';
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    
    document.getElementById("retirerPage").style.display="none"; 
    document.getElementById("mainPage").style.display="block";
}

function getProductNameByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][1] || "";
        }
    }
    return "";
}

// الحصول على QTE GOLD للمنتج
function getQteGoldByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < produitsCache.length; i++) {
        if(produitsCache[i][0] && produitsCache[i][0].trim() === codeRecherche) {
            return produitsCache[i][6] || "0";
        }
    }
    return "0";
}

// الحصول على QTE RESERVE للمنتج
function getQteReserveByCode(codeProduit) {
    const codeRecherche = codeProduit.trim();
    for(let i = 1; i < csvCache.length; i++) {
        if(csvCache[i][0] && csvCache[i][0].trim() === codeRecherche) {
            return csvCache[i][9] || "0";
        }
    }
    return "0";
}

// الحصول على معلومات VENTE J-1 للمنتج
function getVenteJ1ByCode(codeProduit) {
    const codeTrim = codeProduit.trim();
    for(let i = 1; i < csvNewCache.length; i++) {
        if(!csvNewCache[i]) continue;
        const row = csvNewCache[i].map(c=>c.trim());
        if(row[0] == codeTrim){
            return row[1] || "0";
        }
    }
    return "0";
}

document.getElementById("codeInput").addEventListener("input", function(){
    const c = this.value.trim();
    if(c!==""){ 
        chercherProduit(c); 
        remplirQTEReserve(c); 
        remplirCartesAdresse(c); 
        // إزالة استدعاء remplirVenteCommande(c);
    }
    else { 
        resetFields(); 
    }
});

function chercherProduit(code){
    for(let i=1;i<produitsCache.length;i++){
        if(produitsCache[i][0] && produitsCache[i][0].trim() == code){
            const nomProduit = produitsCache[i][1] || "";
            
            const container = document.getElementById("infoDataContainer");
            container.innerHTML = "";
            
            const card = document.createElement("div");
            card.className = "reserveCard";
            
            const title = document.createElement("h3"); 
            title.textContent = nomProduit; 
            card.appendChild(title);
            
            const infos = [
                {label: "RAYON", value: produitsCache[i][2] || ""},
                {label: "PRIX DE VENTE", value: formatPrix(produitsCache[i][3] || "")},
                {label: "VENTE J-1", value: getVenteJ1ByCode(code)},
                {label: "COMMANDE", value: getVenteJ1ByCode(code)},
                {label: "FOURNISSEUR", value: produitsCache[i][4] || ""},
                {label: "CNEUF", value: produitsCache[i][5] || ""},
                {label: "QTE GOLD", value: produitsCache[i][6] || ""}
            ];
            
            infos.forEach(info => {
                if(info.value) {
                    const row = document.createElement("div");
                    row.className = "dataRow";
                    row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
                    card.appendChild(row);
                }
            });
            
            container.appendChild(card);
            return;
        }
    }
    document.getElementById("infoDataContainer").innerHTML = "";
}

function formatPrix(prixValue) {
    if (!prixValue) return "";
    
    prixValue = prixValue.replace(/"/g, '');
    prixValue = prixValue.replace('.', ',');
    
    if (prixValue !== "") {
        prixValue = prixValue + " DH";
    }
    
    return prixValue;
}

function remplirQTEReserve(codeProduit){
    for(let i=1;i<csvCache.length;i++){
        if(csvCache[i][0] && csvCache[i][0].trim() == codeProduit.trim()){
            const container = document.getElementById("infoDataContainer");
            const card = container.querySelector('.reserveCard');
            
            if(card) {
                const row = document.createElement("div");
                row.className = "dataRow";
                row.innerHTML = `<span class="label">QTE RESERVE:</span> <span class="value">${csvCache[i][9] || ""}</span>`;
                card.appendChild(row);
            }
            return;
        }
    }
}

function remplirCartesAdresse(codeProduit){
    const container = document.getElementById("adresseContainer");
    container.innerHTML = "";
    
    let totalQte = 0;
    let adressesTrouvees = 0;
    
    for(let i=1;i<csvCache.length;i++){
        if(csvCache[i][0] && csvCache[i][0].trim() == codeProduit.trim()){
            const adresse = csvCache[i][1] || "";
            const card = document.createElement("div");
            card.className = "adresseCard";
            const title = document.createElement("h3"); 
            title.textContent = adresse; 
            card.appendChild(title);
            
            let compteur = 1;
            let qteAdresse = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    qteAdresse += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            // فرز التواريخ من الأقرب إلى الأبعد
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            // عرض التواريخ بعد الفرز
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(qteAdresse > 0){
                totalQte += qteAdresse;
                adressesTrouvees++;
                
                const totalAdresseRow = document.createElement("div");
                totalAdresseRow.className = "totalRow";
                totalAdresseRow.innerHTML = `<span class="total-value">TOTAL ${qteAdresse} UNITÉS</span>`;
                card.appendChild(totalAdresseRow);
                
                container.appendChild(card);
            }
        }
    }
    
    if(totalQte > 0){
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSE";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${adressesTrouvees} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    }
}

function rechercher() {
    const searchTerm = document.getElementById("adresseInput").value.trim();
    
    // عرض اسم المنتج تلقائيا
    if (searchType === 'code' && searchTerm) {
        const nomProduit = getProductNameByCode(searchTerm);
        const displayElement = document.getElementById("productNameDisplayAdresse");
        if (nomProduit) {
            displayElement.textContent = nomProduit;
            displayElement.style.display = "block";
        } else {
            displayElement.style.display = "none";
        }
    } else {
        document.getElementById("productNameDisplayAdresse").style.display = "none";
    }
    
    if (searchType === 'adresse') {
        rechercherParAdresse(searchTerm);
    } else {
        rechercherParCodeProduit(searchTerm);
    }
}

function rechercherParCodeProduit(searchTerm) {
    const container = document.getElementById("resultatsContainer");
    container.innerHTML = "";
    totalGlobalReserve = 0;
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    // أولاً: عرض كارد معلومات المنتج (مثل صفحة COMMANDE)
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        // إنشاء كارد معلومات مثل صفحة COMMANDE
        const infoCard = document.createElement('div');
        infoCard.className = 'reserveCard';
        
        // إسم المنتج
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        infoCard.appendChild(title);
        
        // عرض المعلومات المطلوبة فقط
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE GOLD", value: qteGold});
        } else {
            infos.push({label: "QTE GOLD", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        // عرض المعلومات
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            infoCard.appendChild(row);
        });
        
        container.appendChild(infoCard);
    }
    
    // ثانياً: عرض كارد TOTAL ADRESSES
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            // حساب الكمية الإجمالية
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    // ثالثاً: عرض جميع الكروت الأصلية (العناوين والكميات)
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            // عرض كود المنتج
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            // عرض اسم المنتج
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            // فرز التواريخ من الأقرب إلى الأبعد
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            // عرض التواريخ بعد الفرز
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                totalGlobalReserve += totalQte;
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

function rechercherParAdresse(searchTerm) {
    const container = document.getElementById("resultatsContainer");
    container.innerHTML = "";
    totalGlobalReserve = 0;
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let rechercheFinale = searchTerm;
    
    // تحويل 6/1 إلى Z6P1
    if (searchTerm.includes('/')) {
        const parties = searchTerm.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            rechercheFinale = `Z${num1}P${num2}`;
        }
    }
    
    for(let i=1;i<csvCache.length;i++){
        const adresse = csvCache[i][1] || "";
        
        if(adresse === rechercheFinale){
            resultatsTrouves++;
            const codeProduit = csvCache[i][0] || "";
            const nomProduit = getProductNameByCode(codeProduit);
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            // عرض كود المنتج
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            // عرض اسم المنتج
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            // فرز التواريخ من الأقرب إلى الأبعد
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            // عرض التواريخ بعد الفرز
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                totalGlobalReserve += totalQte;
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves > 0){
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL PRODUITS";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${resultatsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else if(resultatsTrouves === 0){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN RÉSULTAT POUR "${searchTerm}"</h3>`;
        container.appendChild(noResultCard);
    }
}

// التحكم في إدخال الأرقام فقط مع /
document.getElementById("adresseInput").addEventListener("input", function(e){
    const value = this.value;
    const allowedChars = /^[0-9/]*$/;
    
    if (!allowedChars.test(value)) {
        this.value = value.replace(/[^0-9/]/g, '');
    }
    
    // عرض اسم المنتج تلقائيا
    if (searchType === 'code' && value.trim()) {
        const nomProduit = getProductNameByCode(value.trim());
        const displayElement = document.getElementById("productNameDisplayAdresse");
        if (nomProduit) {
            displayElement.textContent = nomProduit;
            displayElement.style.display = "block";
        } else {
            displayElement.style.display = "none";
        }
    }
    
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(() => {
        const searchTerm = this.value.trim();
        if(searchTerm.length > 0) {
            rechercher();
        } else {
            document.getElementById("resultatsContainer").innerHTML = "";
            document.getElementById("productNameDisplayAdresse").style.display = "none";
        }
    }, 300);
});

document.getElementById("adresseInput").addEventListener("keypress", function(event){
    if(event.key === "Enter"){
        event.preventDefault();
        rechercher();
    }
    
    const allowedKeys = /[0-9/]/;
    if (!allowedKeys.test(event.key) && 
        event.key !== 'Backspace' && 
        event.key !== 'Delete' && 
        event.key !== 'Tab' && 
        event.key !== 'ArrowLeft' && 
        event.key !== 'ArrowRight') {
        event.preventDefault();
    }
});

function scanner(){ 
    const codeInput = document.getElementById("codeInput");
    const codeSimule = "123456";
    codeInput.value = codeSimule;
    
    const event = new Event('input', { bubbles: true });
    codeInput.dispatchEvent(event);
    
    const originalColor = codeInput.style.backgroundColor;
    codeInput.style.backgroundColor = "#c6f6d5";
    codeInput.style.borderColor = "#9ae6b4";
    setTimeout(() => {
        codeInput.style.backgroundColor = originalColor;
        codeInput.style.borderColor = "";
    }, 1000);
}

// التحقق مما إذا كان العنوان ينتمي إلى قسم EPICERIE
function isEpicerieAdresse(adresse) {
    if (!adresse) return false;
    
    // العناوين Z6P1 إلى Z15P9
    for (let i = 6; i <= 15; i++) {
        for (let j = 1; j <= 9; j++) {
            if (adresse === `Z${i}P${j}`) {
                return true;
            }
        }
    }
    
    // العنوان Z107P1
    if (adresse === 'Z107P1') {
        return true;
    }
    
    return false;
}

// التحقق مما إذا كان العنوان ينتمي إلى قسم BISCUITERIE
function isBiscuiterieAdresse(adresse) {
    if (!adresse) return false;
    
    // العناوين Z16P1 إلى Z106P12
    for (let i = 16; i <= 106; i++) {
        for (let j = 1; j <= 12; j++) {
            if (adresse === `Z${i}P${j}`) {
                return true;
            }
        }
    }
    
    // العنوان Z107P2
    if (adresse === 'Z107P2') {
        return true;
    }
    
    return false;
}

// تحويل تاريخ إلى كائن Date للمقارنة
function parseDate(dateStr) {
    if (!dateStr || dateStr === "00/01/1900" || dateStr === "0000-00-00") {
        return null;
    }
    
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1; // الأشهر في JavaScript تبدأ من 0
        let year = parseInt(parts[2]);
        
        // إذا كان السنة مكونة من رقمين، نضيف 2000
        if (year < 100) {
            year += 2000;
        }
        
        return new Date(year, month, day);
    }
    
    return null;
}

// استخراج شهر من تاريخ
function getMonthFromDate(dateStr) {
    if (!dateStr || dateStr === "00/01/1900" || dateStr === "0000-00-00") {
        return null;
    }
    
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const month = parts[1];
        let year = parts[2];
        
        // إذا كان السنة مكونة من رقمين، نضيف 2000
        if (year.length === 2) {
            year = '20' + year;
        }
        
        return `${month}/${year}`;
    }
    
    return null;
}

// استخراج الأشهر المتوفرة من البيانات
function extractAvailableMonths() {
    const monthSet = new Set();
    
    // البحث عن التواريخ في الأعمدة 3، 5، 7
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        
        // التحقق مما إذا كان العنوان ينتمي إلى القسم المحدد
        let adresseValide = false;
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
        }
        
        if (adresseValide) {
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    // استخراج الشهر من التاريخ (تنسيق dd/mm/yyyy)
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        const month = parts[1];
                        let year = parts[2];
                        
                        // إذا كان السنة مكونة من رقمين، نضيف 2000
                        if (year.length === 2) {
                            year = '20' + year;
                        }
                        
                        const monthYear = `${month}/${year}`;
                        monthSet.add(monthYear);
                    }
                }
            }
        }
    }
    
    // تحويل Set إلى مصفوفة وفرزها
    allMonths = Array.from(monthSet).sort((a, b) => {
        const [monthA, yearA] = a.split('/');
        const [monthB, yearB] = b.split('/');
        if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
        return parseInt(monthA) - parseInt(monthB);
    });
    
    // تحديث قائمة اختيار الشهر
    const monthSelect = document.getElementById('monthSelect');
    monthSelect.innerHTML = '<option value="">SÉLECTIONNER UN MOIS</option>';
    
    allMonths.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
    });
}

// عرض منتجات DLC حسب الشهر
function displayDLCByMonth() {
    const monthSelect = document.getElementById('monthSelect');
    const selectedMonth = monthSelect.value;
    
    const container = document.getElementById("dlcContainer");
    container.innerHTML = "";
    
    if (!selectedMonth) {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>SÉLECTIONNEZ UN MOIS</h3>`;
        container.appendChild(noResultCard);
        return;
    }
    
    let produitsTrouves = 0;
    let totalGlobalReserve = 0;
    let produitsMap = new Map();
    
    for(let i = 1; i < csvCache.length; i++) {
        const adresse = csvCache[i][1] || "";
        const codeProduit = csvCache[i][0] || "";
        
        // التحقق مما إذا كان العنوان ينتمي إلى القسم المحدد
        let adresseValide = false;
        if (currentDLCDepartement === 'epicerie') {
            adresseValide = isEpicerieAdresse(adresse);
        } else {
            adresseValide = isBiscuiterieAdresse(adresse);
        }
        
        if (adresseValide && codeProduit) {
            let produitTrouveDansAdresse = false;
            let datesDetails = [];
            
            // التحقق من كل تاريخ في هذا العنوان
            for(let j = 2; j < 8; j += 2) {
                let q = (csvCache[i][j] || "").trim();
                let d = (csvCache[i][j+1] || "").trim();
                const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                const monthFromDate = getMonthFromDate(d);
                
                if (qNum > 0 && monthFromDate === selectedMonth) {
                    produitTrouveDansAdresse = true;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            adresse: adresse,
                            qte: q,
                            date: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            if (produitTrouveDansAdresse) {
                if (!produitsMap.has(codeProduit)) {
                    produitsMap.set(codeProduit, {
                        nom: getProductNameByCode(codeProduit),
                        totalQte: 0,
                        details: []
                    });
                }
                
                const produit = produitsMap.get(codeProduit);
                // جمع الكميات من جميع التفاصيل
                datesDetails.forEach(detail => {
                    const qNum = parseFloat(detail.qte.replace(/[^0-9.-]+/g,"")) || 0;
                    produit.totalQte += qNum;
                });
                produit.details.push(...datesDetails);
            }
        }
    }
    
    // تحويل Map إلى مصفوفة للفرز
    const produitsArray = Array.from(produitsMap.entries());
    
    // فرز المنتجات حسب أقرب تاريخ
    produitsArray.forEach(([code, produit]) => {
        produit.details.sort((a, b) => a.dateObj - b.dateObj);
        produit.nearestDate = produit.details.length > 0 ? produit.details[0].dateObj : new Date(9999, 11, 31);
    });
    
    // فرز المصفوفة حسب أقرب تاريخ (من الأقرب إلى الأبعد)
    produitsArray.sort((a, b) => a[1].nearestDate - b[1].nearestDate);
    
    // عرض المنتجات مرتبة حسب التاريخ
    produitsArray.forEach(([codeProduit, produit]) => {
        if (produit.totalQte > 0) {
            produitsTrouves++;
            totalGlobalReserve += produit.totalQte;
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const adresse = produit.details.length > 0 ? produit.details[0].adresse : "";
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            // عرض كود المنتج
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            // عرض اسم المنتج
            if (produit.nom) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = produit.nom;
                card.appendChild(nameRow);
            }
            
            produit.details.forEach(detail => {
                const detailRow = document.createElement("div");
                detailRow.className = "qteRow";
                detailRow.innerHTML = `<span class="label">QTE :</span> <span class="qte-value">${detail.qte}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.date}</span>`;
                card.appendChild(detailRow);
            });
            
            const totalRow = document.createElement("div");
            totalRow.className = "totalRow";
            totalRow.innerHTML = `<span class="total-value">TOTAL ${produit.totalQte} UNITÉ</span>`;
            card.appendChild(totalRow);
            
            container.appendChild(card);
        }
    });
    
    // عرض المجموع الكلي في الأعلى
    if (produitsTrouves > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = `TOTAL ${currentDLCDepartement.toUpperCase()} - MOIS ${selectedMonth}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT TROUVÉ POUR LE MOIS ${selectedMonth} DANS ${currentDLCDepartement.toUpperCase()}</h3>`;
        container.appendChild(noResultCard);
    }
}

// عرض منتجات الروتور حسب القسم
function displayRuptureProductsByDepartement() {
    const container = document.getElementById("ruptureContainer");
    container.innerHTML = "";
    
    let produitsTrouves = 0;
    let totalGlobalReserve = 0;
    
    // الحصول على جميع الأكواد الفريدة من csvCache
    const codesUniques = [];
    const codesAdresses = {};
    
    for(let i = 1; i < csvCache.length; i++) {
        const code = csvCache[i][0];
        const adresse = csvCache[i][1];
        
        if (code) {
            // التحقق مما إذا كان العنوان ينتمي إلى القسم المحدد
            let adresseValide = false;
            if (currentDepartement === 'epicerie') {
                adresseValide = isEpicerieAdresse(adresse);
            } else {
                adresseValide = isBiscuiterieAdresse(adresse);
            }
            
            if (adresseValide) {
                if (!codesUniques.includes(code)) {
                    codesUniques.push(code);
                    codesAdresses[code] = [];
                }
                
                // إضافة العنوان إلى قائمة عناوين المنتج
                if (adresse && !codesAdresses[code].includes(adresse)) {
                    codesAdresses[code].push(adresse);
                }
            }
        }
    }
    
    // التحقق من كل كود
    codesUniques.forEach(code => {
        const qteGold = getQteGoldByCode(code);
        const qteReserve = getQteReserveByCode(code);
        
        // تحويل إلى أرقام للمقارنة
        const qteGoldNum = parseFloat(qteGold.replace(/[^0-9.-]+/g,"")) || 0;
        const qteReserveNum = parseFloat(qteReserve.replace(/[^0-9.-]+/g,"")) || 0;
        
        // إذا كانت QTE RESERVE و QTE GOLD متساويتان
        if (qteGoldNum === qteReserveNum && qteGoldNum > 0) {
            produitsTrouves++;
            
            // جمع معلومات العنوان للمنتج
            let totalQte = 0;
            let allDetails = [];
            
            // البحث في جميع العناوين لهذا المنتج
            for(let i = 1; i < csvCache.length; i++) {
                if(csvCache[i][0] && csvCache[i][0].trim() === code.trim()) {
                    const adresse = csvCache[i][1] || "";
                    
                    // التحقق مما إذا كان العنوان ينتمي إلى القسم المحدد
                    let adresseValide = false;
                    if (currentDepartement === 'epicerie') {
                        adresseValide = isEpicerieAdresse(adresse);
                    } else {
                        adresseValide = isBiscuiterieAdresse(adresse);
                    }
                    
                    if (adresseValide) {
                        // جمع كل تفاصيل الكميات والتواريخ
                        for(let j = 2; j < 8; j += 2) {
                            let q = (csvCache[i][j] || "").trim();
                            let d = (csvCache[i][j+1] || "").trim();
                            const qNum = parseFloat(q.replace(/[^0-9.-]+/g,"")) || 0;
                            const dateInvalid = (d === "" || d === "00/01/1900" || d === "0000-00-00");
                            
                            if(qNum > 0 && !dateInvalid) {
                                totalQte += qNum;
                                const dateObj = parseDate(d);
                                if (dateObj) {
                                    allDetails.push({
                                        adresse: adresse,
                                        qte: qNum,
                                        date: d,
                                        dateObj: dateObj
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            if (totalQte > 0) {
                totalGlobalReserve += totalQte;
                
                // إنشاء كارد للمنتج
                const card = document.createElement("div");
                card.className = "adresseCard";
                
                // عرض العنوان أولاً
                const adresse = allDetails.length > 0 ? allDetails[0].adresse : "";
                const title = document.createElement("h3"); 
                title.textContent = `${adresse}`; 
                card.appendChild(title);
                
                // عرض كود المنتج
                if (code) {
                    const codeRow = document.createElement("div");
                    codeRow.className = "codeRow";
                    codeRow.textContent = `${code}`;
                    card.appendChild(codeRow);
                }
                
                // عرض اسم المنتج
                const nomProduit = getProductNameByCode(code);
                if (nomProduit) {
                    const nameRow = document.createElement("div");
                    nameRow.className = "nameRow";
                    nameRow.textContent = nomProduit;
                    card.appendChild(nameRow);
                }
                
                // فرز التفاصيل حسب التاريخ (من الأقرب إلى الأبعد)
                allDetails.sort((a, b) => a.dateObj - b.dateObj);
                
                // عرض الكميات والتواريخ مرتبة
                let compteur = 1;
                allDetails.forEach(detail => {
                    const qteRow = document.createElement("div");
                    qteRow.className = "qteRow";
                    qteRow.innerHTML = `<span class="label">QTE ${compteur} :</span> <span class="qte-value">${detail.qte}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.date}</span>`;
                    card.appendChild(qteRow);
                    compteur++;
                });
                
                // إضافة المجموع في الوسط
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉ</span>`;
                card.appendChild(totalRow);
                
                container.appendChild(card);
            }
        }
    });
    
    // عرض المجموع الكلي في الأعلى
    if (produitsTrouves > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = `TOTAL ${currentDepartement.toUpperCase()}`;
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${produitsTrouves} PRODUITS</span>`;
        totalCard.appendChild(totalRow);
        
        container.prepend(totalCard);
    } else {
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC QTE RESERVE = QTE GOLD DANS ${currentDepartement.toUpperCase()}</h3>`;
        container.appendChild(noResultCard);
    }
}

// ============================================
// وظائف صفحة COMMANDE
// ============================================

// تحميل المنتجات المخزنة محليًا
function loadCommandeProduits() {
    const savedProduits = localStorage.getItem('commande_produits');
    if (savedProduits) {
        commandeProduits = JSON.parse(savedProduits);
        updateCommandeDisplay();
    }
}

// حفظ المنتجات محليًا
function saveCommandeProduits() {
    localStorage.setItem('commande_produits', JSON.stringify(commandeProduits));
}

// تحديث عرض صفحة COMMANDE
function updateCommandeDisplay() {
    // تحديث العداد
    document.getElementById('produitCount').textContent = commandeProduits.length;
    
    // عرض المنتجات
    const container = document.getElementById('commandeProduitsContainer');
    container.innerHTML = '';
    
    commandeProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deleteProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <span class="qte-label">QUANTITÉ:</span>
                <span class="qte-value">${produit.qte}</span>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// سكانير لمنتجات COMMANDE
function scannerCommande() {
    const codeInput = document.getElementById('commandeCodeInput');
    const codeSimule = "123456";
    codeInput.value = codeSimule;
    
    const event = new Event('input', { bubbles: true });
    codeInput.dispatchEvent(event);
    
    const originalColor = codeInput.style.backgroundColor;
    codeInput.style.backgroundColor = "#c6f6d5";
    codeInput.style.borderColor = "#9ae6b4";
    setTimeout(() => {
        codeInput.style.backgroundColor = originalColor;
        codeInput.style.borderColor = "";
    }, 1000);
}

// البحث عن معلومات المنتج عند إدخال الكود
document.getElementById('commandeCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForCommande(code);
    } else {
        document.getElementById('commandeProductInfo').innerHTML = '';
    }
});

// عرض معلومات المنتج في صفحة COMMANDE
function showProductInfoForCommande(code) {
    const container = document.getElementById('commandeProductInfo');
    container.innerHTML = '';
    
    // البحث عن معلومات المنتج
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        // إنشاء كارد معلومات
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        // إسم المنتج
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        // عرض المعلومات المطلوبة فقط
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE GOLD", value: qteGold});
        } else {
            infos.push({label: "QTE GOLD", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        // عرض المعلومات
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

// إضافة منتج جديد
function ajouterProduit() {
    const codeInput = document.getElementById('commandeCodeInput');
    const qteInput = document.getElementById('commandeQteInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÉ DU PRODUIT', 'warning');
        return;
    }
    
    // البحث عن المنتج للتأكد من وجوده
    const nomProduit = getProductNameByCode(code);
    
    // السماح بإضافة أي منتج حتى إذا لم يكن في قاعدة البيانات
    const produitNom = nomProduit || "PRODUIT NON RÉFÉRENCÉ";
    
    // التحقق مما إذا كان المنتج موجودًا بالفعل
    const existingIndex = commandeProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        // تحديث الكمية إذا كان المنتج موجودًا
        commandeProduits[existingIndex].qte = parseInt(qte);
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        // إضافة منتج جديد
        commandeProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte)
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    // حفظ وتحديث العرض
    saveCommandeProduits();
    updateCommandeDisplay();
    
    // مسح الحقول
    codeInput.value = '';
    qteInput.value = '';
    document.getElementById('commandeProductInfo').innerHTML = '';
    
    // التركيز على حقل الكود
    codeInput.focus();
}

// تعديل منتج
function editProduit(index) {
    editingProduitIndex = index;
    const produit = commandeProduits[index];
    
    const container = document.getElementById('commandeProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="produit-header">
            <div class="produit-code">${produit.code}</div>
            <div style="color: #3498db; font-weight: bold;">MODIFICATION</div>
        </div>
        <div class="produit-name">${produit.nom}</div>
        <div class="produit-qte" style="flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center;">
                <input type="number" class="edit-qte-input" id="editQteInput" value="${produit.qte}" min="1">
                <button class="save-edit-btn" onclick="saveEditProduit()">ENREGISTRER</button>
                <button class="cancel-edit-btn" onclick="cancelEditProduit()">ANNULER</button>
            </div>
        </div>
    `;
    
    document.getElementById('editQteInput').focus();
    document.getElementById('editQteInput').select();
}

// حفظ التعديل
function saveEditProduit() {
    const newQte = document.getElementById('editQteInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    commandeProduits[editingProduitIndex].qte = parseInt(newQte);
    saveCommandeProduits();
    updateCommandeDisplay();
    editingProduitIndex = -1;
    showAlert('QUANTITÉ MODIFIÉE AVEC SUCCÈS', 'success');
}

// إلغاء التعديل
function cancelEditProduit() {
    editingProduitIndex = -1;
    updateCommandeDisplay();
}

// حذف منتج
function deleteProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        commandeProduits.splice(index, 1);
        saveCommandeProduits();
        updateCommandeDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

// عرض نافذة التأكيد
function showConfirmModal(message, callback) {
    document.getElementById('confirmMessage').textContent = message;
    pendingAction = callback;
    document.getElementById('confirmModal').style.display = 'flex';
}

// تأكيد الإجراء
function confirmAction() {
    if (typeof pendingAction === 'function') {
        pendingAction();
    }
    
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
}

// إلغاء الإجراء
function cancelAction() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
}

// مسح جميع المنتجات - تم إصلاحه
function clearAllProduits() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        commandeProduits = [];
        saveCommandeProduits();
        updateCommandeDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// ============================================
// وظائف صفحة AJOUTER - التعديلات المطلوبة
// ============================================

// تحميل المنتجات المخزنة محليًا لـ AJOUTER
function loadAjouterProduits() {
    const savedProduits = localStorage.getItem('ajouter_produits');
    if (savedProduits) {
        ajouterProduits = JSON.parse(savedProduits);
        updateAjouterDisplay();
    }
}

// حفظ المنتجات محليًا لـ AJOUTER
function saveAjouterProduits() {
    localStorage.setItem('ajouter_produits', JSON.stringify(ajouterProduits));
}

// تحديث عرض صفحة AJOUTER - التعديل 2
function updateAjouterDisplay() {
    // تحديث العداد
    document.getElementById('ajouterProduitCount').textContent = ajouterProduits.length;
    
    // عرض المنتجات
    const container = document.getElementById('ajouterProduitsContainer');
    container.innerHTML = '';
    
    ajouterProduits.forEach((produit, index) => {
        const card = document.createElement("div");
        card.className = "adresseCard";
        
        // ============================================
        // التعديل 2: إضافة زر التعديل والحذف في أعلى الكارد
        // ============================================
        const headerRow = document.createElement("div");
        headerRow.className = "produit-header";
        headerRow.style.marginBottom = "10px";
        
        const title = document.createElement("h3"); 
        title.textContent = `${produit.adresse}`; 
        title.style.marginBottom = "0";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "produit-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "produit-edit";
        editBtn.textContent = "✏️";
        editBtn.onclick = function() {
            editAjouterProduit(index);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "produit-delete";
        deleteBtn.textContent = "✕";
        deleteBtn.onclick = function() {
            deleteAjouterProduit(index);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        headerRow.appendChild(title);
        headerRow.appendChild(actionsDiv);
        card.appendChild(headerRow);
        
        // عرض كود المنتج
        if (produit.code) {
            const codeRow = document.createElement("div");
            codeRow.className = "codeRow";
            codeRow.textContent = `${produit.code}`;
            card.appendChild(codeRow);
        }
        
        // عرض اسم المنتج
        if (produit.nom) {
            const nameRow = document.createElement("div");
            nameRow.className = "nameRow";
            nameRow.textContent = produit.nom;
            card.appendChild(nameRow);
        }
        
        let compteur = 1;
        
        // عرض QTE 1 و DLC 1
        if (produit.qte1 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte1}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc1}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        // عرض QTE 2 و DLC 2
        if (produit.qte2 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte2}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc2}</span>`;
            card.appendChild(row);
            compteur++;
        }
        
        // عرض QTE 3 و DLC 3
        if (produit.qte3 > 0) {
            const row = document.createElement("div");
            row.className = "qteRow";
            row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${produit.qte3}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.dlc3}</span>`;
            card.appendChild(row);
        }
        
        container.appendChild(card);
    });
}

// سكانير لمنتجات AJOUTER
function scannerAjouter() {
    const codeInput = document.getElementById('ajouterCodeInput');
    const codeSimule = "123456";
    codeInput.value = codeSimule;
    
    const event = new Event('input', { bubbles: true });
    codeInput.dispatchEvent(event);
    
    const originalColor = codeInput.style.backgroundColor;
    codeInput.style.backgroundColor = "#c6f6d5";
    codeInput.style.borderColor = "#9ae6b4";
    setTimeout(() => {
        codeInput.style.backgroundColor = originalColor;
        codeInput.style.borderColor = "";
    }, 1000);
}

// البحث عن معلومات المنتج عند إدخال الكود لصفحة AJOUTER
document.getElementById('ajouterCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        // عرض معلومات المنتج
        showProductInfoForAjouter(code);
        
        // عرض كروت نتائج البحث (بنفس شكل CONTENUE D'ADRESSE)
        afficherResultatsRechercheAjouter(code);
    } else {
        document.getElementById('ajouterProductInfo').innerHTML = '';
        document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    }
});

// عرض معلومات المنتج في صفحة AJOUTER - التعديل المطلوب
function showProductInfoForAjouter(code) {
    const container = document.getElementById('ajouterProductInfo');
    container.innerHTML = '';
    
    // البحث عن معلومات المنتج
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        // إنشاء كارد معلومات مثل صفحة COMMANDE
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        // إسم المنتج
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        // عرض المعلومات المطلوبة فقط
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE GOLD", value: qteGold});
        } else {
            infos.push({label: "QTE GOLD", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        // عرض المعلومات
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

// عرض كروت نتائج البحث في صفحة AJOUTER (بنفس شكل CONTENUE D'ADRESSE)
function afficherResultatsRechercheAjouter(searchTerm) {
    const container = document.getElementById('ajouterSearchResultsContainer');
    container.innerHTML = "";
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    // أولاً: عرض كارد معلومات المنتج
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        // إنشاء كارد معلومات مثل صفحة COMMANDE
        const infoCard = document.createElement('div');
        infoCard.className = 'reserveCard';
        
        // إسم المنتج
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        infoCard.appendChild(title);
        
        // عرض المعلومات المطلوبة فقط
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE GOLD", value: qteGold});
        } else {
            infos.push({label: "QTE GOLD", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        // عرض المعلومات
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            infoCard.appendChild(row);
        });
        
        container.appendChild(infoCard);
    }
    
    // ثانياً: عرض كارد TOTAL ADRESSES
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            // حساب الكمية الإجمالية
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    // ثالثاً: عرض جميع الكروت الأصلية (العناوين والكميات)
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            // عرض كود المنتج
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            // عرض اسم المنتج
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            // فرز التواريخ من الأقرب إلى الأبعد
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            // عرض التواريخ بعد الفرز
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

// إضافة منتج جديد لـ AJOUTER - التعديل المطلوب
function ajouterProduitAjouter() {
    const codeInput = document.getElementById('ajouterCodeInput');
    const adresseInput = document.getElementById('ajouterAdresseInput');
    const qte1Input = document.getElementById('ajouterQte1Input');
    const dlc1Input = document.getElementById('ajouterDlc1Input');
    const qte2Input = document.getElementById('ajouterQte2Input');
    const dlc2Input = document.getElementById('ajouterDlc2Input');
    const qte3Input = document.getElementById('ajouterQte3Input');
    const dlc3Input = document.getElementById('ajouterDlc3Input');
    
    const code = codeInput.value.trim();
    const adresse = adresseInput.value.trim();
    
    if (!code) {
        showAlert('VEUILLEZ ENTRER LE CODE DU PRODUIT', 'warning');
        return;
    }
    
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    // تحويل 6/1 إلى Z6P1
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    // البحث عن المنتج للتأكد من وجوده
    const nomProduit = getProductNameByCode(code);
    
    // التعديل: السماح بإضافة جميع المنتجات حتى لو غير موجودة في قاعدة البيانات
    const produitNom = nomProduit || "PRODUIT NON RÉFÉRENCÉ";
    
    // التحقق من صحة التواريخ
    const qte1 = qte1Input.value.trim();
    const dlc1 = dlc1Input.value.trim();
    const qte2 = qte2Input.value.trim();
    const dlc2 = dlc2Input.value.trim();
    const qte3 = qte3Input.value.trim();
    const dlc3 = dlc3Input.value.trim();
    
    // التحقق من أن على الأقل كمية واحدة غير فارغة
    if (!qte1 && !qte2 && !qte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    // التحقق من صحة التواريخ إذا كانت موجودة
    if (dlc1 && !isValidDateYYYY(dlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc1Input.focus();
        return;
    }
    
    if (dlc2 && !isValidDateYYYY(dlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc2Input.focus();
        return;
    }
    
    if (dlc3 && !isValidDateYYYY(dlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dlc3Input.focus();
        return;
    }
    
    // التحقق مما إذا كان المنتج موجودًا بالفعل بنفس الكود والعنوان
    const existingIndex = ajouterProduits.findIndex(p => p.adresse === adresseFinale && p.code === code);
    
    if (existingIndex >= 0) {
        // لا تسمح بإضافة منتج بنفس الكود والعنوان - التعديل المطلوب
        showAlert('CE PRODUIT AVEC LE MÊME CODE ET ADRESSE EXISTE DÉJÀ!', 'warning');
        return;
    }
    
    // إضافة منتج جديد
    ajouterProduits.push({
        code: code,
        adresse: adresseFinale,
        nom: produitNom,
        qte1: qte1 ? parseInt(qte1) : 0,
        dlc1: dlc1,
        qte2: qte2 ? parseInt(qte2) : 0,
        dlc2: dlc2,
        qte3: qte3 ? parseInt(qte3) : 0,
        dlc3: dlc3
    });
    showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    
    // حفظ وتحديث العرض
    saveAjouterProduits();
    updateAjouterDisplay();
    
    // مسح الحقول
    codeInput.value = '';
    adresseInput.value = '';
    qte1Input.value = '';
    dlc1Input.value = '';
    qte2Input.value = '';
    dlc2Input.value = '';
    qte3Input.value = '';
    dlc3Input.value = '';
    document.getElementById('ajouterProductInfo').innerHTML = '';
    document.getElementById('ajouterSearchResultsContainer').innerHTML = '';
    
    // التركيز على حقل الكود
    codeInput.focus();
}

// تعديل منتج لـ AJOUTER - التعديل المطلوب
function editAjouterProduit(index) {
    editingAjouterProduitIndex = index;
    const produit = ajouterProduits[index];
    
    // إنشاء واجهة التعديل
    const container = document.getElementById('ajouterProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="adresseCard">
            <h3 style="color: #3498db;">MODIFICATION</h3>
            
            <div class="codeRow" style="background: #3498db; color: white;">${produit.code}</div>
            
            <div class="nameRow">${produit.nom}</div>
            
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 8px;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">ADRESSE:</div>
                <input type="tel" id="editAjouterAdresseInput" value="${produit.adresse}" pattern="[0-9/]*" style="width: 100%; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 1:</div>
                    <input type="number" id="editAjouterQte1Input" value="${produit.qte1 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 1:</div>
                    <input type="tel" id="editAjouterDlc1Input" value="${produit.dlc1 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 2:</div>
                    <input type="number" id="editAjouterQte2Input" value="${produit.qte2 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 2:</div>
                    <input type="tel" id="editAjouterDlc2Input" value="${produit.dlc2 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE 3:</div>
                    <input type="number" id="editAjouterQte3Input" value="${produit.qte3 || ''}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DLC 3:</div>
                    <input type="tel" id="editAjouterDlc3Input" value="${produit.dlc3 || ''}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="ajouter-btn" onclick="saveEditAjouterProduit()" style="flex: 1; padding: 10px; background: #27ae60;">ENREGISTRER</button>
                <button class="ajouter-btn" onclick="cancelEditAjouterProduit()" style="flex: 1; padding: 10px; background: #e74c3c;">ANNULER</button>
            </div>
        </div>
    `;
    
    // إعداد حقول التاريخ للتعديل
    const dateInputs = [
        document.getElementById('editAjouterDlc1Input'),
        document.getElementById('editAjouterDlc2Input'),
        document.getElementById('editAjouterDlc3Input')
    ];
    
    dateInputs.forEach(dateInput => {
        if (dateInput) {
            dateInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + '/' + value.substring(5, 9);
                }
                
                this.value = value;
            });
        }
    });
    
    document.getElementById('editAjouterAdresseInput').focus();
}

// حفظ التعديل لـ AJOUTER - التعديل المطلوب
function saveEditAjouterProduit() {
    const newAdresse = document.getElementById('editAjouterAdresseInput').value;
    const newQte1 = document.getElementById('editAjouterQte1Input').value;
    const newDlc1 = document.getElementById('editAjouterDlc1Input').value;
    const newQte2 = document.getElementById('editAjouterQte2Input').value;
    const newDlc2 = document.getElementById('editAjouterDlc2Input').value;
    const newQte3 = document.getElementById('editAjouterQte3Input').value;
    const newDlc3 = document.getElementById('editAjouterDlc3Input').value;
    
    if (!newAdresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    // تحويل 6/1 إلى Z6P1
    let adresseFinale = newAdresse;
    if (newAdresse.includes('/')) {
        const parties = newAdresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    // التحقق من صحة التواريخ إذا كانت موجودة
    if (newDlc1 && !isValidDateYYYY(newDlc1)) {
        showAlert('DATE DLC 1 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc2 && !isValidDateYYYY(newDlc2)) {
        showAlert('DATE DLC 2 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    if (newDlc3 && !isValidDateYYYY(newDlc3)) {
        showAlert('DATE DLC 3 INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    // التحقق من أن على الأقل كمية واحدة غير فارغة
    if (!newQte1 && !newQte2 && !newQte3) {
        showAlert('VEUILLEZ ENTRER AU MOINS UNE QUANTITÉ', 'warning');
        return;
    }
    
    // التحقق مما إذا كان العنوان قد تغير والتحقق من التكرار
    const produitOriginal = ajouterProduits[editingAjouterProduitIndex];
    if (adresseFinale !== produitOriginal.adresse) {
        // التحقق من عدم وجود منتج آخر بنفس الكود والعنوان الجديد
        const existingIndex = ajouterProduits.findIndex((p, i) => i !== editingAjouterProduitIndex && p.adresse === adresseFinale && p.code === produitOriginal.code);
        
        if (existingIndex >= 0) {
            showAlert('UN PRODUIT AVEC LE MÊME CODE ET ADRESSE EXISTE DÉJÀ!', 'warning');
            return;
        }
    }
    
    ajouterProduits[editingAjouterProduitIndex].adresse = adresseFinale;
    ajouterProduits[editingAjouterProduitIndex].qte1 = newQte1 ? parseInt(newQte1) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc1 = newDlc1;
    ajouterProduits[editingAjouterProduitIndex].qte2 = newQte2 ? parseInt(newQte2) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc2 = newDlc2;
    ajouterProduits[editingAjouterProduitIndex].qte3 = newQte3 ? parseInt(newQte3) : 0;
    ajouterProduits[editingAjouterProduitIndex].dlc3 = newDlc3;
    
    saveAjouterProduits();
    updateAjouterDisplay();
    editingAjouterProduitIndex = -1;
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

// إلغاء التعديل لـ AJOUTER
function cancelEditAjouterProduit() {
    editingAjouterProduitIndex = -1;
    updateAjouterDisplay();
}

// حذف منتج لـ AJOUTER
function deleteAjouterProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        ajouterProduits.splice(index, 1);
        saveAjouterProduits();
        updateAjouterDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

// مسح جميع المنتجات لـ AJOUTER - تم إصلاحه (التعديل الرئيسي)
function clearAllAjouter() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        ajouterProduits = [];
        saveAjouterProduits();
        updateAjouterDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// ============================================
// وظائف صفحة CASSE FRAIS
// ============================================

// تحميل المنتجات المخزنة محليًا لـ CASSE FRAIS
function loadCasseProduits() {
    const savedProduits = localStorage.getItem('casse_produits');
    if (savedProduits) {
        casseProduits = JSON.parse(savedProduits);
        updateCasseDisplay();
    }
}

// حفظ المنتجات محليًا لـ CASSE FRAIS
function saveCasseProduits() {
    localStorage.setItem('casse_produits', JSON.stringify(casseProduits));
}

// تحديث عرض صفحة CASSE FRAIS
function updateCasseDisplay() {
    // تحديث العداد
    document.getElementById('casseProduitCount').textContent = casseProduits.length;
    
    // عرض المنتجات
    const container = document.getElementById('casseProduitsContainer');
    container.innerHTML = '';
    
    casseProduits.forEach((produit, index) => {
        const card = document.createElement('div');
        card.className = 'produit-card';
        
        card.innerHTML = `
            <div class="produit-header">
                <div class="produit-code">${produit.code}</div>
                <div class="produit-actions">
                    <button class="produit-edit" onclick="editCasseProduit(${index})">✏️</button>
                    <button class="produit-delete" onclick="deleteCasseProduit(${index})">✕</button>
                </div>
            </div>
            <div class="produit-name">${produit.nom}</div>
            <div class="produit-qte">
                <div style="display: flex; justify-content: space-between; width: 100%;">
                    <div>
                        <span class="qte-label">QTE:</span>
                        <span class="qte-value">${produit.qte}</span>
                    </div>
                    <div>
                        <span class="qte-label">DATE:</span>
                        <span class="qte-value">${produit.date}</span>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// سكانير لمنتجات CASSE FRAIS
function scannerCasse() {
    const codeInput = document.getElementById('casseCodeInput');
    const codeSimule = "123456";
    codeInput.value = codeSimule;
    
    const event = new Event('input', { bubbles: true });
    codeInput.dispatchEvent(event);
    
    const originalColor = codeInput.style.backgroundColor;
    codeInput.style.backgroundColor = "#c6f6d5";
    codeInput.style.borderColor = "#9ae6b4";
    setTimeout(() => {
        codeInput.style.backgroundColor = originalColor;
        codeInput.style.borderColor = "";
    }, 1000);
}

// البحث عن معلومات المنتج عند إدخال الكود لـ CASSE FRAIS
document.getElementById('casseCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        showProductInfoForCasse(code);
    } else {
        document.getElementById('casseProductInfo').innerHTML = '';
    }
});

// عرض معلومات المنتج في صفحة CASSE FRAIS
function showProductInfoForCasse(code) {
    const container = document.getElementById('casseProductInfo');
    container.innerHTML = '';
    
    // البحث عن معلومات المنتج
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        // إنشاء كارد معلومات
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        // إسم المنتج
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        // عرض المعلومات المطلوبة فقط
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE GOLD", value: qteGold});
        } else {
            infos.push({label: "QTE GOLD", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        // عرض المعلومات
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

// إضافة منتج جديد لـ CASSE FRAIS
function ajouterProduitCasse() {
    const codeInput = document.getElementById('casseCodeInput');
    const qteInput = document.getElementById('casseQteInput');
    const dateInput = document.getElementById('casseDateInput');
    
    const code = codeInput.value.trim();
    const qte = qteInput.value.trim();
    const date = dateInput.value.trim();
    
    // التحقق من عدم فراغ حقل التاريخ
    if (!date) {
        showAlert('VEUILLEZ ENTRER LA DATE (JJ/MM/AAAA)', 'warning');
        dateInput.focus();
        return;
    }
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÉ DU PRODUIT', 'warning');
        return;
    }
    
    // التحقق من صحة التاريخ
    if (!isValidDateYYYY(date)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dateInput.focus();
        return;
    }
    
    // البحث عن المنتج للتأكد من وجوده
    const nomProduit = getProductNameByCode(code);
    
    // التعديل: السماح بإضافة جميع المنتجات حتى لو غير موجودة في قاعدة البيانات
    const produitNom = nomProduit || "PRODUIT NON RÉFÉRENCÉ";
    
    // التحقق مما إذا كان المنتج موجودًا بالفعل
    const existingIndex = casseProduits.findIndex(p => p.code === code);
    
    if (existingIndex >= 0) {
        // تحديث الكمية إذا كان المنتج موجودًا
        casseProduits[existingIndex].qte = parseInt(qte);
        casseProduits[existingIndex].date = date;
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        // إضافة منتج جديد
        casseProduits.push({
            code: code,
            nom: produitNom,
            qte: parseInt(qte),
            date: date
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    // حفظ وتحديث العرض
    saveCasseProduits();
    updateCasseDisplay();
    
    // مسح الحقول
    codeInput.value = '';
    qteInput.value = '';
    dateInput.value = '';
    document.getElementById('casseProductInfo').innerHTML = '';
    
    // التركيز على حقل الكود
    codeInput.focus();
}

// تعديل منتج لـ CASSE FRAIS
function editCasseProduit(index) {
    editingCasseProduitIndex = index;
    const produit = casseProduits[index];
    
    const container = document.getElementById('casseProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="produit-header">
            <div class="produit-code">${produit.code}</div>
            <div style="color: #3498db; font-weight: bold;">MODIFICATION</div>
        </div>
        <div class="produit-name">${produit.nom}</div>
        <div class="produit-qte" style="flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; font-size: 12px; color: #7f8c8d;">QTE:</div>
                    <input type="number" class="edit-qte-input" id="editCasseQteInput" value="${produit.qte}" min="1" style="width: 100%;">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; font-size: 12px; color: #7f8c8d;">DATE:</div>
                    <input type="tel" class="edit-qte-input" id="editCasseDateInput" value="${produit.date}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; text-align: center;">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="save-edit-btn" onclick="saveEditCasseProduit()" style="flex: 1;">ENREGISTRER</button>
                <button class="cancel-edit-btn" onclick="cancelEditCasseProduit()" style="flex: 1;">ANNULER</button>
            </div>
        </div>
    `;
    
    // إعداد حقل التاريخ للتعديل
    const dateInput = document.getElementById('editCasseDateInput');
    dateInput.addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        if (value.length >= 5) {
            value = value.substring(0, 5) + '/' + value.substring(5, 9);
        }
        
        this.value = value;
    });
    
    document.getElementById('editCasseQteInput').focus();
    document.getElementById('editCasseQteInput').select();
}

// حفظ التعديل لـ CASSE FRAIS
function saveEditCasseProduit() {
    const newQte = document.getElementById('editCasseQteInput').value;
    const newDate = document.getElementById('editCasseDateInput').value;
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    if (!newDate || !isValidDateYYYY(newDate)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    casseProduits[editingCasseProduitIndex].qte = parseInt(newQte);
    casseProduits[editingCasseProduitIndex].date = newDate;
    saveCasseProduits();
    updateCasseDisplay();
    editingCasseProduitIndex = -1;
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

// إلغاء التعديل لـ CASSE FRAIS
function cancelEditCasseProduit() {
    editingCasseProduitIndex = -1;
    updateCasseDisplay();
}

// حذف منتج لـ CASSE FRAIS
function deleteCasseProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        casseProduits.splice(index, 1);
        saveCasseProduits();
        updateCasseDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

// مسح جميع المنتجات لـ CASSE FRAIS - تم إصلاحه (التعديل الرئيسي)
function clearAllProduitsCasse() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        casseProduits = [];
        saveCasseProduits();
        updateCasseDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// ============================================
// وظائف صفحة RETIRER - التعديلات المطلوبة
// ============================================

// تحميل المنتجات المخزنة محليًا لـ RETIRER
function loadRetirerProduits() {
    const savedProduits = localStorage.getItem('retirer_produits');
    if (savedProduits) {
        retirerProduits = JSON.parse(savedProduits);
        updateRetirerDisplay();
    }
}

// حفظ المنتجات محليًا لـ RETIRER
function saveRetirerProduits() {
    localStorage.setItem('retirer_produits', JSON.stringify(retirerProduits));
}

// تحديث عرض صفحة RETIRER - التعديل 3
function updateRetirerDisplay() {
    // تحديث العداد
    document.getElementById('retirerProduitCount').textContent = retirerProduits.length;
    
    // عرض المنتجات
    const container = document.getElementById('retirerProduitsContainer');
    container.innerHTML = '';
    
    retirerProduits.forEach((produit, index) => {
        const card = document.createElement("div");
        card.className = "adresseCard";
        
        // ============================================
        // التعديل 3: إضافة زر التعديل والحذف في أعلى الكارد
        // ============================================
        const headerRow = document.createElement("div");
        headerRow.className = "produit-header";
        headerRow.style.marginBottom = "10px";
        
        const title = document.createElement("h3"); 
        title.textContent = `${produit.adresse}`; 
        title.style.marginBottom = "0";
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "produit-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "produit-edit";
        editBtn.textContent = "✏️";
        editBtn.onclick = function() {
            editRetirerProduit(index);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "produit-delete";
        deleteBtn.textContent = "✕";
        deleteBtn.onclick = function() {
            deleteRetirerProduit(index);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        headerRow.appendChild(title);
        headerRow.appendChild(actionsDiv);
        card.appendChild(headerRow);
        
        // عرض كود المنتج
        if (produit.code) {
            const codeRow = document.createElement("div");
            codeRow.className = "codeRow";
            codeRow.textContent = `${produit.code}`;
            card.appendChild(codeRow);
        }
        
        // عرض اسم المنتج
        if (produit.nom) {
            const nameRow = document.createElement("div");
            nameRow.className = "nameRow";
            nameRow.textContent = produit.nom;
            card.appendChild(nameRow);
        }
        
        // عرض الكمية والتاريخ
        const qteRow = document.createElement("div");
        qteRow.className = "qteRow";
        qteRow.innerHTML = `<span class="label">QTE:</span> <span class="qte-value">${produit.qte}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${produit.date}</span>`;
        card.appendChild(qteRow);
        
        container.appendChild(card);
    });
}

// سكانير لمنتجات RETIRER
function scannerRetirer() {
    const codeInput = document.getElementById('retirerCodeInput');
    const codeSimule = "123456";
    codeInput.value = codeSimule;
    
    const event = new Event('input', { bubbles: true });
    codeInput.dispatchEvent(event);
    
    const originalColor = codeInput.style.backgroundColor;
    codeInput.style.backgroundColor = "#c6f6d5";
    codeInput.style.borderColor = "#9ae6b4";
    setTimeout(() => {
        codeInput.style.backgroundColor = originalColor;
        codeInput.style.borderColor = "";
    }, 1000);
}

// البحث عن معلومات المنتج عند إدخال الكود لـ RETIRER
document.getElementById('retirerCodeInput').addEventListener('input', function() {
    const code = this.value.trim();
    if (code.length > 0) {
        // عرض معلومات المنتج
        showProductInfoForRetirer(code);
        
        // عرض كروت نتائج البحث (بنفس شكل CONTENUE D'ADRESSE)
        afficherResultatsRechercheRetirer(code);
    } else {
        document.getElementById('retirerProductInfo').innerHTML = '';
        document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    }
});

// عرض معلومات المنتج في صفحة RETIRER - التعديل المطلوب
function showProductInfoForRetirer(code) {
    const container = document.getElementById('retirerProductInfo');
    container.innerHTML = '';
    
    // البحث عن معلومات المنتج
    const nomProduit = getProductNameByCode(code);
    const venteJ1 = getVenteJ1ByCode(code);
    const qteGold = getQteGoldByCode(code);
    const qteReserve = getQteReserveByCode(code);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        // إنشاء كارد معلومات مثل صفحة COMMANDE
        const card = document.createElement('div');
        card.className = 'reserveCard';
        
        // إسم المنتج
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        card.appendChild(title);
        
        // عرض المعلومات المطلوبة فقط
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE GOLD", value: qteGold});
        } else {
            infos.push({label: "QTE GOLD", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        // عرض المعلومات
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            card.appendChild(row);
        });
        
        container.appendChild(card);
    } else {
        const message = document.createElement('div');
        message.className = 'adresseCard';
        message.innerHTML = `<h3>PRODUIT NON TROUVÉ</h3>`;
        container.appendChild(message);
    }
}

// عرض كروت نتائج البحث في صفحة RETIRER (بنفس شكل CONTENUE D'ADRESSE)
function afficherResultatsRechercheRetirer(searchTerm) {
    const container = document.getElementById('retirerSearchResultsContainer');
    container.innerHTML = "";
    
    if(!searchTerm) return;
    
    let resultatsTrouves = 0;
    let totalAdresses = 0;
    
    // أولاً: عرض كارد معلومات المنتج
    const nomProduit = getProductNameByCode(searchTerm);
    const venteJ1 = getVenteJ1ByCode(searchTerm);
    const qteGold = getQteGoldByCode(searchTerm);
    const qteReserve = getQteReserveByCode(searchTerm);
    
    if (nomProduit || venteJ1 || qteGold || qteReserve) {
        // إنشاء كارد معلومات مثل صفحة COMMANDE
        const infoCard = document.createElement('div');
        infoCard.className = 'reserveCard';
        
        // إسم المنتج
        const title = document.createElement('h3');
        title.textContent = nomProduit || "PRODUIT INCONNU";
        infoCard.appendChild(title);
        
        // عرض المعلومات المطلوبة فقط
        const infos = [];
        
        if (venteJ1 && venteJ1 !== "0") {
            infos.push({label: "VENTE J-1", value: venteJ1});
        } else {
            infos.push({label: "VENTE J-1", value: "0"});
        }
        
        if (qteGold && qteGold !== "0") {
            infos.push({label: "QTE GOLD", value: qteGold});
        } else {
            infos.push({label: "QTE GOLD", value: "0"});
        }
        
        if (qteReserve && qteReserve !== "0") {
            infos.push({label: "QTE RESERVE", value: qteReserve});
        } else {
            infos.push({label: "QTE RESERVE", value: "0"});
        }
        
        // عرض المعلومات
        infos.forEach(info => {
            const row = document.createElement('div');
            row.className = 'dataRow';
            row.innerHTML = `<span class="label">${info.label}:</span> <span class="value">${info.value}</span>`;
            infoCard.appendChild(row);
        });
        
        container.appendChild(infoCard);
    }
    
    // ثانياً: عرض كارد TOTAL ADRESSES
    const adressesSet = new Set();
    let totalQteGlobal = 0;
    
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        if(codeProduit === searchTerm){
            const adresse = csvCache[i][1] || "";
            if (adresse) adressesSet.add(adresse);
            
            // حساب الكمية الإجمالية
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                if(qNum>0 && !dateInvalid){
                    totalQteGlobal += qNum;
                }
            }
        }
    }
    
    totalAdresses = adressesSet.size;
    
    if (totalAdresses > 0) {
        const totalCard = document.createElement("div");
        totalCard.className = "totalSummaryCard";
        
        const totalTitle = document.createElement("h3");
        totalTitle.textContent = "TOTAL ADRESSES";
        totalCard.appendChild(totalTitle);
        
        const totalRow = document.createElement("div");
        totalRow.className = "dataRow";
        totalRow.innerHTML = `<span class="total-value">${totalAdresses} ADRESSE</span>`;
        totalCard.appendChild(totalRow);
        
        container.appendChild(totalCard);
    }
    
    // ثالثاً: عرض جميع الكروت الأصلية (العناوين والكميات)
    for(let i=1;i<csvCache.length;i++){
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === searchTerm){
            resultatsTrouves++;
            const adresse = csvCache[i][1] || "";
            
            const card = document.createElement("div");
            card.className = "adresseCard";
            
            const title = document.createElement("h3"); 
            title.textContent = `${adresse}`; 
            card.appendChild(title);
            
            // عرض كود المنتج
            if (codeProduit) {
                const codeRow = document.createElement("div");
                codeRow.className = "codeRow";
                codeRow.textContent = `${codeProduit}`;
                card.appendChild(codeRow);
            }
            
            // عرض اسم المنتج
            if (nomProduit) {
                const nameRow = document.createElement("div");
                nameRow.className = "nameRow";
                nameRow.textContent = nomProduit;
                card.appendChild(nameRow);
            }
            
            let compteur = 1;
            let totalQte = 0;
            let datesDetails = [];
            
            for(let j=2;j<8;j+=2){
                let q=(csvCache[i][j]||"").trim();
                let d=(csvCache[i][j+1]||"").trim();
                const qNum=parseFloat(q.replace(/[^0-9.-]+/g,""))||0;
                const dateInvalid=(d===""||d==="00/01/1900"||d==="0000-00-00");
                
                if(qNum>0 && !dateInvalid){
                    totalQte += qNum;
                    const dateObj = parseDate(d);
                    if (dateObj) {
                        datesDetails.push({
                            q: q,
                            d: d,
                            dateObj: dateObj
                        });
                    }
                }
            }
            
            // فرز التواريخ من الأقرب إلى الأبعد
            datesDetails.sort((a, b) => a.dateObj - b.dateObj);
            
            // عرض التواريخ بعد الفرز
            datesDetails.forEach(detail => {
                const row = document.createElement("div");
                row.className="qteRow";
                row.innerHTML = `<span class="label">QTE${compteur}:</span> <span class="qte-value">${detail.q}</span> &nbsp;&nbsp;<--->&nbsp;&nbsp; <span class="date-value">${detail.d}</span>`;
                card.appendChild(row);
                compteur++;
            });
            
            if(totalQte > 0){
                const totalRow = document.createElement("div");
                totalRow.className = "totalRow";
                totalRow.innerHTML = `<span class="total-value">TOTAL ${totalQte} UNITÉS</span>`;
                card.appendChild(totalRow);
            }
            
            container.appendChild(card);
        }
    }
    
    if(resultatsTrouves === 0 && nomProduit){
        const noResultCard = document.createElement("div");
        noResultCard.className = "adresseCard";
        noResultCard.innerHTML = `<h3>AUCUN PRODUIT AVEC LE CODE "${searchTerm}" DANS LES ADRESSES</h3>`;
        container.appendChild(noResultCard);
    }
}

// عند النقر على حقل التاريخ، عرض جميع التواريخ المتاحة
document.getElementById('retirerDateInput').addEventListener('click', function() {
    const code = document.getElementById('retirerCodeInput').value.trim();
    if (!code) {
        showAlert('VEUILLEZ D\'ABORD ENTRER LE CODE PRODUIT', 'warning');
        return;
    }
    
    const dates = getAvailableDatesForProduct(code);
    if (dates.length === 0) {
        showAlert('AUCUNE DATE DISPONIBLE POUR CE PRODUIT', 'warning');
        return;
    }
    
    openDateSelectModalForRetirer(dates);
});

// إغلاق نافذة اختيار التاريخ
function closeDateSelectModal() {
    document.getElementById('dateSelectModal').style.display = 'none';
    document.getElementById('dateOptionsContainer').innerHTML = '';
}

// عرض نافذة اختيار التاريخ لـ RETIRER
function openDateSelectModalForRetirer(dates) {
    document.getElementById('dateSelectMessage').textContent = 'CHOISISSEZ UNE DATE:';
    
    const container = document.getElementById('dateOptionsContainer');
    container.innerHTML = '';
    
    dates.forEach(date => {
        const option = document.createElement('div');
        option.className = 'date-option';
        option.textContent = date;
        option.onclick = function() {
            // إزالة التحديد السابق
            const previousSelected = container.querySelector('.selected');
            if (previousSelected) {
                previousSelected.classList.remove('selected');
            }
            
            // تحديد الخيار الحالي
            this.classList.add('selected');
            
            // تعيين التاريخ في حقل الإدخال
            document.getElementById('retirerDateInput').value = date;
            
            // إغلاق النافذة بعد تأخير قصير
            setTimeout(() => {
                closeDateSelectModal();
            }, 500);
        };
        container.appendChild(option);
    });
    
    document.getElementById('dateSelectModal').style.display = 'flex';
}

// الحصول على التواريخ المتاحة للمنتج
function getAvailableDatesForProduct(code) {
    const dates = [];
    
    for(let i = 1; i < csvCache.length; i++) {
        const codeProduit = csvCache[i][0] || "";
        
        if(codeProduit === code) {
            // البحث عن التواريخ في الأعمدة 3، 5، 7
            for(let j = 3; j <= 7; j += 2) {
                const dateStr = csvCache[i][j] || "";
                if (dateStr && dateStr !== "00/01/1900" && dateStr !== "0000-00-00") {
                    // التحقق من عدم وجود التاريخ مسبقًا
                    if (!dates.includes(dateStr)) {
                        dates.push(dateStr);
                    }
                }
            }
        }
    }
    
    // فرز التواريخ من الأقدم إلى الأحدث
    dates.sort((a, b) => {
        const dateA = parseDate(a);
        const dateB = parseDate(b);
        if (!dateA || !dateB) return 0;
        return dateA - dateB;
    });
    
    return dates;
}

// إضافة منتج جديد لـ RETIRER - التعديل المطلوب
function ajouterProduitRetirer() {
    const codeInput = document.getElementById('retirerCodeInput');
    const adresseInput = document.getElementById('retirerAdresseInput');
    const qteInput = document.getElementById('retirerQteInput');
    const dateInput = document.getElementById('retirerDateInput');
    
    const code = codeInput.value.trim();
    const adresse = adresseInput.value.trim();
    const qte = qteInput.value.trim();
    const date = dateInput.value.trim();
    
    // التحقق من عدم فراغ الحقول
    if (!adresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        adresseInput.focus();
        return;
    }
    
    if (!date) {
        showAlert('VEUILLEZ ENTRER LA DATE (JJ/MM/AAAA)', 'warning');
        dateInput.focus();
        return;
    }
    
    if (!code || !qte) {
        showAlert('VEUILLEZ ENTRER LE CODE ET LA QUANTITÉ DU PRODUIT', 'warning');
        return;
    }
    
    // التحقق من صحة التاريخ
    if (!isValidDateYYYY(date)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        dateInput.focus();
        return;
    }
    
    // البحث عن المنتج للتأكد من وجوده
    const nomProduit = getProductNameByCode(code);
    if (!nomProduit) {
        showAlert('PRODUIT NON TROUVÉ DANS LA BASE DE DONNÉES', 'warning');
        return;
    }
    
    // تحويل 6/1 إلى Z6P1
    let adresseFinale = adresse;
    if (adresse.includes('/')) {
        const parties = adresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    // التحقق مما إذا كان المنتج موجودًا بالفعل
    const existingIndex = retirerProduits.findIndex(p => p.code === code && p.adresse === adresseFinale);
    
    if (existingIndex >= 0) {
        // تحديث الكمية إذا كان المنتج موجودًا
        retirerProduits[existingIndex].qte = parseInt(qte);
        retirerProduits[existingIndex].date = date;
        showAlert('PRODUIT MIS À JOUR AVEC SUCCÈS', 'success');
    } else {
        // إضافة منتج جديد
        retirerProduits.push({
            code: code,
            adresse: adresseFinale,
            nom: nomProduit,
            qte: parseInt(qte),
            date: date
        });
        showAlert('PRODUIT AJOUTÉ AVEC SUCCÈS', 'success');
    }
    
    // حفظ وتحديث العرض
    saveRetirerProduits();
    updateRetirerDisplay();
    
    // مسح الحقول
    codeInput.value = '';
    adresseInput.value = '';
    qteInput.value = '';
    dateInput.value = '';
    document.getElementById('retirerProductInfo').innerHTML = '';
    document.getElementById('retirerSearchResultsContainer').innerHTML = '';
    pendingDateSelection = null;
    
    // التركيز على حقل الكود
    codeInput.focus();
}

// تعديل منتج لـ RETIRER - التعديل المطلوب
function editRetirerProduit(index) {
    editingRetirerProduitIndex = index;
    const produit = retirerProduits[index];
    
    // إنشاء واجهة التعديل
    const container = document.getElementById('retirerProduitsContainer');
    const card = container.children[index];
    
    card.innerHTML = `
        <div class="adresseCard">
            <h3 style="color: #3498db;">MODIFICATION</h3>
            
            <div class="codeRow" style="background: #3498db; color: white;">${produit.code}</div>
            
            <div class="nameRow">${produit.nom}</div>
            
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 8px;">
                <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">ADRESSE:</div>
                <input type="tel" id="editRetirerAdresseInput" value="${produit.adresse}" pattern="[0-9/]*" style="width: 100%; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">QTE:</div>
                    <input type="number" id="editRetirerQteInput" value="${produit.qte}" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 5px; color: #7f8c8d; font-size: 12px;">DATE:</div>
                    <input type="tel" id="editRetirerDateInput" value="${produit.date}" pattern="\\d{2}/\\d{2}/\\d{4}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="retirer-btn" onclick="saveEditRetirerProduit()" style="flex: 1; padding: 10px; background: #34495e;">ENREGISTRER</button>
                <button class="retirer-btn" onclick="cancelEditRetirerProduit()" style="flex: 1; padding: 10px; background: #e74c3c;">ANNULER</button>
            </div>
        </div>
    `;
    
    // إعداد حقل التاريخ للتعديل
    const dateInput = document.getElementById('editRetirerDateInput');
    dateInput.addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        if (value.length >= 5) {
            value = value.substring(0, 5) + '/' + value.substring(5, 9);
        }
        
        this.value = value;
    });
    
    document.getElementById('editRetirerAdresseInput').focus();
    document.getElementById('editRetirerAdresseInput').select();
}

// حفظ التعديل لـ RETIRER - التعديل المطلوب
function saveEditRetirerProduit() {
    const newAdresse = document.getElementById('editRetirerAdresseInput').value;
    const newQte = document.getElementById('editRetirerQteInput').value;
    const newDate = document.getElementById('editRetirerDateInput').value;
    
    if (!newAdresse) {
        showAlert('VEUILLEZ ENTRER L\'ADRESSE', 'warning');
        return;
    }
    
    if (!newQte || parseInt(newQte) <= 0) {
        showAlert('VEUILLEZ ENTRER UNE QUANTITÉ VALIDE', 'warning');
        return;
    }
    
    if (!newDate || !isValidDateYYYY(newDate)) {
        showAlert('DATE INVALIDE. FORMAT: JJ/MM/AAAA', 'warning');
        return;
    }
    
    // تحويل 6/1 إلى Z6P1
    let adresseFinale = newAdresse;
    if (newAdresse.includes('/')) {
        const parties = newAdresse.split('/');
        if (parties.length === 2) {
            const num1 = parties[0].trim();
            const num2 = parties[1].trim();
            adresseFinale = `Z${num1}P${num2}`;
        }
    }
    
    retirerProduits[editingRetirerProduitIndex].adresse = adresseFinale;
    retirerProduits[editingRetirerProduitIndex].qte = parseInt(newQte);
    retirerProduits[editingRetirerProduitIndex].date = newDate;
    saveRetirerProduits();
    updateRetirerDisplay();
    editingRetirerProduitIndex = -1;
    showAlert('PRODUIT MODIFIÉ AVEC SUCCÈS', 'success');
}

// إلغاء التعديل لـ RETIRER
function cancelEditRetirerProduit() {
    editingRetirerProduitIndex = -1;
    updateRetirerDisplay();
}

// حذف منتج لـ RETIRER
function deleteRetirerProduit(index) {
    showConfirmModal('VOULEZ-VOUS VRAIMENT SUPPRIMER CE PRODUIT?', () => {
        retirerProduits.splice(index, 1);
        saveRetirerProduits();
        updateRetirerDisplay();
        showAlert('PRODUIT SUPPRIMÉ AVEC SUCCÈS', 'success');
    });
}

// مسح جميع المنتجات لـ RETIRER - تم إصلاحه (التعديل الرئيسي)
function clearAllProduitsRetirer() {
    showConfirmModal('VOULEZ-VOUS VRAIMENT EFFACER TOUS LES PRODUITS?', function() {
        retirerProduits = [];
        saveRetirerProduits();
        updateRetirerDisplay();
        showAlert('TOUS LES PRODUITS ONT ÉTÉ EFFACÉS', 'success');
    });
}

// تهيئة التطبيق عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>